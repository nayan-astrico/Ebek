{% extends "assessments/base.html" %}

{% block title %}Exam Reports{% endblock %}

{% block content %}
<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="reports-container">
    <!-- Header Section -->
    <div class="reports-header">
        <h1>Exam Reports</h1>
        <p class="subtitle">View and analyze candidate performance across different skillathons</p>
</div>

    <!-- Navigation Tabs -->
    <div class="reports-tabs">
        {% if "view_overall_report" in request.user.get_all_permissions  or request.user.has_all_permissions %}
        <button class="tab-button active" onclick="switchTab('overall')" style="outline: none;">Overall Report</button>
        {% endif %}
        {% if "view_candidate_report" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <button class="tab-button" onclick="switchTab('student')" style="outline: none;">Candidate Report</button>
        {% endif %}
        <button class="tab-button" onclick="switchTab('osce')" style="outline: none;">OSCE Report</button>
    </div>

    <!-- Overall Report Tab -->
    {% if "view_overall_report" in request.user.get_all_permissions or request.user.has_all_permissions %}
    <div id="overall-tab" class="tab-content active">
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <select id="skillathonFilter" class="select-filter" onchange="onSkillathonChange()">
                    <option value="">Select Skillathon</option>
                </select>
                <select id="instituteFilter" class="select-filter" disabled onchange="onInstituteChange()">
                    <option value="">All Institutes</option>
                </select>
                <button id="goButton" class="search-button" onclick="fetchMetricsAuto()" disabled>Go</button>
            </div>
        </div>

        <!-- Metrics Section -->
        <div class="metrics-section">
            <div class="metrics-cards">
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Total Candidates Participated</h3>
                            <div class="metric-value" id="totalStudents">0</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Candidates Completed All Procedures</h3>
                            <div class="metric-value" id="completedAllProcedures">0</div>
                        </div>
                    </div>
                </div>


                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Highest Scoring Skill</h3>
                            <div class="metric-value skillscoring" id="highestScoringSkill">-</div>
                            <div class="metric-value skillpercentage" id="highestScoringSkillPercentage">0</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Lowest Scoring Skill</h3>
                            <div class="metric-value skillscoring" id="lowestScoringSkill">-</div>
                            <div class="metric-value skillpercentage" id="lowestScoringSkillPercentage">0</div>
                        </div>
                    </div>
                </div>


                <div class="metric-card procedures-card" id="procedureCountsContainer">
                    <div class="metric-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="metric-content">
                        <h3>Procedure Participation</h3>
                        <div id="procedureCounts" class="procedure-counts-grid"></div>
                    </div>
                </div>
            </div>

            

            <!-- Institute Metrics Section -->
            <div class="chart-container">
                <h3 style="font-size: 16px;
        color: #1a202c;
        margin: 0 0 20px;
        font-weight: 600;">Overall Grade Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="gradeChart"></canvas>
                </div>
            </div>
        </div>


        <div class="gender-analysis-section">
            <h2 class="section-title">Institute-wise Station Performance</h2>
            <div class="institute-container">
                <table class="table">
                    <thead>
                        <tr id="stationTableHeader"></tr>
                    </thead>
                    <tbody id="instituteTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Gender Analysis Section -->
        <div class="gender-analysis-section">
            <h2 class="section-title">Gender Analysis</h2>
            <div class="gender-charts">
                <div class="gender-chart-card">
                    <h3>Overall Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="genderTotalChart"></canvas>
                    </div>
                </div>
                <div class="gender-chart-card">
                    <h3>Male Candidates Performance</h3>
                    <div class="chart-wrapper">
                        <canvas id="maleGradeChart"></canvas>
                    </div>
                </div>
                <div class="gender-chart-card">
                    <h3>Female Candidates Performance</h3>
                    <div class="chart-wrapper">
                        <canvas id="femaleGradeChart"></canvas>
                    </div>
                </div>
                <div class="gender-chart-card">
                    <h3>Other Candidates Performance</h3>
                    <div class="chart-wrapper">
                        <canvas id="othersGradeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skill Analysis Section -->
        <div class="skill-analysis-section">
            <h2 class="section-title">Skill-wise Analysis</h2>
            <div id="skillAnalysisContainer">
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Student Report Tab -->
    {% if "view_candidate_report" in request.user.get_all_permissions or request.user.has_all_permissions %}
    <div id="student-tab" class="tab-content">
            <!-- Filters Section -->
            <div class="filters-section">
                <div class="filter-group">
                    <select id="studentSkillathonFilter" class="select-filter" onchange="onStudentSkillathonChange()">
                        <option value="">Select Skillathon</option>
                    </select>

                    <select id="studentInstituteFilter" class="select-filter" onchange="onStudentInstituteChange()">
                        <option value="">All Institutes</option>
                    </select>

                    <button id="studentGoButton" class="search-button" onclick="fetchStudentMetricsAuto()" disabled>Go</button>
                </div>
            </div>

            <!-- Score Metrics -->
            <div id="studentMetrics" style="display: none;">
                <div class="score-metrics">
                    <div class="score-card highest">
                        <div class="score-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="score-content">
                            <h3>Highest Score</h3>
                            <div class="score-details">
                                <div class="score-value" id="highestScore">0%</div>
                                <div class="student-info">
                                    <div class="student-name" id="highestScoreStudent">-</div>
                                    <div class="institute-name" id="highestScoreInstitute">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="score-card lowest">
                        <div class="score-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="score-content">
                            <h3>Lowest Score</h3>
                            <div class="score-details">
                                <div class="score-value" id="lowestScore">0%</div>
                                <div class="student-info">
                                    <div class="student-name" id="lowestScoreStudent">-</div>
                                    <div class="institute-name" id="lowestScoreInstitute">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Table -->
                <div class="performance-table-container">
                    <div class="table-header">
                        <h3>Candidate Performance</h3>
                        <div class="header-actions">
                            <div class="search-container">
                                <input type="text" 
                                       id="studentSearchInput" 
                                       placeholder="Search candidates by name..." 
                                       class="search-input"
                                       oninput="searchStudents(this.value)">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div class="download-buttons">
                                {% if "download_candidate_report" in request.user.get_all_permissions or request.user.has_all_permissions %}
                                <button class="download-btn pdf-btn" onclick="downloadStudentReport('pdf')" title="Download as PDF">
                                    <i class="fas fa-file-pdf"></i>
                                    PDF
                                </button>
                                <button class="download-btn excel-btn" onclick="downloadStudentReport('excel')" title="Download as Excel">
                                    <i class="fas fa-file-excel"></i>
                                    Excel
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="performance-table" id="studentDetailsTable">
                            <thead id="performanceTableHead">
                                <tr>
                                    <th class="student-col sticky-col">Candidate Name</th>
                                    <th class="institute-col sticky-col">Institute</th>
                                    <!-- Procedure columns will be added dynamically -->
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <!-- Student data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- No Data Message -->
            <div id="noDataFound" class="no-data-message">
                <i class="fas fa-chart-bar"></i>
                <h3>No Data Available</h3>
                <p>Please select a Skillathon to view metrics</p>
            </div>
    </div>
    {% endif %}

    <!-- OSCE Report Tab -->
    <div id="osce-tab" class="tab-content">
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <select id="osceInstitutionFilter" class="select-filter">
                    <option value="">Select Institution/Hospital *</option>
                </select>
                <select id="osceAcademicYearFilter" class="select-filter">
                    <option value="">Select Academic Year *</option>
                </select>
                <select id="osceSemesterFilter" class="select-filter">
                    <option value="">All Semesters</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                    <option value="4">Semester 4</option>
                    <option value="5">Semester 5</option>
                    <option value="6">Semester 6</option>
                    <option value="7">Semester 7</option>
                    <option value="8">Semester 8</option>
                </select>
                <select id="osceLevelFilter" class="select-filter">
                    <option value="All">All OSCE Levels</option>
                    <option value="Classroom">Classroom</option>
                    <option value="Mock">Mock</option>
                    <option value="Final">Final</option>
                </select>
                <select id="osceSkillFilter" class="select-filter">
                    <option value="">All Procedures</option>
                </select>
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="osceStudentSearch" class="search-input" placeholder="Search by student name...">
                </div>
                <button id="osceGoButton" class="search-button" onclick="applyOsceFilters()">Go</button>
            </div>
        </div>

        <!-- Metrics Section -->
        <div class="metrics-section" style="display: none;">
            <div class="metrics-cards">
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Total Students Enrolled</h3>
                            <div class="metric-value" id="osceTotalStudentsEnrolled">0</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Students Assessed (any OSCE)</h3>
                            <div class="metric-value" id="osceStudentsAssessed">0</div>
                        </div>
                    </div>
                </div>

                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Total OSCEs Conducted</h3>
                            <div class="metric-value" id="osceTotalConducted">0</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Assessment Rate</h3>
                            <div class="metric-value" id="osceAssessmentRate">0%</div>
                        </div>
                    </div>
                </div>

                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Skills Evaluated</h3>
                            <div class="metric-value" id="osceSkillsEvaluated">0</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Average Institutional Score</h3>
                            <div class="metric-value" id="osceAverageScore">0% <span id="osceGradeLetter" style="font-size: 0.7em; opacity: 0.8;"></span></div>
                        </div>
                    </div>
                </div>

                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="metric-content">
                            <h3>Pass Rate (â‰¥80%)</h3>
                            <div class="metric-value" id="oscePassRate">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="osceNoDataFound" class="no-data-message">
            <i class="fas fa-chart-bar"></i>
            <h3>No Data Available</h3>
            <p>Please apply filters to view OSCE report data</p>
        </div>
    </div>
</div>


<div id="procedurePanel" class="procedure-panel">
    <div class="panel-overlay"></div>
    <div class="panel-content">
        <div class="panel-header">
            <h3>Procedure Details</h3>
            <button class="close-btn" onclick="closeProcedurePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="panel-body">
            <div class="student-info" style="margin-bottom: 32px;">
                <div class="info-group">
                    <div class="info-item">
                        <label>Candidate Name</label>
                        <div id="panelStudentName" class="info-value">-</div>
                    </div>
                    <div class="info-item">
                        <label>Institute</label>
                        <div id="panelInstitute" class="info-value">-</div>
                    </div>
                </div>
                <div class="info-group">
                    <div class="info-item">
                        <label>Total Score</label>
                        <div id="panelTotalScore" class="info-value">-</div>
                    </div>
                    <div class="info-item">
                        <label>Completed Steps</label>
                        <div id="panelCompletedSteps" class="info-value">-</div>
                    </div>
                </div>
                <div class="info-group">
                    <div class="info-item">
                        <label>Missed Steps</label>
                        <div id="panelMissedSteps" class="info-value">-</div>
                    </div>
                    <div class="info-item">
                        <label>Critical Steps Missed</label>
                        <div id="panelCriticalSteps" class="info-value">-</div>
                    </div>
                </div>
            </div>

            <div class="steps-section">
                <h4>Procedure Steps</h4>
                <div class="steps-table-wrapper">
                    <table class="steps-table">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="procedureStepsBody">
                            <!-- Steps will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .skillscoring {
        font-size: 18px !important;
        color: #64748b !important;
    }

    .skillpercentage {
        font-size: 20px !important;
        color: #1a202c !important;
        padding-top: 10px;
    }


    .reports-container {
        padding: 24px;
        max-width: 1440px;
        margin: 0 auto;
    }

    .reports-header {
        margin-bottom: 32px;
    }

    .reports-header h1 {
        font-size: 28px;
        font-weight: 600;
        color: #1a202c;
        margin: 0 0 8px;
    }

    .subtitle {
        color: #64748b;
        font-size: 14px;
        margin: 0;
    }

    /* Filters Section */
    .filters-section {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 24px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .filter-group {
        display: flex;
        gap: 16px;
        flex: 1;
        flex-wrap: wrap; /* prevent overflow and keep row responsive */
        align-items: center;
    }

    .select-filter {
        padding: 10px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        color: #1a202c;
        font-size: 14px;
        min-width: 200px;
        flex: 1 1 220px; /* allow wrapping with sensible default width */
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .select-filter:hover {
        border-color: #cbd5e0;
    }

    .select-filter:focus {
        border-color: #F16564;
        box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.1);
        outline: none;
    }

    .search-group {
        flex: 1;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        gap: 8px;
    }

    .search-input {
        flex: 1;
        padding: 10px 16px 10px 40px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }

    .search-button {
        padding: 10px 20px;
        background: #F16564;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .search-button:hover {
        background: #e45857;
    }

    /* Table Styles */
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .reports-table {
        width: 100%;
        border-collapse: collapse;
    }

    .reports-table th {
        background: #f8fafc;
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: #1a202c;
        font-size: 14px;
        border-bottom: 2px solid #e2e8f0;
    }

    .reports-table td {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 14px;
    }

    .reports-table tbody tr:hover {
        background: #f8fafc;
    }

    /* Grade Colors */
    .grade-a { background-color: #d4edda; }
    .grade-b { background-color: #e2efda; }
    .grade-c { background-color: #fff3cd; }
    .grade-d { background-color: #ffe5d0; }
    .grade-e { background-color: #f8d7da; }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #64748b;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: #94a3b8;
    }

    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 48px 24px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #F16564;
        border-radius: 50%;
        margin: 0 auto 16px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Load More Button */
    .load-more-container {
        text-align: center;
        margin-top: 24px;
    }

    .load-more-btn {
        padding: 12px 24px;
        background: #F16564;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .load-more-btn:hover {
        background: #e45857;
    }

    /* Details Row */
    .details-row {
        background: #f8fafc;
    }

    .details-content {
        padding: 20px;
    }

    .feedback-table {
        width: 100%;
        margin-top: 12px;
    }

    .feedback-table th {
        background: #f1f5f9;
        text-align: left;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .filters-section {
            flex-direction: column;
        }

        .filter-group {
            flex-direction: column;
        }

        .select-filter {
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        .reports-table {
            display: block;
            overflow-x: auto;
        }
    }

    /* Metrics Section Styles */
    .metrics-section {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        height: auto;
        min-height: auto;
        max-height: none;
    }

    .metrics-cards {
        flex: 3;
        display: flex;
        flex-direction: column;
        gap: 16px;
        height: auto;
    }

    .metrics-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .metric-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 20px;
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1), 0 15px 20px -3px rgba(0, 0, 0, 0.15);
    }

    .procedures-card {
        grid-column: 1 / -1;
    }

    .metric-icon {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(241, 101, 100, 0.1), rgba(241, 101, 100, 0.2));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .metric-icon i {
        font-size: 24px;
        color: #F16564;
    }

    .metric-content {
        flex: 1;
    }

    .metric-content h3 {
        font-size: 15px;
        color: #64748b;
        margin: 0 0 12px;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a202c;
        line-height: 1;
    }

    .procedure-counts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 8px;
    }

    .procedure-count {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(241, 101, 100, 0.05);
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .procedure-count:hover {
        background: rgba(241, 101, 100, 0.1);
    }

    .procedure-name {
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
    }

    .procedure-value {
        font-weight: 600;
        color: #1a202c;
        font-size: 16px;
        background: white;
        padding: 4px 10px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .chart-container {
        flex: 2;
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        min-height: 300px;
        max-height: 400px;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .chart-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .chart-wrapper {
        flex: 1;
        position: relative;
        width: 100%;
        height: 100%;
    }

    

    .institute-container {
        flex: 2;
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .institute-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .institute-container h3 {
        font-size: 16px;
        color: #1a202c;
        margin: 0 0 16px;
        font-weight: 600;
    }

    /* Add custom scrollbar styling */
    .metrics-cards::-webkit-scrollbar {
        width: 8px;
    }

    .metrics-cards::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .metrics-cards::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }

    .metrics-cards::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    /* Update responsive design */
    @media (max-width: 1024px) {
        .metrics-section {
            flex-direction: column;
            max-height: none;
        }

        .metrics-cards {
            max-height: 500px;
        }

        .chart-container {
            height: 400px;
        }
    }

    /* Gender Analysis Section Styles */
    .gender-analysis-section {
        margin: 32px 0;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
    }

    .gender-charts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
    }

    .gender-chart-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        height: 300px;
    }

    .gender-chart-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .gender-chart-card h3 {
        font-size: 16px;
        color: #1a202c;
        margin: 0 0 20px;
        font-weight: 600;
    }

    .chart-wrapper {
        height: calc(100% - 36px);
        width: 100%;
    }

    @media (max-width: 1200px) {
        .gender-charts {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .gender-charts {
            grid-template-columns: 1fr;
        }
        
        .metrics-row {
            grid-template-columns: 1fr;
        }
    }

    /* Skill Analysis Section Styles */
    .skill-analysis-section {
        margin: 32px 0;
    }

    .skill-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .skill-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .skill-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .skill-name {
        font-size: 18px;
        font-weight: 600;
        color: #1a202c;
    }

    .skill-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
        margin-bottom: 24px;
    }

    .skill-metric-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
    }

    .skill-metric-card h4 {
        font-size: 14px;
        color: #64748b;
        margin: 0 0 16px;
    }

    .chart-container-sm {
        height: 200px;
        position: relative;
    }

    .critical-steps-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: #fff7ed;
        border-radius: 12px;
        margin-top: 16px;
    }

    .critical-step-text {
        color: #9a3412;
        font-size: 14px;
        font-weight: 500;
    }

    .critical-step-count {
        background: #fdba74;
        color: #9a3412;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
    }

    @media (max-width: 1024px) {
        .skill-metrics {
            grid-template-columns: 1fr;
        }
    }

    /* Reports Tabs Styles */
    .reports-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 24px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 2px;
    }

    .tab-button {
        padding: 12px 24px;
        border: none;
        background: none;
        font-size: 16px;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .tab-button:hover {
        color: #F16564;
    }

    .tab-button.active {
        color: #F16564;
    }

    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: #F16564;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .student-filters {
        margin-bottom: 24px;
    }

    .filter-group {
        display: flex;
        gap: 16px;
    }

    .student-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 24px;
    }

    .metric-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: flex-start;
        gap: 20px;
        position: relative;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(241, 101, 100, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .metric-icon i {
        font-size: 24px;
        color: #F16564;
    }

    .metric-content {
        flex: 1;
    }

    .metric-content h3 {
        font-size: 14px;
        color: #64748b;
        margin: 0 0 8px;
    }

    .metric-content .metric-value {
        font-size: 24px;
        font-weight: 600;
        color: #1a202c;
    }

    .no-data-message {
        text-align: center;
        padding: 48px;
        color: #64748b;
    }

    .no-data-message i {
        font-size: 48px;
        margin-bottom: 16px;
        color: #94a3b8;
    }

    .no-data-message h3 {
        margin: 0 0 8px;
        color: #1a202c;
    }

    .no-data-message p {
        margin: 0;
    }

    @media (max-width: 768px) {
        .filter-group {
            flex-direction: column;
        }

        .student-metrics {
            grid-template-columns: 1fr;
        }
    }

    /* Score Metrics Styles */
    .score-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-bottom: 32px;
    }

    .score-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        position: relative;
        overflow: hidden;
    }

    .score-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .score-card.highest::before {
        background: linear-gradient(to right, #22c55e, #4ade80);
    }

    .score-card.lowest::before {
        background: linear-gradient(to right, #ef4444, #f87171);
    }

    .score-icon {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .highest .score-icon {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
    }

    .lowest .score-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .score-icon i {
        font-size: 28px;
    }

    .score-content {
        flex: 1;
    }

    .score-content h3 {
        font-size: 16px;
        color: #64748b;
        margin: 0 0 12px;
    }

    .score-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .score-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a202c;
    }

    .student-name {
        font-size: 16px;
        color: black;
        margin-left: 5px;
    }
    .institute-name {
        font-size: 16px;
        color: #64748b;
        margin-left: 5px;
    }

    /* Performance Table Styles */
    .performance-table-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-top: 24px;
    }

    .performance-table-container h3 {
        font-size: 18px;
        color: #1a202c;
        margin: 0 0 20px;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .search-container {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-input {
        padding: 8px 12px 8px 40px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        width: 300px;
        background: #f8fafc;
        transition: all 0.2s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-input:disabled {
        background: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
        border-color: #e2e8f0;
    }

    .search-input:disabled::placeholder {
        color: #94a3b8;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        color: #64748b;
        font-size: 14px;
        pointer-events: none;
    }

    .search-container:has(.search-input:disabled) .search-icon {
        color: #94a3b8;
    }

    .no-search-results-message {
        background: white;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .download-buttons {
        display: flex;
        gap: 8px;
    }

    .download-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .pdf-btn {
        background: #dc3545;
        color: white;
    }

    .pdf-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .excel-btn {
        background: #28a745;
        color: white;
    }

    .excel-btn:hover {
        background: #218838;
        transform: translateY(-1px);
    }

    .download-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .download-btn i {
        font-size: 14px;
    }

    .table-wrapper {
        width: 100%;
        overflow: visible; /* Change from auto/scroll to visible */
    }

    .performance-table {
        width: 100%;
        table-layout: fixed; /* This will help distribute column widths evenly */
    }

    .performance-table th,
    .performance-table td {
        white-space: normal; /* Allow text to wrap */
        padding: 8px;
        word-wrap: break-word; /* Allow long words to break */
    }

    /* Adjust the width of the first two columns */
    .student-col {
        width: 20%; /* Adjust as needed */
    }

    .institute-col {
        width: 25%; /* Adjust as needed */
    }

    /* Remove any sticky positioning if present */
    .sticky-col {
        position: static !important;
    }

    .performance-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #1a202c;
        position: sticky;
        top: 0;
    }

    .performance-table .student-col {
        position: sticky;
        left: 0;
        background: #f8fafc;
        z-index: 10;
        min-width: 200px;
    }

    .performance-table td.student-col {
        background: white;
    }

    .performance-table td {
        color: #4a5568;
    }

    .grade-cell {
        text-align: center;
        padding: 8px;
        border-radius: 4px;
        min-width: 100px;
    }

    .grade-A {
        background-color: #4CAF50;
        color: white;
    }

    .grade-B {
        background-color: #8BC34A;
        color: white;
    }

    .grade-C {
        background-color: #FFC107;
        color: white;
    }

    .grade-D {  
        background-color: #FF9800;
        color: white;
    }

    .grade-E {
        background-color: #F44336;
        color: white;
    }

    .percentage {
        font-size: 0.8em;
        opacity: 0.8;
        display: block;
        margin-top: 2px;
    }

    /* Sticky Column Styles */
    .table-wrapper {
        overflow-x: auto;
        position: relative;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 1;
        border-right: 2px solid #dee2e6;
    }

    .student-col {
        min-width: 200px;
        z-index: 2;
    }

    .institute-col {
        min-width: 150px;
        left: 200px;
        z-index: 2;
    }

    /* Procedure Panel Styles */
    .procedure-panel {
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1000;
        font-family: 'PT Sans', sans-serif;
    }

    .panel-overlay {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(26, 32, 44, 0.6);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .panel-content {
        position: absolute;
        top: 0;
        right: -40%;
        bottom: 0;
        width: 40%;
        background-color: #f8fafc;
        box-shadow: -4px 0 25px rgba(0, 0, 0, 0.15);
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .procedure-panel.active {
        display: block;
    }

    .procedure-panel.active .panel-overlay {
        opacity: 1;
    }

    .procedure-panel.active .panel-content {
        right: 0;
    }

    .panel-header {
        padding: 24px 32px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        position: relative;
        overflow: hidden;
    }

    .panel-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #1a202c;
        font-weight: 600;
    }

    .close-btn {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 1.2rem;
    }

    .close-btn:hover {
        background-color: #f1f5f9;
        color: #F16564;
    }

    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
    }

    .student-info {
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }

    .info-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-bottom: 24px;
    }

    .info-group:last-child {
        margin-bottom: 0;
    }

    .info-item {
        background-color: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .info-item:hover {
        background-color: #f1f5f9;
        border-color: #cbd5e0;
    }

    .info-item label {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 8px;
        display: block;
        font-weight: 500;
    }

    .info-value {
        font-size: 1.25rem;
        color: #1a202c;
        font-weight: 600;
    }

    .steps-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .steps-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .steps-section h4 {
        margin: 0 0 24px 0;
        color: #1a202c;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .steps-table-wrapper {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
    }

    .steps-table {
        width: 100%;
        border-collapse: collapse;
    }

    .steps-table th,
    .steps-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    .steps-table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #1a202c;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .steps-table td {
        color: #4a5568;
        font-size: 0.9375rem;
    }

    .steps-table td:first-child {
        color: #64748b;
        font-weight: 500;
        width: 80px;
    }

    .steps-table tbody tr:hover {
        background-color: #f8fafc;
    }

    .steps-table tbody tr:last-child td {
        border-bottom: none;
    }

    .step-status {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: capitalize;
    }

    .status-completed {
        background-color: rgb(34 197 94 / 37%);
        color: #15803d;
    }

    .status-missed {
        background-color: rgb(239 68 68 / 34%);
        color: #dc2626;
    }

    .status-critical {
        background-color: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    /* Add some visual enhancement icons */
    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(241, 101, 100, 0.1), rgba(241, 101, 100, 0.2));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-bottom: 16px;
    }

    .metric-icon i {
        font-size: 20px;
        color: #F16564;
    }

    @media (max-width: 1200px) {
        .panel-content {
            width: 50%;
            right: -50%;
        }
        
        .info-group {
            grid-template-columns: 1fr;
            gap: 16px;
        }
    }

    @media (max-width: 768px) {
        .panel-content {
            width: 100%;
            right: -100%;
        }
        
        .panel-header {
            padding: 20px;
        }
        
        .panel-body {
            padding: 20px;
        }
        
        .student-info,
        .steps-section {
            padding: 20px;
        }
    }

    /* Feedback Section Styles */
    .feedback-container {
        padding: 4px 16px;
        background: #f8fafc;
        border-radius: 8px;
        margin: 4px 0;
    }

    .feedback-header {
        display: flex;
        align-items: center;
        gap: 2px;
        margin-bottom: 4px;
    }

    .feedback-icon {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .feedback-header h4 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: #1a202c;
    }

    .feedback-card {
        background: white;
        border-radius: 8px;
        padding: 6px 10px;
        margin-bottom: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border-left: 3px solid;
        position: relative;
        overflow: hidden;
    }

    .feedback-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 3px;
        opacity: 0.1;
    }

    .feedback-excellent {
        border-left-color: #22c55e;
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
    }

    .feedback-excellent::before {
        background: #22c55e;
    }

    .feedback-excellent .feedback-icon {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
    }

    .feedback-good {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
    }

    .feedback-good::before {
        background: #3b82f6;
    }

    .feedback-good .feedback-icon {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .feedback-needs-improvement {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
    }

    .feedback-needs-improvement::before {
        background: #f59e0b;
    }

    .feedback-needs-improvement .feedback-icon {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .feedback-poor {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
    }

    .feedback-poor::before {
        background: #ef4444;
    }

    .feedback-poor .feedback-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .feedback-message {
        font-size: 0.85rem;
        color: #4a5568;
        line-height: 1.3;
        margin-bottom: 3px;
    }

    .critical-points {
        background: white;
        border-radius: 8px;
        padding: 6px 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border-left: 3px solid #F16564;
        position: relative;
        overflow: hidden;
    }

    .critical-points::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 3px;
        background: #F16564;
        opacity: 0.1;
    }

    .critical-points-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
    }

    .critical-points-header .icon {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        background: rgba(241, 101, 100, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #F16564;
        font-size: 10px;
    }

    .critical-points-header h5 {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: #1a202c;
    }

    .critical-points ul {
        margin: 0;
        padding-left: 0;
        list-style: none;
    }

    .critical-points li {
        position: relative;
        padding: 2px 0 2px 16px;
        color: #4a5568;
        font-size: 0.75rem;
        line-height: 1.2;
        border-bottom: 1px solid #f8fafc;
    }

    .critical-points li:last-child {
        border-bottom: none;
    }

    .critical-points li::before {
        content: 'âš ';
        position: absolute;
        left: 0;
        top: 2px;
        color: #F16564;
        font-size: 8px;
        font-weight: bold;
    }

    /* Performance Badge */
    .performance-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 500;
        margin-bottom: 2px;
    }

    .performance-excellent {
        background: rgba(34, 197, 94, 0.1);
        color: #15803d;
    }

    .performance-good {
        background: rgba(59, 130, 246, 0.1);
        color: #1d4ed8;
    }

    .performance-needs-improvement {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .performance-poor {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }

    /* Add after existing styles */
    .scrollable-missed-steps {
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #f1f1f1;
        border-radius: 8px;
        background: #fafbfc;
        padding: 4px 8px;
    }
    .critical-step-count {
        background: #fdba74;
        color: #9a3412;
        padding: 2px 10px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.95em;
    }

    .load-more-container {
    text-align: center;
    margin-top: 24px;
    }

    .load-more-btn {
        padding: 12px 24px;
        background: #F16564;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .load-more-btn:hover {
        background: #e45857;
    }

    /* Add to your existing CSS */
    .station-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .station-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    .station-item:last-child {
        border-bottom: none;
    }

    .table-responsive {
        margin-top: 20px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        background: #f8fafc;
        padding: 12px 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #4a5568;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .table td {
        padding: 16px;
        border-top: 1px solid #e2e8f0;
        font-size: 16px !important;
    }

    .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        margin-top: 24px;
    }

    .table th, .table td {
        vertical-align: middle;
        text-align: left;
        font-size: 12px;
        padding: 12px 8px;
        max-width: 150px;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .table tr td:first-child {
        font-weight: 500;
        background: #fafafa;
    }

    .performance-table {
        border-collapse: collapse;
    }

    .performance-table td,
    .performance-table th {
        padding: 8px 16px;
        border: none;
    }
</style>

<script>
    let offset = 0;
    const limit = 10;
    let hasMoreData = true;
    let loadedExamIds = new Set();
    let selectedInstitute = '';
    let selectedSkillathon = '';
    let selectedStudentSkillathon = '';
    let selectedStudentInstitute = '';
    let allStudentData = []; // Store all student data for searching
    let isSearchActive = false; // Track if search is currently active
    let savedSearchValue = ''; // Store search value when switching tabs
    let gradeChart = null;
    let genderTotalChart = null;
    let maleGradeChart = null;
    let femaleGradeChart = null;
    let othersGradeChart = null;
    let overallGradeChart = null;
    let fetchMetricsInterval = null;
    let fetchStudentMetricsInterval = null;

    let studentOffset = 0;
    const studentLimit = 3;
    let studentHasMore = true;
    let currentSkillathonId = '';
    let currentInstituteId = '';
    let sortingInPlace = false;

    function showLoading() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('loadMoreBtn').style.display = 'none';
    }

    function hideEmptyState() {
        document.getElementById('emptyState').style.display = 'none';
    }

    function fetchInstitutes() {
        fetch('/fetch-institutes/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('instituteFilter');
                data.institutes.forEach(institute => {
                    const option = document.createElement('option');
                    option.value = institute.id;
                    option.textContent = institute.instituteName;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching institutes:', error);
                // Show error toast or notification here
            });
    }

    function updateInstituteTable(data) {
        const tableBody = document.getElementById('instituteTableBody');
        const headerRow = document.getElementById('stationTableHeader');
        tableBody.innerHTML = '';
        headerRow.innerHTML = '';

        // 1. Collect all unique station names
        const allStations = new Set();
        data.institute_table.forEach(inst => {
            Object.keys(inst.stations).forEach(station => allStations.add(station));
        });
        const stationList = Array.from(allStations);

        // 2. Render table header
        headerRow.innerHTML = `
            <th>Institute</th>
            <th>Overall</th>
            ${stationList.map(station => `<th>${station}</th>`).join('')}
        `;

        // 3. Render table body
        data.institute_table.forEach(inst => {
            const row = document.createElement('tr');
            // Institute name
            row.innerHTML = `
                <td>${inst.institute}</td>
                <td>
                    <div>Candidates: ${inst.overall.students}</div>
                    <div>Avg: ${inst.overall.avg_score}%</div>
                </td>
                ${stationList.map(station => 
                    inst.stations[station] 
                        ? `<td>
                            <div>Candidates: ${inst.stations[station].students}</div>
                            <div>Avg: ${inst.stations[station].avg_score}%</div>
                          </td>`
                        : `<td>-</td>`
                ).join('')}
            `;
            tableBody.appendChild(row);
        });
    }

    

    function handleInstituteChange() {
        selectedInstitute = document.getElementById('instituteFilter').value;
        fetchMetrics();  // Fetch new metrics immediately
        // fetchExamReports(true);  // Reset and fetch new reports
    }

    function handleSkillathonChange() {
        selectedSkillathon = document.getElementById('skillathonFilter').value;
        fetchMetrics();  // Fetch new metrics immediately
        // fetchExamReports(true);  // Reset and fetch new reports
    }

    function calculateGrade(percentage) {
        if (percentage >= 90) return { grade: 'A', class: 'grade-a' };
        if (percentage >= 80) return { grade: 'B', class: 'grade-b' };
        if (percentage >= 70) return { grade: 'C', class: 'grade-c' };
        if (percentage >= 60) return { grade: 'D', class: 'grade-d' };
        return { grade: 'E', class: 'grade-e' };
    }

    function toggleDetails(exam_id) {
        let row = document.getElementById("details-" + exam_id);
        let icon = document.getElementById("icon-" + exam_id);
        
        if (row.style.display === "none") {
            row.style.display = "table-row";
            icon.classList.replace("fa-chevron-down", "fa-chevron-up");
        } else {
            row.style.display = "none";
            icon.classList.replace("fa-chevron-up", "fa-chevron-down");
        }
    }

    function generateFeedback(criticalMissed, critical_points) {
        let feedbackType, message, icon, performanceLevel;
        
        if (criticalMissed === 0) {
            feedbackType = 'excellent';
            message = 'Excellent job! You have successfully completed this station.';
            icon = 'ðŸ†';
            performanceLevel = 'Excellent';
        } else if (criticalMissed === 1) {
            feedbackType = 'good';
            message = 'Good effort, but you missed a critical step.';
            icon = 'ðŸ‘';
            performanceLevel = 'Good';
        } else if (criticalMissed === 2) {
            feedbackType = 'needs-improvement';
            message = 'You have demonstrated basic understanding, but need improvement.';
            icon = 'ðŸ“ˆ';
            performanceLevel = 'Needs Improvement';
        } else {
            feedbackType = 'poor';
            message = 'Need significant improvement. Review thoroughly.';
            icon = 'ðŸ“š';
            performanceLevel = 'Needs Significant Improvement';
        }

        let html_feedback = `
            <div class="feedback-container">
                <div class="feedback-header">
                    <div class="feedback-icon feedback-${feedbackType}">
                        ${icon}
                    </div>
                    <h4>Performance Feedback</h4>
                </div>
                
                <div class="feedback-card feedback-${feedbackType}">
                    <div class="performance-badge performance-${feedbackType}">
                        <span>Performance Level: ${performanceLevel}</span>
                    </div>
                    <div class="feedback-message">${message}</div>
                </div>`;
        
        if (critical_points && critical_points.length > 0) {
            html_feedback += `
                <div class="critical-points">
                    <div class="critical-points-header">
                        <div class="icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h5>Critical Points Missed:</h5>
                    </div>
                    <ul>
                        ${critical_points.map(point => `<li>${point}</li>`).join('')}
                    </ul>
                </div>`;
        }

        html_feedback += `</div>`;
        return html_feedback;
    }

    function initializeOverallGradeChart() {
        const ctx = document.getElementById('gradeChart').getContext('2d');
        overallGradeChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['A (>= 90%)', 'B (>= 80%)', 'C (>= 70%)', 'D (>= 60%)', 'E (< 60%)'],
                datasets: [{
                    data: [0,0,0,0,0],
                    backgroundColor: [
                        '#4CAF50', // Green for A
                        '#8BC34A', // Light Green for B
                        '#FFC107', // Yellow for C
                        '#FF9800', // Orange for D
                        '#F44336'  // Red for E
                    ],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `Grade ${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateOverallGradeChart(metrics) {
        if (overallGradeChart) {
            overallGradeChart.data.datasets[0].data = [
                metrics.grade_distribution.A,
                metrics.grade_distribution.B,
                metrics.grade_distribution.C,
                metrics.grade_distribution.D,
                metrics.grade_distribution.E
            ];
            overallGradeChart.update();
        }
    }

    function initializeGenderCharts() {
        // Initialize Total Gender Distribution Chart
        const totalCtx = document.getElementById('genderTotalChart').getContext('2d');
        genderTotalChart = new Chart(totalCtx, {
            type: 'pie',
            data: {
                labels: ['Male', 'Female', 'Others'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        '#4299E1', // Blue for Male
                        '#F687B3', // Pink for Female
                        '#9F7AEA'  // Purple for Others
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        // Initialize Male Grade Distribution Chart
        maleGradeChart = createGradeChart('maleGradeChart', '#4299E1');

        // Initialize Female Grade Distribution Chart
        femaleGradeChart = createGradeChart('femaleGradeChart', '#F687B3');

        // Initialize Others Grade Distribution Chart
        othersGradeChart = createGradeChart('othersGradeChart', '#9F7AEA');
    }

    function createGradeChart(elementId, color) {
        const ctx = document.getElementById(elementId).getContext('2d');
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A', 'B', 'C', 'D', 'E'],
                datasets: [{
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: color,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Candidates: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function updateGenderCharts(metrics) {
        // Update Total Gender Distribution
        if (genderTotalChart) {
            genderTotalChart.data.datasets[0].data = [
                metrics.gender_metrics.total.male,
                metrics.gender_metrics.total.female,
                metrics.gender_metrics.total.others
            ];
            genderTotalChart.update();
        }

        // Update Male Grade Distribution
        if (maleGradeChart) {
            const maleData = ['A', 'B', 'C', 'D', 'E'].map(grade => 
                metrics.gender_metrics.grade_wise[grade].male
            );
            maleGradeChart.data.datasets[0].data = maleData;
            maleGradeChart.update();
        }

        // Update Female Grade Distribution
        if (femaleGradeChart) {
            const femaleData = ['A', 'B', 'C', 'D', 'E'].map(grade => 
                metrics.gender_metrics.grade_wise[grade].female
            );
            femaleGradeChart.data.datasets[0].data = femaleData;
            femaleGradeChart.update();
        }

        // Update Others Grade Distribution
        if (othersGradeChart) {
            const othersData = ['A', 'B', 'C', 'D', 'E'].map(grade => 
                metrics.gender_metrics.grade_wise[grade].others
            );
            othersGradeChart.data.datasets[0].data = othersData;
            othersGradeChart.update();
        }
    }

    function sanitizeId(name) {
        if (!name) return 'unknown';
        return name.toString()
            .replace(/\s+/g, '_')
            .replace(/[^a-zA-Z0-9_]/g, '')
            .toLowerCase();
    }

    function updateSkillWiseAnalysis(metrics) {
        if (!metrics || !metrics.skill_wise_metrics) {
            console.warn('No skill metrics data available');
            return;
        }

        const container = document.getElementById('skillAnalysisContainer');
        if (!container) {
            console.error('Skill analysis container not found');
            return;
        }

        container.innerHTML = ''; // Clear existing content

        // Debug log the metrics data
        // console.log('Skill metrics data:', metrics.skill_wise_metrics);

        // For each procedure/skill in the metrics
        Object.entries(metrics.skill_wise_metrics || {}).forEach(([skillName, skillData]) => {
            if (!skillName) return;
            if (!skillData) return;
            const safeSkillName = sanitizeId(skillName);
            const skillCard = document.createElement('div');
            skillCard.className = 'skill-card';

            // Create skill header
            const header = document.createElement('div');
            header.className = 'skill-header';
            header.innerHTML = `<h3 class="skill-name">${skillName}</h3>`;
            skillCard.appendChild(header);

            // Create metrics grid
            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'skill-metrics';

            // Grade Distribution Chart
            const gradeChartId = `gradeChart_${safeSkillName}`;
            const gradeChartCard = document.createElement('div');
            gradeChartCard.className = 'skill-metric-card';
            gradeChartCard.innerHTML = `
                <h4>Grade Distribution</h4>
                <div class="chart-container-sm">
                    <canvas id="${gradeChartId}"></canvas>
                </div>
            `;
            metricsGrid.appendChild(gradeChartCard);

            // Critical Steps Chart
            const criticalChartId = `criticalChart_${safeSkillName}`;
            const criticalChartCard = document.createElement('div');
            criticalChartCard.className = 'skill-metric-card';
            criticalChartCard.innerHTML = `
                <h4>Critical Steps Performance</h4>
                <div class="chart-container-sm">
                    <canvas id="${criticalChartId}"></canvas>
                </div>
            `;
            metricsGrid.appendChild(criticalChartCard);

            // All Missed Critical Steps (scrollable)
            const allMissedCard = document.createElement('div');
            allMissedCard.className = 'skill-metric-card';
            allMissedCard.innerHTML = `
                <h4>All Missed Critical Steps</h4>
                <div class="missed-steps-list scrollable-missed-steps" style="max-height: 200px; overflow-y: auto;">
                    ${skillData.common_missed_steps && Object.keys(skillData.common_missed_steps).length > 0
                        ? `<ul style='margin:0;padding-left:0;'>${Object.entries(skillData.common_missed_steps)
                            .sort((a, b) => b[1] - a[1])
                            .map(([step, count]) =>
                                `<li style='display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #f1f1f1; font-size: 12px;'><span>${step}</span><span class='critical-step-count'>${count} times</span></li>`
                            ).join('')}</ul>`
                        : `<div style='color:#888;'>No missed critical steps</div>`}
                </div>
            `;
            metricsGrid.appendChild(allMissedCard);

            skillCard.appendChild(metricsGrid);
            container.appendChild(skillCard);

            // Verify canvas elements exist before initializing charts
            const gradeCanvas = document.getElementById(gradeChartId);
            const criticalCanvas = document.getElementById(criticalChartId);

            if (!gradeCanvas) {
                console.error(`Grade chart canvas not found: ${gradeChartId}`);
                return;
            }
            if (!criticalCanvas) {
                console.error(`Critical chart canvas not found: ${criticalChartId}`);
                return;
            }
            try {
                initializeGradeChart(gradeChartId, skillData.grade_distribution || {});
                initializeCriticalChart(criticalChartId, skillData.critical_steps || {});
            } catch (error) {
                console.error(`Error initializing charts for ${skillName}:`, error);
            }
        });
    }

    function initializeGradeChart(chartId, gradeData) {
        try {
            // console.log('Initializing grade chart:', { chartId, gradeData });

            const canvas = document.getElementById(chartId);
            if (!canvas) {
                console.error(`Canvas not found for grade chart: ${chartId}`);
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Could not get context for grade chart: ${chartId}`);
                return;
            }

            const data = {
                A: gradeData?.A || 0,
                B: gradeData?.B || 0,
                C: gradeData?.C || 0,
                D: gradeData?.D || 0,
                E: gradeData?.E || 0
            };

            new Chart(ctx, {
                type: 'pie', // Changed from 'bar' to 'pie'
                data: {
                    labels: ['A', 'B', 'C', 'D', 'E'],
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#4CAF50',
                            '#8BC34A',
                            '#FFC107',
                            '#FF9800',
                            '#F44336'
                        ],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `Grade ${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error(`Error creating grade chart for ${chartId}:`, error);
        }
    }

    function initializeCriticalChart(chartId, criticalData) {
        try {
            console.log('Initializing critical chart:', { chartId, criticalData });

            const canvas = document.getElementById(chartId);
            if (!canvas) {
                console.error(`Canvas not found for critical chart: ${chartId}`);
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Could not get context for critical chart: ${chartId}`);
                return;
            }

            const data = {
                completed_all: criticalData?.completed_all || 0,
                missed_one: criticalData?.missed_one || 0,
                missed_multiple: criticalData?.missed_multiple || 0
            };

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed All', 'Missed One', 'Missed Multiple'],
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#4CAF50',
                            '#FFC107',
                            '#F44336'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error(`Error creating critical chart for ${chartId}:`, error);
        }
    }

    function updateMetricsDisplay(metrics) {
        if (!metrics) {
            console.error('No metrics data available');
            return;
        }

        // Update basic metrics
        document.getElementById('totalStudents').textContent = metrics.total_students || 0;
        document.getElementById('completedAllProcedures').textContent = metrics.completed_all_procedures || 0;
        document.getElementById('highestScoringSkill').textContent = metrics.top_performing_skill?.name || '-';
        document.getElementById('lowestScoringSkill').textContent = metrics.lowest_performing_skill?.name || '-';
        document.getElementById('highestScoringSkillPercentage').textContent = metrics.top_performing_skill?.average_score + "%" || 0;
        document.getElementById('lowestScoringSkillPercentage').textContent = metrics.lowest_performing_skill?.average_score + "%" || 0;
        
        // Update procedure counts
        const procedureCountsDiv = document.getElementById('procedureCounts');
        if (procedureCountsDiv) {
            procedureCountsDiv.innerHTML = '';
            Object.entries(metrics.procedure_counts || {}).forEach(([procedure, count]) => {
                procedureCountsDiv.innerHTML += `
                    <div class="procedure-count">
                        <span class="procedure-name">${procedure}:</span>
                        <span class="procedure-value">${count}</span>
                    </div>
                `;
            });
        }

        // Update grade chart
        if (gradeChart) {
            const gradeData = {
                A: metrics.grade_distribution?.A || 0,
                B: metrics.grade_distribution?.B || 0,
                C: metrics.grade_distribution?.C || 0,
                D: metrics.grade_distribution?.D || 0,
                E: metrics.grade_distribution?.E || 0
            };
            
            gradeChart.data.datasets[0].data = Object.values(gradeData);
            gradeChart.update();
        }
        
        // Update gender charts
        updateGenderCharts(metrics);
        updateSkillWiseAnalysis(metrics);
        updateOverallGradeChart(metrics);
    }

    function fetchMetrics() {
        const skillathonName = document.getElementById('skillathonFilter').value;
        const instituteName = document.getElementById('instituteFilter').value;
        if (!skillathonName) return;
        let url = `/fetch-exam-metrics/?skillathon_name=${encodeURIComponent(skillathonName)}`;
        if (instituteName) url += `&institution_name=${encodeURIComponent(instituteName)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    updateMetricsDisplay(data);
                    updateInstituteTable(data);
                }
            });
    }

    

    function fetchStudentMetrics() {
        const skillathonName = document.getElementById('studentSkillathonFilter').value;
        const instituteName = document.getElementById('studentInstituteFilter').value;

        if (!skillathonName) {
            return;
        }

        let url = `/fetch-student-metrics/?skillathon_name=${encodeURIComponent(skillathonName)}`;

        if (instituteName) {
            url += `&institution_name=${encodeURIComponent(instituteName)}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const studentMetrics = document.getElementById('studentMetrics');
                const noDataFound = document.getElementById('noDataFound');
                
                if (data.students && data.students.length > 0) {
                    if (studentMetrics) studentMetrics.style.display = 'block';
                    if (noDataFound) noDataFound.style.display = 'none';
                    
                    updateScoreCards(data);
                    
                    updateStudentTable(data);

                    const table = document.getElementById('studentDetailsTable');
                    const headers = table.querySelectorAll('th');
                    let sortOrder = {}; // track ascending/descending per column

                    headers.forEach((header, index) => {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', () => {
                        sortingInPlace = true;
                        const tbody = table.querySelector('tbody');
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        console.log(rows);

                        // toggle sorting order for this column
                        sortOrder[index] = !sortOrder[index];
                        const ascending = sortOrder[index];

                        rows.sort((a, b) => {
                            let A = a.children[index].textContent.trim();
                            let B = b.children[index].textContent.trim();

                            // Always push "-" to the end regardless of sort direction
                            if (A === "-" && B === "-") return 0;
                            if (A === "-") return 1;  // A is "-", move it to the end
                            if (B === "-") return -1; // B is "-", move it to the end

                            // Extract percentage values if they exist
                            const percentageA = A.match(/(\d+(\.\d+)?)%/);
                            const percentageB = B.match(/(\d+(\.\d+)?)%/);

                            // Extract grade and percentage if in format "E (24%)"
                            const gradePercentA = A.match(/[A-E]\s*\((\d+(\.\d+)?)%\)/);
                            const gradePercentB = B.match(/[A-E]\s*\((\d+(\.\d+)?)%\)/);

                            if (percentageA || gradePercentA) {
                                const valueA = parseFloat(percentageA?.[1] || gradePercentA?.[1]) || 0;
                                const valueB = parseFloat(percentageB?.[1] || gradePercentB?.[1]) || 0;
                                return ascending ? valueA - valueB : valueB - valueA;
                            }

                            // Default to string comparison for non-percentage values
                            return ascending ? A.localeCompare(B) : B.localeCompare(A);
                        });

                        // Re-append sorted rows
                        rows.forEach(row => tbody.appendChild(row));
                    });
                    });


                } else {
                    if (studentMetrics) studentMetrics.style.display = 'none';
                    if (noDataFound) noDataFound.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching student metrics:', error);
                clearStudentMetrics();
            });
    }

    function clearFetchMetricsInterval() {
        if (fetchMetricsInterval) {
            clearInterval(fetchMetricsInterval);
            fetchMetricsInterval = null;
        }
    }

    function clearFetchStudentMetricsInterval() {
        if (fetchStudentMetricsInterval) {
            clearInterval(fetchStudentMetricsInterval);
            fetchStudentMetricsInterval = null;
        }
    }

    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // Show selected tab content
        const selectedTab = document.getElementById(`${tabName}-tab`);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        
        // Activate selected tab button
        if (event && event.target) {
            event.target.classList.add('active');
        }

        // Handle intervals
        if (tabName === 'overall') {
            clearFetchStudentMetricsInterval();
            clearFetchMetricsInterval();
            // Only start fetchMetrics if Go was pressed
            
            // Save current search value and disable search input for overall tab
            const searchInput = document.getElementById('studentSearchInput');
            if (searchInput) {
                savedSearchValue = searchInput.value; // Save current search value
                searchInput.disabled = true;
                searchInput.placeholder = 'Search only available in Student Report';
            }
            isSearchActive = false;
        } else if (tabName === 'student') {
            clearFetchMetricsInterval();
            clearFetchStudentMetricsInterval();
            // Only start fetchStudentMetrics if Go is pressed in student tab
        } else if (tabName === 'osce') {
            clearFetchMetricsInterval();
            clearFetchStudentMetricsInterval();
            // Load OSCE data when tab is opened
            loadOsceReportData();
        }

        // Reset student report when switching to it
        if (tabName === 'student') {
            const studentSkillathonFilter = document.getElementById('studentSkillathonFilter');
            const studentDetails = document.getElementById('studentDetails');
            const noDataFound = document.getElementById('noDataFound');
            
            if (studentSkillathonFilter) studentSkillathonFilter.value = '';
            if (studentDetails) studentDetails.style.display = 'none';
            if (noDataFound) noDataFound.style.display = 'block';
            
            // Reset institute filter for student report
            const studentInstituteFilter = document.getElementById('studentInstituteFilter');
            if (studentInstituteFilter) {
                studentInstituteFilter.innerHTML = '<option value="">All Institutes</option>';
                studentInstituteFilter.disabled = true;
            }
            
            // Restore search input and apply saved search value
            const searchInput = document.getElementById('studentSearchInput');
            if (searchInput) {
                searchInput.disabled = false;
                searchInput.placeholder = 'Search candidates by name...';
                searchInput.value = savedSearchValue; // Restore saved search value
                
                // Apply the search if there was a saved value
                if (savedSearchValue) {
                    searchStudents(savedSearchValue);
                }
            }
            isSearchActive = savedSearchValue !== '';
        }
    }

    function initializeInstituteCharts() {
        // Performance Trend Chart
        const trendCtx = document.getElementById('performanceTrendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Average Score',
                    data: [65, 70, 75, 72, 78, 80],
                    borderColor: '#F16564',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // Skill Performance Chart
        const skillCtx = document.getElementById('skillPerformanceChart').getContext('2d');
        new Chart(skillCtx, {
            type: 'radar',
            data: {
                labels: ['Communication', 'Technical', 'Practical', 'Theory', 'Overall'],
                datasets: [{
                    label: 'Performance',
                    data: [85, 75, 80, 70, 78],
                    backgroundColor: 'rgba(241, 101, 100, 0.2)',
                    borderColor: '#F16564',
                    pointBackgroundColor: '#F16564'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    function handleInstituteReportChange() {
        const instituteId = document.getElementById('instituteFilterReport').value;
        const year = document.getElementById('yearFilter').value;
        
        if (instituteId && year) {
            fetchInstituteMetrics(instituteId, year);
        }
    }

    function fetchInstituteMetrics(instituteId, year) {
        // This is a placeholder for the actual API call
        // You'll need to implement the backend endpoint
        fetch(`/fetch-institute-metrics/?institute_id=${instituteId}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                updateInstituteMetrics(data);
            })
            .catch(error => {
                console.error("Error fetching institute metrics:", error);
            });
    }

    function updateInstituteMetrics(data) {
        // Update summary statistics
        document.getElementById('instituteTotalStudents').textContent = data.total_students || 0;
        document.getElementById('instituteAvgScore').textContent = `${data.average_score || 0}%`;
        document.getElementById('institutePassRate').textContent = `${data.pass_rate || 0}%`;
        
        // Update charts
        // This would be implemented based on your actual data structure
    }

    // Call this to load the first batch (e.g. on filter change)

    // Helper to append student rows (reuse your updateStudentTable logic, but append instead of replace)
    function appendStudentRows(data) {
        const tableBody = document.getElementById('performanceTableBody');
        data.students.forEach(student => {
            const row = document.createElement('tr');
            // ... (same as your updateStudentTable logic for each row)
            // Add student name
            const nameCell = document.createElement('td');
            nameCell.className = 'student-col sticky-col';
            nameCell.textContent = student.name;
            row.appendChild(nameCell);
            // Add institute
            const instituteCell = document.createElement('td');
            instituteCell.className = 'institute-col sticky-col';
            instituteCell.textContent = student.institute;
            row.appendChild(instituteCell);
            // Add grades for each procedure
            data.procedures.forEach(procedure => {
                const cell = document.createElement('td');
                const grade = student.grades[procedure];
                const missedSteps = (student.missed_critical_steps && student.missed_critical_steps[procedure]) || [];
                if (grade) {
                    cell.textContent = `${grade.grade} (${grade.percentage}%)`;
                    cell.className = getGradeClass(grade.grade);
                    if (missedSteps.length > 0) {
                        const warnIcon = document.createElement('span');
                        warnIcon.textContent = ' âš ';
                        warnIcon.style.color = '#F16564';
                        warnIcon.style.cursor = 'pointer';
                        warnIcon.title = `Missed Critical Steps: \n${missedSteps.join('\n')}`;
                        cell.appendChild(warnIcon);
                    }
                    cell.style.cursor = 'pointer';
                    cell.dataset.student = JSON.stringify({
                        name: student.name,
                        institute: student.institute,
                        procedure: procedure,
                        grade: grade,
                        examData: student.exam_data || {}
                    });
                    cell.onclick = () => openProcedurePanel(
                        student.name,
                        student.institute,
                        procedure,
                        grade,
                        (student.exam_data && student.exam_data[procedure]) ? student.exam_data[procedure] : []
                    );
                } else {
                    cell.textContent = '-';
                }
                row.appendChild(cell);
            });
            tableBody.appendChild(row);
        });
    }

    function clearStudentMetrics() {
        const studentMetrics = document.getElementById('studentMetrics');
        const noDataFound = document.getElementById('noDataFound');
        const headerRow = document.getElementById('performanceTableHead');
        const tableBody = document.getElementById('performanceTableBody');

        // Clear search input and reset search state
        const searchInput = document.getElementById('studentSearchInput');
        if (searchInput) {
            searchInput.value = '';
        }
        isSearchActive = false;
        savedSearchValue = ''; // Clear saved search value

        // Safely toggle display of main sections
        if (studentMetrics) studentMetrics.style.display = 'none';
        if (noDataFound) noDataFound.style.display = 'block';
        
        // Safely clear score cards
        const elements = [
            'highestScore', 'highestScoreStudent', 'highestScoreInstitute',
            'lowestScore', 'lowestScoreStudent', 'lowestScoreInstitute'
        ];
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = '-';
        });
        
        // Safely clear table
        if (headerRow) {
            while (headerRow.children.length > 2) {
                headerRow.removeChild(headerRow.lastChild);
            }
        }
        if (tableBody) tableBody.innerHTML = '';
    }

    function updateScoreCards(data) {
        console.log(data)
        document.getElementById('highestScore').textContent = `${data.highest_score}%`;
        document.getElementById('highestScoreStudent').textContent = data.highest_score_student;
        document.getElementById('highestScoreInstitute').textContent = data.highest_score_institute;

        document.getElementById('lowestScore').textContent = `${data.lowest_score}%`;
        document.getElementById('lowestScoreStudent').textContent = data.lowest_score_student;
        document.getElementById('lowestScoreInstitute').textContent = data.lowest_score_institute;
    }

    function updateStudentTable(data) {
        const headerRow = document.getElementById('performanceTableHead')?.querySelector('tr');
        const tableBody = document.getElementById('performanceTableBody');

        if (!headerRow || !tableBody) {
            console.error('Table elements not found');
            return;
        }
        
        // Check if search is active - if so, don't update the table
        if (isSearchActive) {
            console.log('Search is active, skipping table update to preserve search results');
            return;
        }
                
        // Clear existing content
        while (headerRow.children.length > 2) {
            headerRow.removeChild(headerRow.lastChild);
        }

        // Add procedure columns to header
        if (data.procedures && data.procedures.length > 0) {
            data.procedures.forEach(procedure => {
                const th = document.createElement('th');
                th.textContent = procedure;
                headerRow.appendChild(th);
            });
        }

        // Clear and populate table body
        tableBody.innerHTML = '';
        data.students.forEach(student => {
            const row = document.createElement('tr');
            // Add student name
            const nameCell = document.createElement('td');
            nameCell.className = 'student-col sticky-col';
            nameCell.textContent = student.name;
            row.appendChild(nameCell);
            // Add institute
            const instituteCell = document.createElement('td');
            instituteCell.className = 'institute-col sticky-col';
            instituteCell.textContent = student.institute;
            row.appendChild(instituteCell);
            // Add grades for each procedure
            data.procedures.forEach(procedure => {
                const cell = document.createElement('td');
                const grade = student.grades[procedure];
                const missedSteps = (student.missed_critical_steps && student.missed_critical_steps[procedure]) || [];
                if (grade) {
                    cell.textContent = `${grade.grade} (${grade.percentage}%)`;
                    cell.className = getGradeClass(grade.grade);
                    // Add missed critical steps indicator if any
                    if (missedSteps.length > 0) {
                        const warnIcon = document.createElement('span');
                        warnIcon.textContent = ' âš ';
                        warnIcon.style.color = '#F16564';
                        warnIcon.style.cursor = 'pointer';
                        warnIcon.title = `Missed Critical Steps: \n${missedSteps.join('\n')}`;
                        cell.appendChild(warnIcon);
                    }
                    // Add click handler and cursor style
                    cell.style.cursor = 'pointer';
                    cell.dataset.student = JSON.stringify({
                        name: student.name,
                        institute: student.institute,
                        procedure: procedure,
                        grade: grade,
                        examData: student.exam_data || {}
                    });
                    cell.onclick = () => openProcedurePanel(
                        student.name,
                        student.institute,
                        procedure,
                        grade,
                        (student.exam_data && student.exam_data[procedure]) ? student.exam_data[procedure] : []
                    );
                } else {
                    cell.textContent = '-';
                }
                row.appendChild(cell);
            });
            tableBody.appendChild(row);
        });
    }

    function getGradeClass(grade) {
        const gradeClasses = {
            'A': 'grade-a',
            'B': 'grade-b',
            'C': 'grade-c',
            'D': 'grade-d',
            'E': 'grade-e'
        };
        return gradeClasses[grade] || '';
    }

    function openProcedurePanel(studentName, institute, procedure, grade, examData) {
        // Update panel content
        document.getElementById('panelStudentName').textContent = studentName;
        document.getElementById('panelInstitute').textContent = institute;
        document.getElementById('panelTotalScore').textContent = `${grade.percentage}%`;
        
        // Get procedure steps data
        const steps = examData.steps || [];
        const completedSteps = steps.filter(step => step.completed).length;
        const missedSteps = steps.length - completedSteps;
        const criticalMissed = examData.critical_missed || 0;
        
        // Update metrics
        document.getElementById('panelCompletedSteps').textContent = `${completedSteps}/${steps.length}`;
        document.getElementById('panelMissedSteps').textContent = missedSteps;
        document.getElementById('panelCriticalSteps').textContent = criticalMissed;
        
        // Populate steps table
        const stepsBody = document.getElementById('procedureStepsBody');
        stepsBody.innerHTML = '';
        
        steps.forEach((step, index) => {
            const row = document.createElement('tr');
            const status = !step.completed ? 'missed' : 'completed';
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${step.description}</td>
                
                <td>
                    <span class="step-status status-${status}">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                        </td>
            `;
            if(step.critical){
                row.style.backgroundColor = '#fad2d2';
            }
            stepsBody.appendChild(row);
        });

        // Show panel
        const panel = document.getElementById('procedurePanel');
        panel.classList.add('active');
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    function closeProcedurePanel() {
        const panel = document.getElementById('procedurePanel');
        panel.classList.remove('active');
        
        // Restore body scroll
        document.body.style.overflow = '';
    }

    function onSkillathonChange() {
        selectedSkillathon = document.getElementById('skillathonFilter').value;
        // Enable institute dropdown if skillathon is selected
        const instituteFilter = document.getElementById('instituteFilter');
        const goButton = document.getElementById('goButton');
        if (selectedSkillathon) {
            instituteFilter.disabled = false;
            goButton.disabled = false;
            
            // Call API with skillathon name
            callSkillathonAPI(selectedSkillathon);
        } else {
            instituteFilter.disabled = true;
            goButton.disabled = true;
            selectedInstitute = '';
            instituteFilter.value = '';
        }
        clearMetricsDisplay();
        clearFetchMetricsInterval();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function callSkillathonAPI(skillathonName) {
        console.log('Calling skillathon API with:', skillathonName);
        
        // Show loading state
        const instituteFilter = document.getElementById('instituteFilter');
        instituteFilter.disabled = true;
        instituteFilter.innerHTML = '<option value="">Loading...</option>';
        
        fetch('/api/institute-based-skillathon/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                skillathon_name: skillathonName
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Skillathon API response:', data);
            
            // Populate institute dropdown with response data
            populateInstituteDropdown(data);
            
            // Re-enable institute dropdown
            instituteFilter.disabled = false;
        })
        .catch(error => {
            console.error('Error calling skillathon API:', error);
            
            // Reset institute dropdown on error
            instituteFilter.innerHTML = '<option value="">All Institutes</option>';
            instituteFilter.disabled = false;
            
            // Show error message
            showError('Failed to load institutes for selected skillathon');
        });
    }

    function populateInstituteDropdown(data) {
        const instituteFilter = document.getElementById('instituteFilter');
        
        // Clear existing options
        instituteFilter.innerHTML = '<option value="">All Institutes</option>';
        
        // Add institutes from API response
        if (data.institutes && Array.isArray(data.institutes)) {
            data.institutes.forEach(institute => {
                const option = document.createElement('option');
                option.value = institute.name;
                option.textContent = institute.name;
                instituteFilter.appendChild(option);
            });
        }
    }

    function onInstituteChange() {
        selectedInstitute = document.getElementById('instituteFilter').value;
        clearMetricsDisplay();
        clearFetchMetricsInterval();
    }

    function clearMetricsDisplay() {
        // Reset metrics display to default/empty
        document.getElementById('totalStudents').textContent = '0';
        document.getElementById('completedAllProcedures').textContent = '0';
        const procedureCountsDiv = document.getElementById('procedureCounts');
        if (procedureCountsDiv) procedureCountsDiv.innerHTML = '';
        if (overallGradeChart) {
            overallGradeChart.data.datasets[0].data = [0,0,0,0,0];
            overallGradeChart.update();
        }
        updateGenderCharts({gender_metrics: {total: {male: 0, female: 0, others: 0}, grade_wise: {A: {male: 0, female: 0, others: 0}, B: {male: 0, female: 0, others: 0}, C: {male: 0, female: 0, others: 0}, D: {male: 0, female: 0, others: 0}, E: {male: 0, female: 0, others: 0}}}});
        updateSkillWiseAnalysis({skill_wise_metrics: {}});
    }

    // Initialize everything
    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOMContentLoaded");
        try{
            initializeOverallGradeChart();
            initializeGenderCharts();
        }catch(error){
            console.error("Error initializing Overall Grade Chart and Gender Charts:", error);
        }
        
        console.log("Initialized Overall Grade Chart and Gender Charts");
        
        // Fetch skillathons
        fetch('/fetch-skillathons/')
            .then(response => response.json())
            .then(data => {
                // Populate Overall Report skillathon filter
                const skillathonFilter = document.getElementById('skillathonFilter');
                if (skillathonFilter) {
                    skillathonFilter.innerHTML = '<option value="">Select Skillathon</option>';
                    data.skillathons.forEach(skillathon => {
                        const option = document.createElement('option');
                        option.value = skillathon.name;
                        option.textContent = `${skillathon.name} (${skillathon.date})`;
                        skillathonFilter.appendChild(option);
                    });
                }

                // Populate Student Report skillathon filter
                const studentSkillathonFilter = document.getElementById('studentSkillathonFilter');
                if (studentSkillathonFilter) {
                    studentSkillathonFilter.innerHTML = '<option value="">Select Skillathon</option>';
                    data.skillathons.forEach(skillathon => {
                        const option = document.createElement('option');
                        option.value = skillathon.name;
                        option.textContent = `${skillathon.name} (${skillathon.date})`;
                        studentSkillathonFilter.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching skillathons:', error);
            });
        
        // Fetch institutes for both tabs
        fetch('/fetch-institutes/')
            .then(response => response.json())
            .then(data => {
                // Populate Overall Report institute filter
                const instituteFilter = document.getElementById('instituteFilter');
                if (instituteFilter) {
                    instituteFilter.innerHTML = '<option value="">All Institutes</option>';
                    data.institutes.forEach(institute => {
                        const option = document.createElement('option');
                        option.value = institute.instituteName;
                        option.textContent = institute.instituteName;
                        instituteFilter.appendChild(option);
                    });
                }

                // Populate Student Report institute filter
                const studentInstituteFilter = document.getElementById('studentInstituteFilter');
                if (studentInstituteFilter) {
                    studentInstituteFilter.innerHTML = '<option value="">All Institutes</option>';
                    data.institutes.forEach(institute => {
                        const option = document.createElement('option');
                        option.value = institute.instituteName;
                        option.textContent = institute.instituteName;
                        studentInstituteFilter.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching institutes:', error);
            });

        // Add event listeners
        document.getElementById('skillathonFilter').addEventListener('change', onSkillathonChange);
        document.getElementById('instituteFilter').addEventListener('change', onInstituteChange);
    });

    // Student Report Go button logic
    function onStudentSkillathonChange() {
        selectedStudentSkillathon = document.getElementById('studentSkillathonFilter').value;
        
        // Enable/disable institute filter and call API
        const studentInstituteFilter = document.getElementById('studentInstituteFilter');
        const goBtn = document.getElementById('studentGoButton');
        
        if (selectedStudentSkillathon) {
            // Call API to get institutes for this skillathon
            callStudentSkillathonAPI(selectedStudentSkillathon);
            goBtn.disabled = false;
        } else {
            // Reset institute filter
            if (studentInstituteFilter) {
                studentInstituteFilter.innerHTML = '<option value="">All Institutes</option>';
                studentInstituteFilter.disabled = true;
            }
            goBtn.disabled = true;
        }
        
        updateStudentGoButtonState();
        clearStudentMetrics();
        clearFetchStudentMetricsInterval();
    }

    function callStudentSkillathonAPI(skillathonName) {
        console.log('Calling student skillathon API with:', skillathonName);
        
        // Show loading state
        const studentInstituteFilter = document.getElementById('studentInstituteFilter');
        studentInstituteFilter.disabled = true;
        studentInstituteFilter.innerHTML = '<option value="">Loading...</option>';
        
        fetch('/api/institute-based-skillathon/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                skillathon_name: skillathonName
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Student skillathon API response:', data);
            
            // Populate institute dropdown with response data
            populateStudentInstituteDropdown(data);
            
            // Re-enable institute dropdown
            studentInstituteFilter.disabled = false;
        })
        .catch(error => {
            console.error('Error calling student skillathon API:', error);
            
            // Reset institute dropdown on error
            studentInstituteFilter.innerHTML = '<option value="">All Institutes</option>';
            studentInstituteFilter.disabled = false;
            
            // Show error message
            showError('Failed to load institutes for selected skillathon');
        });
    }

    function populateStudentInstituteDropdown(data) {
        const studentInstituteFilter = document.getElementById('studentInstituteFilter');
        
        // Clear existing options
        studentInstituteFilter.innerHTML = '<option value="">All Institutes</option>';
        
        // Add institutes from API response
        if (data.institutes && Array.isArray(data.institutes)) {
            data.institutes.forEach(institute => {
                const option = document.createElement('option');
                option.value = institute.name;
                option.textContent = institute.name;
                studentInstituteFilter.appendChild(option);
            });
        }
    }

    function searchStudents(searchTerm) {
        console.log('Searching students with term:', searchTerm);
        
        const tbody = document.getElementById('performanceTableBody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        const searchLower = searchTerm.toLowerCase().trim();
        
        // Update search active flag
        const wasSearchActive = isSearchActive;
        isSearchActive = searchLower !== '';
        console.log('Search active:', isSearchActive);
        
        // If search was active and now cleared, refresh the table data
        if (wasSearchActive && !isSearchActive) {
            console.log('Search cleared, refreshing table data');
            // Trigger a fresh fetch of student metrics to update the table
            fetchStudentMetrics();
        }
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const studentNameCell = row.querySelector('.student-col');
            if (studentNameCell) {
                const studentName = studentNameCell.textContent.toLowerCase();
                
                if (searchLower === '' || studentName.includes(searchLower)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
        console.log(`Search completed. ${visibleCount} students visible out of ${rows.length} total.`);
        
        // Show/hide no results message if needed
        if (searchLower === '') {
            // If search is cleared, hide search results message and show general no data if needed
            showNoSearchResults(false);
            const noDataFound = document.getElementById('noDataFound');
            const tbody = document.getElementById('performanceTableBody');
            const allRows = tbody.querySelectorAll('tr');
            if (allRows.length === 0 && noDataFound) {
                noDataFound.style.display = 'block';
            }
        } else {
            // Show search results message if no results found
            showNoSearchResults(visibleCount === 0);
        }
    }

    function showNoSearchResults(show) {
        let noResultsMsg = document.getElementById('noSearchResults');
        const noDataFound = document.getElementById('noDataFound');
        const tableWrapper = document.querySelector('.table-wrapper');
        
        if (show && !noResultsMsg) {
            // Hide the general no data message
            if (noDataFound) {
                noDataFound.style.display = 'none';
            }
            
            // Hide the table
            if (tableWrapper) {
                tableWrapper.style.display = 'none';
            }
            
            // Create no results message
            noResultsMsg = document.createElement('div');
            noResultsMsg.id = 'noSearchResults';
            noResultsMsg.className = 'no-search-results-message';
            noResultsMsg.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                    <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; display: block; color: #cbd5e1;"></i>
                    <h3 style="margin: 0 0 8px; color: #64748b; font-size: 18px;">No candidates found</h3>
                    <p style="margin: 0; font-style: italic; color: #94a3b8;">Try adjusting your search terms</p>
                </div>
            `;
            
            // Insert the message after the table header
            const tableHeader = document.querySelector('.table-header');
            if (tableHeader) {
                tableHeader.parentNode.insertBefore(noResultsMsg, tableHeader.nextSibling);
            }
        } else if (!show && noResultsMsg) {
            // Remove no results message
            noResultsMsg.remove();
            
            // Show the table again
            if (tableWrapper) {
                tableWrapper.style.display = 'block';
            }
            
            // Show the general no data message if there are no visible rows
            const tbody = document.getElementById('performanceTableBody');
            const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
            if (visibleRows.length === 0 && noDataFound) {
                noDataFound.style.display = 'block';
            }
        }
    }

    function downloadStudentReport(format) {
        const skillathonName = document.getElementById('studentSkillathonFilter').value;
        const instituteName = document.getElementById('studentInstituteFilter').value;
        
        if (!skillathonName) {
            alert('Please select a skillathon first');
            return;
        }
        
        // Build URL with parameters
        const url = '/api/download-student-report/';
        
        // Add parameters
        const params = new URLSearchParams();
        params.append('skillathon_name', skillathonName);
        params.append('format', format);
        if (instituteName && instituteName !== 'all') {
            params.append('institute_name', instituteName);
        }
        
        const fullUrl = url + '?' + params.toString();
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = fullUrl;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function onStudentInstituteChange() {
        selectedStudentInstitute = document.getElementById('studentInstituteFilter').value;
        updateStudentGoButtonState();
        clearStudentMetrics();
        clearFetchStudentMetricsInterval();
    }
    function updateStudentGoButtonState() {
        const goBtn = document.getElementById('studentGoButton');
        if (selectedStudentSkillathon) {
            goBtn.disabled = false;
        } else {
            goBtn.disabled = true;
        }
    }
    function fetchStudentMetricsAuto() {
        fetchStudentMetrics();
        if (!fetchStudentMetricsInterval) {
            fetchStudentMetricsInterval = setInterval(() => {
                if (!sortingInPlace) {
                    fetchStudentMetrics();
                }
            }, 10000); // 10 seconds
        }
    }

    function fetchMetricsAuto() {
        fetchMetrics();
        if (!fetchMetricsInterval) {
            fetchMetricsInterval = setInterval(() => {
                fetchMetrics();
            }, 10000); // 10 seconds
        }
    }

    // OSCE Report Functions
    function loadOsceReportData() {
        // Populate academic year dropdown (2025-2050)
        const academicYearSelect = document.getElementById('osceAcademicYearFilter');
        if (academicYearSelect && academicYearSelect.options.length <= 1) {
            const currentYear = new Date().getFullYear();
            for (let year = 2025; year <= 2050; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                academicYearSelect.appendChild(option);
            }
        }
        
        // Fetch and populate institutions/hospitals dropdown
        fetchInstitutionsHospitalsForOsce();
        
        // Fetch and populate procedures dropdown
        fetchProceduresForOsce();
        
        // Initially show no data message, hide metrics
        const metricsSection = document.querySelector('#osce-tab .metrics-section');
        const noDataMessage = document.getElementById('osceNoDataFound');
        if (metricsSection) metricsSection.style.display = 'none';
        if (noDataMessage) {
            noDataMessage.innerHTML = `
                <i class="fas fa-chart-bar"></i>
                <h3>No Data Available</h3>
                <p>Please select Institution/Hospital and Academic Year to view OSCE report data</p>
            `;
            noDataMessage.style.display = 'block';
        }
    }

    function fetchInstitutionsHospitalsForOsce() {
        const institutionSelect = document.getElementById('osceInstitutionFilter');
        if (!institutionSelect || institutionSelect.options.length > 1) {
            return; // Already populated
        }
        
        fetch('/api/institutions-hospitals-for-report/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add institutions
                    if (data.institutions && Array.isArray(data.institutions)) {
                        data.institutions.forEach(inst => {
                            const option = document.createElement('option');
                            option.value = `${inst.id}|${inst.type}`;
                            option.textContent = `${inst.name} (Institution)`;
                            option.dataset.institutionId = inst.id;
                            option.dataset.institutionType = inst.type;
                            institutionSelect.appendChild(option);
                        });
                    }
                    
                    // Add hospitals
                    if (data.hospitals && Array.isArray(data.hospitals)) {
                        data.hospitals.forEach(hosp => {
                            const option = document.createElement('option');
                            option.value = `${hosp.id}|${hosp.type}`;
                            option.textContent = `${hosp.name} (Hospital)`;
                            option.dataset.institutionId = hosp.id;
                            option.dataset.institutionType = hosp.type;
                            institutionSelect.appendChild(option);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching institutions/hospitals:', error);
            });
    }

    function fetchProceduresForOsce() {
        const procedureSelect = document.getElementById('osceSkillFilter');
        if (!procedureSelect || procedureSelect.options.length > 1) {
            return; // Already populated
        }
        
        fetch('/fetch-procedures/')
            .then(response => response.json())
            .then(data => {
                if (data.procedures && Array.isArray(data.procedures)) {
                    data.procedures.forEach(procedure => {
                        const option = document.createElement('option');
                        option.value = procedure.id;
                        option.textContent = procedure.name;
                        procedureSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching procedures:', error);
            });
    }

    function applyOsceFilters() {
        const institutionValue = document.getElementById('osceInstitutionFilter').value;
        const academicYear = document.getElementById('osceAcademicYearFilter').value;
        const semester = document.getElementById('osceSemesterFilter').value;
        const osceLevel = document.getElementById('osceLevelFilter').value;
        const skill = document.getElementById('osceSkillFilter').value;
        const studentSearch = document.getElementById('osceStudentSearch').value;
        
        // Validate mandatory fields
        if (!institutionValue) {
            alert('Please select an Institution/Hospital');
            return;
        }
        if (!academicYear) {
            alert('Please select an Academic Year');
            return;
        }
        
        // Parse institution value (format: "id|type")
        const [institutionId, institutionType] = institutionValue.split('|');
        
        // Build query parameters
        const params = new URLSearchParams();
        params.append('academic_year', academicYear);
        params.append('institution_id', institutionId);
        params.append('institution_type', institutionType);
        if (semester) params.append('semester', semester);
        if (osceLevel && osceLevel !== 'All') params.append('osce_level', osceLevel);
        if (skill) params.append('skill', skill);
        if (studentSearch) params.append('student_search', studentSearch);
        
        // Show loading state
        const metricsSection = document.querySelector('#osce-tab .metrics-section');
        const noDataMessage = document.getElementById('osceNoDataFound');
        if (metricsSection) metricsSection.style.display = 'none';
        if (noDataMessage) {
            noDataMessage.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                <h3>Loading...</h3>
                <p>Fetching OSCE report data</p>
            `;
            noDataMessage.style.display = 'block';
        }
        
        // Fetch OSCE report data
        fetch(`/api/osce-report/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayOsceKPIs(data);
                } else {
                    const metricsSection = document.querySelector('#osce-tab .metrics-section');
                    const noDataMessage = document.getElementById('osceNoDataFound');
                    if (metricsSection) metricsSection.style.display = 'none';
                    if (noDataMessage) {
                        noDataMessage.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error Loading Data</h3>
                            <p>${data.error || 'Unknown error'}</p>
                        `;
                        noDataMessage.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching OSCE report:', error);
                const metricsSection = document.querySelector('#osce-tab .metrics-section');
                const noDataMessage = document.getElementById('osceNoDataFound');
                if (metricsSection) metricsSection.style.display = 'none';
                if (noDataMessage) {
                    noDataMessage.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Data</h3>
                        <p>Failed to fetch OSCE report data</p>
                    `;
                    noDataMessage.style.display = 'block';
                }
            });
    }

    function displayOsceKPIs(data) {
        // Update metric values
        const totalEnrolled = data.total_students_enrolled || 0;
        const studentsAssessed = data.students_assessed || 0;
        const averageScore = data.average_institution_score || 0;
        const gradeLetter = data.grade_letter || '-';
        const passRate = data.pass_rate || 0;
        const totalConducted = data.total_osce_conducted || 0;
        const assessmentRate = data.assessment_rate || (totalEnrolled > 0 ? Math.round((studentsAssessed / totalEnrolled) * 100) : 0);
        const skillsEvaluated = data.skills_evaluated || 0;
        
        document.getElementById('osceTotalStudentsEnrolled').textContent = totalEnrolled.toLocaleString();
        document.getElementById('osceStudentsAssessed').textContent = `${studentsAssessed.toLocaleString()}${totalEnrolled > 0 ? ` (${Math.round(assessmentRate)}%)` : ''}`;
        document.getElementById('osceTotalConducted').textContent = totalConducted.toLocaleString();
        document.getElementById('osceAssessmentRate').textContent = `${assessmentRate}%`;
        document.getElementById('osceSkillsEvaluated').textContent = skillsEvaluated.toLocaleString();
        
        // Update new metrics
        document.getElementById('osceAverageScore').textContent = `${averageScore}%`;
        const gradeSpan = document.getElementById('osceGradeLetter');
        if (gradeSpan) {
            gradeSpan.textContent = gradeLetter !== '-' ? `(Grade ${gradeLetter})` : '';
        }
        document.getElementById('oscePassRate').textContent = `${passRate}%`;
        
        // Show metrics section and hide no data message
        const metricsSection = document.querySelector('#osce-tab .metrics-section');
        const noDataMessage = document.getElementById('osceNoDataFound');
        if (metricsSection) metricsSection.style.display = 'flex';
        if (noDataMessage) noDataMessage.style.display = 'none';
    }

</script>
{% endblock %}