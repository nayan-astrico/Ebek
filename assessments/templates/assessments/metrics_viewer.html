{% extends "assessments/base.html" %}

{% block title %}Metrics Dashboard{% endblock %}

{% block content %}
<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Override base.html min-height to prevent unnecessary scrolling on empty state */
    #content {
        min-height: auto !important;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-left h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1.2;
    }

    .header-left p {
        margin: 2px 0 0;
        color: #666;
        font-size: 1rem;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .tabs-container {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 2px solid #e2e8f0;
    }

    .tab-btn {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        color: #64748b;
        transition: all 0.2s;
        outline: none;
    }

    .tab-btn:hover {
        color: #1e293b;
    }

    .tab-btn:focus {
        outline: none;
        box-shadow: none;
    }

    .tab-btn.active {
        color: #F16564;
        border-bottom-color: #F16564;
        outline: none;
        box-shadow: none;
        border: none;
        border-bottom: 3px solid #F16564;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Filters */
    .filters-section {
        margin-bottom: 32px;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        padding: 28px;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: nowrap;
    }

    .filter-group > .searchable-dropdown,
    .filter-group > .select-filter {
        flex: 1;
        min-width: 0;
    }

    .filter-group > .search-button {
        flex-shrink: 0;
        min-width: 100px;
    }

    .filter-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        background: white;
        transition: all 0.2s ease;
        color: #1a202c;
        font-weight: 500;
    }

    .filter-input:hover {
        border-color: #cbd5e1;
    }

    .filter-input:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
        background: #fff;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #F16564;
        color: white;
        font-weight: 500;
    }

    .btn-primary:hover {
        background: #e45857;
    }

    .btn-secondary {
        background-color: #64748b;
        color: white;
        font-weight: 500;
    }

    .btn-secondary:hover {
        background-color: #475569;
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }
    
    /* Responsive: 2 columns on tablets */
    @media (max-width: 1024px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* Responsive: 1 column on mobile */
    @media (max-width: 640px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
    }

    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border: none;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1), 0 15px 20px -3px rgba(0, 0, 0, 0.15);
    }

    .kpi-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 4px;
        line-height: 1;
    }

    .kpi-subtitle {
        font-size: 13px;
        color: #64748b;
    }

    .grade-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 700;
        margin-left: 10px;
    }

    .grade-A { background: #dcfce7; color: #166534; }
    .grade-B { background: #dbeafe; color: #1e40af; }
    .grade-C { background: #fef3c7; color: #92400e; }
    .grade-D { background: #fed7aa; color: #9a3412; }
    .grade-E { background: #fee2e2; color: #991b1b; }

    /* Chart Sections */
    .chart-section {
        background: white;
        padding: 25px;
        border-radius: 16px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .chart-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a202c;
        margin: 0 0 20px 0;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
    }

    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: #1a202c;
        font-size: 14px;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table td {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 14px;
    }

    .data-table tbody tr:hover {
        background: #f8fafc;
    }

    .data-table tbody tr {
        cursor: pointer;
        transition: all 0.2s;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-secondary { background: #f1f5f9; color: #475569; }

    /* Grade Colors */
    .grade-a { background-color: #d4edda; }
    .grade-b { background-color: #e2efda; }
    .grade-c { background-color: #fff3cd; }
    .grade-d { background-color: #ffe5d0; }
    .grade-e { background-color: #f8d7da; }

    /* Progress Bar */
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 4px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #1e40af, #3b82f6);
        transition: width 0.3s ease;
    }

    .progress-fill.high { background: linear-gradient(90deg, #166534, #22c55e); }
    .progress-fill.medium { background: linear-gradient(90deg, #ca8a04, #fbbf24); }
    .progress-fill.low { background: linear-gradient(90deg, #991b1b, #ef4444); }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
    }

    .modal.active {
        display: flex;
        align-items: flex-start;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        max-width: 1000px;
        width: 100%;
        margin: 40px auto;
    }

    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #1a202c;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #64748b;
        padding: 0;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background-color: #f1f5f9;
        color: #1a202c;
    }

    .modal-body {
        padding: 25px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    /* Searchable Dropdown */
    .searchable-dropdown {
        position: relative;
        min-width: 220px;
    }

    .searchable-dropdown-toggle {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: #1a202c;
        font-weight: 500;
        transition: all 0.2s ease;
        min-height: 46px;
        box-sizing: border-box;
    }

    .searchable-dropdown-toggle:hover {
        border-color: #cbd5e1;
        cursor: pointer;
    }

    .searchable-dropdown-toggle:focus,
    .searchable-dropdown-toggle.active {
        border-color: #F16564;
        outline: none;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
    }

    .searchable-dropdown-toggle:hover .arrow {
        color: #64748b;
    }

    .searchable-dropdown-toggle .placeholder {
        color: #64748b;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .searchable-dropdown-toggle .selected-text {
        color: #1a202c;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .searchable-dropdown-toggle .arrow {
        transition: all 0.2s ease;
        margin-left: 12px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
    }

    .searchable-dropdown-toggle .arrow svg {
        width: 12px;
        height: 8px;
    }

    .searchable-dropdown-toggle.active .arrow {
        transform: rotate(180deg);
        color: #F16564;
    }

    .searchable-dropdown-menu {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        min-width: 300px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        max-height: 400px;
        overflow: hidden;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }

    .searchable-dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .searchable-dropdown-search {
        position: sticky;
        top: 0;
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(to bottom, #f8fafc, #ffffff);
        z-index: 1;
    }

    .searchable-dropdown-search input {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
        transition: all 0.2s ease;
        background: white;
        color: #1a202c;
    }

    .searchable-dropdown-search input::placeholder {
        color: #94a3b8;
        font-weight: 400;
    }

    .searchable-dropdown-search input:focus {
        border-color: #F16564;
        box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.1);
    }

    .searchable-dropdown-search::before {
        content: 'ðŸ”';
        position: absolute;
        left: 24px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        opacity: 0.5;
        pointer-events: none;
        z-index: 1;
    }

    .searchable-dropdown-options {
        max-height: 320px;
        overflow-y: auto;
        background: white;
    }

    .searchable-dropdown-options::-webkit-scrollbar {
        width: 6px;
    }

    .searchable-dropdown-options::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .searchable-dropdown-options::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }

    .searchable-dropdown-options::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .searchable-dropdown-option {
        padding: 12px 16px;
        cursor: pointer;
        font-size: 14px;
        color: #475569;
        transition: all 0.15s ease;
        border-bottom: 1px solid #f1f5f9;
    }

    .searchable-dropdown-option:last-child {
        border-bottom: none;
    }

    .searchable-dropdown-option:hover {
        background: #f8fafc;
        padding-left: 20px;
    }

    .searchable-dropdown-option.selected {
        background: rgba(241, 101, 100, 0.08);
        color: #F16564;
        font-weight: 600;
        border-left: 3px solid #F16564;
    }

    .searchable-dropdown-option.selected:hover {
        background: rgba(241, 101, 100, 0.12);
    }

    .searchable-dropdown-option.hidden {
        display: none;
    }

    .searchable-dropdown-no-results {
        padding: 24px 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 14px;
        font-style: italic;
    }

    .searchable-dropdown-loading {
        padding: 24px 20px;
        text-align: center;
        color: #64748b;
        font-size: 14px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 24px;
        color: #64748b;
        background: #f8fafc;
        border-radius: 12px;
        border: 2px dashed #e2e8f0;
        margin: 24px 0;
        transition: all 0.3s ease;
    }

    .empty-state:hover {
        border-color: #cbd5e0;
        background: #f1f5f9;
    }

    .empty-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(241, 101, 100, 0.1), rgba(241, 101, 100, 0.05));
        border-radius: 50%;
        position: relative;
    }

    .empty-icon::before {
        content: '';
        position: absolute;
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, rgba(241, 101, 100, 0.15), rgba(241, 101, 100, 0.08));
        border-radius: 50%;
    }

    .empty-icon svg {
        position: relative;
        z-index: 1;
        width: 48px;
        height: 48px;
        opacity: 0.6;
        color: #F16564;
    }

    .empty-icon .icon-emoji {
        font-size: 48px;
        position: relative;
        z-index: 1;
        opacity: 0.7;
    }

    .empty-text {
        font-size: 16px;
        margin: 0;
        color: #475569;
        font-weight: 500;
        line-height: 1.6;
        max-width: 500px;
        margin: 0 auto;
    }

    .empty-subtitle {
        font-size: 14px;
        color: #94a3b8;
        margin-top: 8px;
        font-weight: 400;
    }

    /* Loading */
    .loading {
        text-align: center;
        padding: 48px 24px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #F16564;
        border-radius: 50%;
        margin: 0 auto 16px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Expandable Rows */
    .expandable-content {
        display: none;
        background: #f8fafc;
        padding: 20px;
    }

    .expandable-content.active {
        display: block;
    }

    .expand-icon {
        transition: transform 0.2s;
        display: inline-block;
    }

    .expand-icon.rotated {
        transform: rotate(90deg);
    }

    /* Score Display */
    .score-display {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .score-number {
        font-weight: 600;
        font-size: 15px;
    }

    .small-badge {
        padding: 2px 8px;
        font-size: 11px;
    }

    /* Search */
    .search-box {
        width: 100%;
        max-width: 400px;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .search-box:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.1);
    }

    /* Enterprise Filter UI Styles */
    .select-filter {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        color: #1a202c;
        font-size: 14px;
        font-weight: 500;
        min-width: 220px;
        cursor: pointer;
        transition: all 0.2s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 40px;
    }

    .select-filter:hover {
        border-color: #cbd5e1;
    }

    .select-filter:focus {
        border-color: #F16564;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
        outline: none;
    }

    .search-input-wrapper {
        position: relative;
        min-width: 240px;
    }

    .search-input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        background: white;
        transition: all 0.2s ease;
        color: #1a202c;
    }

    .search-input:hover {
        border-color: #cbd5e1;
    }

    .search-input:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 16px;
    }

    .search-button {
        padding: 12px 28px;
        background: linear-gradient(135deg, #F16564 0%, #e45857 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(241, 101, 100, 0.2);
        min-width: 80px;
    }

    .search-button:hover {
        background: linear-gradient(135deg, #e45857 0%, #d34746 100%);
        box-shadow: 0 4px 12px rgba(241, 101, 100, 0.3);
        transform: translateY(-1px);
    }

    .search-button:active {
        transform: translateY(0);
    }

    /* Grid Layouts */
    .two-column-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .info-label {
        font-weight: 600;
        color: #64748b;
    }

    .info-value {
        color: #1a202c;
        font-weight: 500;
    }

    /* Category Drill-down Responsive */
    @media (max-width: 1024px) {
        #categoryDrilldown > .chart-section > div {
            grid-template-columns: 1fr !important;
        }
    }

    /* Ensure KPI cards stack nicely in drill-down */
    #categoryDrilldown .kpi-grid {
        grid-template-columns: 1fr !important;
        gap: 15px;
    }

    /* Sliding Modal Styles */
    .procedure-modal-overlay {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(26, 32, 44, 0.6);
        z-index: 9999;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .procedure-modal-overlay.active {
        pointer-events: auto;
        opacity: 1;
    }

    .procedure-modal-slider {
        position: fixed;
        top: 0;
        right: -40%;
        bottom: 0;
        width: 40%;
        max-width: 600px;
        background-color: #f8fafc;
        box-shadow: -4px 0 25px rgba(0, 0, 0, 0.15);
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
        z-index: 10000;
    }

    .procedure-modal-slider.active {
        right: 0;
    }

    .procedure-modal-slider .panel-header {
        padding: 24px 32px;
        border-bottom: 1px solid #e2e8f0;
        background: white;
        position: relative;
        overflow: hidden;
    }

    .procedure-modal-slider .panel-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .procedure-modal-slider .panel-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #1a202c;
        font-weight: 600;
    }

    .procedure-modal-slider .close-btn {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 1.2rem;
    }

    .procedure-modal-slider .close-btn:hover {
        background-color: #f1f5f9;
        color: #F16564;
    }

    .procedure-modal-slider .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
        background: white;
    }

    .procedure-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 32px;
    }

    .procedure-info-card {
        background-color: #f8fafc;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .procedure-info-card:hover {
        background-color: #f1f5f9;
        border-color: #cbd5e0;
    }

    .procedure-info-card label {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 8px;
        display: block;
        font-weight: 500;
    }

    .procedure-info-card .info-value {
        font-size: 1.5rem;
        color: #1a202c;
        font-weight: 700;
    }

    .procedure-info-card.grade-card .info-value {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 8px;
        color: white;
        font-size: 1.25rem;
    }

    @keyframes slideInFromRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-header-custom {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }

    .modal-header-custom h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #1a202c;
    }

    .modal-close-btn {
        background: none;
        border: none;
        font-size: 32px;
        cursor: pointer;
        color: #6b7280;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close-btn:hover {
        color: #1a202c;
    }

    .modal-body-custom {
        padding: 20px;
        flex: 1;
    }

    .aggregated-score-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        text-align: center;
    }

    .aggregated-score-card h4 {
        margin: 0 0 16px 0;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .score-display {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
    }

    .score-number {
        font-size: 36px;
        font-weight: bold;
        color: #1a202c;
    }

    .attempts-list h4 {
        margin: 0 0 16px 0;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
    }

    .attempt-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .attempt-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .attempt-header {
        padding: 20px 24px;
        background: #f8fafc;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
        border-bottom: 1px solid #e2e8f0;
    }

    .attempt-header:hover {
        background: #f1f5f9;
    }

    .attempt-header h4 {
        margin: 0 0 4px 0;
        color: #1a202c;
        font-weight: 600;
        font-size: 1rem;
    }

    .attempt-header p {
        margin: 0;
        font-size: 0.875rem;
        color: #64748b;
    }

    .attempt-score-badge {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .attempt-score-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #F16564;
    }

    .attempt-expand-icon {
        font-size: 1.25rem;
        color: #94a3b8;
        transition: transform 0.3s ease;
    }

    .attempt-header:hover {
        background: #f3f4f6;
    }

    .attempt-header strong {
        display: block;
        margin-bottom: 4px;
        color: #1a202c;
        font-size: 14px;
    }

    .attempt-header-info {
        color: #6b7280;
        font-size: 13px;
        display: block;
    }

    .attempt-header-score {
        color: #1a202c;
        font-weight: 600;
    }

    .attempt-details {
        padding: 24px;
        display: none;
        background: white;
    }

    .attempt-details.expanded {
        display: block;
    }

    .detail-section {
        margin-bottom: 24px;
    }

    .detail-section:last-child {
        margin-bottom: 0;
    }

    .detail-section h5 {
        margin: 0 0 16px 0;
        color: #1a202c;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.875rem;
        background: #f8fafc;
        border-radius: 8px;
        overflow: hidden;
    }

    .detail-table tr {
        border-bottom: 1px solid #e2e8f0;
    }

    .detail-table tr:last-child {
        border-bottom: none;
    }

    .detail-table td {
        padding: 12px 16px;
    }

    .detail-table td:first-child {
        color: #64748b;
        font-weight: 500;
        width: 40%;
    }

    .detail-table td:last-child {
        color: #1a202c;
        font-weight: 600;
    }

    .detail-table td:first-child {
        font-weight: 600;
        color: #374151;
        width: 40%;
        vertical-align: top;
    }

    .detail-table td:last-child {
        color: #1a202c;
        word-break: break-word;
    }

    .missed-steps-list {
        list-style: decimal;
        padding-left: 20px;
        margin: 0;
    }

    .missed-steps-list li {
        margin-bottom: 6px;
        color: #1a202c;
        font-style: italic;
    }

    .procedure-cell-hover {
        cursor: pointer;
        color: #2563eb;
    }

    .procedure-cell-hover:hover {
        background-color: #eff6ff;
        text-decoration: underline;
    }
</style>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1>Reports</h1>
        <p class="text-muted">View comprehensive analytics for semesters and aggregated yearly data</p>
    </div>
</div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('overall-report-tab')">Overall Report</button>
        <button class="tab-btn" onclick="switchTab('candidate-report-tab')">Candidate Report</button>
    </div>

    <!-- OVERALL REPORT TAB -->
    <div id="overall-report-tab" class="tab-content active">
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <div class="searchable-dropdown" id="semInstitutionDropdown">
                    <div class="searchable-dropdown-toggle" id="semInstitutionToggle" tabindex="0">
                        <span class="placeholder">Select Institution/Hospital *</span>
                        <span class="arrow">
                            <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </div>
                    <div class="searchable-dropdown-menu" id="semInstitutionMenu">
                        <div class="searchable-dropdown-search">
                            <input type="text" id="semInstitutionSearch" placeholder="Search...">
                        </div>
                        <div class="searchable-dropdown-options" id="semInstitutionOptions">
                            <!-- Options will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <input type="hidden" id="semInstitutionFilter" value="">

                <select id="semAcademicYearFilter" class="select-filter">
                    <option value="">Select Academic Year *</option>
                </select>

                <select id="semSemesterFilter" class="select-filter">
                    <option value="">All Semesters</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                    <option value="4">Semester 4</option>
                    <option value="5">Semester 5</option>
                    <option value="6">Semester 6</option>
                    <option value="7">Semester 7</option>
                    <option value="8">Semester 8</option>
                </select>

                <select id="semOsceLevelFilter" class="select-filter">
                    <option value="All">All OSCE Levels</option>
                    <option value="Classroom">Classroom</option>
                    <option value="Mock">Mock</option>
                    <option value="Final">Final</option>
                </select>

                <button id="semGoButton" class="search-button" onclick="applySemesterFilters()">Go</button>
            </div>
        </div>

        <div id="semesterDashboard">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">Select Institution/Hospital and Academic Year to view semester metrics</p>
                <p class="empty-subtitle">Use the filters above to get started</p>
            </div>
        </div>
    </div>

    <!-- CANDIDATE REPORT TAB -->
    <div id="candidate-report-tab" class="tab-content">
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <div class="searchable-dropdown" id="candInstitutionDropdown">
                    <div class="searchable-dropdown-toggle" id="candInstitutionToggle" tabindex="0">
                        <span class="placeholder">Select Institution/Hospital *</span>
                        <span class="arrow">
                            <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </div>
                    <div class="searchable-dropdown-menu" id="candInstitutionMenu">
                        <div class="searchable-dropdown-search">
                            <input type="text" id="candInstitutionSearch" placeholder="Search...">
                        </div>
                        <div class="searchable-dropdown-options" id="candInstitutionOptions">
                            <!-- Options will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <input type="hidden" id="candInstitutionFilter" value="">

                <select id="candAcademicYearFilter" class="select-filter">
                    <option value="">Select Academic Year *</option>
                </select>

                <select id="candSemesterFilter" class="select-filter">
                    <option value="">Select Semester *</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                    <option value="4">Semester 4</option>
                    <option value="5">Semester 5</option>
                    <option value="6">Semester 6</option>
                    <option value="7">Semester 7</option>
                    <option value="8">Semester 8</option>
                </select>

                <select id="candStudentFilter" class="select-filter" disabled>
                    <option value="">Select Student *</option>
                </select>

                <button id="candGoButton" class="search-button" onclick="applyCandidateFilters()" disabled>Go</button>
            </div>
        </div>

        <div id="candidateDashboard">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">Select all filters to view candidate report</p>
                <p class="empty-subtitle">All fields are mandatory</p>
            </div>
        </div>
    </div>

<!-- Student Detail Modal -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="studentModalTitle">Student Details</h2>
            <button class="modal-close" onclick="closeStudentModal()">&times;</button>
        </div>
        <div class="modal-body" id="studentModalBody"></div>
    </div>
</div>

<script>
let semesterMetricsData = null;

// Flag to control visibility of Marks and Details columns in Student Batch Report
// Set to true to show these columns, false to hide them
const SHOW_MARKS_AND_DETAILS_COLUMNS = true;

// Tab Switching Function
function switchTab(tabId) {
    // Remove active class from all tabs and buttons
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Add active class to selected tab and button
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// Searchable Dropdown Functions
function initSearchableDropdown() {
    const toggle = document.getElementById('semInstitutionToggle');
    const menu = document.getElementById('semInstitutionMenu');
    const search = document.getElementById('semInstitutionSearch');
    const options = document.getElementById('semInstitutionOptions');
    const hiddenInput = document.getElementById('semInstitutionFilter');

    if (!toggle || !menu || !search || !options) return;

    // Toggle dropdown
    toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = menu.classList.contains('show');
        
        // Close all other dropdowns if any
        document.querySelectorAll('.searchable-dropdown-menu.show').forEach(m => {
            if (m !== menu) m.classList.remove('show');
        });
        document.querySelectorAll('.searchable-dropdown-toggle.active').forEach(t => {
            if (t !== toggle) t.classList.remove('active');
        });

        if (isOpen) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        } else {
            menu.classList.add('show');
            toggle.classList.add('active');
            search.focus();
        }
    });

    // Search functionality
    search.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const allOptions = options.querySelectorAll('.searchable-dropdown-option');
        let visibleCount = 0;

        allOptions.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                option.classList.remove('hidden');
                visibleCount++;
            } else {
                option.classList.add('hidden');
            }
        });

        // Show/hide no results message
        let noResults = options.querySelector('.searchable-dropdown-no-results');
        if (visibleCount === 0) {
            if (!noResults) {
                noResults = document.createElement('div');
                noResults.className = 'searchable-dropdown-no-results';
                noResults.textContent = 'No results found';
                options.appendChild(noResults);
            }
            noResults.style.display = 'block';
        } else if (noResults) {
            noResults.style.display = 'none';
        }
    });

    // Prevent dropdown from closing when clicking inside
    menu.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!toggle.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menu.classList.contains('show')) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        }
    });
}

function selectSearchableOption(value, text) {
    const toggle = document.getElementById('semInstitutionToggle');
    const menu = document.getElementById('semInstitutionMenu');
    const hiddenInput = document.getElementById('semInstitutionFilter');
    const options = document.getElementById('semInstitutionOptions');
    const search = document.getElementById('semInstitutionSearch');

    // Update hidden input value
    hiddenInput.value = value;

    // Update toggle display
    let textSpan = toggle.querySelector('.placeholder, .selected-text');
    if (!textSpan || textSpan.classList.contains('arrow')) {
        textSpan = toggle.querySelector('span:not(.arrow)');
    }
    
    if (textSpan && !textSpan.classList.contains('arrow')) {
        textSpan.textContent = text;
        textSpan.className = 'selected-text';
    }

    // Update selected state in options
    options.querySelectorAll('.searchable-dropdown-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.value === value) {
            opt.classList.add('selected');
        }
    });

    // Close dropdown
    menu.classList.remove('show');
    toggle.classList.remove('active');

    // Clear search
    search.value = '';
    options.querySelectorAll('.searchable-dropdown-option').forEach(opt => {
        opt.classList.remove('hidden');
    });
}

// Semester Metrics Initialization Functions
function loadSemesterMetricsData() {
    console.log('loadSemesterMetricsData called');
    
    // Initialize searchable dropdown
    initSearchableDropdown();

    // Populate academic year dropdown (2025-2050)
    const academicYearSelect = document.getElementById('semAcademicYearFilter');
    if (academicYearSelect && academicYearSelect.options.length <= 1) {
        const currentYear = new Date().getFullYear();
        for (let year = 2025; year <= 2050; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            academicYearSelect.appendChild(option);
        }
    }

    // Fetch and populate institutions/hospitals dropdown
    fetchInstitutionsHospitalsForSemester();

    // Initially show no data message, hide metrics
    const dashboard = document.getElementById('semesterDashboard');
    if (dashboard) {
        dashboard.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">Select Institution/Hospital and Academic Year to view semester metrics</p>
                <p class="empty-subtitle">Use the filters above to get started</p>
            </div>
        `;
    }
}

function fetchInstitutionsHospitalsForSemester() {
    const optionsContainer = document.getElementById('semInstitutionOptions');
    
    if (!optionsContainer) {
        console.error('Institution options container not found');
        return;
    }
    
    // Check if already populated
    if (optionsContainer.children.length > 0 && !optionsContainer.querySelector('[style*="pointer-events"]')) {
        return; // Already populated with real options
    }

    console.log('Fetching institutions/hospitals...');
    
    // Show loading state
    optionsContainer.innerHTML = '<div class="searchable-dropdown-option" style="pointer-events: none; color: #94a3b8;">Loading...</div>';

    fetch('/api/institutions-hospitals-for-report/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Institutions/hospitals data received:', data);
            
            // Clear container
            optionsContainer.innerHTML = '';
            
            if (data.success) {
                // Add institutions
                if (data.institutions && Array.isArray(data.institutions)) {
                    data.institutions.forEach(inst => {
                        const option = document.createElement('div');
                        option.className = 'searchable-dropdown-option';
                        option.dataset.value = `${inst.id}|${inst.type}`;
                        option.textContent = `${inst.name} (Institution)`;
                        option.onclick = function() {
                            selectSearchableOption(this.dataset.value, this.textContent);
                        };
                        optionsContainer.appendChild(option);
                    });
                }
                
                // Add hospitals
                if (data.hospitals && Array.isArray(data.hospitals)) {
                    data.hospitals.forEach(hosp => {
                        const option = document.createElement('div');
                        option.className = 'searchable-dropdown-option';
                        option.dataset.value = `${hosp.id}|${hosp.type}`;
                        option.textContent = `${hosp.name} (Hospital)`;
                        option.onclick = function() {
                            selectSearchableOption(this.dataset.value, this.textContent);
                        };
                        optionsContainer.appendChild(option);
                    });
                }
                
                const totalOptions = (data.institutions?.length || 0) + (data.hospitals?.length || 0);
                console.log('Searchable dropdown populated with', totalOptions, 'options');
            } else {
                optionsContainer.innerHTML = '<div class="searchable-dropdown-option" style="pointer-events: none; color: #ef4444;">Error: Unable to load options</div>';
                console.error('API returned success: false', data);
            }
        })
        .catch(error => {
            console.error('Error fetching institutions/hospitals:', error);
            optionsContainer.innerHTML = '<div class="searchable-dropdown-option" style="pointer-events: none; color: #ef4444;">Error loading data</div>';
        });
}

// Apply Semester Filters (replaces loadSemesterData)
async function applySemesterFilters() {
    // Validate mandatory fields
    const institutionValue = document.getElementById('semInstitutionFilter').value;
    const academicYear = document.getElementById('semAcademicYearFilter').value;

    if (!institutionValue) {
        alert('Please select Institution/Hospital');
        return;
    }
    if (!academicYear) {
        alert('Please select Academic Year');
        return;
    }

    const container = document.getElementById('semesterDashboard');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading semester metrics...</p></div>';

    // Parse institution value (format: "id|type")
    const [institutionId, institutionType] = institutionValue.split('|');

    // Get unit name from searchable dropdown toggle text (remove the type suffix)
    const toggle = document.getElementById('semInstitutionToggle');
    const toggleText = toggle.querySelector('.selected-text, .placeholder');
    let unitName = toggleText ? toggleText.textContent.replace(' (Institution)', '').replace(' (Hospital)', '').trim() : '';
    
    // If unit name contains "Select Institution" it means nothing was selected
    if (unitName.includes('Select Institution') || unitName.includes('*')) {
        unitName = '';
    }

    if (!unitName || !institutionValue) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <p class="empty-text">Error: Unit name could not be determined</p>
                <p class="empty-subtitle">Please try selecting a different institution or hospital</p>
            </div>
        `;
        return;
    }

    // Build query parameters
    const params = new URLSearchParams();
    params.append('unit_name', unitName);
    params.append('year', academicYear); // Backend expects 'year', but we use academic_year

    // Get optional filter values
    const semester = document.getElementById('semSemesterFilter').value;
    const osceLevel = document.getElementById('semOsceLevelFilter').value;

    // Determine which API to use based on semester selection and osce level filter
    // Use SemesterMetrics if osce_level filter is applied (even if "All Semesters" is selected)
    // because UnitMetrics doesn't have osce_type_breakdown
    let apiEndpoint = '/api/semester-metrics/';
    const useUnitMetrics = (!semester || semester === '') && (!osceLevel || osceLevel === 'All');

    if (useUnitMetrics) {
        // No semester AND no OSCE level filter - fetch aggregated data from UnitMetrics
        apiEndpoint = '/api/unit-metrics/';
    } else {
        // Either semester is selected OR OSCE level filter is applied - use SemesterMetrics
        if (semester && semester !== '') {
            params.append('semester', semester);
        }
    }

    if (osceLevel && osceLevel !== 'All') params.append('osce_level', osceLevel);

    try {
        const response = await fetch(`${apiEndpoint}?${params}`);
        const data = await response.json();

        if (data.success && data.count > 0) {
            let dashboardData = data.documents[0].data;

            // If OSCE level filter is applied, extract data from osce_type_breakdown
            if (osceLevel && osceLevel !== 'All') {
                const osce_type_breakdown = dashboardData.osce_type_breakdown || {};
                if (osce_type_breakdown[osceLevel]) {
                    const typeData = osce_type_breakdown[osceLevel];
                    // Replace dashboard data with OSCE type specific data
                    dashboardData = {
                        ...dashboardData,
                        total_students: typeData.total_students,
                        students_assessed: typeData.students_assessed,
                        osces_conducted: typeData.osces_conducted,
                        avg_score: typeData.avg_score,
                        pass_rate: typeData.pass_rate,
                        grade_letter: typeData.grade_letter,
                        grade_distribution: typeData.grade_distribution,
                        category_performance: typeData.category_performance,
                        category_details: typeData.category_details,  // Add category drill-down data for filtered view
                        skills_performance: typeData.skills_performance,
                        osce_activity_timeline: typeData.osce_activity_timeline,
                        student_batch_report: typeData.student_batch_report,
                        raw_scores: typeData.raw_scores
                    };
                }
            }

            semesterMetricsData = dashboardData;

            // Pass filter state to control what sections are displayed
            const filterState = {
                semester: semester && semester !== '',
                osceLevel: osceLevel && osceLevel !== 'All'
            };

            renderSemesterDashboard(semesterMetricsData, filterState);
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <p class="empty-text">No semester metrics found matching the filters</p>
                    <p class="empty-subtitle">Try adjusting your filter criteria</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <p class="empty-text">Error: ${error.message}</p>
                <p class="empty-subtitle">Please try again or contact support if the issue persists</p>
            </div>
        `;
    }
}

// ===== CANDIDATE REPORT FUNCTIONS =====

// Initialize Candidate Report Searchable Dropdown
function initCandidateSearchableDropdown() {
    const toggle = document.getElementById('candInstitutionToggle');
    const menu = document.getElementById('candInstitutionMenu');
    const search = document.getElementById('candInstitutionSearch');
    const options = document.getElementById('candInstitutionOptions');
    const hiddenInput = document.getElementById('candInstitutionFilter');

    if (!toggle || !menu || !search || !options) return;

    // Toggle dropdown
    toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = menu.classList.contains('show');

        // Close all other dropdowns if any
        document.querySelectorAll('.searchable-dropdown-menu.show').forEach(m => {
            if (m !== menu) m.classList.remove('show');
        });
        document.querySelectorAll('.searchable-dropdown-toggle.active').forEach(t => {
            if (t !== toggle) t.classList.remove('active');
        });

        if (isOpen) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        } else {
            menu.classList.add('show');
            toggle.classList.add('active');
            search.focus();
        }
    });

    // Filter options on search
    search.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const optionElements = options.querySelectorAll('.searchable-dropdown-option');

        optionElements.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!toggle.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        }
    });

    // Populate institutions/hospitals (reuse the same data from Overall Report)
    loadCandidateInstitutions();
}

// Load institutions for Candidate Report
function loadCandidateInstitutions() {
    const optionsContainer = document.getElementById('candInstitutionOptions');

    if (!optionsContainer) {
        console.error('Candidate institution options container not found');
        return;
    }

    // Check if already populated
    if (optionsContainer.children.length > 0 && !optionsContainer.querySelector('[style*="pointer-events"]')) {
        return; // Already populated with real options
    }

    console.log('Fetching institutions/hospitals for Candidate Report...');

    // Show loading state
    optionsContainer.innerHTML = '<div class="searchable-dropdown-option" style="pointer-events: none; color: #94a3b8;">Loading...</div>';

    fetch('/api/institutions-hospitals-for-report/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Candidate Report - Institutions/hospitals data received:', data);

            // Clear container
            optionsContainer.innerHTML = '';

            if (data.success) {
                // Add institutions
                if (data.institutions && Array.isArray(data.institutions)) {
                    data.institutions.forEach(inst => {
                        const option = document.createElement('div');
                        option.className = 'searchable-dropdown-option';
                        option.dataset.value = `${inst.id}|${inst.type}`;
                        option.textContent = `${inst.name} (Institution)`;
                        option.onclick = function() {
                            selectCandidateInstitution(inst.name, this.dataset.value);
                        };
                        optionsContainer.appendChild(option);
                    });
                }

                // Add hospitals
                if (data.hospitals && Array.isArray(data.hospitals)) {
                    data.hospitals.forEach(hosp => {
                        const option = document.createElement('div');
                        option.className = 'searchable-dropdown-option';
                        option.dataset.value = `${hosp.id}|${hosp.type}`;
                        option.textContent = `${hosp.name} (Hospital)`;
                        option.onclick = function() {
                            selectCandidateInstitution(hosp.name, this.dataset.value);
                        };
                        optionsContainer.appendChild(option);
                    });
                }

                const totalOptions = (data.institutions?.length || 0) + (data.hospitals?.length || 0);
                console.log('Candidate dropdown populated with', totalOptions, 'options');
            } else {
                optionsContainer.innerHTML = '<div class="searchable-dropdown-option" style="pointer-events: none; color: #ef4444;">Error: Unable to load options</div>';
                console.error('API returned success: false', data);
            }
        })
        .catch(error => {
            console.error('Error fetching institutions/hospitals for Candidate Report:', error);
            optionsContainer.innerHTML = '<div class="searchable-dropdown-option" style="pointer-events: none; color: #ef4444;">Error loading data</div>';
        });
}

// Select institution in Candidate Report
function selectCandidateInstitution(name, value) {
    const toggle = document.getElementById('candInstitutionToggle');
    const menu = document.getElementById('candInstitutionMenu');
    const hiddenInput = document.getElementById('candInstitutionFilter');
    const search = document.getElementById('candInstitutionSearch');

    // Update toggle text
    const placeholder = toggle.querySelector('.placeholder');
    if (placeholder) {
        placeholder.textContent = name;
        placeholder.classList.add('selected-text');
        placeholder.classList.remove('placeholder');
    } else {
        const selectedText = toggle.querySelector('.selected-text');
        if (selectedText) {
            selectedText.textContent = name;
        }
    }

    // Set hidden input value
    hiddenInput.value = value;

    // Clear search
    search.value = '';

    // Show all options again
    const options = menu.querySelectorAll('.searchable-dropdown-option');
    options.forEach(opt => opt.style.display = 'block');

    // Close menu
    menu.classList.remove('show');
    toggle.classList.remove('active');

    // Trigger filter check
    checkCandidateFilters();
}

// Setup Candidate Report Filters
function setupCandidateFilters() {
    // Load academic years
    loadCandidateAcademicYears();

    // Add change event listeners
    document.getElementById('candInstitutionFilter').addEventListener('change', checkCandidateFilters);
    document.getElementById('candAcademicYearFilter').addEventListener('change', onCandidateFilterChange);
    document.getElementById('candSemesterFilter').addEventListener('change', onCandidateFilterChange);
    document.getElementById('candStudentFilter').addEventListener('change', checkCandidateFilters);
}

// Load academic years for Candidate Report
function loadCandidateAcademicYears() {
    const academicYearSelect = document.getElementById('candAcademicYearFilter');
    if (academicYearSelect && academicYearSelect.options.length <= 1) {
        const currentYear = new Date().getFullYear();
        for (let year = 2025; year <= 2050; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            academicYearSelect.appendChild(option);
        }
    }
}

// When Institution, Year, or Semester changes, fetch students
async function onCandidateFilterChange() {
    const institutionValue = document.getElementById('candInstitutionFilter').value;
    const academicYear = document.getElementById('candAcademicYearFilter').value;
    const semester = document.getElementById('candSemesterFilter').value;

    // If all three are selected, fetch students
    if (institutionValue && academicYear && semester) {
        await loadCandidateStudents(institutionValue, academicYear, semester);
    } else {
        // Reset student dropdown
        const studentSelect = document.getElementById('candStudentFilter');
        studentSelect.innerHTML = '<option value="">Select Student *</option>';
        studentSelect.disabled = true;
    }

    checkCandidateFilters();
}

// Load students based on filters
async function loadCandidateStudents(institutionValue, academicYear, semester) {
    const studentSelect = document.getElementById('candStudentFilter');

    console.log('ðŸ” Loading students with:', { institutionValue, academicYear, semester });

    // Show loading state
    studentSelect.innerHTML = '<option value="">Loading students...</option>';
    studentSelect.disabled = true;

    try {
        // Parse institution value (format: "id|type")
        const [institutionId, institutionType] = institutionValue.split('|');

        // Get unit name from searchable dropdown toggle text
        const toggle = document.getElementById('candInstitutionToggle');
        const toggleText = toggle.querySelector('.selected-text, .placeholder');
        let unitName = toggleText ? toggleText.textContent.replace(' (Institution)', '').replace(' (Hospital)', '').trim() : '';

        console.log('ðŸ“ Unit name extracted:', unitName);

        const params = new URLSearchParams({
            unit_name: unitName,
            academic_year: academicYear,
            semester: semester
        });

        console.log('ðŸŒ Fetching:', `/api/candidate-report/students/?${params}`);

        const response = await fetch(`/api/candidate-report/students/?${params}`);
        const data = await response.json();

        console.log('ðŸ“¦ API Response:', data);

        if (data.success && data.students) {
            console.log(`âœ… Found ${data.students.length} students`);
            studentSelect.innerHTML = '<option value="">Select Student *</option>';

            data.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                studentSelect.appendChild(option);
            });

            studentSelect.disabled = false;
        } else {
            console.warn('âš ï¸ No students found or API returned error:', data);
            studentSelect.innerHTML = '<option value="">No students found</option>';
            studentSelect.disabled = true;
        }
    } catch (error) {
        console.error('âŒ Error loading students:', error);
        studentSelect.innerHTML = '<option value="">Error loading students</option>';
        studentSelect.disabled = true;
    }

    checkCandidateFilters();
}

// Check if all Candidate filters are filled
function checkCandidateFilters() {
    const institutionValue = document.getElementById('candInstitutionFilter').value;
    const academicYear = document.getElementById('candAcademicYearFilter').value;
    const semester = document.getElementById('candSemesterFilter').value;
    const student = document.getElementById('candStudentFilter').value;
    const goButton = document.getElementById('candGoButton');

    // Enable Go button only if all mandatory fields are filled
    if (institutionValue && academicYear && semester && student) {
        goButton.disabled = false;
    } else {
        goButton.disabled = true;
    }
}

// Apply Candidate Report Filters
async function applyCandidateFilters() {
    const institutionValue = document.getElementById('candInstitutionFilter').value;
    const academicYear = document.getElementById('candAcademicYearFilter').value;
    const semester = document.getElementById('candSemesterFilter').value;
    const student = document.getElementById('candStudentFilter').value;

    if (!institutionValue || !academicYear || !semester || !student) {
        alert('Please fill all mandatory fields');
        return;
    }

    const container = document.getElementById('candidateDashboard');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading candidate report...</p></div>';

    try {
        // Get unit name from searchable dropdown toggle text
        const toggle = document.getElementById('candInstitutionToggle');
        const toggleText = toggle.querySelector('.selected-text, .placeholder');
        let unitName = toggleText ? toggleText.textContent.replace(' (Institution)', '').replace(' (Hospital)', '').trim() : '';

        // Reuse existing semester-metrics API
        const params = new URLSearchParams({
            unit_name: unitName,
            year: academicYear,
            semester: semester
        });

        console.log('ðŸŒ Fetching semester metrics:', `/api/semester-metrics/?${params}`);

        const response = await fetch(`/api/semester-metrics/?${params}`);
        const data = await response.json();

        console.log('ðŸ“¦ Semester metrics received:', data);

        if (data.success && data.documents && data.documents.length > 0) {
            // Get student_batch_report from the semester data
            const semesterData = data.documents[0].data;
            const studentBatchReport = semesterData.student_batch_report || [];

            // Find the specific student
            const studentData = studentBatchReport.find(s =>
                s.user_id === student ||
                String(s.user_id) === String(student) ||
                s.name === student
            );

            if (studentData) {
                console.log('âœ… Found student:', studentData);
                console.log('ðŸ“Š exam_attempts:', studentData.exam_attempts);
                console.log('ðŸ“Š exam_attempts structure:', JSON.stringify(studentData.exam_attempts, null, 2));
                renderCandidateReport(studentData);
            } else {
                console.warn('âš ï¸ Student not found in batch report. Available user_ids:',
                    studentBatchReport.map(s => s.user_id).slice(0, 5));
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <p class="empty-text">Student not found in this semester</p>
                        <p class="empty-subtitle">This student may not have completed any OSCEs yet</p>
                    </div>
                `;
            }
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <p class="empty-text">Error: ${data.error || 'Unable to load student data'}</p>
                    <p class="empty-subtitle">Please try again or contact support</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('âŒ Error fetching student data:', error);
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <p class="empty-text">Error: ${error.message}</p>
                <p class="empty-subtitle">Please try again or contact support</p>
            </div>
        `;
    }
}

// Render Candidate Report Table
function renderCandidateReport(data) {
    const container = document.getElementById('candidateDashboard');

    // Use pre-computed unique OSCEs participated count (from backend)
    // This counts unique BatchAssignmentSummary documents the student participated in
    const totalOSCEs = data.unique_osces_participated || 0;
    const avgScore = data.overall_avg || 0;
    const overallGrade = data.overall_grade || '-';
    const studentName = data.name || data.student_name || 'Unknown';

    // Determine best and least performing OSCE (using actual field names)
    const osceScores = {
        'Classroom': data.classroom_score || null,
        'Mock': data.mock_score || null,
        'Final': data.final_score || null
    };

    // Filter out null values and find best/least
    const validScores = Object.entries(osceScores).filter(([_, score]) => score !== null && score > 0);

    let bestOSCE = '-';
    let leastOSCE = '-';

    if (validScores.length > 0) {
        const sortedScores = validScores.sort((a, b) => b[1] - a[1]);
        bestOSCE = `${sortedScores[0][0]} (${sortedScores[0][1].toFixed(1)}%)`;

        if (sortedScores.length > 1) {
            leastOSCE = `${sortedScores[sortedScores.length - 1][0]} (${sortedScores[sortedScores.length - 1][1].toFixed(1)}%)`;
        }
    }

    // Find skills needing re-demo (< 80%)
    const skillsNeedingReDemo = [];

    // Check procedure_scores_by_type (nested structure: OSCE type -> procedures -> scores)
    if (data.procedure_scores_by_type && typeof data.procedure_scores_by_type === 'object') {
        // Iterate through OSCE types (Classroom, Mock, Final)
        Object.entries(data.procedure_scores_by_type).forEach(([osceType, procedures]) => {
            if (procedures && typeof procedures === 'object') {
                // Iterate through procedures within that OSCE type
                Object.entries(procedures).forEach(([procedureName, score]) => {
                    if (typeof score === 'number' && score < 80) {
                        skillsNeedingReDemo.push(procedureName);
                    }
                });
            }
        });
    }

    // Format: "3 (CPR, IV Insertion, Intubation)" or "None"
    const reDemoList = skillsNeedingReDemo.length > 0
        ? `${skillsNeedingReDemo.length} (${skillsNeedingReDemo.join(', ')})`
        : 'None';

    // ============================================
    // OSCE SESSION BREAKDOWN TABLE
    // ============================================

    // Group exam_attempts by OSCE session (exam_type + test_date)
    const osceSessionsMap = {};
    if (data.exam_attempts && Array.isArray(data.exam_attempts)) {
        data.exam_attempts.forEach(attempt => {
            const examType = attempt.exam_type || 'Unknown';
            const testDate = attempt.test_date || '';
            const sessionKey = `${examType}_${testDate}`;

            if (!osceSessionsMap[sessionKey]) {
                osceSessionsMap[sessionKey] = {
                    osce_type: examType,
                    date: testDate,
                    attempts: []
                };
            }
            osceSessionsMap[sessionKey].attempts.push(attempt);
        });
    }

    // Calculate metrics for each OSCE session
    const osceSessionsData = [];
    let semesterTotalObtained = 0;
    let semesterTotalMax = 0;

    Object.values(osceSessionsMap).forEach(session => {
        let sessionMarksObtained = 0;
        let sessionMaxMarks = 0;
        const procedureScores = {}; // {procedure_id: {name, score}}

        session.attempts.forEach(attempt => {
            sessionMarksObtained += attempt.marks_obtained || 0;
            sessionMaxMarks += attempt.max_marks || 0;

            // Track individual procedure scores for this session
            const procId = attempt.procedure_id || attempt.procedure_name;
            if (procId) {
                if (!procedureScores[procId]) {
                    procedureScores[procId] = {
                        name: attempt.procedure_name || 'Unknown',
                        obtained: 0,
                        max: 0
                    };
                }
                procedureScores[procId].obtained += attempt.marks_obtained || 0;
                procedureScores[procId].max += attempt.max_marks || 0;
            }
        });

        // Calculate average score for this session
        const sessionAverage = sessionMaxMarks > 0 ? (sessionMarksObtained / sessionMaxMarks) * 100 : 0;
        const sessionGrade = getGrade(sessionAverage);

        // Count skills <60% and >80% for this session
        let skillsBelow60 = 0;
        let skillsAbove80 = 0;

        Object.values(procedureScores).forEach(proc => {
            const procScore = proc.max > 0 ? (proc.obtained / proc.max) * 100 : 0;
            if (procScore < 60) skillsBelow60++;
            if (procScore > 80) skillsAbove80++;
        });

        // Format date
        const formattedDate = session.date ? new Date(session.date).toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        }) : 'â€”';

        osceSessionsData.push({
            osceType: session.osce_type,
            date: formattedDate,
            marksObtained: sessionMarksObtained,
            maxMarks: sessionMaxMarks,
            average: sessionAverage,
            grade: sessionGrade,
            skillsBelow60: skillsBelow60,
            skillsAbove80: skillsAbove80,
            rawAttempts: session.attempts  // Store raw attempts for modal
        });

        // Accumulate for semester average
        semesterTotalObtained += sessionMarksObtained;
        semesterTotalMax += sessionMaxMarks;
    });

    // Calculate Semester Average
    const semesterAverage = semesterTotalMax > 0 ? (semesterTotalObtained / semesterTotalMax) * 100 : 0;
    const semesterGrade = getGrade(semesterAverage);

    // ============================================
    // OSCE WISE ANALYSIS - Procedure Breakdown
    // ============================================

    // Collect all unique procedures the student attempted across all OSCEs
    const allProcedures = new Set();
    if (data.exam_attempts && Array.isArray(data.exam_attempts)) {
        data.exam_attempts.forEach(attempt => {
            if (attempt.procedure_name) {
                allProcedures.add(attempt.procedure_name);
            }
        });
    }
    const proceduresList = Array.from(allProcedures);

    // Calculate procedure scores for each OSCE session
    osceSessionsData.forEach(session => {
        session.procedureScores = {}; // {procedureName: score}

        proceduresList.forEach(procName => {
            // Find all attempts for this procedure in this specific OSCE session
            const procAttempts = session.rawAttempts.filter(a => a.procedure_name === procName);

            if (procAttempts.length > 0) {
                // Calculate aggregated score using Total Marks Method
                const totalObtained = procAttempts.reduce((sum, a) => sum + (a.marks_obtained || 0), 0);
                const totalMax = procAttempts.reduce((sum, a) => sum + (a.max_marks || 0), 0);
                session.procedureScores[procName] = totalMax > 0 ? (totalObtained / totalMax) * 100 : 0;
            } else {
                // Procedure not attempted in this OSCE
                session.procedureScores[procName] = null;
            }
        });

        // Format OSCE label: "Classroom OSCE - 20 Nov"
        session.osceLabel = `${session.osceType} OSCE - ${session.date}`;
    });

    // ============================================
    // SKILL WISE ANALYSIS
    // ============================================

    // Calculate category performance using Total Marks Method from category_marks
    const categoryPerformance = {};
    if (data.category_marks && typeof data.category_marks === 'object') {
        Object.entries(data.category_marks).forEach(([category, marks]) => {
            if (marks.max > 0) {
                const percentage = (marks.obtained / marks.max) * 100;
                categoryPerformance[category] = percentage;
            }
        });
    }

    // Calculate skill grade distribution from procedure_scores_by_type
    const gradeDistribution = {A: 0, B: 0, C: 0, D: 0, E: 0};
    if (data.procedure_scores_by_type) {
        Object.values(data.procedure_scores_by_type).forEach(procedures => {
            Object.values(procedures).forEach(score => {
                if (typeof score === 'number') {
                    const grade = getGrade(score);
                    gradeDistribution[grade]++;
                }
            });
        });
    }

    // Render transposed table (rows instead of columns)
    container.innerHTML = `
        <div class="chart-section" style="margin-top: 24px;">
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <tbody>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc; width: 200px;">Student Name</td>
                            <td style="padding: 16px; font-size: 14px; color: #1a202c; font-weight: 500;">${studentName}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc;">Total OSCEs</td>
                            <td style="padding: 16px; font-size: 14px; color: #1a202c;">${totalOSCEs}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc;">Average Score (%)</td>
                            <td style="padding: 16px; font-size: 14px; color: #1a202c; font-weight: 600;">${avgScore.toFixed(1)}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc;">Overall Grade</td>
                            <td style="padding: 16px;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; background: ${getGradeColor(overallGrade)}; color: white;">
                                    ${overallGrade}
                                </span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc;">Best Performing OSCE</td>
                            <td style="padding: 16px; font-size: 14px; color: #059669;">${bestOSCE}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc;">Least Performing OSCE</td>
                            <td style="padding: 16px; font-size: 14px; color: #dc2626;">${leastOSCE}</td>
                        </tr>
                        <tr>
                            <td style="padding: 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc;">Skills Needing Re-Demo</td>
                            <td style="padding: 16px; font-size: 13px; color: #64748b; word-wrap: break-word;">${reDemoList}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- OSCE Session Breakdown Table -->
        <div class="chart-section" style="margin-top: 32px;">
            <h3 class="section-title">Overall OSCE Report</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">OSCE Level</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Date Conducted</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Score/Total Marks</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Average Score (%)</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Grade</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Skills &lt;60%</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Skills &gt;80%</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${osceSessionsData.map(session => `
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 16px; font-size: 14px; color: #1a202c; font-weight: 500;">${session.osceType} OSCE</td>
                                <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c;">${session.date}</td>
                                <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c;">${session.marksObtained}/${session.maxMarks}</td>
                                <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c; font-weight: 600;">${session.average.toFixed(1)}%</td>
                                <td style="padding: 16px; text-align: center;">
                                    <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; background: ${getGradeColor(session.grade)}; color: white;">
                                        ${session.grade}
                                    </span>
                                </td>
                                <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c;">${session.skillsBelow60}</td>
                                <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c;">${session.skillsAbove80}</td>
                            </tr>
                        `).join('')}
                        <!-- Semester Average Row -->
                        <tr style="background: #f8fafc; border-top: 2px solid #e2e8f0;">
                            <td style="padding: 16px; font-size: 14px; color: #1a202c; font-weight: 700;">Semester Average</td>
                            <td style="padding: 16px; text-align: center; font-size: 14px; color: #64748b;">â€”</td>
                            <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c; font-weight: 600;">${semesterTotalObtained}/${semesterTotalMax}</td>
                            <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c; font-weight: 700;">${semesterAverage.toFixed(1)}%</td>
                            <td style="padding: 16px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 700; background: ${getGradeColor(semesterGrade)}; color: white;">
                                    ${semesterGrade}
                                </span>
                            </td>
                            <td style="padding: 16px; text-align: center; font-size: 14px; color: #64748b;">â€”</td>
                            <td style="padding: 16px; text-align: center; font-size: 14px; color: #64748b;">â€”</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- OSCE Wise Analysis Table -->
        <div class="chart-section" style="margin-top: 32px;">
            <h3 class="section-title">OSCE wise analysis</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">OSCE Level</th>
                            ${proceduresList.map((proc, idx) => `
                                <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">${proc} (%)</th>
                            `).join('')}
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">OSCE Average (%)</th>
                            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${osceSessionsData.map(session => {
                            // Generate procedure cells
                            const procedureCells = proceduresList.map(procName => {
                                const score = session.procedureScores[procName];

                                if (score !== null) {
                                    // Clickable cell with modal trigger
                                    const procAttempts = session.rawAttempts.filter(a => a.procedure_name === procName);
                                    const procData = {
                                        aggregated_score: score,
                                        attempts: procAttempts
                                    };

                                    const procDataStr = JSON.stringify(procData)
                                        .replace(/"/g, '&quot;')
                                        .replace(/'/g, '&#39;');

                                    return `<td class="procedure-cell-hover"
                                                onclick="showProcedureDetails('${studentName}', '${procName}', ${score}, ${procDataStr})"
                                                style="padding: 16px; text-align: center; font-size: 14px; color: #2563eb; cursor: pointer;">
                                                ${score.toFixed(1)}
                                            </td>`;
                                } else {
                                    return `<td style="padding: 16px; text-align: center; font-size: 14px; color: #94a3b8;">â€”</td>`;
                                }
                            }).join('');

                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0;">
                                    <td style="padding: 16px; font-size: 14px; color: #1a202c; font-weight: 500;">${session.osceLabel}</td>
                                    ${procedureCells}
                                    <td style="padding: 16px; text-align: center; font-size: 14px; color: #1a202c; font-weight: 600;">${session.average.toFixed(1)}</td>
                                    <td style="padding: 16px; text-align: center;">
                                        <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; background: ${getGradeColor(session.grade)}; color: white;">
                                            ${session.grade}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Skill Wise Analysis Section -->
        <div class="two-column-grid" style="margin-top: 32px;">
            <!-- Category Performance Bar Chart -->
            <div class="chart-section">
                <h3 class="section-title">Category Performance</h3>
                <div class="chart-wrapper">
                    <canvas id="candidateCategoryChart"></canvas>
                </div>
            </div>

            <!-- Skill Grade Distribution Pie Chart -->
            <div class="chart-section">
                <h3 class="section-title">Grade Distribution (Student Overall Performance)</h3>
                <div class="chart-wrapper">
                    <canvas id="candidateSkillGradeChart"></canvas>
                </div>
            </div>
        </div>
    `;

    // Render charts after DOM is updated
    setTimeout(() => {
        renderCandidateCategoryChart(categoryPerformance);
        renderCandidateSkillGradeChart(gradeDistribution);
    }, 100);
}

// Render Candidate Category Performance Chart (Horizontal Bar Chart)
function renderCandidateCategoryChart(categoryPerf) {
    const categories = Object.keys(categoryPerf).filter(cat => categoryPerf[cat] !== null);
    const scores = categories.map(cat => categoryPerf[cat]);

    const ctx = document.getElementById('candidateCategoryChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Average Score (%)',
                data: scores,
                backgroundColor: scores.map(score => {
                    if (score >= 90) return '#4CAF50'; // A - Green
                    if (score >= 80) return '#8BC34A'; // B - Light Green
                    if (score >= 70) return '#FFC107'; // C - Yellow
                    if (score >= 60) return '#FF9800'; // D - Orange
                    return '#F44336'; // E - Red
                }),
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: '#f1f5f9' },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });
}

// Render Candidate Skill Grade Distribution Chart (Pie Chart)
function renderCandidateSkillGradeChart(gradeDist) {
    const ctx = document.getElementById('candidateSkillGradeChart');
    if (!ctx) return;

    const grades = ['A', 'B', 'C', 'D', 'E'];
    const counts = grades.map(g => gradeDist[g] || 0);

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: grades,
            datasets: [{
                data: counts,
                backgroundColor: ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Calculate Student-Level Grade Distribution
function calculateStudentGradeDistribution(studentBatchReport) {
    const gradeDistribution = { A: 0, B: 0, C: 0, D: 0, E: 0 };
    
    // Count students by their overall_grade
    studentBatchReport.forEach(student => {
        const grade = student.overall_grade;
        if (grade && grade in gradeDistribution) {
            gradeDistribution[grade]++;
        }
    });
    
    return gradeDistribution;
}

// Render Semester Dashboard
function renderSemesterDashboard(data, filterState = {}) {
    // Store data globally so extractUniqueProcedures() can access skills_performance
    // This eliminates the need to pass data through multiple function calls
    window.currentSemesterData = data;

    const hasOptionalFilters = filterState.semester || filterState.osceLevel;
    const hasSemesterFilter = filterState.semester;

    // Get latest OSCE if semester filter is applied
    let latestOSCE = null;
    if (hasSemesterFilter && data.osce_activity_timeline && data.osce_activity_timeline.length > 0) {
        // Sort by date descending and get the most recent
        const sortedOSCEs = [...data.osce_activity_timeline].sort((a, b) => {
            return new Date(b.date_conducted) - new Date(a.date_conducted);
        });
        latestOSCE = sortedOSCEs[0];
    }
    
    const html = `
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Students</div>
                <div class="kpi-value">${data.students_assessed || 0} <span style="font-size: 18px; color: #64748b;">/ ${data.total_students || 0}</span></div>
                <div class="kpi-subtitle">Assessed / Enrolled</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">OSCEs Conducted</div>
                <div class="kpi-value">${data.osces_conducted || data.total_osces || 0}</div>
                <div class="kpi-subtitle">${data.unit_type || 'institute'}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Average Score</div>
                <div class="kpi-value">${data.avg_score || 0}%<span class="grade-badge grade-${data.grade_letter}">${data.grade_letter || '-'}</span></div>
                <div class="kpi-subtitle">Overall Performance</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Pass Rate</div>
                <div class="kpi-value" style="color: ${getPassRateColor(data.pass_rate)}">${data.pass_rate || 0}%</div>
                <div class="kpi-subtitle">Students scoring â‰¥80%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Skills Evaluated</div>
                <div class="kpi-value">${data.skills_evaluated || 0}</div>
                <div class="kpi-subtitle">Unique procedures</div>
            </div>
            ${hasSemesterFilter ? `
                <div class="kpi-card" style="position: relative;">
                    ${latestOSCE ? `
                        <span class="badge ${getBadgeClass(latestOSCE.osce_level)}" style="position: absolute; top: 20px; right: 20px; font-size: 11px; padding: 4px 10px; font-weight: 600;">
                            ${latestOSCE.osce_level || 'N/A'}
                        </span>
                    ` : ''}
                    <div class="kpi-label">Latest OSCE</div>
                    ${latestOSCE ? `
                        <div class="kpi-value" style="font-size: 28px; margin-top: 8px; line-height: 1.2;">${formatOSCEDate(latestOSCE.date_conducted)}</div>
                        <div class="kpi-subtitle" style="color: #64748b; margin-top: 8px; line-height: 1.4;">Most recent assessment</div>
                    ` : `
                        <div class="kpi-value" style="font-size: 48px; opacity: 0.3;">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 60px; height: 60px; margin: 10px auto; display: block;">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="kpi-subtitle" style="color: #94a3b8;">No OSCE conducted yet</div>
                    `}
                </div>
            ` : ''}
        </div>

        <!-- Charts Row (Level 2) - Always shown -->
        <div class="two-column-grid">
            <div class="chart-section">
                <h3 class="section-title">Category Performance</h3>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="chart-section">
                <h3 class="section-title">Grade Distribution (Student Overall Performance)</h3>
                <div class="chart-wrapper">
                    <canvas id="gradeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Category Drill-down Section (shown when category is clicked) -->
        <div id="categoryDrilldown" style="display: none; margin-top: 25px;"></div>

        ${!hasOptionalFilters ? `
            <!-- Message to apply more filters for detailed views -->
            <div class="empty-state" style="margin-top: 24px;">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="7" cy="6" r="1.5" fill="currentColor"/>
                        <circle cx="7" cy="12" r="1.5" fill="currentColor"/>
                        <circle cx="7" cy="18" r="1.5" fill="currentColor"/>
                    </svg>
                </div>
                <p class="empty-text">Apply additional filters to view detailed breakdowns</p>
                <p class="empty-subtitle">Select Semester, OSCE Level, Skill/Procedure, or search for a student to see OSCE timeline, skills performance, and student reports</p>
            </div>
        ` : `
            <!-- Skills Analysis Table (Level 3) -->
            <div class="chart-section">
                <h3 class="section-title">Skills Analysis</h3>
                <input type="text" id="skillsAnalysisSearch" class="search-box" placeholder="Search by skill name..." onkeyup="filterSkillsAnalysis()">
                <div style="overflow-x: auto;">
                    <table class="data-table" id="skillsAnalysisTable">
                        <thead>
                            <tr>
                                <th>Skill Name</th>
                                <th>Category</th>
                                <th>OSCE Types</th>
                                <th>Students Attempted</th>
                                <th style="cursor: pointer;" onclick="sortSkillsTable('score')">Average Score <span id="scoreSort"></span></th>
                                <th style="cursor: pointer;" onclick="sortSkillsTable('grade')">Grade <span id="gradeSort"></span></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderSkillsAnalysisTable(data.skills_performance || {})}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- OSCE Timeline (Level 4) -->
            <div class="chart-section">
                <h3 class="section-title">OSCE Activity Timeline</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Batch</th>
                                <th>OSCE Level</th>
                                <th>Students Attempted</th>
                                <th>Avg Score</th>
                                <th>Pass Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderOSCETimeline(data.osce_activity_timeline || [])}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Student Batch Report (Level 5) -->
            <div class="chart-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="section-title" style="margin-bottom: 0;">Student Batch Report</h3>
                    ${filterState.semester && !filterState.osceLevel ? `
                        <button class="download-btn pdf-btn" onclick="downloadMetricsReportPDF()" title="Download as PDF" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                            <i class="fas fa-file-pdf"></i>
                            Download PDF
                        </button>
                    ` : ''}
                </div>
                <input type="text" id="studentSearch" class="search-box" placeholder="Search by student name..." onkeyup="filterStudents()">
                <div style="overflow-x: auto;">
                    <table class="data-table" id="studentTable">
                        <thead>
                            <tr>
                                ${(() => {
                                    const osceLevel = filterState.osceLevel ? document.getElementById('semOsceLevelFilter').value : null;
                                    if (osceLevel && osceLevel !== 'All') {
                                        // Generate dynamic headers for procedure report
                                        const procedures = extractUniqueProcedures(data.student_batch_report || [], osceLevel);
                                        let headerHtml = '<th>Name</th>';
                                        procedures.forEach(proc => {
                                            headerHtml += `<th>${proc} (%)</th>`;
                                        });
                                        headerHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStudentTable(\'overall\')">Average (%) <span id="overallSort"></span></th>';
                                        headerHtml += '<th style="text-align: center;">Grade</th>';
                                        return headerHtml;
                                    } else {
                                        // Default headers for overall report
                                        let headerHtml = `
                                            <th>Name</th>
                                            <th style="cursor: pointer;" onclick="sortStudentTable('overall')">Overall <span id="overallSort"></span></th>
                                        `;

                                        // Conditionally add Marks column
                                        if (SHOW_MARKS_AND_DETAILS_COLUMNS) {
                                            headerHtml += `<th>Marks</th>`;
                                        }

                                        headerHtml += `
                                            <th>Classroom</th>
                                            <th>Mock</th>
                                            <th>Final</th>
                                        `;

                                        // Conditionally add Details column
                                        if (SHOW_MARKS_AND_DETAILS_COLUMNS) {
                                            headerHtml += `<th>Details</th>`;
                                        }

                                        return headerHtml;
                                    }
                                })()}
                            </tr>
                        </thead>
                        <tbody>
                            ${renderStudentBatchReport(data.student_batch_report || [], filterState.osceLevel ? document.getElementById('semOsceLevelFilter').value : null)}
                        </tbody>
                    </table>
                </div>
            </div>
        `}
    `;

    document.getElementById('semesterDashboard').innerHTML = html;

    // Always render Level 2 charts (Category Performance & Grade Distribution)
    // Use pre-computed student-level grade distribution from backend
    const gradeDistribution = data.grade_distribution || {};

    // Render charts
    renderCategoryChart(data.category_performance || {});
    renderGradeDistributionChart(gradeDistribution);
}

// Render Multiple Documents (if more than one found)
// Render Category Chart
function renderCategoryChart(categoryPerf) {
    const categories = Object.keys(categoryPerf).filter(cat => categoryPerf[cat] !== null);
    const scores = categories.map(cat => categoryPerf[cat]);

    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Average Score (%)',
                data: scores,
                backgroundColor: scores.map(score => {
                    if (score >= 90) return '#4CAF50'; // A - Green
                    if (score >= 80) return '#8BC34A'; // B - Light Green
                    if (score >= 70) return '#FFC107'; // C - Yellow
                    if (score >= 60) return '#FF9800'; // D - Orange
                    return '#F44336'; // E - Red
                }),
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            onClick: (event, activeElements) => {
                if (activeElements.length > 0) {
                    const categoryIndex = activeElements[0].index;
                    const selectedCategory = categories[categoryIndex];
                    showCategoryDrilldown(selectedCategory, semesterMetricsData);
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: '#f1f5f9' }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });
}

// Render Grade Distribution Chart
function renderGradeDistributionChart(gradeDist) {
    const ctx = document.getElementById('gradeChart');
    if (!ctx) return;

    const grades = ['A', 'B', 'C', 'D', 'E'];
    const counts = grades.map(g => gradeDist[g] || 0);

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: grades,
            datasets: [{
                data: counts,
                backgroundColor: ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Render Skill Grade Distribution Chart
// OPTIMIZED: Uses pre-computed category_details from backend
function renderSkillGradeDistributionChart(categoryName, semesterData) {
    const canvasId = `skillGradeChart_${categoryName.replace(/\s+/g, '_')}`;
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    // Use pre-computed skill grade distribution from backend
    const gradeDistribution = semesterData.category_details?.[categoryName]?.skill_grade_distribution || {};

    const grades = ['A', 'B', 'C', 'D', 'E'];
    const counts = grades.map(g => gradeDistribution[g] || 0);

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: grades,
            datasets: [{
                data: counts,
                backgroundColor: ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Render OSCE Timeline
function renderOSCETimeline(timeline) {
    if (!timeline || timeline.length === 0) {
        return '<tr><td colspan="6" style="text-align: center; color: #64748b;">No OSCE data available</td></tr>';
    }

    return timeline.map(osce => {
        // Format students as "attempted/total"
        const studentsAttempted = osce.students_attempted || osce.num_students || 0;
        const totalStudents = osce.total_students || 0;
        const studentsDisplay = totalStudents > 0 ? `${studentsAttempted}/${totalStudents}` : studentsAttempted;

        return `
        <tr>
            <td style="color: #1a202c; font-weight: 500;">${osce.date_conducted || 'N/A'}</td>
            <td style="color: #475569; font-weight: 500;">${osce.batch_name || 'N/A'}</td>
            <td>
                <span style="display: inline-block; padding: 4px 12px; background: #f1f5f9; color: #475569; border-radius: 6px; font-size: 13px; font-weight: 500;">
                    ${osce.osce_level || 'N/A'}
                </span>
            </td>
            <td style="color: #1a202c;">${studentsDisplay}</td>
            <td style="color: #1a202c; font-weight: 500;">${osce.avg_score || 0}%</td>
            <td style="color: #1a202c; font-weight: 500;">${osce.pass_percentage || 0}%</td>
        </tr>
        `;
    }).join('');
}

// Render Skills Performance
function renderSkillsPerformance(skillsPerf) {
    const skills = Object.entries(skillsPerf);
    if (skills.length === 0) {
        return '<p style="color: #64748b;">No skills data available</p>';
    }

    // Group by category
    const byCategory = {};
    skills.forEach(([id, skill]) => {
        const cat = skill.category || 'Other';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push({ id, ...skill });
    });

    return Object.entries(byCategory).map(([category, catSkills]) => `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #1e40af; margin-bottom: 10px; font-size: 16px;">${category}</h4>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Skill Name</th>
                            <th>Attempts</th>
                            <th>Students</th>
                            <th>Avg Score</th>
                            <th>Pass Rate</th>
                            <th>Score Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${catSkills.map(skill => `
                            <tr>
                                <td><strong>${skill.skill_name || 'Unknown'}</strong></td>
                                <td>${skill.attempts || 0}</td>
                                <td>${skill.students_attempted || 0}</td>
                                <td>
                                    <div class="score-display">
                                        <span class="score-number">${skill.avg_score || 0}%</span>
                                        <span class="badge small-badge grade-${getGrade(skill.avg_score)}">${getGrade(skill.avg_score)}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${getProgressClass(skill.avg_score)}" style="width: ${skill.avg_score || 0}%"></div>
                                    </div>
                                </td>
                                <td style="color: ${getPassRateColor(skill.pass_rate)}">${skill.pass_rate || 0}%</td>
                                <td>${skill.lowest_score || 0}% - ${skill.highest_score || 0}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `).join('');
}

// Render Student Batch Report
// Helper: Extract unique procedures from student exam attempts
// OPTIMIZED: Uses pre-computed skills_performance data instead of looping through students
// Eliminates 1000-2000+ frontend iterations per page load
function extractUniqueProcedures(students, osceType = null) {
    // Use pre-computed skills_performance data from backend
    const semesterData = window.currentSemesterData || {};
    const skillsPerformance = semesterData.skills_performance || {};

    const procedures = Object.values(skillsPerformance)
        .filter(skill => {
            // Filter by OSCE type if specified
            if (osceType && skill.osce_types) {
                return skill.osce_types.includes(osceType);
            }
            return true;
        })
        .map(skill => skill.skill_name)
        .filter(name => name); // Remove any null/undefined names

    // Return sorted array for consistent column ordering (remove duplicates if any)
    return [...new Set(procedures)].sort();
}

// Helper: Get student's procedure scores (aggregated if multiple attempts)
// Returns both individual procedure percentages and total marks for average calculation
// REMOVED: getStudentProcedureScores() function
// This calculation is now pre-computed in the backend (process_metric_queue.py lines 673-701)
// and stored in student.procedure_scores_by_type field
// This eliminates 500-1000+ frontend calculations per page load

// Render procedure-by-procedure report when OSCE level is selected
function renderStudentStationReport(students, osceType) {
    if (!students || students.length === 0) {
        return '<tr><td colspan="10" style="text-align: center; color: #64748b;">No student data available for ' + osceType + '</td></tr>';
    }

    // Extract unique procedures
    const procedures = extractUniqueProcedures(students, osceType);

    if (procedures.length === 0) {
        return '<tr><td colspan="10" style="text-align: center; color: #64748b;">No procedure data available for ' + osceType + '</td></tr>';
    }

    return students.map((student, idx) => {
        // Filter exams for this OSCE type
        const typeExams = (student.exam_attempts || []).filter(e => e.exam_type === osceType);

        if (typeExams.length === 0) {
            return ''; // Skip students with no attempts in this OSCE type
        }

        // Use pre-computed procedure scores from backend (eliminates 500-1000+ calculations)
        const procedureScores = student.procedure_scores_by_type?.[osceType] || {};

        // Use pre-computed OSCE average from backend (already calculated using Total Marks Method)
        // When OSCE level is selected, backend provides type_student_batch_report with overall_avg field
        // This overall_avg represents the average for ONLY that specific OSCE type (Classroom/Mock/Final)
        // Calculated as: (type_marks_obtained / type_max_marks) Ã— 100
        let osceAvg = 0;

        // Check if overall_avg exists (from type breakdown) - this is the OSCE-specific average
        if (student.overall_avg !== undefined) {
            osceAvg = student.overall_avg;
        } else {
            // Fallback to type-specific fields (from main student report when viewing all data)
            if (osceType === 'Classroom') {
                osceAvg = student.classroom_score || 0;
            } else if (osceType === 'Mock') {
                osceAvg = student.mock_score || 0;
            } else if (osceType === 'Final') {
                osceAvg = student.final_score || 0;
            }
        }
        const osceGrade = getGrade(osceAvg);

        // Build row with procedure scores (with click handlers)
        const procCells = procedures.map(proc => {
            const score = procedureScores[proc];
            const scoreDisplay = score !== undefined ? score + '%' : '-';

            if (score !== undefined) {
                // Create procedure data object with all attempt info
                const procedureData = {
                    aggregated_score: score,
                    attempts: typeExams.filter(e => e.procedure_name === proc)
                };

                const procedureDataStr = JSON.stringify(procedureData)
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                return `<td class="procedure-cell-hover" onclick="showProcedureDetails('${student.name || 'Unknown'}', '${proc}', ${score}, ${procedureDataStr})" style="cursor: pointer;">${scoreDisplay}</td>`;
            }
            return `<td>-</td>`;
        }).join('');

        return `
            <tr class="student-row" data-index="${idx}" data-overall-grade="${osceGrade}" data-overall-avg="${osceAvg}">
                <td><strong>${student.name || 'Unknown'}</strong></td>
                ${procCells}
                <td style="font-weight: 600; text-align: center;">${osceAvg}%</td>
                <td style="font-weight: 600; text-align: center;">
                    <span style="padding: 4px 8px; background: ${getGradeColor(osceGrade)}; color: white; border-radius: 4px;">${osceGrade}</span>
                </td>
            </tr>
        `;
    }).filter(row => row !== '').join('');
}

function renderStudentBatchReport(students, osceLevel = null) {
    // If OSCE level is selected, render station-by-station report
    if (osceLevel && osceLevel !== 'All') {
        return renderStudentStationReport(students, osceLevel);
    }

    // Otherwise render the default report with Classroom/Mock/Final columns
    if (!students || students.length === 0) {
        // Calculate colspan based on flag
        const colspan = SHOW_MARKS_AND_DETAILS_COLUMNS ? 9 : 7;
        return `<tr><td colspan="${colspan}" style="text-align: center; color: #64748b;">No student data available</td></tr>`;
    }

    return students.map((student, idx) => {
        let rowHtml = `
        <tr class="student-row" data-index="${idx}" data-overall-grade="${student.overall_grade || '-'}" data-overall-avg="${student.overall_avg || 0}">
            <td><strong>${student.name || 'Unknown'}</strong></td>
            <td>
                <span style="font-weight: 600; color: #1a202c;">${student.overall_grade || '-'}</span> <span style="color: #64748b;">(${student.overall_avg || 0}%)</span>
            </td>
        `;

        // Conditionally add Marks column
        if (SHOW_MARKS_AND_DETAILS_COLUMNS) {
            rowHtml += `
            <td>
                <div style="font-size: 13px; color: #1a202c;">
                    <strong>${student.total_marks_obtained || 0}</strong> / ${student.total_max_marks || 0}
                </div>
            </td>
            `;
        }

        rowHtml += `
            <td>${formatScoreWithGrade(student.classroom_score, student.classroom_grade)}</td>
            <td>${formatScoreWithGrade(student.mock_score, student.mock_grade)}</td>
            <td>${formatScoreWithGrade(student.final_score, student.final_grade)}</td>
        `;

        // Conditionally add Details column
        if (SHOW_MARKS_AND_DETAILS_COLUMNS) {
            rowHtml += `
            <td><button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="viewStudentDetails(${idx})">View</button></td>
            `;
        }

        rowHtml += `</tr>`;
        return rowHtml;
    }).join('');
}

// Filter Students
function filterStudents() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const rows = document.querySelectorAll('.student-row');

    rows.forEach(row => {
        const name = row.querySelector('td strong').textContent.toLowerCase();
        row.style.display = name.includes(searchTerm) ? '' : 'none';
    });
}

// Sort Student Table by Overall Grade
function sortStudentTable(sortBy) {
    const table = document.getElementById('studentTable');
    const rows = Array.from(table.querySelectorAll('tbody .student-row'));

    // Determine sort direction (toggle between asc and desc)
    let isAscending = true;
    const sortSpan = document.getElementById('overallSort');
    if (sortSpan.textContent === ' â–²') {
        isAscending = false;
    }

    // Sort rows
    rows.sort((a, b) => {
        if (sortBy === 'overall') {
            const gradeOrder = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, '-': 0 };
            const gradeA = gradeOrder[a.getAttribute('data-overall-grade')] || 0;
            const gradeB = gradeOrder[b.getAttribute('data-overall-grade')] || 0;

            // If grades are equal, sort by percentage
            if (gradeA === gradeB) {
                const avgA = parseFloat(a.getAttribute('data-overall-avg'));
                const avgB = parseFloat(b.getAttribute('data-overall-avg'));
                return isAscending ? avgB - avgA : avgA - avgB;
            }

            return isAscending ? gradeB - gradeA : gradeA - gradeB;
        }
    });

    // Update table body with sorted rows
    const tbody = table.querySelector('tbody');
    rows.forEach(row => tbody.appendChild(row));

    // Update sort indicators
    document.getElementById('overallSort').textContent = isAscending ? ' â–²' : ' â–¼';
}

// Render Skills Analysis Table
function renderSkillsAnalysisTable(skillsPerf) {
    const skills = Object.values(skillsPerf);
    if (skills.length === 0) {
        return '<tr><td colspan="6" style="text-align: center; color: #64748b;">No skills data available</td></tr>';
    }

    return skills.map((skill, idx) => {
        const osceTypes = getOSCETypesForSkill(skill);
        const score = skill.avg_score_student_method || skill.avg_score || 0;
        const grade = getGrade(score);

        return `
            <tr class="skill-row" data-skill-name="${skill.skill_name || 'Unknown'}" data-score="${score}" data-grade="${grade}">
                <td><strong>${skill.skill_name || 'Unknown'}</strong></td>
                <td>${skill.category || 'Other'}</td>
                <td>${osceTypes}</td>
                <td>${skill.students_attempted || 0}</td>
                <td style="font-weight: 600; font-size: 15px; color: #1a202c;">
                    ${score}%
                </td>
                <td>
                    <span class="badge" style="padding: 8px 16px; font-weight: 600; font-size: 14px; background: ${getGradeColor(grade)}; color: white;">${grade}</span>
                </td>
            </tr>
        `;
    }).join('');
}

// Get OSCE Types for a Skill
function getOSCETypesForSkill(skill) {
    // Check if osce_types array exists and has values
    if (skill.osce_types && Array.isArray(skill.osce_types) && skill.osce_types.length > 0) {
        return skill.osce_types.join(', ');
    }

    return 'N/A';
}

// Filter Skills Analysis Table
function filterSkillsAnalysis() {
    const searchTerm = document.getElementById('skillsAnalysisSearch').value.toLowerCase();
    const rows = document.querySelectorAll('.skill-row');

    rows.forEach(row => {
        const skillName = row.getAttribute('data-skill-name').toLowerCase();
        row.style.display = skillName.includes(searchTerm) ? '' : 'none';
    });
}

// Sort Skills Table
function sortSkillsTable(sortBy) {
    const table = document.getElementById('skillsAnalysisTable');
    const rows = Array.from(table.querySelectorAll('tbody .skill-row'));

    // Determine sort direction (toggle between asc and desc)
    let isAscending = true;
    const sortSpan = document.getElementById(sortBy === 'score' ? 'scoreSort' : 'gradeSort');
    if (sortSpan.textContent === ' â–²') {
        isAscending = false;
    }

    // Sort rows
    rows.sort((a, b) => {
        let aVal, bVal;

        if (sortBy === 'score') {
            aVal = parseFloat(a.getAttribute('data-score'));
            bVal = parseFloat(b.getAttribute('data-score'));
        } else if (sortBy === 'grade') {
            const gradeOrder = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
            aVal = gradeOrder[a.getAttribute('data-grade')] || 0;
            bVal = gradeOrder[b.getAttribute('data-grade')] || 0;
        }

        return isAscending ? bVal - aVal : aVal - bVal;
    });

    // Update table body with sorted rows
    const tbody = table.querySelector('tbody');
    rows.forEach(row => tbody.appendChild(row));

    // Update sort indicators
    document.getElementById('scoreSort').textContent = '';
    document.getElementById('gradeSort').textContent = '';

    if (sortBy === 'score') {
        sortSpan.textContent = isAscending ? ' â–²' : ' â–¼';
    } else {
        sortSpan.textContent = isAscending ? ' â–²' : ' â–¼';
    }
}

// View Student Details
function viewStudentDetails(index) {
    const student = semesterMetricsData.student_batch_report[index];

    const modalTitle = document.getElementById('studentModalTitle');
    const modalBody = document.getElementById('studentModalBody');

    modalTitle.textContent = `${student.name} - Detailed Report`;

    modalBody.innerHTML = `
        <div style="margin-bottom: 25px;">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Overall Average</div>
                    <div class="kpi-value">${student.overall_avg}%<span class="grade-badge grade-${student.overall_grade}">${student.overall_grade}</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Marks</div>
                    <div class="kpi-value" style="font-size: 24px;">${student.total_marks_obtained || 0} <span style="font-size: 18px; color: #64748b;">/ ${student.total_max_marks || 0}</span></div>
                    <div class="kpi-subtitle">Obtained / Maximum</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Skills Passed</div>
                    <div class="kpi-value">${student.skills_passed} / ${student.skills_attempted}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total OSCEs</div>
                    <div class="kpi-value">${student.total_osces}</div>
                </div>
            </div>
        </div>

        <h4 style="margin-bottom: 15px; color: #1a202c;">OSCE Type Performance</h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">CLASSROOM</div>
                <div style="font-size: 24px; font-weight: 700; color: #1e40af;">${student.classroom_score || '-'}${student.classroom_score ? '%' : ''}</div>
                <span class="badge grade-${student.classroom_grade}">${student.classroom_grade}</span>
            </div>
            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">MOCK</div>
                <div style="font-size: 24px; font-weight: 700; color: #1e40af;">${student.mock_score || '-'}${student.mock_score ? '%' : ''}</div>
                <span class="badge grade-${student.mock_grade}">${student.mock_grade}</span>
            </div>
            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">FINAL</div>
                <div style="font-size: 24px; font-weight: 700; color: #1e40af;">${student.final_score || '-'}${student.final_score ? '%' : ''}</div>
                <span class="badge grade-${student.final_grade}">${student.final_grade}</span>
            </div>
        </div>

        <h4 style="margin-bottom: 15px; color: #1a202c;">Category Breakdown</h4>
        <div style="background: #f8fafc; padding: 20px; border-radius: 6px; margin-bottom: 25px;">
            ${Object.entries(student.category_breakdown || {}).map(([cat, data]) => `
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-weight: 600; color: #475569;">${cat}</span>
                        <span style="font-weight: 600; color: #1e40af;">${data.avg_score}% <span style="font-size: 12px; color: #64748b;">(${data.attempts} attempts)</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getProgressClass(data.avg_score)}" style="width: ${data.avg_score}%"></div>
                    </div>
                </div>
            `).join('')}
        </div>

        <h4 style="margin-bottom: 15px; color: #1a202c;">Exam History</h4>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Procedure</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Score</th>
                        <th>Marks</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    ${(student.exam_attempts || []).map(exam => `
                        <tr>
                            <td>${exam.test_date ? new Date(exam.test_date).toLocaleDateString() : 'N/A'}</td>
                            <td><strong>${exam.procedure_name || 'Unknown'}</strong></td>
                            <td>${exam.category || 'N/A'}</td>
                            <td><span class="badge ${getBadgeClass(exam.exam_type)}">${exam.exam_type || 'N/A'}</span></td>
                            <td><span class="badge grade-${getGrade(exam.score)}">${exam.score}%</span></td>
                            <td><strong>${exam.marks_obtained || 0}</strong> / ${exam.max_marks || 0}</td>
                            <td><span class="badge ${exam.pass ? 'badge-success' : 'badge-danger'}">${exam.pass ? 'PASS' : 'FAIL'}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('studentModal').classList.add('active');
}

function closeStudentModal() {
    document.getElementById('studentModal').classList.remove('active');
}

// Close Category Drill-down
function closeCategoryDrilldown() {
    const drilldownContainer = document.getElementById('categoryDrilldown');
    drilldownContainer.style.display = 'none';
    drilldownContainer.innerHTML = '';
}

// ====================================
// CATEGORY DRILL-DOWN FUNCTIONS
// ====================================

// OPTIMIZED: Uses pre-computed category_details from backend
function getTotalSkillsInCategory(data, categoryName) {
    return data.category_details?.[categoryName]?.total_skills || 0;
}

// OPTIMIZED: Uses pre-computed category_details from backend
function getHighestScoringSkill(data, categoryName) {
    const categoryDetail = data.category_details?.[categoryName];
    if (!categoryDetail) return null;

    // Return skill object with name and score for compatibility
    return {
        skill_name: categoryDetail.highest_scoring_skill.name,
        avg_score_student_method: categoryDetail.highest_scoring_skill.score
    };
}

// OPTIMIZED: Uses pre-computed category_details from backend
function getLowestScoringSkill(data, categoryName) {
    const categoryDetail = data.category_details?.[categoryName];
    if (!categoryDetail) return null;

    // Return skill object with name and score for compatibility
    return {
        skill_name: categoryDetail.lowest_scoring_skill.name,
        avg_score_student_method: categoryDetail.lowest_scoring_skill.score
    };
}

function showCategoryDrilldown(categoryName, semesterData) {
    const totalSkills = getTotalSkillsInCategory(semesterData, categoryName);
    const highestSkill = getHighestScoringSkill(semesterData, categoryName);
    const lowestSkill = getLowestScoringSkill(semesterData, categoryName);

    if (!highestSkill || !lowestSkill) {
        alert('No skills data available for this category');
        return;
    }

    const highestScore = highestSkill.avg_score_student_method || highestSkill.avg_score;
    const lowestScore = lowestSkill.avg_score_student_method || lowestSkill.avg_score;

    const drilldownContainer = document.getElementById('categoryDrilldown');

    drilldownContainer.innerHTML = `
        <div class="chart-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="section-title" style="margin: 0;">${categoryName} - Skills Analysis</h3>
                <button class="modal-close" style="padding: 0; width: 40px; height: 40px; font-size: 24px;" onclick="closeCategoryDrilldown()">&times;</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <!-- Left Side: KPI Cards -->
                <div>
                    <div class="kpi-grid" style="margin-bottom: 0; grid-template-columns: 1fr;">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Skills Assessed</div>
                            <div class="kpi-value">${totalSkills}</div>
                            <div class="kpi-subtitle">Unique procedures in ${categoryName}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Highest Scoring Skill</div>
                            <div class="kpi-value">${highestScore}%<span class="grade-badge grade-${getGrade(highestScore)}">${getGrade(highestScore)}</span></div>
                            <div class="kpi-subtitle">${highestSkill.skill_name}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Lowest Scoring Skill</div>
                            <div class="kpi-value">${lowestScore}%<span class="grade-badge grade-${getGrade(lowestScore)}">${getGrade(lowestScore)}</span></div>
                            <div class="kpi-subtitle">${lowestSkill.skill_name}</div>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Skill Grade Distribution Chart -->
                <div>
                    <h3 class="section-title" style="margin-top: 0;">Skills Grade Distribution</h3>
                    <div class="chart-wrapper" style="height: 320px;">
                        <canvas id="skillGradeChart_${categoryName.replace(/\s+/g, '_')}"></canvas>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Show the drill-down and scroll to it
    drilldownContainer.style.display = 'block';
    drilldownContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Render the skill grade distribution chart after DOM is updated
    setTimeout(() => {
        renderSkillGradeDistributionChart(categoryName, semesterData);
    }, 0);
}

function renderCategorySkillsTable(data, categoryName) {
    const skillsInCategory = Object.values(data.skills_performance || {})
        .filter(skill => skill.category === categoryName)
        .sort((a, b) => {
            const scoreA = a.avg_score_student_method || a.avg_score;
            const scoreB = b.avg_score_student_method || b.avg_score;
            return scoreB - scoreA;  // Sort by score descending
        });

    if (skillsInCategory.length === 0) {
        return '<tr><td colspan="6" style="text-align: center; color: #64748b;">No skills found</td></tr>';
    }

    return skillsInCategory.map(skill => {
        const displayScore = skill.avg_score_student_method || skill.avg_score;
        return `
            <tr>
                <td><strong>${skill.skill_name}</strong></td>
                <td>${skill.attempts}</td>
                <td>${skill.students_attempted}</td>
                <td>
                    <div class="score-display">
                        <span class="score-number">${displayScore}%</span>
                        <span class="badge small-badge grade-${getGrade(displayScore)}">${getGrade(displayScore)}</span>
                    </div>
                </td>
                <td style="color: ${getPassRateColor(skill.pass_rate)}">${skill.pass_rate}%</td>
                <td>${skill.lowest_score}% - ${skill.highest_score}%</td>
            </tr>
        `;
    }).join('');
}


// Helper Functions
function formatOSCEDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        const options = { month: 'short', day: 'numeric', year: 'numeric' };
        return date.toLocaleDateString('en-US', options);
    } catch (e) {
        return dateString;
    }
}

function getGrade(percentage) {
    if (!percentage && percentage !== 0) return '-';
    if (percentage >= 90) return 'A';
    if (percentage >= 80) return 'B';
    if (percentage >= 70) return 'C';
    if (percentage >= 60) return 'D';
    return 'E';
}

function getPassRateColor(rate) {
    if (!rate) return '#64748b';
    if (rate >= 80) return '#22c55e';
    if (rate >= 60) return '#fbbf24';
    return '#ef4444';
}

function getGradeColor(grade) {
    const colors = {
        'A': '#4CAF50',      // Green
        'B': '#8BC34A',      // Light Green
        'C': '#FFC107',      // Yellow
        'D': '#FF9800',      // Orange
        'E': '#F44336'       // Red
    };
    return colors[grade] || '#64748b';
}

function getProgressClass(score) {
    if (!score) return 'low';
    if (score >= 80) return 'high';
    if (score >= 60) return 'medium';
    return 'low';
}

function getBadgeClass(osceType) {
    const types = {
        'Final': 'badge-success',
        'Mock': 'badge-warning',
        'Classroom': 'badge-info'
    };
    return types[osceType] || 'badge-secondary';
}

function formatScore(score, grade) {
    if (!score && score !== 0) return '-';
    return `<span class="badge small-badge grade-${grade}">${score}%</span>`;
}

function formatScoreWithGrade(score, grade) {
    if (!score && score !== 0) return '-';
    return `<span style="font-weight: 600; color: #1a202c;">${grade || '-'}</span> <span style="color: #64748b;">(${score}%)</span>`;
}

// Clear Filters
function clearSemesterFilters() {
    // Reset all dropdowns to their default values
    // Reset searchable dropdown
    document.getElementById('semInstitutionFilter').value = '';
    const toggle = document.getElementById('semInstitutionToggle');
    if (toggle) {
        const textSpan = toggle.querySelector('.placeholder, .selected-text, span:not(.arrow)');
        if (textSpan && !textSpan.classList.contains('arrow')) {
            textSpan.textContent = 'Select Institution/Hospital *';
            textSpan.className = 'placeholder';
        }
    }
    
    // Clear selected state from options
    const optionsDiv = document.getElementById('semInstitutionOptions');
    if (optionsDiv) {
        optionsDiv.querySelectorAll('.searchable-dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
        });
    }
    
    // Reset other filters
    document.getElementById('semAcademicYearFilter').value = '';
    document.getElementById('semSemesterFilter').value = '';
    document.getElementById('semOsceLevelFilter').value = 'All';

    // Reset dashboard to initial state
    const dashboard = document.getElementById('semesterDashboard');
    if (dashboard) {
        dashboard.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">Select Institution/Hospital and Academic Year to view semester metrics</p>
                <p class="empty-subtitle">Use the filters above to get started</p>
            </div>
        `;
    }
}


// Close modal on outside click
document.getElementById('studentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStudentModal();
    }
});

// ESC key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeStudentModal();
    }
});

// Download Metrics Report as PDF
function downloadMetricsReportPDF() {
    // Get filter values
    const institutionValue = document.getElementById('semInstitutionFilter').value;
    const academicYear = document.getElementById('semAcademicYearFilter').value;
    const semester = document.getElementById('semSemesterFilter').value;
    const osceLevel = document.getElementById('semOsceLevelFilter').value;

    // Validate required parameters
    if (!institutionValue) {
        alert('Please select an Institution/Hospital');
        return;
    }
    if (!academicYear) {
        alert('Please select an Academic Year');
        return;
    }
    if (!semester) {
        alert('Please select a Semester to download the report');
        return;
    }

    // Get unit name from searchable dropdown
    const toggle = document.getElementById('semInstitutionToggle');
    const toggleText = toggle.querySelector('.selected-text, .placeholder');
    let unitName = toggleText ? toggleText.textContent.replace(' (Institution)', '').replace(' (Hospital)', '').trim() : '';

    if (!unitName || unitName.includes('Select Institution')) {
        alert('Could not determine institution name. Please try selecting again.');
        return;
    }

    // Build URL with parameters
    const url = '/api/download-metrics-report/';
    const params = new URLSearchParams();
    params.append('unit_name', unitName);
    params.append('academic_year', academicYear);
    params.append('semester', semester);
    params.append('osce_level', osceLevel || 'All');
    params.append('show_marks_details', SHOW_MARKS_AND_DETAILS_COLUMNS.toString());

    const fullUrl = url + '?' + params.toString();

    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = fullUrl;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize semester tab on page load if it's active
document.addEventListener('DOMContentLoaded', function() {
    const overallReportTab = document.getElementById('overall-report-tab');
    if (overallReportTab && overallReportTab.classList.contains('active')) {
        loadSemesterMetricsData();
    }

    // Add event listener to semester filter to reset OSCE level when "All Semesters" is selected
    const semesterFilter = document.getElementById('semSemesterFilter');
    const osceLevelFilter = document.getElementById('semOsceLevelFilter');
    if (semesterFilter && osceLevelFilter) {
        semesterFilter.addEventListener('change', function() {
            // If "All Semesters" is selected (empty value), reset OSCE Level to "All"
            if (this.value === '') {
                osceLevelFilter.value = 'All';
            }
        });
    }

    // Initialize Candidate Report dropdown
    initCandidateSearchableDropdown();
    setupCandidateFilters();
});

// Also try to initialize immediately if DOM is already loaded
if (document.readyState === 'loading') {
    // DOM is still loading, wait for DOMContentLoaded
} else {
    // DOM is already loaded, initialize immediately
    const overallReportTab = document.getElementById('overall-report-tab');
    if (overallReportTab && overallReportTab.classList.contains('active')) {
        loadSemesterMetricsData();
    }

    // Add event listener to semester filter to reset OSCE level when "All Semesters" is selected
    const semesterFilter = document.getElementById('semSemesterFilter');
    const osceLevelFilter = document.getElementById('semOsceLevelFilter');
    if (semesterFilter && osceLevelFilter) {
        semesterFilter.addEventListener('change', function() {
            // If "All Semesters" is selected (empty value), reset OSCE Level to "All"
            if (this.value === '') {
                osceLevelFilter.value = 'All';
            }
        });
    }

    // Initialize Candidate Report dropdown
    initCandidateSearchableDropdown();
    setupCandidateFilters();
}

// ===== PROCEDURE DETAILS MODAL =====

// Show procedure details modal
function showProcedureDetails(studentName, procedureName, procedureScore, procedureData) {
    const modal = document.getElementById('procedure-modal-slider');
    const overlay = document.getElementById('procedure-modal-overlay');

    if (!modal || !overlay) return;

    // Set header
    const headerTitle = document.getElementById('procedure-modal-title');
    if (headerTitle) {
        headerTitle.textContent = procedureName;
    }

    const headerSubtitle = document.getElementById('procedure-modal-subtitle');
    if (headerSubtitle) {
        headerSubtitle.textContent = `Student: ${studentName}`;
    }

    // Set score and grade
    const scoreDisplay = document.getElementById('procedure-score-display');
    if (scoreDisplay) {
        scoreDisplay.textContent = `${procedureScore.toFixed(2)}%`;
    }

    const gradeDisplay = document.getElementById('procedure-grade-display');
    if (gradeDisplay) {
        const grade = getGrade(procedureScore);
        gradeDisplay.textContent = grade;
        gradeDisplay.style.background = getGradeColor(grade);
        gradeDisplay.style.color = 'white';
    }

    // Clear and populate attempts list
    const attemptsList = document.getElementById('procedure-modal-attempts');
    if (attemptsList && procedureData && procedureData.attempts) {
        attemptsList.innerHTML = '';

        // Add individual attempts
        if (procedureData.attempts.length > 0) {
            procedureData.attempts.forEach((attempt, idx) => {
                const attemptCard = renderAttemptCard(attempt, idx, studentName, procedureName);
                attemptsList.appendChild(attemptCard);
            });
        } else {
            const noData = document.createElement('div');
            noData.style.cssText = 'padding: 20px; text-align: center; color: #64748b;';
            noData.textContent = 'No attempt data available';
            attemptsList.appendChild(noData);
        }
    }

    // Show modal
    overlay.classList.add('active');
    modal.classList.add('active');
}

// Render individual attempt card
function renderAttemptCard(attempt, index, studentName, procedureName) {
    const card = document.createElement('div');
    card.className = 'attempt-card';
    card.id = `attempt-${index}`;

    const isExpanded = index === 0; // Expand first attempt by default

    // Header
    const headerDiv = document.createElement('div');
    headerDiv.className = 'attempt-header';
    headerDiv.style.cursor = 'pointer';
    headerDiv.onclick = () => toggleAttemptDetails(index);

    const osceType = attempt.exam_type || 'N/A';
    const score = attempt.score || 0;
    const marksObtained = attempt.marks_obtained || 0;
    const marksMax = attempt.max_marks || 0;
    const testDate = attempt.test_date || '';

    // Format date if available
    let formattedDate = '';
    if (testDate) {
        try {
            const date = new Date(testDate);
            formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch (e) {
            formattedDate = testDate;
        }
    }

    headerDiv.innerHTML = `
        <div style="flex: 1;">
            <h4>${osceType} OSCE${formattedDate ? ` - ${formattedDate}` : ''}</h4>
            <p>${marksObtained}/${marksMax} marks</p>
        </div>
        <div class="attempt-score-badge">
            <div class="attempt-score-value">${score}%</div>
            <span class="attempt-expand-icon" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'};">â–¼</span>
        </div>
    `;

    card.appendChild(headerDiv);

    // Details section (initially hidden)
    const detailsDiv = document.createElement('div');
    detailsDiv.className = 'attempt-details';
    detailsDiv.id = `attempt-details-${index}`;
    detailsDiv.style.display = isExpanded ? 'block' : 'none';

    const detailsHTML = `
        <div class="detail-section">
            <h5>Exam Details</h5>
            <table class="detail-table">
                <tbody>
                    <tr>
                        <td>Assessors</td>
                        <td>${attempt.assessor_names && attempt.assessor_names.length > 0 ? attempt.assessor_names.join(', ') : 'N/A'}</td>
                    </tr>
                    <tr>
                        <td>Marks Obtained</td>
                        <td>${marksObtained}/${marksMax}</td>
                    </tr>
                    <tr>
                        <td>Percentage</td>
                        <td>${score}%</td>
                    </tr>
                    ${attempt.checklist_summary ? `
                        <tr>
                            <td>Total Steps</td>
                            <td>${attempt.checklist_summary.total_steps || 0}</td>
                        </tr>
                        <tr>
                            <td>Completed Steps</td>
                            <td style="color: #10b981;">${attempt.checklist_summary.steps_completed || 0}</td>
                        </tr>
                        <tr>
                            <td>Missed Steps</td>
                            <td style="color: #f59e0b;">${attempt.checklist_summary.steps_missed || 0}</td>
                        </tr>
                        <tr>
                            <td>Critical Steps Total</td>
                            <td>${attempt.checklist_summary.critical_steps_total || 0}</td>
                        </tr>
                        <tr>
                            <td>Missed Critical Steps</td>
                            <td style="color: #ef4444;">${attempt.checklist_summary.critical_steps_missed || 0}</td>
                        </tr>
                    ` : ''}
                </tbody>
            </table>
            ${attempt.checklist_summary && attempt.checklist_summary.missed_critical_steps_list && attempt.checklist_summary.missed_critical_steps_list.length > 0 ? `
                <div style="margin-top: 12px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 8px;">
                    <p style="margin: 0 0 8px 0; color: #991b1b; font-weight: 600; font-size: 0.875rem;">Missed Critical Steps:</p>
                    <ul style="margin: 0; padding-left: 20px; color: #7f1d1d; font-size: 0.875rem; line-height: 1.6;">
                        ${attempt.checklist_summary.missed_critical_steps_list.map(step => `<li style="margin-bottom: 4px;">${step}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>

        <div class="detail-section">
            <h5>Examiner Notes</h5>
            <div style="padding: 16px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 8px;">
                <p style="margin: 0; color: #1e3a8a; font-size: 0.875rem; line-height: 1.6;">${attempt.notes || '-'}</p>
            </div>
        </div>
    `;

    detailsDiv.innerHTML = detailsHTML;
    card.appendChild(detailsDiv);

    return card;
}

// Toggle attempt details
function toggleAttemptDetails(index) {
    const detailsDiv = document.getElementById(`attempt-details-${index}`);
    const attemptCard = document.getElementById(`attempt-${index}`);
    const expandIcon = attemptCard.querySelector('.attempt-expand-icon');

    if (!detailsDiv) return;

    const isVisible = detailsDiv.style.display === 'block';
    detailsDiv.style.display = isVisible ? 'none' : 'block';

    if (expandIcon) {
        expandIcon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
    }
}

// Close procedure modal
function closeProcedureModal() {
    const modal = document.getElementById('procedure-modal-slider');
    const overlay = document.getElementById('procedure-modal-overlay');

    if (modal) modal.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
}

// Close modal when clicking on overlay
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('procedure-modal-overlay');
    if (overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closeProcedureModal();
            }
        });
    }

    // Close button handler
    const closeBtn = document.getElementById('procedure-modal-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeProcedureModal);
    }
});

// ESC key to close procedure modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeProcedureModal();
    }
});
</script>

<!-- Procedure Details Modal HTML -->
<div id="procedure-modal-overlay" class="procedure-modal-overlay"></div>
<div id="procedure-modal-slider" class="procedure-modal-slider">
    <!-- Modal Header -->
    <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 id="procedure-modal-title">Procedure Name</h3>
            <p id="procedure-modal-subtitle" style="margin: 8px 0 0 0; font-size: 0.875rem; color: #64748b;">Student: Name</p>
        </div>
        <button id="procedure-modal-close" class="close-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Modal Body (Scrollable) -->
    <div class="panel-body">
        <!-- Score & Grade Info Cards -->
        <div class="procedure-info-grid">
            <div class="procedure-info-card">
                <label>Aggregated Score</label>
                <div class="info-value" id="procedure-score-display">0%</div>
            </div>
            <div class="procedure-info-card grade-card">
                <label>Grade</label>
                <div class="info-value" id="procedure-grade-display">-</div>
            </div>
        </div>

        <!-- Attempts List -->
        <div id="procedure-modal-attempts"></div>
    </div>
</div>
{% endblock %}
