{% extends 'assessments/base.html' %}
{% load static %}

{% block title %}Assign Roles{% endblock %}

{% block content %}
<link href="{% static 'assessments/css/list.css' %}" rel="stylesheet">

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1>User Management</h1>
        <p class="text-muted">Create new users and assign roles</p>
    </div>
    <div class="header-right">
        <button class="btn btn-primary" onclick="toggleCreateUserPanel()">
            <i class="fas fa-user-plus"></i> Create User
        </button>
    </div>
</div>

<!-- Search Bar -->
<div class="search-filter-bar">
    <div class="search-box">
        <input type="text" 
               placeholder="Search users..." 
               id="userSearchInput"
               oninput="filterUsers(this.value)">
    </div>
</div>

<!-- Create User Side Panel -->
<div id="createUserPanel" class="side-panel">
    <div class="side-panel-header">
        <h3 id="createUserTitle">Create New User</h3>
        <button type="button" class="close" onclick="closeCreateUserPanel()">&times;</button>
    </div>
    <div class="side-panel-body">
        <form id="createUserForm">
            {% csrf_token %}
            
            <!-- Step 1: Basic User Information -->
            <div class="form-step active" id="step1">
                <h4 class="step-title">Basic Information</h4>
                <div class="form-group">
                    <label for="userName">Full Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="userName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="userEmail">Email Address <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="userEmail" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="userPhone">Phone Number <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="userPhone" name="phone" required>
                </div>
            </div>
                        
            <!-- Step 3: Access Type Selection (for regular users) -->
            <div class="form-step" id="step2">
                <h4 class="step-title">Access Type for OSCE App</h4>
                <div class="form-group">
                    <label>What should this user be able to do?</label>
                    <div class="access-options">
                        <div class="access-option">
                            <input type="checkbox" id="takeSkillathon" name="access_types" value="skillathon">
                            <label for="takeSkillathon" class="access-label">
                                <div class="access-info">
                                    <div class="access-name">Take Skillathons</div>
                                    <div class="access-description">Allow user to participate in skillathon events</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="access-option">
                            <input type="checkbox" id="takeOSCE" name="access_types" value="osce">
                            <label for="takeOSCE" class="access-label">
                                <div class="access-info">
                                    <div class="access-name">Take OSCE</div>
                                    <div class="access-description">Allow user to participate in OSCE exams</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Institution & Hospital Selection (for regular users) -->
            <div class="form-step" id="step3">
                <h4 class="step-title">Institution & Hospital</h4>
                <div class="form-group">
                    <label class="form-label">Institution</label>
                    <div id="institutionChips" class="chip-container"></div>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="institutionDropdownBtn">Select Institution</button>
                        <div class="dropdown-search" id="institutionSearchContainer">
                            <input type="text" id="institutionSearch" placeholder="Search institution">
                        </div>
                        <ul class="dropdown-list" id="institutionDropdownList"></ul>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Hospital</label>
                    <div id="hospitalChips" class="chip-container"></div>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="hospitalDropdownBtn">Select Hospital</button>
                        <div class="dropdown-search" id="hospitalSearchContainer">
                            <input type="text" id="hospitalSearch" placeholder="Search hospital">
                        </div>
                        <ul class="dropdown-list" id="hospitalDropdownList"></ul>
                    </div>
                </div>

                <!-- Skillathon Selection (optional and always visible) -->
                <div class="form-group" id="skillathonSelection">
                    <label class="form-label">Select Skillathon (Optional)</label>
                    <div id="skillathonChips" class="chip-container"></div>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="skillathonDropdownBtn">Select Skillathon</button>
                        <div class="dropdown-search" id="skillathonSearchContainer">
                            <input type="text" id="skillathonSearch" placeholder="Search skillathon">
                        </div>
                        <ul class="dropdown-list" id="skillathonDropdownList"></ul>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Full Access Overrides</label>
                    <div class="full-access-options simple">
                        <label class="full-access-simple" for="accessAllInstitutes">
                            <input type="checkbox" id="accessAllInstitutes" name="access_all_institutes">
                            <span>Access to all institutes</span>
                        </label>
                        <label class="full-access-simple" for="accessAllHospitals">
                            <input type="checkbox" id="accessAllHospitals" name="access_all_hospitals">
                            <span>Access to all hospitals</span>
                        </label>
                        <label class="full-access-simple" for="accessAllSkillathons">
                            <input type="checkbox" id="accessAllSkillathons" name="access_all_skillathons">
                            <span>Access to all skillathons</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Role Assignment (for regular users) -->
            <div class="form-step" id="step4">
                <h4 class="step-title">Assign Role</h4>
                <div class="form-group">
                    <label>Select Role <span class="text-danger">*</span></label>
                    <div class="roles-container">
                        <div class="roles-list" id="rolesList">
                            <!-- Roles will be loaded here via AJAX -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="form-navigation">
                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                    <span id="submitButtonText">Create User</span>
                    <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                </button>
            </div>

        </form>
    </div>
</div>
<div id="sidePanelOverlay" class="side-panel-overlay" onclick="closeCreateUserPanel()"></div>

<!-- Users Table -->
<div class="card">
    <table class="table" id="usersTable">
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Status</th>
                <th>Current Roles</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <!-- Users will be loaded here via AJAX -->
        </tbody>
    </table>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state">
        <div class="empty-state-content">
            <i class="fas fa-users"></i>
            <p>No users found</p>
            <button class="btn btn-primary" onclick="toggleAssignRolePanel()">
                Assign Roles
            </button>
        </div>
    </div>
</div>

<!-- Remove Role Modal -->
<div class="modal fade" id="removeRoleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Remove Role</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove the role <strong><span id="removeRoleName"></span></strong> from <strong><span id="removeUserName"></span></strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                <form id="removeRoleForm" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Remove Role</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Delete User</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteUserEmail"></strong>?</p>
                <p class="text-muted">This will permanently remove the user and their access.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal" id="deleteCancelBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteConfirmBtn">
                    <span class="btn-text">Delete</span>
                    <span class="spinner-border spinner-border-sm" style="display:none; margin-left:8px;" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
    <input type="hidden" id="deleteUserId" value="">
</div>

<script type="application/json" id="users-data">{{ users_json|safe }}</script>

<style>


.btn-secondary {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    color: #495057;
}

.btn-primary {
    background: #F16564;
    border: 1px solid #F16564;
    color: white;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary:hover {
    background: #e55a59;
    border-color: #e55a59;
}
/* Role assignment specific styles */
.roles-container {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    background: #f8fafc;
}

.roles-header {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
}

.roles-list {
    max-height: 300px;
    overflow-y: auto;
}

.role-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    transition: all 0.2s;
}

.role-item:hover {
    border-color: #F16564;
    box-shadow: 0 2px 4px rgba(241, 101, 100, 0.1);
}

.role-item .form-check {
    margin: 0;
}

.role-item .form-check-label {
    cursor: pointer;
    margin-left: 8px;
    width: 100%;
}

.role-name {
    font-weight: 500;
    color: #2d3748;
    font-size: 14px;
}

.role-description {
    font-size: 12px;
    color: #718096;
    margin-top: 2px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-icon {
    width: 36px;
    height: 36px;
    background: #F16564;
    color: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}

.user-name {
    font-weight: 500;
    color: #2d3748;
}

.user-email {
    font-size: 12px;
    color: #718096;
}

.roles-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.full-access-options.simple {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.full-access-simple {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 14px;
    color: #374151;
}

.full-access-simple input {
    width: 16px;
    height: 16px;
}

.status-toggle {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.status-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.status-toggle .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5f5;
    transition: .3s;
}

.status-toggle .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .3s;
}

.status-toggle input:checked + .slider {
    background-color: #1AA09A;
}

.status-toggle input:checked + .slider:before {
    transform: translateX(26px);
}

.status-toggle .slider.round {
    border-radius: 24px;
}

.status-toggle .slider.round:before {
    border-radius: 50%;
}

.role-badge {
    background: #edf2f7;
    color: #4a5568;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.form-actions {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: #4a5568;
    margin-bottom: 8px;
}

.form-control {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
}

.form-control:focus {
    border-color: #F16564;
    box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
}

.btn-outline-secondary {
    border: 1px solid #e2e8f0;
    color: #4a5568;
    background: white;
}

.btn-outline-secondary:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
}

.btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 6px;
    transition: all 0.2s;
}

/* Multi-step form styles */
.form-step {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.form-step.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.step-title {
    color: #374151;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e5e7eb;
}

/* Role selection styles */
.role-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.role-option {
    position: relative;
}

.role-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.role-label {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.role-label:hover {
    border-color: #F16564;
    box-shadow: 0 2px 8px rgba(241, 101, 100, 0.1);
}

.role-option input[type="radio"]:checked + .role-label {
    border-color: #F16564;
    background: #fef2f2;
    box-shadow: 0 2px 8px rgba(241, 101, 100, 0.15);
}

/* Access type selection styles */
.access-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.access-option {
    position: relative;
}

.access-option input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.access-label {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.access-label:hover {
    border-color: #F16564;
    box-shadow: 0 2px 8px rgba(241, 101, 100, 0.1);
}

.access-option input[type="checkbox"]:checked + .access-label {
    border-color: #F16564;
    background: #fef2f2;
    box-shadow: 0 2px 8px rgba(241, 101, 100, 0.15);
}

.role-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    flex-shrink: 0;
}

.role-icon.super-admin {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.role-icon.regular-user {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.role-icon.role-default {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

.role-info {
    flex: 1;
}

.role-info .role-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 16px;
    margin-bottom: 4px;
}

.role-info .role-description {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.4;
}

/* Access icon styles */
.access-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    flex-shrink: 0;
}

.access-icon.skillathon {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.access-icon.osce {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.access-info {
    flex: 1;
}

.access-info .access-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 16px;
    margin-bottom: 4px;
}

.access-info .access-description {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.4;
}

/* Form navigation */
.form-navigation {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Custom multiselect (chips + search) */
.chips-select {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 6px 8px;
    background: #fff;
    min-height: 42px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    cursor: text;
}
.chips-select .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #F16564;
    color: #fff;
    padding: 4px 8px;
    border-radius: 16px;
    font-size: 12px;
}
.chips-select .chip .remove {
    cursor: pointer;
    opacity: 0.9;
}
.chips-select input {
    border: none;
    outline: none;
    min-width: 120px;
    flex: 1 1 160px;
    font-size: 14px;
}
.chips-dropdown {
    position: relative;
}
.chips-dropdown .menu {
    position: absolute;
    z-index: 9999;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    margin-top: 4px;
    width: 100%;
    max-height: 260px;
    overflow: auto;
}
.chips-dropdown .item {
    padding: 10px 12px;
    cursor: pointer;
}
.chips-dropdown .item:hover {
    background: #f7fafc;
}
.hidden-select { display: none; }

/* Chip UI (match assignments) */
.chip-container {
    margin-top: 8px;
    margin-bottom: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.chip {
    display: inline-flex;
    align-items: center;
    background-color: #F16564;
    color: #fff;
    padding: 5px 10px;
    border-radius: 14px;
    font-size: 12px;
}
.chip .remove {
    margin-left: 6px;
    cursor: pointer;
    font-weight: 700;
    opacity: 0.9;
}
/* Remove bullets from dropdown lists */
.dropdown-container ul,
.dropdown-list {
    list-style: none;
    margin: 0;
    padding: 0;
}
.dropdown-list li {
    list-style: none;
}

.dropdown-list li label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    width: 100%;
    cursor: pointer;
}

.dropdown-list li input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
}

.dropdown-list li label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    width: 100%;
    cursor: pointer;
}

.dropdown-list li input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
}

/* Dropdown UI (same behavior as assignments) */
.dropdown-container { position: relative; }
.dropdown-btn {
    width: 100%;
    padding: 10px;
    font-size: 14px;
    color: #333;
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    border-radius: 6px;
    text-align: left;
    cursor: pointer;
}
.dropdown-btn:hover { background-color: #e9ecef; }
.dropdown-list {
    position: absolute;
    top: calc(100% + 48px);
    width: 100%;
    background: #fff;
    border: 1px solid #ced4da;
    border-radius: 0 0 6px 6px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    max-height: 240px;
    overflow-y: auto;
    margin-top: 0;
    display: none;
    z-index: 1000;
}
.dropdown-list.show { display: block; }
.dropdown-list li { padding: 10px 12px; cursor: pointer; }
.dropdown-list li:hover { background: #f7fafc; }

.dropdown-search {
    position: absolute;
    top: 100%;
    width: 100%;
    background: #fff;
    border: 1px solid #ced4da;
    border-radius: 6px 6px 0 0;
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    padding: 8px 10px;
    display: none;
    z-index: 1001;
}

.dropdown-search.show { display: block; }

.dropdown-search input {
    width: 100%;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 13px;
}

.dropdown-search {
    position: absolute;
    top: 100%;
    width: 100%;
    background: #fff;
    border: 1px solid #ced4da;
    border-top: none;
    padding: 8px 10px;
    display: none;
    z-index: 1010;
}

.dropdown-search.show { display: block; }

.dropdown-search input {
    width: 100%;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 13px;
}

.dropdown-search {
    position: absolute;
    top: 100%;
    width: 100%;
    background: #fff;
    border: 1px solid #ced4da;
    border-top: none;
    padding: 8px 10px;
    display: none;
    z-index: 1010;
}

.dropdown-search.show { display: block; }

.dropdown-search input {
    width: 100%;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 13px;
}

/* Modal overrides */
.modal .spinner-border { vertical-align: middle; }
</style>

<script>
// Global variables
let allUsers = [];
let filteredUsers = [];
let currentStep = 1;
const totalSteps = 4; 
let prefillRoleId = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    // Dropdown toggle and outside click (like assignments)
    document.addEventListener('click', function(){
        document.querySelectorAll('.dropdown-list').forEach(l=> l.classList.remove('show'));
        document.querySelectorAll('.dropdown-search').forEach(s=> s.classList.remove('show'));
    });
    ['institution','hospital','skillathon'].forEach(prefix => {
        const btn = document.getElementById(prefix+'DropdownBtn');
        const list = document.getElementById(prefix+'DropdownList');
        const searchContainer = document.getElementById(prefix+'SearchContainer');
        const searchInput = document.getElementById(prefix+'Search');
        if(btn && list){
            btn.addEventListener('click', function(e){
                e.preventDefault(); e.stopPropagation();
                document.querySelectorAll('.dropdown-list').forEach(l=> { if(l!==list) l.classList.remove('show'); });
                document.querySelectorAll('.dropdown-search').forEach(s=> { if(s!==searchContainer) s.classList.remove('show'); });
                list.classList.toggle('show');
                if(searchContainer){
                    searchContainer.classList.toggle('show');
                    if(searchContainer.classList.contains('show')){
                        setTimeout(()=> searchInput && searchInput.focus(), 0);
                    }
                }
            });
            // Dedicated list click handler to ensure selection works
            list.addEventListener('click', function(e){
                e.preventDefault();
                e.stopPropagation();
                const li = e.target.closest('li');
                if(!li) return;
                if(prefix==='institution'){
                    addChip('institutionChips', li.dataset.id, li.dataset.value);
                } else if(prefix==='hospital'){
                    addChip('hospitalChips', li.dataset.id, li.dataset.value);
                } else if(prefix==='skillathon'){
                    addChip('skillathonChips', li.dataset.id, li.dataset.value);
                }
                list.classList.remove('show');
                if(searchContainer){ searchContainer.classList.remove('show'); }
            });
            if(searchInput){
                searchInput.addEventListener('keyup', function(){
                    filterDropdownItems(prefix, this.value.trim().toLowerCase());
                });
            }
        }
    });
    
    document.getElementById('createUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createUser();
    });
    document.addEventListener('change', function(e) {
        if(e.target.classList.contains('user-status-toggle')){
            const userId = e.target.dataset.userId;
            const isActive = e.target.checked;
            toggleUserStatus(userId, isActive, e.target);
        }
    });
    
    // Add event listeners to access type checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.name === 'access_types') {
            handleAccessTypeChange();
        }
    });
});
// ---------- Chip helpers (reused from assignments) ----------
function addChip(containerId, id, label) {
    if ($(`#${containerId} .chip[data-id="${id}"]`).length) return;
    $(`#${containerId}`).append(`<span class="chip" data-id="${id}" data-value="${label}">${label}<span class="remove">&times;</span></span>`);
}
function removeChip(containerId, id){
    $(`#${containerId} .chip[data-id="${id}"]`).remove();
}
function clearChips(containerId){ $(`#${containerId}`).empty(); }

function uncheckDropdownCheckbox(containerId, id){
    let listId = null;
    if(containerId === 'institutionChips') listId = 'institutionDropdownList';
    else if(containerId === 'hospitalChips') listId = 'hospitalDropdownList';
    else if(containerId === 'skillathonChips') listId = 'skillathonDropdownList';
    if(!listId) return;
    const checkbox = document.querySelector(`#${listId} input[type="checkbox"][value="${id}"]`);
    if(checkbox){
        checkbox.checked = false;
    }
}

function renderDropdownList(prefix, items){
    const list = document.getElementById(`${prefix}DropdownList`);
    if(!list) return;
    const chipsId = `${prefix}Chips`;
    const changeHandler = prefix === 'institution' ? handleInstitutionChange : prefix === 'hospital' ? handleHospitalChange : null;

    list.innerHTML = '';

    items.forEach(item => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.dataset.value = item.name;

        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item.id;

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(item.name));
        li.appendChild(label);

        const isSelected = document.querySelector(`#${chipsId} .chip[data-id="${item.id}"]`);
        checkbox.checked = !!isSelected;

        checkbox.addEventListener('change', function(){
            if(this.checked){
                addChip(chipsId, item.id, item.name);
            } else {
                removeChip(chipsId, item.id);
            }
            if(changeHandler) changeHandler();
        });

        label.addEventListener('click', function(e){ e.stopPropagation(); });
        li.addEventListener('click', function(){
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        });

        list.appendChild(li);
    });
}

function getDropdownItems(prefix){
    const list = document.getElementById(`${prefix}DropdownList`);
    if(!list) return [];
    try {
        return JSON.parse(list.dataset.items || '[]');
    } catch (err) {
        return [];
    }
}

function filterDropdownItems(prefix, term){
    const items = getDropdownItems(prefix);
    if(!items.length){
        renderDropdownList(prefix, []);
        return;
    }
    if(!term){
        renderDropdownList(prefix, items);
        return;
    }
    const lower = term.toLowerCase();
    const filtered = items.filter(item => (item.name || '').toLowerCase().includes(lower));
    renderDropdownList(prefix, filtered);
}

// Side panel functions
function toggleCreateUserPanel() {
    document.getElementById('createUserPanel').classList.add('active');
    document.getElementById('sidePanelOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
    resetForm();
}

function closeCreateUserPanel() {
    document.getElementById('createUserPanel').classList.remove('active');
    document.getElementById('sidePanelOverlay').classList.remove('active');
    document.body.style.overflow = '';
    resetForm();
}

function resetForm() {
    document.getElementById('createUserForm').reset();
    currentStep = 1;
    showStep(1);
    deselectAllRoles();
    // Clear chip containers and close dropdowns
    ['institutionChips','hospitalChips','skillathonChips'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    document.querySelectorAll('.dropdown-list').forEach(l=> l.classList.remove('show'));
    document.getElementById('skillathonSelection').style.display = 'block';
    // Reset roles list
    document.getElementById('rolesList').innerHTML = '';
}

// Step navigation
function changeStep(direction) {
    
    if (direction === 1) {
        // Next step
        if (validateCurrentStep()) {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
    } else {
        // Previous step
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    }
}

function showStep(step) {
    // Hide all steps
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step3').classList.remove('active');
    document.getElementById('step4').classList.remove('active');
    
    // Show current step
    const map = {1:'step1', 2:'step2', 3:'step3', 4:'step4'};
    const targetId = map[step];
    if (targetId) document.getElementById(targetId).classList.add('active');
    
    // Load data when reaching specific steps
    if (step === 2) {
        // Load institutions, hospitals and skillathons independently
        loadInstitutions();
        loadHospitals();
        document.getElementById('skillathonSelection').style.display = 'block';
        loadSkillathons();
    }
    
    if (step === 3) {
        // Load roles when reaching step 5 (only if not already loaded)
        const rolesList = document.getElementById('rolesList');
        if (!rolesList || rolesList.children.length === 0) {
            loadRoles();
        }
    }
    
    // Update navigation buttons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    prevBtn.style.display = step > 1 ? 'block' : 'none';
    
    if (step === totalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
    }
}

function validateCurrentStep() {
    const currentStepElement = document.getElementById(`step${currentStep}`);
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            showError(`Please fill in the ${field.previousElementSibling.textContent.replace('*', '').trim()}`);
            field.focus();
            return false;
        }
    }
    
    // Additional validation for specific steps
    // Step 2 removed; all users are regular users
    
    // Step 3: access types are optional now (no validation)
    
    if (currentStep === 2) {
        // Step 3 uses chip-based selectors; all fields are optional.
        // Do not reference legacy selects; allow proceeding without checks.
        return true;
    }
    
    if (currentStep === 3) {
        const userType = document.querySelector('input[name="user_type"]:checked');
        if (userType && userType.value === 'regular_user') {
            const selectedRole = document.querySelector('input[name="role_id"]:checked');
            if (!selectedRole) {
                showError('Please select a role');
                return false;
            }
        }
    }
    
    return true;
}

// Handle user type change
function handleUserTypeChange(userType) {
    if (userType === 'super_admin') {
        // Skip steps 3, 4 for super admin
        // Super admin will have user_role = 'ebek_admin'
    } else {
        // For regular users, proceed to access type selection
    }
}

// Handle access type change (no longer controls skillathon visibility)
function handleAccessTypeChange() {
    // Access toggles no longer drive visibility of skillathon selection
}

// Role selection functions
function selectAllRoles() {
    const checkboxes = document.querySelectorAll('.role-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function deselectAllRoles() {
    const checkboxes = document.querySelectorAll('.role-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

// Load institutions
function loadInstitutions() {
    return fetch('{% url "institution_list_api" %}?offset=0&limit=1000')
    .then(response => response.json())
    .then(data => {
        const list = document.getElementById('institutionDropdownList');
        list.innerHTML = '';
        const items = data.institutions || [];
        list.dataset.items = JSON.stringify(items.map(inst => ({id: inst.id, name: inst.name})));
        renderDropdownList('institution', items.map(inst => ({id: inst.id, name: inst.name})));
    })
    .catch(() => showError('Failed to load institutions'));
}

// Handle institution change
function handleInstitutionChange() {
    loadRoles();
}

// Handle hospital change
function handleHospitalChange() {
    loadRoles();
}

// Load all hospitals (independent of institution)
function loadHospitals() {
    return fetch(`{% url "hospital_list_api" %}?offset=0&limit=1000`)
    .then(response => response.json())
    .then(data => {
        const list = document.getElementById('hospitalDropdownList');
        list.innerHTML = '';
        const items = data.hospitals || [];
        list.dataset.items = JSON.stringify(items.map(h => ({id: h.id, name: h.name})));
        renderDropdownList('hospital', items.map(h => ({id: h.id, name: h.name})));
    })
    .catch(() => showError('Failed to load hospitals'));
}

// Load skillathons
function loadSkillathons() {
    return fetch('{% url "skillathon_list_api" %}')
    .then(response => response.json())
    .then(data => {
        const list = document.getElementById('skillathonDropdownList');
        list.innerHTML = '';
        const events = data.events || data.skillathons || [];
        list.dataset.items = JSON.stringify(events.map(s => ({id: s.id, name: s.name || s.skillathonName || 'Skillathon'})));
        renderDropdownList('skillathon', events.map(s => ({id: s.id, name: s.name || s.skillathonName || 'Skillathon'})));
    })
    .catch(() => showError('Failed to load skillathons'));
}

// Load roles based on selected hospital or institution
function loadRoles() {
    
    const url = '{% url "get_roles" %}';

    fetch(url)
    .then(response => response.json())
    .then(data => {
        const rolesList = document.getElementById('rolesList');
        rolesList.innerHTML = '';
        if (data.roles && data.roles.length > 0) {
            data.roles.forEach(role => {
                const roleItem = document.createElement('div');
                roleItem.className = 'role-option';
                roleItem.innerHTML = `
                    <input type="radio" id="role_${role.id}" name="role_id" value="${role.id}">
                    <label for="role_${role.id}" class="role-label">
                        <div class="role-icon role-default">
                            <i class="fas fa-user-tag"></i>
                        </div>
                        <div class="role-info">
                            <div class="role-name">${role.name}</div>
                            ${role.description ? `<div class="role-description">${role.description}</div>` : ''}
                        </div>
                    </label>
                `;
                rolesList.appendChild(roleItem);
            });
            // Apply preselection if provided (from edit user)
            if (prefillRoleId !== null) {
                const radio = document.getElementById(`role_${prefillRoleId}`);
                if (radio) radio.checked = true;
            }
        } else {
            rolesList.innerHTML = '<div class="text-muted text-center p-4">No roles available.</div>';
        }
    })
    .catch(error => {
        console.error('Error loading roles:', error);
        showError('Failed to load roles');
    });
}

// Create user function
function createUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const buttonText = submitBtn.querySelector('#submitButtonText');
    const isEdit = document.getElementById('createUserTitle').textContent.trim().toLowerCase().includes('edit');
    
    const userType = 'regular_user';

    const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        user_type: userType
    };
    
    // Set user_role based on user type
    // For all users (regular), add access types and related data (all optional)
    const accessTypes = Array.from(document.querySelectorAll('input[name="access_types"]:checked')).map(checkbox => checkbox.value);
    data.access_types = accessTypes;
    
    // Collect multiple selections as arrays (optional)
    data.institution_ids = Array.from(document.querySelectorAll('#institutionChips .chip')).map(c => c.dataset.id);
    data.hospital_ids = Array.from(document.querySelectorAll('#hospitalChips .chip')).map(c => c.dataset.id);
    data.skillathon_ids = Array.from(document.querySelectorAll('#skillathonChips .chip')).map(c => c.dataset.id);
    data.access_all_institutes = document.getElementById('accessAllInstitutes').checked;
    data.access_all_hospitals = document.getElementById('accessAllHospitals').checked;
    data.access_all_skillathons = document.getElementById('accessAllSkillathons').checked;
    
    // Add permissions (empty for now, can be extended later)
    data.permission_ids = [];
    
    // Add selected role
    const selectedRole = document.querySelector('input[name="role_id"]:checked');
    if (selectedRole) {
        data.role_id = selectedRole.value;
    }
    
    // Show loading state
    spinner.style.display = 'inline-block';
    buttonText.textContent = isEdit ? 'Saving...' : 'Creating...';
    submitBtn.disabled = true;
    
    const endpoint = isEdit && window.__editingUserId ? `/api/users/${window.__editingUserId}/update/` : '{% url "create_user" %}';
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            closeCreateUserPanel();
            window.location.reload();
        } else {
            showError(data.error || 'Failed to create user');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('An error occurred while creating the user');
    })
    .finally(() => {
        // Hide loading state
        spinner.style.display = 'none';
        buttonText.textContent = isEdit ? 'Save' : 'Create User';
        submitBtn.disabled = false;
    });
}

function toggleUserStatus(userId, isActive, checkboxEl){
    const previousChecked = checkboxEl.checked;
    checkboxEl.disabled = true;
    fetch(`/api/users/${userId}/toggle-active/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ is_active: isActive })
    }).then(response => response.json())
      .then(data => {
        if(!data.success){
            checkboxEl.checked = !previousChecked;
            showError(data.error || 'Failed to update user status');
        } else {
            showSuccess(data.message || 'User status updated');
        }
      }).catch(() => {
        checkboxEl.checked = !previousChecked;
        showError('Failed to update user status');
      }).finally(() => {
        checkboxEl.disabled = false;
      });
}

// Assign roles function
function assignRoles() {
    const userId = document.getElementById('userSelect').value;
    const selectedRoles = Array.from(document.querySelectorAll('.role-checkbox:checked'))
        .map(checkbox => parseInt(checkbox.value));
    
    if (!userId) {
        showError('Please select a user');
        return;
    }
    
    if (selectedRoles.length === 0) {
        showError('Please select at least one role');
        return;
    }
    
    const form = document.getElementById('assignRolesForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    const spinner = submitBtn.querySelector('.spinner-border');
    const buttonText = submitBtn.querySelector('#submitButtonText');
    
    const data = {
        user_id: userId,
        role_ids: selectedRoles
    };
    
    // Show loading state
    spinner.style.display = 'inline-block';
    buttonText.textContent = 'Assigning...';
    submitBtn.disabled = true;
    
    fetch('{% url "assign_roles" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            closeAssignRolePanel();
            window.location.reload();
        } else {
            showError(data.error || 'Failed to assign roles');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('An error occurred while assigning roles');
    })
    .finally(() => {
        // Hide loading state
        spinner.style.display = 'none';
        buttonText.textContent = 'Assign Roles';
        submitBtn.disabled = false;
    });
}

// Load and display users
function loadUsers() {
    // This would typically be an API call to get all users with their roles
    // For now, we'll use the users from the template context
    try {
        const usersDataScript = document.getElementById('users-data');
        allUsers = JSON.parse(usersDataScript.textContent).map(u => ({
            ...u,
        }));
    } catch (error) {
        console.error('Error parsing users data:', error);
        allUsers = [];
    }
    filteredUsers = [...allUsers];
    console.log(allUsers);
    renderUsers();
}

// Render users in table
function renderUsers() {
    const tbody = document.querySelector('#usersTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredUsers.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'flex';
        emptyState.classList.add('show');
        return;
    }
    
    emptyState.style.display = 'none';
    emptyState.classList.remove('show');
    
    tbody.innerHTML = '';
    
    filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="user-info">
                    <div class="user-icon">${user.full_name.charAt(0).toUpperCase()}</div>
                    <div>
                        <div class="user-name">${user.full_name}</div>
                    </div>
                </div>
            </td>
            <td>${user.email}</td>
            <td>
                <label class="status-toggle">
                    <input type="checkbox" class="user-status-toggle" data-user-id="${user.id}" ${user.is_active ? 'checked' : ''}>
                    <span class="slider round"></span>
                </label>
            </td>
            <td>
                <div class="roles-badges">
                    ${user.custom_roles.length > 0 ? 
                        user.custom_roles.map(role => `<span class="role-badge">${role.name}</span>`).join('') :
                        '<span class="text-muted">No roles assigned</span>'
                    }
                </div>
            </td>
            <td>
                <div class="actions">
                    <button type="button" class="btn-icon" onclick="openEditUser(${user.id})" title="Edit User"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn-icon btn-danger" onclick="confirmDeleteUser(${user.id}, '${user.email}');" title="Delete User"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Dropdown item handlers (multi-select chips)
document.addEventListener('click', function(e){
    const t = e.target;
    if(t.closest('#institutionDropdownList li')){
        const li = t.closest('li');
        addChip('institutionChips', li.dataset.id, li.dataset.value);
        document.getElementById('institutionDropdownList').classList.remove('show');
        handleInstitutionChange();
    }
    if(t.closest('#hospitalDropdownList li')){
        const li = t.closest('li');
        addChip('hospitalChips', li.dataset.id, li.dataset.value);
        document.getElementById('hospitalDropdownList').classList.remove('show');
        handleHospitalChange();
    }
    if(t.closest('#skillathonDropdownList li')){
        const li = t.closest('li');
        addChip('skillathonChips', li.dataset.id, li.dataset.value);
        document.getElementById('skillathonDropdownList').classList.remove('show');
    }
});

// Remove chip handler
document.addEventListener('click', function(e){
    if(e.target.matches('.chip .remove')){
        e.preventDefault();
        const chip = e.target.closest('.chip');
        if(chip){
            const containerId = chip.parentElement.id;
            const id = chip.dataset.id;
            chip.remove();
            uncheckDropdownCheckbox(containerId, id);
            if(containerId === 'institutionChips'){ handleInstitutionChange(); }
            if(containerId === 'hospitalChips'){ handleHospitalChange(); }
        }
    }
});

// Search/filter users
function filterUsers(searchText) {
    const searchTerm = searchText.toLowerCase().trim();
    
    if (searchTerm === '') {
        filteredUsers = [...allUsers];
    } else {
        filteredUsers = allUsers.filter(user => 
            user.full_name.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm)
        );
    }
    
    renderUsers();
}

// Edit user roles
function editUserRoles(userId, userName) {
    // Set the user in the form
    document.getElementById('userSelect').value = userId;
    loadUserRoles();
    toggleAssignRolePanel();
}
// Open edit user side panel (reuse create panel but prefill)
async function openEditUser(userId){
    try{
        // Reset form and set current step to 1 first
        currentStep = 1;
        showStep(1);

        const res = await fetch(`/api/users/${userId}/`);
        const data = await res.json();
        console.log(data)
        if(!data.user){ showError('Failed to load user'); return; }
        window.__editingUserId = userId;
        toggleCreateUserPanel();
        document.getElementById('createUserTitle').innerHTML = 'Edit User <span class="spinner-border spinner-border-sm" role="status"></span>';
        document.getElementById('submitButtonText').innerHTML = "Save";
        document.getElementById('submitBtn').disabled = true;
        

        const u = data.user;
        document.getElementById('userName').value = u.name || '';
        document.getElementById('userEmail').value = u.email || '';
        document.getElementById('userPhone').value = u.phone || '';
        // access
        document.getElementById('takeOSCE').checked = (u.access_types||[]).includes('osce');
        document.getElementById('takeSkillathon').checked = (u.access_types||[]).includes('skillathon');
        document.getElementById('accessAllInstitutes').checked = !!u.access_all_institutes;
        document.getElementById('accessAllHospitals').checked = !!u.access_all_hospitals;
        document.getElementById('accessAllSkillathons').checked = !!u.access_all_skillathons;
        // Selections (set after ensure data lists loaded)
        await Promise.all([loadInstitutions(), loadHospitals(), loadSkillathons()]);
        // set selected options
        // Prefill chips based on IDs
        const instIds = (u.institution_ids||[]).map(String);
        const hospIds = (u.hospital_ids||[]).map(String);
        const skillIds = (u.skillathon_ids||[]).map(String);
        // Map ids to current dropdown labels
        function prefillFromList(listId, chipsId, ids){
            const list = document.getElementById(listId);
            ids.forEach(id => {
                const li = Array.from(list.querySelectorAll('li')).find(x=> String(x.dataset.id)===String(id));
                if(li){ addChip(chipsId, li.dataset.id, li.dataset.value); }
            });
        }
        clearChips('institutionChips'); prefillFromList('institutionDropdownList','institutionChips', instIds);
        clearChips('hospitalChips'); prefillFromList('hospitalDropdownList','hospitalChips', hospIds);
        clearChips('skillathonChips'); prefillFromList('skillathonDropdownList','skillathonChips', skillIds);
        // Roles: preselect first if present
        // Remember role to preselect during loadRoles
        try{
            prefillRoleId = u.custom_roles.id;
        }catch(e){
            prefillRoleId = null;
        }
        console.log(prefillRoleId)
        await loadRoles();
        document.getElementById('createUserTitle').textContent = 'Edit User';
        document.getElementById('submitBtn').disabled = false;

    }catch(e){
        console.error(e); showError('Error opening user');
    }
}

// Delete user (modal with loader)
function confirmDeleteUser(userId, email){
    document.getElementById('deleteUserId').value = userId;
    document.getElementById('deleteUserEmail').textContent = email;
    $('#deleteUserModal').modal('show');
}

document.addEventListener('DOMContentLoaded', function(){
    const confirmBtn = document.getElementById('deleteConfirmBtn');
    const cancelBtn = document.getElementById('deleteCancelBtn');
    const btnSpinner = confirmBtn ? confirmBtn.querySelector('.spinner-border') : null;
    const btnText = confirmBtn ? confirmBtn.querySelector('.btn-text') : null;
    confirmBtn?.addEventListener('click', function(){
        const userId = document.getElementById('deleteUserId').value;
        confirmBtn.disabled = true; cancelBtn.disabled = true;
        if(btnSpinner) btnSpinner.style.display = 'inline-block';
        if(btnText) btnText.textContent = 'Deleting';
        fetch(`/api/users/${userId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        }).then(r=>r.json()).then(d=>{
            if(d.success){ 
                showSuccess(d.message||'Deleted');
                $('#deleteUserModal').modal('hide'); 
                window.location.reload();
             }
            else { showError(d.error||'Failed to delete'); }
        }).catch(()=>showError('Failed to delete user')).finally(()=>{
            if(btnSpinner) btnSpinner.style.display = 'none';
            if(btnText) btnText.textContent = 'Delete';
            confirmBtn.disabled = false; cancelBtn.disabled = false;
        });
    });
});

// Load user roles (placeholder - would need API endpoint)
function loadUserRoles() {
    const userId = document.getElementById('userSelect').value;
    if (!userId) {
        return;
    }
    
    // This would typically fetch user roles from an API
    // For now, we'll just show a placeholder
    console.log('Loading roles for user:', userId);
}

// Remove role function (placeholder)
function removeUserRole(userId, roleId, roleName, userName) {
    document.getElementById('removeRoleName').textContent = roleName;
    document.getElementById('removeUserName').textContent = userName;
    // Set the form action URL
    document.getElementById('removeRoleForm').action = `/remove-role/${userId}/${roleId}/`;
    $('#removeRoleModal').modal('show');
}

// Notification functions
function showSuccess(message) {
    const notification = $(`
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-check-circle"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}

function showError(message) {
    const notification = $(`
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}
</script>
{% endblock %}
