{% extends 'assessments/base.html' %}
{% load static %}
{% block content %}

<link href="{% static 'assessments/css/list.css' %}" rel="stylesheet">

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1>Learners</h1>
        <p class="text-muted">Manage your learners</p>
    </div>
    <div class="header-right">
        {% if "bulk_upload_learners" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <button class="btn btn-outline-upload" onclick="toggleUploadPanel()">
            <i class="fas fa-upload"></i>
            Bulk Upload
        </button>
        {% endif %}
        {% if "add_learner" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <a href="javascript:void(0);" class="btn btn-primary"
           onclick="openLearnerFormPanel('{% url 'learner_create' %}', 'Add Learner')">
            <i class="fas fa-plus"></i> Add Learner
        </a>
        {% endif %}
        </div>
    </div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search learners..." id="searchInput" oninput="filterLearners(this.value)">
    </div>
    <button class="btn-filter" onclick="toggleFilterPanel()">
        <i class="fas fa-filter"></i>
        Filters
    </button>
</div>

<!-- Filter Side Panel -->
<div class="filter-panel" id="filterPanel">
    <div class="filter-header">
        <h3>Filter Learners</h3>
    </div>
    
    <form method="get" class="filter-form">
        <div class="filter-layout">
            <!-- Main Filter Types (30%) -->
            <div class="filter-types">
                <div class="filter-type {% if active_filter == 'institution' %}active{% endif %}" 
                     data-filter="institution" 
                     onclick="switchFilter('institution')">
                    <span>Institution</span>
                </div>
                <div class="filter-type {% if active_filter == 'hospital' %}active{% endif %}" 
                     data-filter="hospital" 
                     onclick="switchFilter('hospital')">
                    <span>Hospital</span>
                </div>
                <div class="filter-type {% if active_filter == 'learner-type' %}active{% endif %}" 
                     data-filter="learner-type" 
                     onclick="switchFilter('learner-type')">
                    <span>Learner Type</span>
                </div>
            </div>

            <!-- Filter Content (70%) -->
            <div class="filter-content-wrapper">
                <!-- Institution Content -->
                <div class="filter-content" id="institution-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search institutions" onkeyup="filterOptions('institution')">
                        <div class="selection-count">0 Institution selected</div>
                    </div>
                    <div class="options-list" id="institution-options">
                            {% for institution in institutions %}
                        <label class="option-item">
                            <input type="checkbox" name="institution" value="{{ institution.id }}"
                                   {% if institution.id in selected_institutions %}checked{% endif %}
                                   onchange="updateSelectionCount('institution')">
                            <span>{{ institution.name }}</span>
                        </label>
                            {% endfor %}
                    </div>
                </div>

                <!-- Hospital Content -->
                <div class="filter-content" id="hospital-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search hospitals" onkeyup="filterOptions('hospital')">
                        <div class="selection-count">0 Hospital selected</div>
                    </div>
                    <div class="options-list" id="hospital-options">
                            {% for hospital in hospitals %}
                        <label class="option-item">
                            <input type="checkbox" name="hospital" value="{{ hospital.id }}"
                                   {% if hospital.id in selected_hospitals %}checked{% endif %}
                                   onchange="updateSelectionCount('hospital')">
                            <span>{{ hospital.name }}</span>
                        </label>
                            {% endfor %}
                    </div>
                </div>

                <!-- Learner Type Content -->
                <div class="filter-content" id="learner-type-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search learner types" onkeyup="filterOptions('learner-type')">
                        <div class="selection-count">0 Type selected</div>
                    </div>
                    <div class="options-list" id="learner-type-options">
                        <label class="option-item">
                            <input type="checkbox" name="learner_type" value="student"
                                   {% if 'student' in selected_learner_types %}checked{% endif %}
                                   onchange="updateSelectionCount('learner-type')">
                            <span>Student</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="learner_type" value="nurse"
                                   {% if 'nurse' in selected_learner_types %}checked{% endif %}
                                   onchange="updateSelectionCount('learner-type')">
                            <span>Working Nurse</span>
                        </label>
                </div>
                    </div>
                </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button type="button" class="btn btn-light" onclick="toggleFilterPanel()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply filter</button>
        </div>
    </form>
    </div>

<!-- Table -->
    <div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Mobile</th>
                <th>Type</th>
                <th>Institution/Hospital</th>
                <th>Skillathon</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="learnerTableBody">
            <!-- Learner rows will be loaded here by JS -->
                    </tbody>
                </table>
    <div style="text-align:center; margin: 20px 0;">
    <button id="showMoreBtn" class="btn btn-primary" onclick="loadMoreLearners()">Show More</button>
            </div>
        </div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Delete Learner</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong><span id="deleteItemName"></span></strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Upload Panel -->
<div class="upload-panel" id="uploadPanel">
    <div class="upload-header">
        <h3>Bulk Upload Learners</h3>
        <button type="button" class="btn-close" onclick="toggleUploadPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="upload-content">
        <!-- Templates Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-file-download"></i>
                <h4>Download Templates</h4>
            </div>
            <div class="template-buttons">
                <a href="/media/excel_templates/learner_student_template.xlsx" class="template-card" download>
                    <div class="template-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="template-info">
                        <h5>Student Template</h5>
                        <p>For college students</p>
                    </div>
                    <i class="fas fa-download"></i>
                </a>
                <a href="/media/excel_templates/learner_nurse_template.xlsx" class="template-card" download>
                    <div class="template-icon">
                        <i class="fas fa-user-nurse"></i>
                    </div>
                    <div class="template-info">
                        <h5>Nurse Template</h5>
                        <p>For working nurses</p>
                    </div>
                    <i class="fas fa-download"></i>
                </a>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Upload Excel File</h4>
            </div>
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-placeholder">
                        <div class="upload-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <h5>Drag and drop your Excel file here</h5>
                        <p>or</p>
                        <label class="btn btn-outline">
                            Choose File
                            <input type="file" id="fileInput" accept=".xlsx" hidden>
                        </label>
                        <p class="upload-hint">Supported format: Excel (.xlsx)</p>
                    </div>
                    <div class="upload-preview" style="display: none;">
                        <div class="file-info">
                            <i class="fas fa-file-excel"></i>
                            <span class="filename">No file selected</span>
                        </div>
                        <button type="button" class="btn-icon" onclick="removeFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Preview Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-table"></i>
                <h4>Data Preview</h4>
            </div>
            <div class="preview-container">
                <div class="preview-table">
                    <div class="table-wrapper">
                        <!-- Table will be dynamically populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-check-circle"></i>
                <h4>Validation Results</h4>
            </div>
            <div class="validation-results">
                <!-- Results will be dynamically populated -->
            </div>
        </div>

        <!-- Progress Section -->
        <div class="upload-section" id="progressSection" style="display: none;">
            <div class="section-header">
                <!-- <i class="fas fa-spinner fa-spin"></i> -->
                <h4>Upload Progress</h4>
            </div>
            <div class="progress-container">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <div class="progress-status" id="progressStatus">Preparing upload...</div>
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Rows:</span>
                        <span class="stat-value" id="totalRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Processed:</span>
                        <span class="stat-value" id="processedRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Success:</span>
                        <span class="stat-value success" id="successCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Updated:</span>
                        <span class="stat-value updated" id="updateCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Errors:</span>
                        <span class="stat-value error" id="errorCount">0</span>
                    </div>
                </div>
                <div class="progress-details" id="progressDetails">
                    <!-- Detailed progress information will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="upload-actions">
        <button type="button" class="btn btn-light" onclick="toggleUploadPanel()">Cancel</button>
        <button type="button" class="btn btn-primary" id="uploadButton" onclick="submitUpload()">
            <i class="fas fa-upload"></i>
            Upload
        </button>
        <button type="button" class="btn btn-success" id="doneButton" onclick="completeUpload()" style="display: none;">
            <i class="fas fa-check"></i>
            Done
        </button>
    </div>
</div>

<div id="learnerFormPanel" class="side-panel">
    <div class="side-panel-header">
        <h3 id="formPanelTitle">Add Learner</h3>
        <button type="button" class="close" onclick="closeLearnerFormPanel()">&times;</button>
    </div>
    <div class="side-panel-body" id="learnerFormContainer">
    </div>
</div>
<div id="sidePanelOverlay" class="side-panel-overlay" onclick="closeLearnerFormPanel()"></div>


<style>
    
/* Basic Layout */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header-left h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

.header-left p {
    margin: 4px 0 0;
    color: #666;
}

.btn-success {
    background: #48BB78;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    color: white;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
    text-decoration: none;
}

.btn-success:hover {
    background: #38A169;
    text-decoration: none;
    color: white;
}

/* Filters */
.filters {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
}

.filters .form-group {
    margin-bottom: 0;
}

.filters label {
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 4px;
}

.filters .form-control {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.filters .btn-block {
    margin-top: 24px;
}

/* Table */
.card {
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background: #f8fafc;
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.table td {
    padding: 16px;
    border-top: 1px solid #e2e8f0;
}

/* Institution */
.institution {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Status Badge */
.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.badge.active {
    background: #c6f6d5;
    color: #2f855a;
}

.badge.inactive {
    background: #fed7d7;
    color: #c53030;
}

/* Actions */
.actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: #edf2f7;
    color: #4a5568;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    text-decoration: none;
}

.btn-icon:hover {
    background: #e2e8f0;
    text-decoration: none;
    color: #4a5568;
}

.btn-icon.btn-danger {
    color: #c53030;
    background: #fff5f5;
}

.btn-icon.btn-danger:hover {
    background: #fed7d7;
}

/* Empty State */
.empty {
    text-align: center;
    padding: 48px !important;
}

.empty i.fa-user-graduate {
    font-size: 48px;
    color: #a0aec0;
    margin-bottom: 16px;
}

.empty p {
    margin: 0 0 16px;
    color: #4a5568;
    font-size: 14px;
}

.empty .btn-add {
    display: inline-flex;
    margin: 0 auto;
    padding: 8px 16px;
    font-size: 14px;
    width: fit-content;
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    gap: 4px;
    margin-top: 24px;
}

.btn-page {
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background: #edf2f7;
    color: #4a5568;
    text-decoration: none;
}

.btn-page:hover {
    background: #e2e8f0;
    text-decoration: none;
}

.btn-page.active {
    background: #1AA09A;
    color: white;
}

/* Responsive */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .header-right {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .header-right .btn {
        width: 100%;
    }

    .filters .row {
        margin: 0;
    }

    .filters [class*="col-"] {
        padding: 0;
        margin-bottom: 16px;
    }

    .filters .btn-block {
        margin-top: 0;
    }

    .card {
        overflow-x: auto;
    }

    .table {
        min-width: 800px;
    }
}

/* Search and Filter Bar */
.search-filter-bar {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
}

.search-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 16px;
}

.search-box input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 14px;
}

.btn-filter {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-filter:hover {
    background: #f7fafc;
}

/* Updated Filter Panel Styles */
.filter-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
}

.filter-panel.active {
    right: 0;
}

.filter-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
}

.filter-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1a202c;
}

.filter-form {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 64px); /* Header height */
}

.filter-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Filter Types (30%) */
.filter-types {
    width: 30%;
    background: #f8fafc;
    border-right: 1px solid #e2e8f0;
}

.filter-type {
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    color: #4a5568;
}

.filter-type:hover {
    background: #f1f5f9;
}

.filter-type.active {
    background: white;
    color: #F16564;
}

.filter-type.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #F16564;
}

/* Filter Content (70%) */
.filter-content-wrapper {
    width: 70%;
    display: flex;
    flex-direction: column;
    background: white;
}

.filter-content {
    display: none;
    height: 100%;
    flex-direction: column;
}

.filter-content.active {
    display: flex;
}

.filter-search {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
}

.filter-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 12px;
}

.filter-search input:focus {
    outline: none;
    border-color: #F16564;
    box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
}

.selection-count {
    font-size: 14px;
    color: #4a5568;
}

.options-list {
    padding: 16px 20px;
    overflow-y: auto;
    flex: 1;
}

.option-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    cursor: pointer;
}

.option-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border: 2px solid #cbd5e0;
    border-radius: 4px;
    cursor: pointer;
}

.option-item input[type="checkbox"]:checked {
    background-color: #F16564;
    border-color: #F16564;
}

.option-item span {
    font-size: 14px;
    color: #4a5568;
}

.filter-actions {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
    margin-top: auto;
}


.btn-light {
    background: #f1f5f9;
    border: none;
    padding: 8px 24px;
    border-radius: 6px;
    color: #4a5568;
    font-weight: 500;
    cursor: pointer;
}

.btn-light:hover {
    background: #e2e8f0;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-panel {
        width: 100%;
        right: -100%;
    }
}

/* Upload Panel */
.upload-panel {
    position: fixed;
    top: 0;
    right: -800px;
    width: 800px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.upload-panel.active {
    right: 0;
}

.upload-header {
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
}

.upload-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1a202c;
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    color: #64748b;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-close:hover {
    background: #e2e8f0;
    color: #1a202c;
}

.upload-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
}

.upload-section {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    padding: 20px;
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-header i {
    font-size: 20px;
    color: #F16564;
}

.section-header h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

.template-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.template-card {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    text-decoration: none;
    color: #1a202c;
    transition: all 0.2s;
}

.template-card:hover {
    border-color: #F16564;
    background: #fff5f5;
}

.template-icon {
    width: 40px;
    height: 40px;
    background: #F16564;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.template-info {
    flex: 1;
    margin-left: 16px;
}

.template-info h5 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.template-info p {
    margin: 4px 0 0;
    font-size: 12px;
    color: #64748b;
}

.template-card i.fa-download {
    color: #64748b;
    font-size: 16px;
}

.upload-zone {
    border: 2px dashed #e2e8f0;
    border-radius: 12px;
    padding: 32px;
    transition: all 0.2s;
    background: #f8fafc;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-zone.dragover {
    border-color: #F16564;
    background: #fff5f5;
}

.upload-placeholder {
    color: #4a5568;
    width: 100%;
    text-align: center;
}

.upload-icon {
    width: 64px;
    height: 64px;
    background: #F16564;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.upload-icon i {
    font-size: 32px;
    color: white;
}

.upload-placeholder h5 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

.upload-placeholder p {
    margin: 8px 0;
    color: #64748b;
}

.upload-hint {
    font-size: 12px;
    color: #64748b;
    margin-top: 16px;
}

.btn-outline {
    padding: 8px 24px;
    border: 2px solid #F16564;
    border-radius: 6px;
    background: none;
    color: #F16564;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    width: fit-content;
    margin: 0 auto;
    display: inline-block;
}

.btn-outline:hover {
    background: #F16564;
    color: white;
}

.upload-preview {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.file-info i {
    font-size: 24px;
    color: #F16564;
}

.filename {
    font-size: 14px;
    color: #1a202c;
}

.preview-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.table-wrapper {
    overflow-x: auto;
    max-height: 300px;
}

.table-wrapper table {
    width: 100%;
    border-collapse: collapse;
}

.table-wrapper th {
    background: #f8fafc;
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    position: sticky;
    top: 0;
}

.table-wrapper td {
    padding: 12px 16px;
    border-top: 1px solid #e2e8f0;
    font-size: 14px;
}

.validation-results {
    padding: 16px;
    border-radius: 8px;
    background: #f8fafc;
}

.alert {
    padding: 16px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.alert-danger {
    background: #fff5f5;
    color: #c53030;
}

.alert-success {
    background: #f0fff4;
    color: #2f855a;
}

.alert i {
    font-size: 20px;
}

.alert ul {
    margin: 8px 0 0;
    padding-left: 20px;
}

.upload-actions {
    padding: 20px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
}



.btn-primary:hover {
    background: #e45857;
}

.btn-light {
    background: #f1f5f9;
    border: none;
    color: #4a5568;
}

.btn-light:hover {
    background: #e2e8f0;
}

@media (max-width: 992px) {
    .upload-panel {
        width: 100%;
        right: -100%;
    }
    
    .template-buttons {
        grid-template-columns: 1fr;
    }
}

/* Header Buttons */
.header-right {
    display: flex;
    gap: 12px;
    align-items: center;
}

.btn-outline-upload {
    padding: 8px 16px;
    border: 1px solid #E2E8F0;
    background: white;
    color: #4A5568;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-outline-upload:hover {
    border-color: #CBD5E0;
    background: #F7FAFC;
}

.btn-outline-upload i {
    color: #4A5568;
}

.btn-add {
    padding: 8px 16px;
    background: #F16564;
    border: none;
    color: white;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    text-decoration: none;
}

.btn-add:hover {
    background: #e45857;
    color: white;
    text-decoration: none;
}

.file-info i.fa-file-excel {
    color: #217346; /* Excel green color */
}

.upload-icon i.fa-file-excel {
    font-size: 32px;
    color: white;
}

/* Progress Loader Styles */
.progress-container {
    padding: 20px 0;
}

.progress-bar-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.progress-bar {
    flex: 1;
    height: 12px;
    background: #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #F16564, #e45857);
    border-radius: 6px;
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-text {
    font-size: 14px;
    font-weight: 600;
    color: #1a202c;
    min-width: 40px;
    text-align: right;
}

.progress-status {
    font-size: 14px;
    color: #4a5568;
    margin-bottom: 16px;
    font-weight: 500;
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 18px;
    font-weight: 600;
    color: #1a202c;
}

.stat-value.success {
    color: #2f855a;
}

.stat-value.updated {
    color: #3182ce;
}

.stat-value.error {
    color: #c53030;
}

.progress-details {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
}

.progress-detail-item {
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.progress-detail-item:last-child {
    border-bottom: none;
}

.progress-detail-item.success {
    background: #f0fff4;
    border-left: 4px solid #48bb78;
}

.progress-detail-item.error {
    background: #fff5f5;
    border-left: 4px solid #f56565;
}

.progress-detail-item.updated {
    background: #ebf8ff;
    border-left: 4px solid #4299e1;
}

.progress-detail-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
}

.progress-detail-icon.success {
    background: #48bb78;
    color: white;
}

.progress-detail-icon.error {
    background: #f56565;
    color: white;
}

.progress-detail-icon.updated {
    background: #4299e1;
    color: white;
}

.progress-detail-content {
    flex: 1;
}

.progress-detail-title {
    font-size: 14px;
    font-weight: 500;
    color: #1a202c;
    margin-bottom: 2px;
}

.progress-detail-message {
    font-size: 12px;
    color: #64748b;
}

.progress-detail-row {
    font-size: 11px;
    color: #a0aec0;
    font-weight: 500;
}

/* Loading animation for the header icon */
.section-header i.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Overlay for blocking interaction during upload */
.upload-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.upload-overlay.active {
    display: block;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function openLearnerFormPanel(url, title) {
    document.getElementById('formPanelTitle').textContent = title;
    document.getElementById('learnerFormPanel').classList.add('active');
    document.getElementById('sidePanelOverlay').classList.add('active');
    fetch(url)
        .then(response => response.text())
        .then(html => {
            document.getElementById('learnerFormContainer').innerHTML = html;
        });
}

function closeLearnerFormPanel() {
    document.getElementById('learnerFormPanel').classList.remove('active');
    document.getElementById('sidePanelOverlay').classList.remove('active');
    document.getElementById('learnerFormContainer').innerHTML = '';
}

function confirmDelete(button) {
    const name = button.dataset.name;
    const url = button.dataset.url;
    document.getElementById('deleteItemName').textContent = name;
    document.getElementById('deleteForm').action = url;
    $('#deleteModal').modal('show');
}

document.addEventListener('DOMContentLoaded', function() {
    const learnerTypeSelect = document.getElementById('learner_type');
    const institutionSelect = document.getElementById('institution');
    const hospitalSelect = document.getElementById('hospital');

    function toggleInstitutionHospitalFields() {
        if (learnerTypeSelect.value === 'student') {
            institutionSelect.parentElement.style.display = 'block';
            hospitalSelect.parentElement.style.display = 'none';
        } else if (learnerTypeSelect.value === 'nurse') {
            institutionSelect.parentElement.style.display = 'none';
            hospitalSelect.parentElement.style.display = 'block';
        } else {
            institutionSelect.parentElement.style.display = 'block';
            hospitalSelect.parentElement.style.display = 'block';
        }
    }

    learnerTypeSelect.addEventListener('change', toggleInstitutionHospitalFields);
    toggleInstitutionHospitalFields();
});

function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    const overlay = document.querySelector('.overlay');
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
        if (!overlay) {
            const newOverlay = document.createElement('div');
            newOverlay.className = 'overlay';
            newOverlay.onclick = toggleFilterPanel;
            document.body.appendChild(newOverlay);
        }
        setTimeout(() => {
            document.querySelector('.overlay').classList.add('active');
        }, 10);
    } else {
        document.body.style.overflow = '';
        const overlay = document.querySelector('.overlay');
        if (overlay) {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
    }
}

function clearFilters() {
    const form = document.querySelector('.filter-form');
    form.reset();
    document.querySelectorAll('.selection-count').forEach(counter => {
        counter.textContent = '0 selected';
    });
    toggleFilterPanel();
}

function switchFilter(filterType) {
    // Remove active class from all filter types and contents
    document.querySelectorAll('.filter-type').forEach(type => type.classList.remove('active'));
    document.querySelectorAll('.filter-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to selected filter type and content
    document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
    document.getElementById(`${filterType}-content`).classList.add('active');
}

// Initialize the first filter as active
document.addEventListener('DOMContentLoaded', function() {
    switchFilter('institution');
    
    // Initialize selection counts
    ['institution', 'hospital', 'learner-type'].forEach(category => {
        updateSelectionCount(category);
    });
});

function filterOptions(category) {
    const searchInput = document.querySelector(`#${category}-content .filter-search input`);
    const searchTerm = searchInput.value.toLowerCase();
    const options = document.querySelectorAll(`#${category}-options .option-item`);
    
    options.forEach(option => {
        const text = option.querySelector('span').textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function updateSelectionCount(category) {
    const checkboxes = document.querySelectorAll(`#${category}-options input[type="checkbox"]:checked`);
    const countElement = document.querySelector(`#${category}-content .selection-count`);
    const count = checkboxes.length;
    const label = category === 'learner-type' ? 'Type' : category.charAt(0).toUpperCase() + category.slice(1);
    countElement.textContent = `${count} ${label} selected`;
}

function toggleUploadPanel() {
    const panel = document.getElementById('uploadPanel');
    const overlay = document.querySelector('.overlay');
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
        if (!overlay) {
            const newOverlay = document.createElement('div');
            newOverlay.className = 'overlay';
            newOverlay.onclick = toggleUploadPanel;
            document.body.appendChild(newOverlay);
        }
        setTimeout(() => {
            document.querySelector('.overlay').classList.add('active');
        }, 10);
        
        // Reset upload panel state
        resetUploadPanel();
    } else {
        document.body.style.overflow = '';
        const overlay = document.querySelector('.overlay');
        if (overlay) {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
    }
}

function resetUploadPanel() {
    // Reset file input
    const fileInput = document.getElementById('fileInput');
    fileInput.value = '';
    
    // Reset file preview
    const placeholder = document.querySelector('.upload-placeholder');
    const preview = document.querySelector('.upload-preview');
    if (placeholder && preview) {
        placeholder.style.display = 'block';
        preview.style.display = 'none';
    }
    
    // Clear preview and validation
    const tableWrapper = document.querySelector('.table-wrapper');
    const validationResults = document.querySelector('.validation-results');
    if (tableWrapper) tableWrapper.innerHTML = '';
    if (validationResults) validationResults.innerHTML = '';
    
    // Hide progress section and show validation section
    const progressSection = document.getElementById('progressSection');
    const validationSection = document.querySelector('.upload-section:nth-child(4)');
    if (progressSection) progressSection.style.display = 'none';
    if (validationSection) validationSection.style.display = 'block';
    
    // Reset button states
    const uploadButton = document.getElementById('uploadButton');
    const doneButton = document.getElementById('doneButton');
    if (uploadButton) uploadButton.style.display = 'inline-flex';
    if (doneButton) doneButton.style.display = 'none';
}

// File Upload Handling
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || file.name.endsWith('.xlsx')) {
            showFilePreview(file);
            validateAndPreviewExcel(file);
        } else {
            alert('Please upload an Excel (.xlsx) file');
        }
    }
}

function showFilePreview(file) {
    const placeholder = uploadZone.querySelector('.upload-placeholder');
    const preview = uploadZone.querySelector('.upload-preview');
    const filename = preview.querySelector('.filename');
    const fileIcon = preview.querySelector('.file-info i');
    
    placeholder.style.display = 'none';
    preview.style.display = 'flex';
    filename.textContent = file.name;
    fileIcon.className = 'fas fa-file-excel';
}

function removeFile() {
    const placeholder = uploadZone.querySelector('.upload-placeholder');
    const preview = uploadZone.querySelector('.upload-preview');
    fileInput.value = '';
    
    placeholder.style.display = 'block';
    preview.style.display = 'none';
    
    // Clear preview and validation
    document.querySelector('.table-wrapper').innerHTML = '';
    document.querySelector('.validation-results').innerHTML = '';
}

function validateAndPreviewExcel(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        if (jsonData.length > 0) {
            const headers = jsonData[0];
            // Filter out empty rows and get first few non-empty rows
            const nonEmptyRows = jsonData.slice(1).filter(row => 
                row.some(cell => cell !== null && cell !== undefined && cell.toString().trim() !== '')
            ).slice(0, 5); // Get up to 5 non-empty rows
            
            // Get total non-empty rows for progress tracking
            const allNonEmptyRows = jsonData.slice(1).filter(row => 
                row.some(cell => cell !== null && cell !== undefined && cell.toString().trim() !== '')
            );
            
            // Store total rows for progress tracking
            window.totalRowsToProcess = allNonEmptyRows.length;
            
            // Validate headers
            const validationResults = validateHeaders(headers);
            
            // Create preview table with non-empty rows
            createPreviewTable(headers, nonEmptyRows);
            
            // Validate data (using all rows for validation)
            const dataValidation = validateData(headers, nonEmptyRows);
            
            // Show validation results
            showValidationResults(validationResults, dataValidation);
        }
    };
    reader.readAsArrayBuffer(file);
}

function validateHeaders(headers) {
    const requiredHeaders = {
        'Onboarding Type': true,
        'Learner Type': true,
        'Learner Name': true,
        'Learner Email': true,
        'Learner Phone': true,
        'College': false,
        'Course': false,
        'Stream': false,
        'Year of Study': false,
        'Hospital': false,
        'Designation': false,
        'Years of Experience': false,
        'Educational Qualification': false,
        'Educational Institution': false,
        'Speciality': false,
        'State': false,
        'District': false,
        'Pincode': false,
        'Address': false,
        'Date of Birth': false,
        'Certifications': false,
        'Learner Gender': true,
        'Skillathon Event': false
    };

    const missing = [];
    const extra = [];

    // Check for missing required headers
    Object.entries(requiredHeaders).forEach(([header, required]) => {
        if (required && !headers.includes(header)) {
            missing.push(header);
        }
    });

    // Check for extra headers
    headers.forEach(header => {
        if (!requiredHeaders.hasOwnProperty(header)) {
            extra.push(header);
        }
    });

    return {
        isValid: missing.length === 0,
        missing,
        extra
    };
}

function validateData(headers, rows) {
    const errors = [];
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const phoneRegex = /^\d{10}$/;
    const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
    const pincodeRegex = /^\d{6}$/;

    rows.forEach((row, index) => {
        const rowErrors = [];
        const rowData = {};
        
        // Create object from row data
        headers.forEach((header, i) => {
            rowData[header] = row[i];
        });

        // Validate required fields
        if (!rowData['Learner Name']) {
            rowErrors.push('Name is required');
        }
        if (!rowData['Learner Email']) {
            rowErrors.push('Email is required');
        } else if (!emailRegex.test(rowData['Learner Email'])) {
            rowErrors.push('Invalid email format');
        }
        if (!rowData['Learner Phone']) {
            rowErrors.push('Phone is required');
        } else if (!phoneRegex.test(rowData['Learner Phone'])) {
            rowErrors.push('Phone must be 10 digits');
        }

        if (rowErrors.length > 0) {
            errors.push({
                row: index + 2, // +2 because of 0-based index and header row
                errors: rowErrors
            });
        }
    });

    return {
        isValid: errors.length === 0,
        errors
    };
}

function createPreviewTable(headers, rows) {
    const tableWrapper = document.querySelector('.table-wrapper');
    let html = '<table class="table"><thead><tr>';
    
    // Add headers
    headers.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // Add rows
    rows.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
            const cellValue = row[headers.indexOf(header)] || '';
            html += `<td>${cellValue || '-'}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    tableWrapper.innerHTML = html;
}

function showValidationResults(headerValidation, dataValidation) {
    const validationResults = document.querySelector('.validation-results');
    let html = '';

    // Show header validation results
    if (!headerValidation.isValid) {
        html += `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                <div class="alert-content">
                    <strong>Header Validation Failed</strong>
                    ${headerValidation.missing.length > 0 ? `
                        <p>Missing required columns:</p>
                        <ul>
                            ${headerValidation.missing.map(h => `<li>${h}</li>`).join('')}
                        </ul>
                    ` : ''}
                    ${headerValidation.extra.length > 0 ? `
                        <p>Extra columns found:</p>
                        <ul>
                            ${headerValidation.extra.map(h => `<li>${h}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
            </div>
        `;
    }

    // Show data validation results
    if (!dataValidation.isValid) {
        html += `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                <div class="alert-content">
                    <strong>Data Validation Failed</strong>
                    <p>Errors found in the following rows:</p>
                    <ul>
                        ${dataValidation.errors.map(error => `
                            <li>Row ${error.row}:
                                <ul>
                                    ${error.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `;
    }

    // Show success message if all validations pass
    if (headerValidation.isValid && dataValidation.isValid) {
        html += `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <div class="alert-content">
                    <strong>Validation Successful</strong>
                    <p>All headers and data are valid. You can proceed with the upload.</p>
                </div>
            </div>
        `;
    }

    validationResults.innerHTML = html;
}

function submitUpload() {
    const form = document.getElementById('uploadForm');
    const formData = new FormData(form);
    const fileInput = document.getElementById('fileInput');
    
    // Make sure we have a file
    if (!fileInput.files.length) {
        alert('Please select a file to upload');
        return;
    }
    
    // Show progress section and hide validation section
    document.getElementById('progressSection').style.display = 'block';
    document.querySelector('.upload-section:nth-child(4)').style.display = 'none'; // Hide validation section
    
    // Initialize progress tracking
    initializeProgress();
    
    // Add the file to formData with the correct field name
    formData.append('file', fileInput.files[0]);
    
    // Add loading state
    const uploadButton = document.querySelector('.upload-actions .btn-primary');
    const originalText = uploadButton.innerHTML;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    uploadButton.disabled = true;
    
    fetch('/onboarding/learners/bulk-upload/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.session_key) {
            console.log("Hereee")
            // Start real-time progress tracking
            startProgressTracking(data.session_key);
        } else {
            updateProgress(100, 'Upload failed: ' + (data.error || 'Unknown error'));
            showUploadError(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        updateProgress(100, 'Upload failed: ' + error.message);
        showUploadError(error.message);
    })
    .finally(() => {
        uploadButton.innerHTML = originalText;
        uploadButton.disabled = false;
    });
}

function startProgressTracking(sessionKey) {
    console.log(`[DEBUG] Starting SSE connection for session: ${sessionKey}`);
    const sseUrl = `/onboarding/learners/upload-progress/${sessionKey}/`;
    console.log(`[DEBUG] SSE URL: ${sseUrl}`);
    
    const eventSource = new EventSource(sseUrl);
    
    eventSource.onopen = function(event) {
        console.log('[DEBUG] SSE connection opened');
    };
    
    eventSource.onmessage = function(event) {
        console.log(`[DEBUG] Received SSE message:`, event.data);
        try {
            const data = JSON.parse(event.data);
            console.log(`[DEBUG] Parsed data:`, data);
            
            if (data.error) {
                console.log(`[DEBUG] SSE error:`, data.error);
                showUploadError(data.error);
                eventSource.close();
                return;
            }
            
            // Update progress
            console.log(`[DEBUG] Updating progress to ${data.progress}%`);
            updateProgress(data.progress, data.message);
            
            // Update statistics
            if (data.total_rows) document.getElementById('totalRows').textContent = data.total_rows;
            if (data.processed_rows) document.getElementById('processedRows').textContent = data.processed_rows;
            if (data.success_count) document.getElementById('successCount').textContent = data.success_count;
            if (data.update_count) document.getElementById('updateCount').textContent = data.update_count;
            if (data.error_count) document.getElementById('errorCount').textContent = data.error_count;
            
            // Handle completion
            if (data.status === 'completed') {
                console.log('[DEBUG] Upload completed');
                showUploadResult(data);
                eventSource.close();
                // Hide progress section after completion
                // setTimeout(() => {
                //     document.getElementById('progressSection').style.display = 'none';
                // }, 3000); // Hide after 3 seconds to show completion message
            } else if (data.status === 'error') {
                console.log('[DEBUG] Upload error:', data.message);
                showUploadError(data.message);
                eventSource.close();
                // Hide progress section after error
                // setTimeout(() => {
                //     document.getElementById('progressSection').style.display = 'none';
                // }, 3000); // Hide after 3 seconds to show error message
            }
            
        } catch (error) {
            console.error('[DEBUG] Error parsing SSE data:', error);
        }
    };
    
    eventSource.onerror = function(error) {
        console.error('[DEBUG] SSE connection error:', error);
        console.error('[DEBUG] Error details:', {
            readyState: eventSource.readyState,
            url: eventSource.url
        });
        eventSource.close();
        showUploadError('Connection lost. Please check the upload status.');
    };
    
    // Add timeout to check if connection is working
    setTimeout(() => {
        if (eventSource.readyState === 0) { // CONNECTING
            console.log('[DEBUG] SSE still connecting after 5 seconds...');
        } else if (eventSource.readyState === 1) { // OPEN
            console.log('[DEBUG] SSE connection is open');
        } else if (eventSource.readyState === 2) { // CLOSED
            console.log('[DEBUG] SSE connection is closed');
        }
    }, 5000);
}

function initializeProgress() {
    // Reset all progress elements
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
    document.getElementById('progressStatus').textContent = 'Preparing upload...';
    
    // Set total rows if available from file validation
    const totalRows = window.totalRowsToProcess || 0;
    document.getElementById('totalRows').textContent = totalRows;
    document.getElementById('processedRows').textContent = '0';
    document.getElementById('successCount').textContent = '0';
    document.getElementById('updateCount').textContent = '0';
    document.getElementById('errorCount').textContent = '0';
    document.getElementById('progressDetails').innerHTML = '';
    
    // Show file name if available
    const fileInput = document.getElementById('fileInput');
    if (fileInput.files.length > 0) {
        const fileName = fileInput.files[0].name;
        const progressStatus = document.getElementById('progressStatus');
        progressStatus.textContent = `Preparing upload for: ${fileName}`;
    }
}



function updateProgress(percentage, status) {
    console.log(`[DEBUG] updateProgress called with: ${percentage}%, "${status}"`);
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressStatus = document.getElementById('progressStatus');
    
    if (!progressFill || !progressText || !progressStatus) {
        console.error('[DEBUG] Progress elements not found!');
        return;
    }
    
    progressFill.style.width = percentage + '%';
    progressText.textContent = Math.round(percentage) + '%';
    progressStatus.textContent = status;
    
    console.log(`[DEBUG] Progress updated: ${percentage}%, "${status}"`);
}



function showUploadResult(data) {
    const progressDetails = document.getElementById('progressDetails');
    let html = '';
    
    // Add success summary
    html += `
        <div class="progress-detail-item success">
            <div class="progress-detail-icon success">
                <i class="fas fa-check"></i>
            </div>
            <div class="progress-detail-content">
                <div class="progress-detail-title">Upload Completed Successfully</div>
                <div class="progress-detail-message">${data.message}</div>
            </div>
        </div>
    `;
    
    // Add summary statistics
    const stats = data.stats || {};
    const totalRows = stats.total_rows || 0;
    const successCount = stats.success_count || 0;
    const updateCount = stats.update_count || 0;
    const errorCount = stats.error_count || 0;
    
    if (totalRows > 0) {
        html += `
            <div class="progress-detail-item success">
                <div class="progress-detail-icon success">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="progress-detail-content">
                    <div class="progress-detail-title">Upload Summary</div>
                    <div class="progress-detail-message">
                        Processed ${totalRows} rows: ${successCount} new learners created, ${updateCount} existing learners updated, ${errorCount} errors encountered.
                    </div>
                </div>
            </div>
        `;
    }
    
    // Add error details if any
    if (data.errors && data.errors.length > 0) {
        html += `
            <div class="progress-detail-item error">
                <div class="progress-detail-icon error">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="progress-detail-content">
                    <div class="progress-detail-title">Errors Found (${data.errors.length})</div>
                    <div class="progress-detail-message">Please review the errors below and fix them in your Excel file if needed.</div>
                </div>
            </div>
        `;
        
        data.errors.forEach(error => {
            html += `
                <div class="progress-detail-item error">
                    <div class="progress-detail-icon error">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div class="progress-detail-content">
                        <div class="progress-detail-title">Row ${error.row}</div>
                        <div class="progress-detail-message">
                            ${Object.values(error.errors).flat().join(', ')}
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    progressDetails.innerHTML = html;
    
    // Show Done button
    document.getElementById('uploadButton').style.display = 'none';
    document.getElementById('doneButton').style.display = 'inline-flex';
    
    // Show completion message
    // setTimeout(() => {
    //     const message = errorCount > 0 
    //         ? `Upload completed with ${errorCount} errors. Check the details below.`
    //         : 'Upload completed successfully! All learners have been processed.';
    //     alert(message);
    // }, 500);
    
    // Add completion notice
    // html += `
    //     <div class="progress-detail-item success" style="background: #f0fff4; border-left: 4px solid #48bb78;">
    //         <div class="progress-detail-icon success">
    //             <i class="fas fa-info-circle"></i>
    //         </div>
            
    //     </div>
    // `;
    progressDetails.innerHTML = html;
}

function showUploadError(error) {
    const progressDetails = document.getElementById('progressDetails');
    progressDetails.innerHTML = `
        <div class="progress-detail-item error">
            <div class="progress-detail-icon error">
                <i class="fas fa-times"></i>
            </div>
            <div class="progress-detail-content">
                <div class="progress-detail-title">Upload Failed</div>
                <div class="progress-detail-message">${error}</div>
            </div>
        </div>
    `;
    
    // Show Done button
    document.getElementById('uploadButton').style.display = 'none';
    document.getElementById('doneButton').style.display = 'inline-flex';
    
    alert('Upload failed: ' + error);
}

function completeUpload() {
    // Reload the page to show updated data
    location.reload();
}

document.addEventListener('submit', function(e) {
    if (e.target.closest('#learnerFormPanel form')) {
        e.preventDefault();
        const form = e.target;
        const url = form.action;
        const formData = new FormData(form);

        // Get the save button and add loading state
        const saveButton = form.querySelector('button[type="submit"]');
        if (saveButton) {
            document.getElementById("save-button").innerText = "Loading..."
            saveButton.classList.add('btn-loading');
        }
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.text())
        .then(html => {
            // Remove loading state from button
            if (saveButton) {
                saveButton.classList.remove('btn-loading');
            }

            if (html.includes('form-group')) {
                // Form has errors, re-render it
                document.getElementById('learnerFormContainer').innerHTML = html;
            } else {
                // Success: close panel and reload page
                closeLearnerFormPanel();
                location.reload(); // <--- This reloads the page
            }
        });
    }
});

let offset = 0;
const limit = 10;
let loading = false;
let allLoaded = false;
let currentSearch = '';
let currentFilters = {};

// Search functionality
function filterLearners(searchQuery) {
    currentSearch = searchQuery;
    resetLearnerList();
    applySearch();
}

// Apply search with reset functionality
function applySearch() {
    offset = 0;
    allLoaded = false;
    document.getElementById('learnerTableBody').innerHTML = '';
    document.getElementById('showMoreBtn').style.display = 'inline-flex';
    loadMoreLearners();
}

function resetLearnerList() {
    offset = 0;
    allLoaded = false;
    document.getElementById('learnerTableBody').innerHTML = '';
    document.getElementById('showMoreBtn').style.display = 'inline-flex';
}

function applyFilters() {
    currentFilters = {};
    
    // Get institution filters
    const institutionCheckboxes = document.querySelectorAll('input[name="institution"]:checked');
    if (institutionCheckboxes.length > 0) {
        currentFilters.institution = Array.from(institutionCheckboxes).map(cb => cb.value);
    }
    
    // Get hospital filters
    const hospitalCheckboxes = document.querySelectorAll('input[name="hospital"]:checked');
    if (hospitalCheckboxes.length > 0) {
        currentFilters.hospital = Array.from(hospitalCheckboxes).map(cb => cb.value);
    }
    
    // Get learner type filters
    const learnerTypeCheckboxes = document.querySelectorAll('input[name="learner_type"]:checked');
    if (learnerTypeCheckboxes.length > 0) {
        currentFilters.learner_type = Array.from(learnerTypeCheckboxes).map(cb => cb.value);
    }
    
    resetLearnerList();
    loadMoreLearners();
    toggleFilterPanel();
}

function renderLearnerRow(learner) {
    console.log(learner)
    return `
    <tr>
        <td><div class="institution"><span>${learner.full_name}</span></div></td>
        <td>${learner.email}</td>
        <td>${learner.phone_number}</td>
        <td>${learner.learner_type}</td>
        <td>${learner.institution}</td>
        <td>${learner.skillathon}</td>
        <td>
            <span class="badge ${learner.is_active ? 'active' : 'inactive'}">
                ${learner.is_active ? 'Active' : 'Inactive'}
            </span>
        </td>
        <td>
            <div class="actions">
                {% if "edit_learner" in request.user.get_all_permissions or request.user.has_all_permissions %}
                <a href="javascript:void(0);" class="btn-icon"
                   onclick="openLearnerFormPanel('${learner.edit_url}', 'Edit Learner')">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                {% if "delete_learner" in request.user.get_all_permissions or request.user.has_all_permissions %}
                <button type="button" 
                        class="btn-icon btn-danger" 
                        data-name="${learner.full_name}"
                        data-url="${learner.delete_url}"
                        onclick="confirmDelete(this)"
                        title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </td>
    </tr>
    `;
}

function loadMoreLearners() {
    if (loading || allLoaded) return;
    loading = true;
    document.getElementById('showMoreBtn').innerText = 'Loading...';
    
    // Build query parameters
    const params = new URLSearchParams();
    params.append('offset', offset);
    params.append('limit', limit);
    
    if (currentSearch) {
        params.append('search', currentSearch);
    }
    
    // Add filters
    Object.keys(currentFilters).forEach(key => {
        if (currentFilters[key] && currentFilters[key].length > 0) {
            currentFilters[key].forEach(value => {
                params.append(key, value);
            });
        }
    });
    
    fetch(`/onboarding/learners/api/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            const learners = data.learners;
            if (data.all_loaded) {
                allLoaded = true;
                document.getElementById('showMoreBtn').style.display = 'none';
            }
            offset += learners.length;
            const tbody = document.getElementById('learnerTableBody');
            learners.forEach(learner => {
                tbody.insertAdjacentHTML('beforeend', renderLearnerRow(learner));
            });
            // If no learners at all, show empty state
            if (offset === 0 && learners.length === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="8" class="empty">
                        <i class="fas fa-user-graduate"></i>
                        <p>No learners found</p>
                        <a href="javascript:void(0);" class="btn btn-primary"
                           onclick="openLearnerFormPanel('{% url 'learner_create' %}', 'Add Learner')">
                            Add Learner
                        </a>
                    </td>
                </tr>`;
                document.getElementById('showMoreBtn').style.display = 'none';
            }
        })
        .finally(() => {
            loading = false;
            if (!allLoaded) document.getElementById('showMoreBtn').innerText = 'Show More';
        });
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    loadMoreLearners();
});

// Function that was referenced in the form but missing from template
function toggleLearnerFields(learnerType) {
    console.log(learnerType)
    const studentFields = document.getElementById('student-fields');
    const nurseFields = document.getElementById('nurse-fields');
    
    if (learnerType === 'student') {
        studentFields.style.display = 'block';
        nurseFields.style.display = 'none';
    } else if (learnerType === 'nurse') {
        studentFields.style.display = 'none';
        nurseFields.style.display = 'block';
    } else {
        studentFields.style.display = 'none';
        nurseFields.style.display = 'none';
    }
}

// Function to toggle fields based on onboarding type (b2b/b2c)
function toggleOnboardingFields(onboardingType) {
    const skillathonEventFields = document.getElementById('skillathon-event-fields');
    loadInstitutions("", onboardingType);
    loadHospitals("", onboardingType);
    
    if (onboardingType === 'b2c') {
        skillathonEventFields.style.display = 'block';
    } else {
        skillathonEventFields.style.display = 'none';
    }
}

// Function to load institutions based on skillathon and onboarding type
function loadInstitutions(skillathonId = null, onboardingType = null) {
    const collegeSelect = document.getElementById('id_college');
    if (!collegeSelect) return;
    
    const params = new URLSearchParams();
    if (skillathonId) params.append('skillathon_id', skillathonId);
    if (onboardingType) params.append('onboarding_type', onboardingType);
    
    fetch(`/onboarding/learners/get-institutions-by-skillathon/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            // Clear existing options except the first one (empty option)
            collegeSelect.innerHTML = '<option value="">---------</option>';
            
            // Add new options
            data.institutions.forEach(institution => {
                const option = document.createElement('option');
                option.value = institution.id;
                option.textContent = institution.name;
                collegeSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading institutions:', error);
        });
}

// Function to load hospitals based on skillathon and onboarding type
function loadHospitals(skillathonId = null, onboardingType = null) {
    const hospitalSelect = document.getElementById('id_hospital');
    if (!hospitalSelect) return;
    
    const params = new URLSearchParams();
    if (skillathonId) params.append('skillathon_id', skillathonId);
    if (onboardingType) params.append('onboarding_type', onboardingType);
    
    fetch(`/onboarding/learners/get-hospitals-by-skillathon/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            // Clear existing options except the first one (empty option)
            hospitalSelect.innerHTML = '<option value="">---------</option>';
            
            // Add new options
            data.hospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital.id;
                option.textContent = hospital.name;
                hospitalSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading hospitals:', error);
        });
}

// Function to handle skillathon selection change
function handleSkillathonChange() {
    const skillathonSelect = document.getElementById('id_skillathon_event');
    const onboardingSelect = document.getElementById('id_onboarding_type');
    
    const skillathonId = skillathonSelect ? skillathonSelect.value : null;
    const onboardingType = onboardingSelect ? onboardingSelect.value.toLowerCase() : null;
    
    console.log("DEBUG: Skillathon changed, skillathonId:", skillathonId, "onboardingType:", onboardingType);
    
    // Load institutions and hospitals based on selected skillathon and onboarding type
    loadInstitutions(skillathonId, onboardingType);
    loadHospitals(skillathonId, onboardingType);
}
</script>
{% endblock %} 