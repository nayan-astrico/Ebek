{% extends 'assessments/base.html' %}
{% load static %}
{% block content %}

<link href="{% static 'assessments/css/list.css' %}" rel="stylesheet">
<style>
.btn-filter {
    position: relative;
}

.filter-badge {
    background: #F16564;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
    position: absolute;
    top: -5px;
    right: -5px;
}

.filter-type {
    position: relative;
}

.filter-type .filter-type-badge {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    min-width: 18px;
    height: 18px;
    line-height: 18px;
    padding: 0 6px;
    border-radius: 9px;
    background: #F16564;
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    display: none;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.option-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    cursor: pointer;
    width: 100%;
    user-select: none;
    margin: 0;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    pointer-events: auto;
    position: relative;
}

.option-item:hover {
    background-color: #f7fafc;
}

.option-item span {
    pointer-events: none;
    flex: 1;
}

.select-all-item {
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 12px;
    margin-bottom: 8px;
    font-weight: 600;
}

.select-all-item span {
    font-weight: 600;
    color: #1a202c;
}

/* Toggle Switch for Status */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: #1AA09A;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider.round {
    border-radius: 24px;
}

.slider.round:before {
    border-radius: 50%;
}

/* Confirmation Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.confirmation-modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-body {
    padding: 24px;
}

.modal-body p {
    margin: 0 0 8px 0;
    color: #4a5568;
    line-height: 1.6;
}

.modal-body ul li {
    color: #4a5568;
    line-height: 1.8;
}

.modal-actions {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.btn-danger {
    background: #F16564;
    color: white;
}

.btn-danger:hover {
    background: #e45857;
}
</style>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1>Institutions</h1>
        <p class="text-muted">Manage your educational institutions</p>
    </div>
    <div class="header-right">
        {% if "create_institute" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <a href="javascript:void(0);" class="btn btn-primary"
           onclick="openInstitutionFormPanel('{% url 'institution_create' %}', 'Add Institution')">
            <i class="fas fa-plus"></i> Add Institution
        </a>
        {% endif %}
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar">
    <div class="search-box">
        <input type="text" 
               placeholder="Search institutions..." 
               value="{{ search_query }}"
               id="institutionSearchInput"
               oninput="filterInstitutions(this.value)">
    </div>
    <button class="btn-filter" onclick="toggleFilterPanel()" id="filterBtn">
        <i class="fas fa-filter"></i>
        <span>Filters</span>
        <span class="filter-badge" id="filterBadge" style="display: none;">0</span>
    </button>
</div>

<div class="filter-panel" id="filterPanel">
    <div class="filter-header">
        <h3>Filter Institutions</h3>
    </div>
    
    <form method="get" class="filter-form">
        <div class="filter-layout">
            <div class="filter-types">
                <!-- <div class="filter-type {% if active_filter == 'group' %}active{% endif %}" 
                     data-filter="group" 
                     onclick="switchFilter('group')">
                    <span>Group</span>
                </div> -->
                <!-- <div class="filter-type {% if active_filter == 'institution' %}active{% endif %}" 
                     data-filter="institution" 
                     onclick="switchFilter('institution')">
                    <span>Institution</span>
                </div> -->
                <div class="filter-type {% if active_filter == 'state' %}active{% endif %}" 
                     data-filter="state" 
                     onclick="switchFilter('state')">
                    <span>State</span>
                </div>
                <div class="filter-type {% if active_filter == 'status' %}active{% endif %}" 
                     data-filter="status" 
                     onclick="switchFilter('status')">
                    <span>Status</span>
                </div>
            </div>

            <!-- Filter Content (70%) -->
            <div class="filter-content-wrapper">
                <!-- Group Content -->
                <div class="filter-content" id="group-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search groups" onkeyup="filterOptions('group')">
                        <div class="selection-count">0 Group selected</div>
                    </div>
                    <div class="options-list" id="group-options">
                        {% for items in all_groups %}
                        <label class="option-item">
                            <input type="checkbox" name="group" value="{{ items.id }}"
                                   {% if items.id|stringformat:"s" in selected_groups %}checked{% endif %}
                                   onchange="updateSelectionCount('group')">
                            <span>{{ items.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Institution Content -->
                <div class="filter-content" id="institution-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search institutions" onkeyup="filterOptions('institution')">
                        <div class="selection-count">0 Institution selected</div>
                    </div>
                    <div class="options-list" id="institution-options">
                        {% for institution in all_institutions %}
                        <label class="option-item">
                            <input type="checkbox" name="institution" value="{{ institution.id }}"
                                   {% if institution.id in selected_institutions %}checked{% endif %}
                                   onchange="updateSelectionCount('institution')">
                            <span>{{ institution.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- State Content -->
                <div class="filter-content" id="state-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search states" onkeyup="filterOptions('state')">
                        <div class="selection-count" id="stateSelectionCount">0 State selected</div>
                    </div>
                    <div class="options-list" id="state-options">
                        <label class="option-item select-all-item">
                            <input type="checkbox" id="selectAllStates" onchange="toggleSelectAll('state', this)">
                            <span><strong>Select All</strong></span>
                        </label>
                        {% for state in all_states %}
                        <label class="option-item">
                            <input type="checkbox" name="state" value="{{ state }}"
                                   {% if state in selected_states %}checked{% endif %}
                                   onchange="updateSelectionCount('state')"
                                   class="state-checkbox">
                            <span>{{ state }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Status Content -->
                <div class="filter-content" id="status-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search status" onkeyup="filterOptions('status')">
                        <div class="selection-count" id="statusSelectionCount">0 Status selected</div>
                    </div>
                    <div class="options-list" id="status-options">
                        <label class="option-item select-all-item">
                            <input type="checkbox" id="selectAllStatuses" onchange="toggleSelectAll('status', this)">
                            <span><strong>Select All</strong></span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="status" value="active"
                                   {% if 'active' in selected_statuses %}checked{% endif %}
                                   onchange="updateSelectionCount('status')"
                                   class="status-checkbox">
                            <span>Active</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="status" value="inactive"
                                   {% if 'inactive' in selected_statuses %}checked{% endif %}
                                   onchange="updateSelectionCount('status')"
                                   class="status-checkbox">
                            <span>Inactive</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button type="button" class="btn btn-light" onclick="toggleFilterPanel()">Cancel</button>
            <button type="button" class="btn btn-light" onclick="clearAllFilters()">Clear All</button>
            <button type="submit" class="btn btn-primary">Apply filter</button>
        </div>
    </form>
</div>

<!-- Table -->
<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Institution</th>
                <!-- <th>Group</th> -->
                <th>State</th>
                <th>Learners</th>
                <th>Unit Head</th>
                <th>Status</th>
                {% if "edit_institute" in request.user.get_all_permissions or "delete_institute" in request.user.get_all_permissions or request.user.has_all_permissions %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody id="institutionTableBody">
            <!-- Institution rows will be loaded here by JS -->
        </tbody>
    </table>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state">
        <div class="empty-state-content">
            <i class="fas fa-school"></i>
            <p>No institutions found</p>
            {% if "create_institute" in request.user.get_all_permissions or request.user.has_all_permissions %}
            <a href="javascript:void(0);" class="btn btn-primary"
               onclick="openInstitutionFormPanel('{% url 'institution_create' %}', 'Add Institution')">
                Add New Institution
            </a>
            {% endif %}
            <script>
            // Declare variables first
            var canCreateInstitution = false;
            var canEditInstitution = false;
            var canDeleteInstitution = false;

            // Then set them based on permissions
            {% if "create_institute" in request.user.get_all_permissions or request.user.has_all_permissions %}
            canCreateInstitution = true;
            {% endif %}

            {% if "edit_institute" in request.user.get_all_permissions or request.user.has_all_permissions %}
            canEditInstitution = true;
            {% endif %}

            {% if "delete_institute" in request.user.get_all_permissions or request.user.has_all_permissions %}
            canDeleteInstitution = true;
            {% endif %}

            var userPermissions = {
                canCreate: canCreateInstitution,
                canEdit: canEditInstitution,
                canDelete: canDeleteInstitution
            };

            var showActionsColumn = userPermissions.canEdit || userPermissions.canDelete;
            </script>
        </div>
    </div>
    
    <!-- Loading and Show More -->
    <div style="text-align:center; margin: 20px 0;">
        <button id="showMoreBtn" class="btn btn-primary" onclick="loadMoreInstitutions()">
            Show More
        </button>
        
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Delete Institution</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong><span id="deleteItemName"></span></strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Institution Form Side Panel -->
<div id="institutionFormPanel" class="side-panel">
    <div class="side-panel-header">
        <h3 id="formPanelTitle">Add Institution</h3>
        <button type="button" class="close" onclick="closeInstitutionFormPanel()">&times;</button>
    </div>
    <div class="side-panel-body" id="institutionFormContainer">
    </div>
</div>
<div id="sidePanelOverlay" class="side-panel-overlay" onclick="closeInstitutionFormPanel()"></div>

<script>
function confirmDelete(button) {
    const name = button.dataset.name;
    const url = button.dataset.url;
    document.getElementById('deleteItemName').textContent = name;
    document.getElementById('deleteForm').action = url;
    $('#deleteModal').modal('show');
}

function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    const overlay = document.querySelector('.overlay');
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
        if (!overlay) {
            const newOverlay = document.createElement('div');
            newOverlay.className = 'overlay';
            newOverlay.onclick = toggleFilterPanel;
            document.body.appendChild(newOverlay);
        }
        setTimeout(() => {
            document.querySelector('.overlay').classList.add('active');
        }, 10);
    } else {
        document.body.style.overflow = '';
        const overlay = document.querySelector('.overlay');
        if (overlay) {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
    }
}

function switchFilter(filterType) {
    // Remove active class from all filter types and contents
    document.querySelectorAll('.filter-type').forEach(type => type.classList.remove('active'));
    document.querySelectorAll('.filter-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to selected filter type and content
    document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
    document.getElementById(`${filterType}-content`).classList.add('active');
}

// Initialize the first filter as active
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with state filter (since group and institution are commented out)
    const firstActiveFilter = document.querySelector('.filter-type.active');
    if (firstActiveFilter) {
        const filterType = firstActiveFilter.getAttribute('data-filter');
        switchFilter(filterType);
    } else {
        switchFilter('state');
    }
    
    // Initialize selection counts
    ['state', 'status'].forEach(category => {
        updateSelectionCount(category);
    });
    
    // Initialize filter badge
    updateFilterBadge();
});

// Make entire option row clickable to toggle checkbox
document.addEventListener('click', function(e) {
    const label = e.target.closest('label.option-item');
    if (!label) return;
    
    if (label.classList.contains('select-all-item')) {
        return;
    }
    
    const checkbox = label.querySelector('input[type="checkbox"]');
    if (!checkbox) return;
    
    if (e.target === checkbox || e.target.type === 'checkbox') {
        setTimeout(function() {
            const container = label.closest('.filter-content');
            if (container) {
                const category = container.id.replace('-content', '');
                if (category) {
                    updateSelectionCount(category);
                }
            }
        }, 10);
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    checkbox.checked = !checkbox.checked;
    
    const changeEvent = new Event('change', { bubbles: true, cancelable: false });
    checkbox.dispatchEvent(changeEvent);
    
    const container = label.closest('.filter-content');
    if (container) {
        const category = container.id.replace('-content', '');
        if (category) {
            updateSelectionCount(category);
        }
    }
}, true);

function filterOptions(category) {
    const searchInput = document.querySelector(`#${category}-content .filter-search input`);
    const searchTerm = searchInput.value.toLowerCase();
    const options = document.querySelectorAll(`#${category}-options .option-item`);
    
    options.forEach(option => {
        // Always show "Select All" option
        if (option.classList.contains('select-all-item')) {
            option.style.display = '';
            return;
        }
        const text = option.querySelector('span').textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function toggleSelectAll(category, selectAllCheckbox) {
    let checkboxSelector;
    if (category === 'state') {
        checkboxSelector = '.state-checkbox';
    } else if (category === 'status') {
        checkboxSelector = '.status-checkbox';
    } else {
        checkboxSelector = `input[name="${category}"]`;
    }
    
    const checkboxes = document.querySelectorAll(`#${category}-options ${checkboxSelector}`);
    const isChecked = selectAllCheckbox.checked;
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        const changeEvent = new Event('change', { bubbles: true });
        checkbox.dispatchEvent(changeEvent);
    });
    
    updateSelectionCount(category);
}

function updateSelectionCount(category) {
    // Get checkboxes excluding the "Select All" checkbox
    let checkboxSelector;
    if (category === 'state') {
        checkboxSelector = '.state-checkbox';
    } else if (category === 'status') {
        checkboxSelector = '.status-checkbox';
    } else {
        checkboxSelector = `input[name="${category}"]`;
    }
    
    const checkboxes = document.querySelectorAll(`#${category}-options ${checkboxSelector}`);
    const checkedBoxes = document.querySelectorAll(`#${category}-options ${checkboxSelector}:checked`);
    const count = checkedBoxes.length;
    
    // Update selection count display
    const countElement = document.getElementById(`${category}SelectionCount`) || document.querySelector(`#${category}-content .selection-count`);
    const label = category.charAt(0).toUpperCase() + category.slice(1);
    if (countElement) {
        countElement.textContent = `${count} ${label} selected`;
    }
    
    // Sync "Select All" checkbox state
    let selectAllId;
    if (category === 'state') {
        selectAllId = 'selectAllStates';
    } else if (category === 'status') {
        selectAllId = 'selectAllStatuses';
    }
    
    if (selectAllId) {
        const selectAllCheckbox = document.getElementById(selectAllId);
        if (selectAllCheckbox && checkboxes.length > 0) {
            selectAllCheckbox.checked = (count === checkboxes.length);
            selectAllCheckbox.indeterminate = (count > 0 && count < checkboxes.length);
        }
    }
    
    updateFilterBadge();
    setFilterTypeBadge(category, count);
}

function updateFilterBadge() {
    let totalFilterCategories = 0;
    
    if (document.querySelectorAll('input[name="state"]:checked').length > 0) {
        totalFilterCategories++;
    }
    if (document.querySelectorAll('input[name="status"]:checked').length > 0) {
        totalFilterCategories++;
    }
    
    const badge = document.getElementById('filterBadge');
    if (badge) {
        if (totalFilterCategories > 0) {
            badge.textContent = totalFilterCategories;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
}

function setFilterTypeBadge(category, count) {
    const el = document.querySelector(`.filter-type[data-filter="${category}"]`);
    if (!el) return;
    let badge = el.querySelector('.filter-type-badge');
    if (!badge) {
        badge = document.createElement('span');
        badge.className = 'filter-type-badge';
        el.appendChild(badge);
    }
    if (count > 0) {
        badge.textContent = String(count);
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

function clearAllFilters() {
    document.querySelectorAll('.filter-form input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
    });
    
    ['state', 'status'].forEach(category => {
        updateSelectionCount(category);
    });
    
    updateFilterBadge();
}

function openInstitutionFormPanel(url, title) {
    document.getElementById('formPanelTitle').textContent = title;
    document.getElementById('institutionFormPanel').classList.add('active');
    document.getElementById('sidePanelOverlay').classList.add('active');
    fetch(url)
        .then(response => response.text())
        .then(html => {
            console.log(html);
            document.getElementById('institutionFormContainer').innerHTML = html;
            
            // Initialize the form after it's loaded
            initializeInstitutionForm();
        });
}

// Function to initialize the institution form after it's loaded dynamically
function initializeInstitutionForm() {
    // Function to toggle skillathon field based on onboarding type
    function toggleSkillathonField(onboardingType) {
        const skillathonFields = document.getElementById('skillathon-fields');
        console.log('Toggling skillathon field for onboarding type:', onboardingType);
        console.log('Skillathon fields element:', skillathonFields);
        
        if (onboardingType === 'b2c') {
            skillathonFields.style.display = 'block';
            console.log('Showing skillathon fields');
        } else {
            skillathonFields.style.display = 'none';
            console.log('Hiding skillathon fields');
        }
    }
    
    // Find the onboarding type select element
    const onboardingTypeSelect = document.querySelector('select[name="onboarding_type"]');
    console.log('Onboarding type select element:', onboardingTypeSelect);
    
    // Add event listener
    if (onboardingTypeSelect) {
        onboardingTypeSelect.addEventListener('change', function() {
            console.log('Onboarding type changed to:', this.value);
            toggleSkillathonField(this.value);
        });
        
        // Set initial state
        console.log('Setting initial state for onboarding type:', onboardingTypeSelect.value);
        toggleSkillathonField(onboardingTypeSelect.value);
    } else {
        console.error('Onboarding type select element not found');
    }
}

function closeInstitutionFormPanel() {
    document.getElementById('institutionFormPanel').classList.remove('active');
    document.getElementById('sidePanelOverlay').classList.remove('active');
    document.getElementById('institutionFormContainer').innerHTML = '';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Intercept form submission (optional, for AJAX submit)
document.addEventListener('submit', function(e) {
    if (e.target.closest('#institutionFormPanel form')) {
        e.preventDefault();
        const form = e.target;
        const url = form.action;
        const formData = new FormData(form);
        
        // Get the save button and add loading state
        const saveButton = form.querySelector('button[type="submit"]');
        if (saveButton) {
            document.getElementById("save-button").innerText = "Loading..."
            saveButton.classList.add('btn-loading');
        }
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            // Check if response is JSON (error) or HTML (form)
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    // Handle JSON error response
                    throw new Error(data.error || 'An error occurred');
                });
            } else {
                return response.text();
            }
        })
        .then(html => {
            // Remove loading state from button
            if (saveButton) {
                saveButton.classList.remove('btn-loading');
            }
            
            if (html.includes('form-group')) {
                // Form has errors, re-render it
                document.getElementById('institutionFormContainer').innerHTML = html;
            } else {
                // Success: close panel and show success message
                closeInstitutionFormPanel();
                showSuccess('Institution saved successfully!');
                // Reload the page after a short delay to show the success message
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            // Remove loading state from button on error
            if (saveButton) {
                saveButton.classList.remove('btn-loading');
            }
            
            // Handle JSON error responses
            console.error('Error:', error);
            showError(error.message);
        });
    }
});

// Add the notification functions
function showSuccess(message) {
    // Create a simple notification
    const notification = $(`
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-check-circle"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto remove after 5 seconds
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}

function showError(message) {
    // Create a simple notification
    const notification = $(`
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto remove after 5 seconds
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}

// Global variables for pagination and loading
let offset = 0;
const limit = 10;
let loading = false;
let allLoaded = false;
let searchQuery = '';

// Helper function to safely get elements
function getElement(id) {
    return document.getElementById(id);
}

// Helper function to safely set element style
function setElementStyle(id, property, value) {
    const element = getElement(id);
    if (element) {
        element.style[property] = value;
    }
}

// Helper function to safely set element text
function setElementText(id, text) {
    const element = getElement(id);
    if (element) {
        element.innerText = text;
    }
}

// Build query parameters for API calls
function buildInstitutionQueryParams() {
    const params = new URLSearchParams({
        offset: offset,
        limit: limit
    });
    
    if (searchQuery && searchQuery.trim() !== '') {
        params.append('search', searchQuery.trim());
        console.log('DEBUG: Adding search parameter:', searchQuery.trim());
    }
    
    // Add filter parameters
    const selectedGroups = Array.from(document.querySelectorAll('input[name="group"]:checked')).map(cb => cb.value);
    const selectedStates = Array.from(document.querySelectorAll('input[name="state"]:checked')).map(cb => cb.value);
    const selectedStatuses = Array.from(document.querySelectorAll('input[name="status"]:checked')).map(cb => cb.value);

    console.log('DEBUG: Selected groups:', selectedGroups);
    console.log(Array.from(document.querySelectorAll('input[name="group"]:checked')))
    console.log('DEBUG: Selected states:', selectedStates);
    console.log('DEBUG: Selected statuses:', selectedStatuses);
    
    selectedGroups.forEach(group => params.append('group', group));
    selectedStates.forEach(state => params.append('state', state));
    selectedStatuses.forEach(status => params.append('status', status));
    
    console.log('DEBUG: API URL params:', params.toString());
    return params.toString();
}

// Render institution row
function renderInstitutionRow(inst) {
    const row = document.createElement('tr');
    row.setAttribute('data-institution-id', inst.id);
    
    var showActions = userPermissions.canEdit || userPermissions.canDelete;
    
    var html = '<td><div class="institution"><span>' + inst.name + '</span></div></td>' +
               '<!-- <td>' + (inst.group ? inst.group : '-') + '</td> -->' +
               '<td>' + (inst.state ? inst.state : '-') + '</td>' +
               '<td>' + (inst.total_strength ? inst.total_strength : '-') + '</td>' +
               '<td>' +
                   (inst.unit_head ? '<div class="unit-head"><span>' + inst.unit_head + '</span></div>' : '<span class="text-muted">-</span>') +
               '</td>' +
               '<td>' +
                   '<label class="switch">' +
                       '<input type="checkbox" ' + (inst.is_active ? 'checked' : '') +
                       ' onchange="handleInstitutionStatusChange(' + inst.id + ', this.checked ? \'active\' : \'inactive\', this)">' +
                       '<span class="slider round"></span>' +
                   '</label>' +
               '</td>';
    
    // Actions column - only if user has permission
    if (showActions) {
        html += '<td><div class="actions">';
        
        if (userPermissions.canEdit) {
            html += '<a href="javascript:void(0);" class="btn-icon" ' +
                    'onclick="openInstitutionFormPanel(\'' + inst.edit_url + '\', \'Edit Institution\')" ' +
                    'title="Edit">' +
                    '<i class="fas fa-edit"></i>' +
                    '</a>';
        }
        
        // if (userPermissions.canDelete) {
        //     html += '<button type="button" class="btn-icon btn-danger" ' +
        //             'data-name="' + inst.name + '" ' +
        //             'data-url="' + inst.delete_url + '" ' +
        //             'onclick="confirmDelete(this)" ' +
        //             'title="Delete">' +
        //             '<i class="fas fa-trash"></i>' +
        //             '</button>';
        // }
        
        html += '</div></td>';
    }
    
    row.innerHTML = html;
    return row;
}

// Load institutions with improved error handling and loading states
function loadMoreInstitutions() {
    if (loading || allLoaded) return Promise.resolve();
    
    loading = true;
    setElementText('showMoreBtn', 'Loading...');
    setElementStyle('showMoreBtn', 'disabled', 'true');
    const apiUrl = `/onboarding/institutions/api/?${buildInstitutionQueryParams()}`;
    console.log('DEBUG: Making API call to:', apiUrl);
    
    return fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            console.log('DEBUG: API response:', data);
            
            const institutions = data.institutions || [];

            console.log('DEBUG: Institutions:', institutions);
            
            if (institutions.length < limit || data.all_loaded) {
                allLoaded = true;
                setElementStyle('showMoreBtn', 'display', 'none');
            }
            
            offset += institutions.length;
            
            const tbody = getElement('institutionTableBody');
            const emptyState = getElement('emptyState');
            
            if (tbody) {
                institutions.forEach(inst => {
                    tbody.appendChild(renderInstitutionRow(inst));
                });
                
                // Handle empty state
                if (offset === 0 && institutions.length === 0) {
                    tbody.innerHTML = '';
                    if (emptyState) {
                        emptyState.style.display = 'flex';
                        emptyState.classList.add('show');
                    }
                    setElementStyle('showMoreBtn', 'display', 'none');
                } else {
                    if (emptyState) {
                        emptyState.style.display = 'none';
                        emptyState.classList.remove('show');
                    }
                }
            }
            
            // Show/hide "Show More" button
            if (!allLoaded && institutions.length > 0) {
                setElementStyle('showMoreBtn', 'display', 'inline-block');
                setElementText('showMoreBtn', 'Show More');
                setElementStyle('showMoreBtn', 'disabled', 'false');
            }
        })
        .catch(error => {
            console.error('Error loading institutions:', error);
            showError('Failed to load institutions. Please try again.');
        })
        .finally(() => {
            loading = false;
            setElementStyle('institutionLoadingSpinner', 'display', 'none');
        });
}

// Real-time search function (like courses)
function filterInstitutions(searchText) {
    searchQuery = searchText || '';
    console.log('DEBUG: Real-time search triggered with:', searchQuery);
    resetInstitutionList();
    loadMoreInstitutions();
}

// Apply search with reset functionality (for button click)
function applySearch() {
    const searchInput = document.querySelector('.search-box input');
    if (searchInput) {
        searchQuery = searchInput.value.trim();
        console.log('DEBUG: Search button clicked, applying search:', searchQuery);
    }
    
    // Reset pagination and data
    resetInstitutionList();
    
    // Load institutions with search
    loadMoreInstitutions();
}

// Reset institution list for new searches/filters
function resetInstitutionList() {
    offset = 0;
    allLoaded = false;
    
    // Clear existing table content
    const tbody = getElement('institutionTableBody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    // Hide empty state initially
    const emptyState = getElement('emptyState');
    if (emptyState) {
        emptyState.style.display = 'none';
        emptyState.classList.remove('show');
    }
    
    // Reset show more button
    setElementStyle('showMoreBtn', 'display', 'inline-block');
    setElementText('showMoreBtn', 'Show More');
    setElementStyle('showMoreBtn', 'disabled', 'false');
}

// Apply filters with reset functionality
function applyFilters() {
    resetInstitutionList();
    loadMoreInstitutions();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search
    const searchInput = document.querySelector('.search-box input');
    if (searchInput) {
        // Set initial search query from URL params
        const urlParams = new URLSearchParams(window.location.search);
        searchQuery = urlParams.get('search') || '';
        searchInput.value = searchQuery;
        
        // Add Enter key event listener for search (optional, since we have real-time search)
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log('DEBUG: Enter key pressed, applying search');
                applySearch();
            }
        });
        
        // Add search button event listener
        const searchButton = document.querySelector('.btn-search');
        if (searchButton) {
            searchButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('DEBUG: Search button clicked, applying search');
                applySearch();
            });
        }
    }
    
    // Initialize selection counts
    ['group', 'state', 'status'].forEach(category => {
        updateSelectionCount(category);
    });
    
    // Load initial data
    loadMoreInstitutions();
});

// Variables to store institution info for the modal
let pendingInstitutionId = null;
let pendingInstitutionStatus = null;
let pendingInstitutionCheckbox = null;

function handleInstitutionStatusChange(institutionId, newStatus, checkboxElement) {
    if (newStatus === 'inactive') {
        // Store the pending info and show confirmation modal
        pendingInstitutionId = institutionId;
        pendingInstitutionStatus = newStatus;
        pendingInstitutionCheckbox = checkboxElement;

        // Show the modal
        const modal = document.getElementById('inactiveInstitutionModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    } else {
        // If marking as active, no confirmation needed
        toggleInstitutionStatus(institutionId, newStatus);
    }
}

function confirmInactiveInstitution() {
    // Hide modal
    document.getElementById('inactiveInstitutionModal').style.display = 'none';
    document.body.style.overflow = '';

    // Proceed with status change
    if (pendingInstitutionId && pendingInstitutionStatus) {
        toggleInstitutionStatus(pendingInstitutionId, pendingInstitutionStatus);
    }

    // Clear pending data
    pendingInstitutionId = null;
    pendingInstitutionStatus = null;
    pendingInstitutionCheckbox = null;
}

function cancelInactiveInstitution() {
    // Hide modal
    document.getElementById('inactiveInstitutionModal').style.display = 'none';
    document.body.style.overflow = '';

    // Revert the checkbox
    if (pendingInstitutionCheckbox) {
        pendingInstitutionCheckbox.checked = true; // Revert to active (checked)
    }

    // Clear pending data
    pendingInstitutionId = null;
    pendingInstitutionStatus = null;
    pendingInstitutionCheckbox = null;
}

function toggleInstitutionStatus(institutionId, status) {
    fetch(`/onboarding/institutions/${institutionId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.task_id) {
            // Show progress modal and start polling
            showProgressModal(data.task_id, data.total_learners, data.total_assessors, data.total_batches);
        } else {
            showNotification(data.error || 'Failed to update institution status', 'error');
            resetAndReload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating institution status', 'error');
        resetAndReload();
    });
}

function showProgressModal(taskId, totalLearners, totalAssessors, totalBatches) {
    // Create progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal-overlay';
    progressModal.id = 'progressModal';
    progressModal.style.display = 'flex';
    progressModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; min-width: 500px; max-width: 600px;">
            <h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 20px;">
                Updating Status
            </h3>
            <div style="margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; color: #4a5568; font-size: 14px;">
                    <strong>Learners:</strong> <span id="progressLearnersCount">0</span>/<span id="progressLearnerTotal">${totalLearners}</span>
                </p>
                <div style="background: #e2e8f0; border-radius: 8px; overflow: hidden; height: 8px;">
                    <div id="progressBarLearners" style="background: #1AA09A; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; color: #4a5568; font-size: 14px;">
                    <strong>Assessors:</strong> <span id="progressAssessorsCount">0</span>/<span id="progressAssessorTotal">${totalAssessors}</span>
                </p>
                <div style="background: #e2e8f0; border-radius: 8px; overflow: hidden; height: 8px;">
                    <div id="progressBarAssessors" style="background: #1AA09A; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; color: #4a5568; font-size: 14px;">
                    <strong>Batches:</strong> <span id="progressBatchesCount">0</span>/<span id="progressBatchTotal">${totalBatches}</span>
                </p>
                <div style="background: #e2e8f0; border-radius: 8px; overflow: hidden; height: 8px;">
                    <div id="progressBarBatches" style="background: #1AA09A; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
            <div style="padding: 15px; background: #f7fafc; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0; color: #718096; font-size: 13px;">
                    <strong>Current:</strong> <span id="progressCurrentUser">Starting...</span>
                </p>
            </div>
            <p style="margin: 0; color: #a0aec0; font-size: 12px; text-align: center;">
                Please wait while we update all users and batches...
            </p>
        </div>
    `;
    document.body.appendChild(progressModal);
    document.body.style.overflow = 'hidden';

    // Start polling for progress
    const pollInterval = setInterval(() => {
        fetch(`/api/status-update/${taskId}/`)
        .then(response => response.json())
        .then(progress => {
            if (progress.error) {
                clearInterval(pollInterval);
                removeProgressModal();
                showNotification('Task not found or expired', 'error');
                resetAndReload();
                return;
            }

            // Update progress display
            const learnersPercent = progress.total_learners > 0
                ? (progress.updated_learners / progress.total_learners) * 100
                : 100;
            const assessorsPercent = progress.total_assessors > 0
                ? (progress.updated_assessors / progress.total_assessors) * 100
                : 100;
            const batchesPercent = progress.total_batches > 0
                ? (progress.updated_batches / progress.total_batches) * 100
                : 100;

            document.getElementById('progressLearnersCount').textContent = progress.updated_learners;
            document.getElementById('progressAssessorsCount').textContent = progress.updated_assessors;
            document.getElementById('progressBatchesCount').textContent = progress.updated_batches;
            document.getElementById('progressBarLearners').style.width = learnersPercent + '%';
            document.getElementById('progressBarAssessors').style.width = assessorsPercent + '%';
            document.getElementById('progressBarBatches').style.width = batchesPercent + '%';
            document.getElementById('progressCurrentUser').textContent = progress.current_user;

            // Check if completed
            if (progress.status === 'completed') {
                clearInterval(pollInterval);
                setTimeout(() => {
                    removeProgressModal();
                    showNotification('Institution status updated successfully!', 'success');
                    resetAndReload();
                }, 1000);
            } else if (progress.status === 'error') {
                clearInterval(pollInterval);
                removeProgressModal();
                showNotification('Error updating status: ' + (progress.error || 'Unknown error'), 'error');
                resetAndReload();
            }
        })
        .catch(error => {
            console.error('Error polling progress:', error);
        });
    }, 3000); // Poll every 3 seconds
}

function removeProgressModal() {
    const modal = document.getElementById('progressModal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
}

function showAffectedUsersModal(affectedUsers, status) {
    const action = status === 'active' ? 'enabled' : 'disabled';
    let usersHtml = '';

    if (affectedUsers.learners && affectedUsers.learners.length > 0) {
        usersHtml += '<h4 style="margin-top: 16px; margin-bottom: 8px;">Learners (' + affectedUsers.learners.length + '):</h4>';
        usersHtml += '<ul style="list-style: none; padding-left: 0; max-height: 200px; overflow-y: auto;">';
        affectedUsers.learners.forEach(user => {
            usersHtml += '<li style="padding: 4px 0; border-bottom: 1px solid #e2e8f0;">' +
                         '<strong>' + user.name + '</strong><br>' +
                         '<small style="color: #666;">' + user.email + '</small></li>';
        });
        usersHtml += '</ul>';
    }

    if (affectedUsers.assessors && affectedUsers.assessors.length > 0) {
        usersHtml += '<h4 style="margin-top: 16px; margin-bottom: 8px;">Assessors (' + affectedUsers.assessors.length + '):</h4>';
        usersHtml += '<ul style="list-style: none; padding-left: 0; max-height: 200px; overflow-y: auto;">';
        affectedUsers.assessors.forEach(user => {
            usersHtml += '<li style="padding: 4px 0; border-bottom: 1px solid #e2e8f0;">' +
                         '<strong>' + user.name + '</strong><br>' +
                         '<small style="color: #666;">' + user.email + '</small></li>';
        });
        usersHtml += '</ul>';
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="confirmation-modal">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle" style="color: #1AA09A;"></i> Affected Users</h3>
            </div>
            <div class="modal-body">
                <p><strong>${affectedUsers.total_count} user account(s) have been ${action}:</strong></p>
                ${usersHtml}
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove(); document.body.style.overflow = ''; setTimeout(() => resetAndReload(), 500);">
                    <i class="fas fa-check"></i> OK
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- Confirmation Modal for Marking Institution as Inactive -->
<div class="modal-overlay" id="inactiveInstitutionModal" style="display: none;">
    <div class="confirmation-modal">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle" style="color: #F16564;"></i> Mark Institution as Inactive</h3>
        </div>
        <div class="modal-body">
            <p><strong>Please note the following:</strong></p>
            <ul style="list-style: none; padding-left: 0; margin: 16px 0;">
                <li style="margin-bottom: 12px;">
                    <i class="fas fa-eye-slash" style="color: #F16564; margin-right: 8px;"></i>
                    This institution will <strong>no longer be visible</strong> in relevant dropdowns
                </li>
                <li style="margin-bottom: 12px;">
                    <i class="fas fa-redo" style="color: #F16564; margin-right: 8px;"></i>
                    You can mark it as active again later if needed
                </li>
            </ul>
            <p style="margin-top: 16px; color: #666;">Are you sure you want to mark this institution as inactive?</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-light" onclick="cancelInactiveInstitution()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmInactiveInstitution()">
                <i class="fas fa-check"></i> Yes, Mark as Inactive
            </button>
        </div>
    </div>
</div>

{% endblock %} 