{% extends "assessments/base.html" %}
{% load static %}

{% block title %}Admin Report Portal{% endblock %}

{% block content %}
<style>
    /* Override base.html min-height to prevent unnecessary scrolling on empty state */
    #content {
        min-height: auto !important;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-left h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1.2;
    }

    .header-left p {
        margin: 2px 0 0;
        color: #666;
        font-size: 1rem;
    }

    /* Filters */
    .filters-section {
        margin-bottom: 32px;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        padding: 28px;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group > .select-filter {
        flex: 1;
        min-width: 200px;
    }

    .filter-group > .search-button {
        flex-shrink: 0;
        min-width: 80px;
    }

    .filter-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        background: white;
        transition: all 0.2s ease;
        color: #1a202c;
        font-weight: 500;
    }

    .filter-input:hover {
        border-color: #cbd5e1;
    }

    .filter-input:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
        background: #fff;
    }

    .search-button {
        padding: 12px 28px;
        background: linear-gradient(135deg, #F16564 0%, #e45857 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(241, 101, 100, 0.2);
        min-width: 80px;
    }

    .search-button:hover {
        background: linear-gradient(135deg, #e45857 0%, #d34746 100%);
        box-shadow: 0 4px 12px rgba(241, 101, 100, 0.3);
        transform: translateY(-1px);
    }

    .search-button:active {
        transform: translateY(0);
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    @media (max-width: 1024px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
    }

    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border: none;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1), 0 15px 20px -3px rgba(0, 0, 0, 0.15);
    }

    .kpi-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 4px;
        line-height: 1;
    }

    .kpi-subtitle {
        font-size: 13px;
        color: #64748b;
    }

    .grade-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 700;
        margin-left: 10px;
    }

    .grade-A { background: #dcfce7; color: #166534; }
    .grade-B { background: #dbeafe; color: #1e40af; }
    .grade-C { background: #fef3c7; color: #92400e; }
    .grade-D { background: #fed7aa; color: #9a3412; }
    .grade-E { background: #fee2e2; color: #991b1b; }

    /* Table Sections */
    .table-section {
        background: white;
        padding: 25px;
        border-radius: 16px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .table-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, #F16564, #ff8a8a);
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a202c;
        margin: 0 0 20px 0;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: #1a202c;
        font-size: 14px;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table td {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 14px;
    }

    .data-table tbody tr:hover {
        background: #f8fafc;
    }

    .search-box {
        width: 100%;
        max-width: 400px;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .search-box:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.1);
    }

    .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .loading {
        text-align: center;
        padding: 48px 24px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #F16564;
        border-radius: 50%;
        margin: 0 auto 16px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 80px 24px;
        color: #64748b;
        background: #f8fafc;
        border-radius: 12px;
        border: 2px dashed #e2e8f0;
        margin: 24px 0;
        transition: all 0.3s ease;
    }

    .empty-state:hover {
        border-color: #cbd5e0;
        background: #f1f5f9;
    }

    .empty-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(241, 101, 100, 0.1), rgba(241, 101, 100, 0.05));
        border-radius: 50%;
        position: relative;
    }

    .empty-icon svg {
        position: relative;
        z-index: 1;
        width: 48px;
        height: 48px;
        opacity: 0.6;
        color: #F16564;
    }

    .empty-text {
        font-size: 16px;
        margin: 0;
        color: #475569;
        font-weight: 500;
        line-height: 1.6;
        max-width: 500px;
        margin: 0 auto;
    }

    .empty-subtitle {
        font-size: 14px;
        color: #94a3b8;
        margin-top: 8px;
        font-weight: 400;
    }

    .select-filter {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        color: #1a202c;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 40px;
    }

    .select-filter:hover {
        border-color: #cbd5e1;
    }

    .select-filter:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
    }

    /* Searchable Dropdown */
    .searchable-dropdown {
        position: relative;
        min-width: 220px;
    }

    .searchable-dropdown-toggle {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: #1a202c;
        font-weight: 500;
        transition: all 0.2s ease;
        min-height: 46px;
        box-sizing: border-box;
    }

    .searchable-dropdown-toggle:hover {
        border-color: #cbd5e1;
        cursor: pointer;
    }

    .searchable-dropdown-toggle:focus,
    .searchable-dropdown-toggle.active {
        border-color: #F16564;
        outline: none;
        box-shadow: 0 0 0 4px rgba(241, 101, 100, 0.08);
    }

    .searchable-dropdown-toggle .placeholder {
        color: #64748b;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .searchable-dropdown-toggle .selected-text {
        color: #1a202c;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .searchable-dropdown-toggle .arrow {
        transition: all 0.2s ease;
        margin-left: 12px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
    }

    .searchable-dropdown-toggle .arrow svg {
        width: 12px;
        height: 8px;
    }

    .searchable-dropdown-toggle.active .arrow {
        transform: rotate(180deg);
        color: #F16564;
    }

    .searchable-dropdown-menu {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        min-width: 300px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        max-height: 400px;
        overflow: hidden;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }

    .searchable-dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .searchable-dropdown-search {
        position: sticky;
        top: 0;
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(to bottom, #f8fafc, #ffffff);
        z-index: 1;
    }

    .searchable-dropdown-search input {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
        transition: all 0.2s ease;
        background: white;
        color: #1a202c;
    }

    .searchable-dropdown-search input::placeholder {
        color: #94a3b8;
        font-weight: 400;
    }

    .searchable-dropdown-search input:focus {
        border-color: #F16564;
        box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.1);
    }

    .searchable-dropdown-search::before {
        content: 'üîç';
        position: absolute;
        left: 24px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        opacity: 0.5;
        pointer-events: none;
        z-index: 1;
    }

    .searchable-dropdown-options {
        max-height: 320px;
        overflow-y: auto;
        background: white;
    }

    .searchable-dropdown-options::-webkit-scrollbar {
        width: 6px;
    }

    .searchable-dropdown-options::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .searchable-dropdown-options::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }

    .searchable-dropdown-options::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .searchable-dropdown-option {
        padding: 12px 16px;
        cursor: pointer;
        font-size: 14px;
        color: #475569;
        transition: all 0.15s ease;
        border-bottom: 1px solid #f1f5f9;
    }

    .searchable-dropdown-option:last-child {
        border-bottom: none;
    }

    .searchable-dropdown-option:hover {
        background: #f8fafc;
        padding-left: 20px;
    }

    .searchable-dropdown-option.selected {
        background: rgba(241, 101, 100, 0.08);
        color: #F16564;
        font-weight: 600;
        border-left: 3px solid #F16564;
    }

    .searchable-dropdown-option.selected:hover {
        background: rgba(241, 101, 100, 0.12);
    }

    .searchable-dropdown-option.hidden {
        display: none;
    }

    .searchable-dropdown-no-results {
        padding: 24px 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 14px;
        font-style: italic;
    }
</style>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1>Admin Report Portal</h1>
        <p class="text-muted">View comprehensive analytics and KPIs across all institutions</p>
    </div>
</div>

<!-- Main Content -->
<div>
    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filter-group">
            <div class="searchable-dropdown" id="institutionDropdown">
                <div class="searchable-dropdown-toggle" id="institutionToggle" tabindex="0">
                    <span class="placeholder">Select Institution/Hospital *</span>
                    <span class="arrow">
                        <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                </div>
                <div class="searchable-dropdown-menu" id="institutionMenu">
                    <div class="searchable-dropdown-search">
                        <input type="text" id="institutionSearch" placeholder="Search...">
                    </div>
                    <div class="searchable-dropdown-options" id="institutionOptions">
                        <!-- Options will be populated dynamically -->
                    </div>
                </div>
            </div>
            <input type="hidden" id="institutionFilter" value="">

            <select id="academicYearFilter" class="select-filter">
                <option value="">Select Academic Year *</option>
            </select>

            <select id="semesterFilter" class="select-filter">
                <option value="">All Semesters</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
                <option value="4">Semester 4</option>
                <option value="5">Semester 5</option>
                <option value="6">Semester 6</option>
                <option value="7">Semester 7</option>
                <option value="8">Semester 8</option>
            </select>

            <select id="osceLevelFilter" class="select-filter">
                <option value="">All OSCE Levels</option>
                <option value="Classroom">Classroom</option>
                <option value="Mock">Mock</option>
                <option value="Final">Final</option>
            </select>

            <button class="search-button" onclick="applyFilters()">Go</button>
        </div>
    </div>

    <!-- KPI Section -->
    <div id="kpiSection">
        <h3 class="section-title">Key Performance Indicators</h3>
        <div id="kpiContainer" class="kpi-grid">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">Select Academic Year and Institution to view KPIs</p>
                <p class="empty-subtitle">Use the filters above to get started</p>
            </div>
        </div>
    </div>

    <!-- Institutions Metrics Table -->
    <div class="table-section">
        <h3 class="section-title">Institution Performance Metrics</h3>
        <input
            type="text"
            id="institutionSearchInput"
            class="search-box"
            placeholder="Search institutions..."
            onkeyup="filterInstitutionsTable(this.value)"
        />
        <div id="institutionsMetricsContainer">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No institutions data available</p>
                <p class="empty-subtitle">Apply filters to view institution performance</p>
            </div>
        </div>
    </div>

    <!-- State-Level Analysis Table -->
    <div class="table-section">
        <h3 class="section-title">State-Level Analysis</h3>
        <input
            type="text"
            id="stateSearchInput"
            class="search-box"
            placeholder="Search by state..."
            onkeyup="filterStateAnalysisTable(this.value)"
        />
        <div id="stateAnalysisContainer">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No state data available</p>
                <p class="empty-subtitle">Apply filters to view state-level analysis</p>
            </div>
        </div>
    </div>

    <!-- OSCE Type Analysis Table -->
    <div class="table-section">
        <h3 class="section-title">OSCE Type Analysis</h3>
        <div id="osceTypeAnalysisContainer">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No OSCE type data available</p>
                <p class="empty-subtitle">Apply filters to view OSCE type analysis</p>
            </div>
        </div>
    </div>

    <!-- Category Usage Analytics Table -->
    <div class="table-section">
        <h3 class="section-title">Category Usage Analytics</h3>
        <input
            type="text"
            id="categorySearchInput"
            class="search-box"
            placeholder="Search by category name..."
            onkeyup="filterCategoryTable(this.value)"
        />
        <div id="categoryAnalysisContainer">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No category data available</p>
                <p class="empty-subtitle">Apply filters to view category usage analytics</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentFilters = {
    academic_year: '2025',
    institution: 'All',
    semester: '',
    osce_level: ''
};
let kpiData = null;
let availableInstitutions = [];

// Load filter options on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    // Load metrics with default filters (current year 2025 + all institutions)
    setTimeout(() => {
        applyFilters();
    }, 500);
});

function initializeFilters() {
    // Load academic years (2025 to 2050)
    const yearSelect = document.getElementById('academicYearFilter');
    for (let year = 2025; year <= 2050; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
    // Set default to current year (2025)
    yearSelect.value = 2025;

    // Set default semester to "All Semesters" (empty value)
    document.getElementById('semesterFilter').value = '';

    // Set default OSCE level to "All OSCE Levels" (empty value)
    document.getElementById('osceLevelFilter').value = '';

    // Load institutions from backend API (which also sets default to "All")
    loadInstitutions();
}

function loadInstitutions() {
    // Fetch institutions and hospitals from Django backend
    fetch('/api/institutions-hospitals-for-report/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const institutions = data.institutions || [];
                const hospitals = data.hospitals || [];

                // Combine institutions and hospitals, sorted by name
                const allUnits = [...institutions, ...hospitals]
                    .map(u => ({ name: u.name, type: u.type }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                const optionsContainer = document.getElementById('institutionOptions');
                optionsContainer.innerHTML = '';

                // Add "All Institutions/Hospitals" option first
                const allOptionEl = document.createElement('div');
                allOptionEl.className = 'searchable-dropdown-option';
                allOptionEl.setAttribute('data-value', 'All');
                allOptionEl.textContent = 'All Institutions/Hospitals';
                allOptionEl.onclick = () => selectInstitution('All', 'All Institutions/Hospitals');
                optionsContainer.appendChild(allOptionEl);

                // Add other institutions and hospitals
                allUnits.forEach(unit => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'searchable-dropdown-option';
                    optionEl.setAttribute('data-value', unit.name);
                    optionEl.textContent = unit.name;
                    optionEl.onclick = () => selectInstitution(unit.name, unit.name);
                    optionsContainer.appendChild(optionEl);
                });

                // Initialize dropdown handlers
                initSearchableDropdown();

                // Set default institution to "All" after loading
                selectInstitution('All', 'All Institutions/Hospitals');
            }
        })
        .catch(error => {
            console.error('Error loading institutions/hospitals:', error);
        });
}

function selectInstitution(value, label) {
    document.getElementById('institutionFilter').value = value;

    // Update toggle text
    const toggle = document.getElementById('institutionToggle');
    const textSpan = toggle.querySelector('span:not(.arrow)');
    if (textSpan) {
        textSpan.textContent = label;
        // Remove placeholder class since we now have selected text
        textSpan.classList.remove('placeholder');
        textSpan.classList.add('selected-text');
    }

    // Update selected state in options
    document.querySelectorAll('.searchable-dropdown-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    const selectedOption = document.querySelector(`[data-value="${value}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }

    // Close dropdown
    const menu = document.getElementById('institutionMenu');
    if (menu) menu.classList.remove('show');
    const toggleBtn = document.getElementById('institutionToggle');
    if (toggleBtn) toggleBtn.classList.remove('active');
}

function initSearchableDropdown() {
    const toggle = document.getElementById('institutionToggle');
    const menu = document.getElementById('institutionMenu');
    const search = document.getElementById('institutionSearch');
    const options = document.getElementById('institutionOptions');

    if (!toggle || !menu) return;

    // Toggle dropdown
    toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = menu.classList.contains('show');
        if (isOpen) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        } else {
            menu.classList.add('show');
            toggle.classList.add('active');
            search.focus();
        }
    });

    // Search functionality
    search.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('.searchable-dropdown-option').forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                option.classList.remove('hidden');
            } else {
                option.classList.add('hidden');
            }
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!document.getElementById('institutionDropdown').contains(e.target)) {
            menu.classList.remove('show');
            toggle.classList.remove('active');
        }
    });
}

function applyFilters() {
    currentFilters = {
        academic_year: document.getElementById('academicYearFilter').value,
        institution: document.getElementById('institutionFilter').value,
        semester: document.getElementById('semesterFilter').value,
        osce_level: document.getElementById('osceLevelFilter').value
    };

    loadKPIsAndMetrics();
}

function loadKPIsAndMetrics() {
    loadKPIs();
    loadInstitutionsMetrics();
    loadStateAnalysis();
    loadOSCETypeAnalysis();
    loadCategoryAnalysis();
}

function loadKPIs() {
    const year = currentFilters.academic_year || new Date().getFullYear().toString();
    const semester = currentFilters.semester && currentFilters.semester !== '' ? currentFilters.semester : null;
    const institution = currentFilters.institution !== 'All' ? currentFilters.institution : null;
    const osceLevel = currentFilters.osce_level && currentFilters.osce_level !== '' ? currentFilters.osce_level : 'All';

    // Determine which endpoint to use
    // Use UnitMetrics when NO semester filter (all semesters) AND no OSCE level filter
    // Use SemesterMetrics when specific semester OR specific OSCE level is selected
    const useUnitMetrics = !semester && osceLevel === 'All';
    const endpoint = useUnitMetrics ? '/api/unit-metrics/' : '/api/semester-metrics/';
    const params = new URLSearchParams();

    // Build query parameters
    if (year) params.append('year', year);
    if (institution) params.append('unit_name', institution);
    if (semester) params.append('semester', semester);
    if (osceLevel !== 'All') params.append('osce_level', osceLevel);

    // Fetch metrics based on which endpoint we're using
    fetch(`${endpoint}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.documents && data.documents.length > 0) {
                // Extract the data from documents array
                const metricsArray = data.documents.map(doc => doc.data);
                // Aggregate KPIs from semester metrics
                const kpis = aggregateKPIsFromMetrics(metricsArray);
                displayKPIs(kpis);
                kpiData = kpis;
            } else {
                document.getElementById('kpiContainer').innerHTML =
                    `<div class="empty-state">
                        <div class="empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                                <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                                <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                            </svg>
                        </div>
                        <p class="empty-text">No KPI data available</p>
                        <p class="empty-subtitle">Try selecting different filters</p>
                    </div>`;
            }
        })
        .catch(error => {
            console.error('Error loading KPIs:', error);
            document.getElementById('kpiContainer').innerHTML =
                `<div class="error">Error loading KPIs: ${error.message}</div>`;
        });
}

function aggregateKPIsFromMetrics(metricsArray) {
    // Handle both UnitMetrics and SemesterMetrics
    // UnitMetrics: already aggregated per unit/year
    // SemesterMetrics: per semester, need aggregation

    const kpis = {
        institutions_active: new Set(),
        students_assessed_set: new Set(),
        osces_conducted: 0,
        total_students: 0,
        scores: []
    };

    let studentsAssessedFromUnitMetrics = 0;

    metricsArray.forEach(metric => {
        if (metric.unit_name) {
            kpis.institutions_active.add(metric.unit_name);
        }

        // Handle both UnitMetrics (total_osces) and SemesterMetrics (osces_conducted)
        kpis.osces_conducted += metric.total_osces || metric.osces_conducted || 0;
        kpis.total_students += metric.total_students || 0;

        // UnitMetrics has pre-calculated students_assessed
        // SemesterMetrics has assessed_student_ids that need de-duplication
        if (metric.students_assessed) {
            // UnitMetrics: students_assessed is already the count
            studentsAssessedFromUnitMetrics += metric.students_assessed;
        }

        // Collect assessed student IDs (from SemesterMetrics)
        if (metric.assessed_student_ids && Array.isArray(metric.assessed_student_ids)) {
            metric.assessed_student_ids.forEach(id => kpis.students_assessed_set.add(id));
        }

        // Collect scores for pass rate calculation
        // Both UnitMetrics and SemesterMetrics have raw_scores (student percentages)
        if (metric.raw_scores && Array.isArray(metric.raw_scores)) {
            kpis.scores.push(...metric.raw_scores);
        }
    });

    // Calculate aggregated metrics
    const institutionsCount = kpis.institutions_active.size;
    // Priority: Use UnitMetrics students_assessed if available, otherwise use unique assessed_student_ids from SemesterMetrics
    const studentsCount = studentsAssessedFromUnitMetrics > 0
        ? studentsAssessedFromUnitMetrics
        : kpis.students_assessed_set.size;

    const avgScore = kpis.scores.length > 0
        ? (kpis.scores.reduce((a, b) => a + b, 0) / kpis.scores.length).toFixed(2)
        : 0;
    const passCount = kpis.scores.filter(s => s >= 80).length;
    const passRate = kpis.scores.length > 0
        ? ((passCount / kpis.scores.length) * 100).toFixed(2)
        : 0;

    return {
        institutions_active: institutionsCount,
        students_assessed: studentsCount,
        osces_conducted: kpis.osces_conducted,
        total_students: kpis.total_students,
        avg_osce_score: parseFloat(avgScore),
        avg_osce_grade: getGradeFromPercentage(parseFloat(avgScore)),
        pass_rate: parseFloat(passRate)
    };
}

function getGradeFromPercentage(percentage) {
    if (!percentage && percentage !== 0) return 'N/A';
    if (percentage >= 90) return 'A';
    if (percentage >= 80) return 'B';
    if (percentage >= 70) return 'C';
    if (percentage >= 60) return 'D';
    return 'E';
}

function displayKPIs(kpis) {
    const kpiContainer = document.getElementById('kpiContainer');
    kpiContainer.innerHTML = '';

    const kpiItems = [
        {
            label: 'Institutions Active',
            value: kpis.institutions_active || 0,
            subtitle: 'Number of institutions with completed OSCEs'
        },
        {
            label: 'Students Assessed',
            value: kpis.students_assessed || 0,
            subtitle: 'Total students who completed at least one OSCE'
        },
        {
            label: 'OSCEs Conducted',
            value: kpis.osces_conducted || 0,
            subtitle: 'Total count of OSCE events'
        },
        {
            label: 'Avg OSCE Score',
            value: `${(kpis.avg_osce_score || 0).toFixed(2)}%`,
            grade: kpis.avg_osce_grade || 'N/A',
            subtitle: 'Overall Performance'
        },
        {
            label: 'Pass Rate',
            value: `${(kpis.pass_rate || 0).toFixed(2)}%`,
            subtitle: 'Students scoring ‚â•80%'
        },
        {
            label: 'Total Students',
            value: kpis.total_students || 0,
            subtitle: 'Total enrolled students'
        }
    ];

    kpiItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'kpi-card';

        // Build the value HTML - include grade badge for Avg OSCE Score
        let valueHtml = typeof item.value === 'number' ? item.value.toLocaleString() : item.value;
        if (item.grade) {
            valueHtml += `<span class="grade-badge grade-${item.grade}">${item.grade}</span>`;
        }

        card.innerHTML = `
            <div class="kpi-label">${item.label}</div>
            <div class="kpi-value">${valueHtml}</div>
            <div class="kpi-subtitle">${item.subtitle}</div>
        `;
        kpiContainer.appendChild(card);
    });
}

function loadInstitutionsMetrics() {
    const year = currentFilters.academic_year || new Date().getFullYear().toString();
    const semester = currentFilters.semester && currentFilters.semester !== '' ? currentFilters.semester : null;
    const institution = currentFilters.institution !== 'All' ? currentFilters.institution : null;
    const osceLevel = currentFilters.osce_level && currentFilters.osce_level !== '' ? currentFilters.osce_level : 'All';

    // Determine endpoint based on semester selection and OSCE level
    const useUnitMetrics = !semester && osceLevel === 'All';
    const endpoint = useUnitMetrics ? '/api/unit-metrics/' : '/api/semester-metrics/';

    const params = new URLSearchParams();
    if (year) params.append('year', year);
    if (institution) params.append('unit_name', institution);
    if (semester) params.append('semester', semester);
    if (osceLevel !== 'All') params.append('osce_level', osceLevel);

    fetch(`${endpoint}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.documents && data.documents.length > 0) {
                const metricsArray = data.documents.map(doc => doc.data);
                displayInstitutionsMetrics(metricsArray);
            } else {
                displayInstitutionsMetrics([]);
            }
        })
        .catch(error => {
            console.error('Error loading institutions metrics:', error);
            displayInstitutionsMetrics([]);
        });
}

function displayInstitutionsMetrics(metricsArray) {
    const container = document.getElementById('institutionsMetricsContainer');

    // Clear search input and any previous "no results" message
    const searchInput = document.getElementById('institutionSearchInput');
    if (searchInput) searchInput.value = '';
    const noResults = document.getElementById('noSearchResults');
    if (noResults) noResults.remove();

    if (!metricsArray || metricsArray.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No institutions data available</p>
                <p class="empty-subtitle">Apply filters to view institution performance</p>
            </div>
        `;
        return;
    }

    // Store the metrics array globally for sorting
    window.institutionsMetricsData = metricsArray;

    // Create table with sortable headers
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortInstitutionsTable(0)">Institution <span id="institutionSort"></span></th>';
    tableHtml += '<th style="cursor: pointer;" onclick="sortInstitutionsTable(1)">State <span id="stateSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(2)">Avg Score <span id="avgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(3)">Pass % <span id="passRateSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(4)">OSCEs <span id="oscesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(5)">Students Enrolled <span id="studentsSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    metricsArray.forEach(metric => {
        const avgScore = parseFloat(metric.avg_score || 0).toFixed(2);
        const passRate = parseFloat(metric.pass_rate || 0).toFixed(2);
        const oscesCount = metric.osces_conducted || metric.total_osces || 0;
        const totalStudents = metric.total_students || 0;
        const institutionName = metric.unit_name || 'Unknown';
        const state = metric.state || 'Unknown';

        tableHtml += `
            <tr>
                <td>${institutionName}</td>
                <td>${state}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
                <td style="text-align: center;">${oscesCount}</td>
                <td style="text-align: center;">${totalStudents}</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';

    container.innerHTML = tableHtml;

    // Reset all sort indicators
    document.getElementById('institutionSort').textContent = '';
    document.getElementById('stateSort').textContent = '';
    document.getElementById('avgScoreSort').textContent = '';
    document.getElementById('passRateSort').textContent = '';
    document.getElementById('oscesSort').textContent = '';
    document.getElementById('studentsSort').textContent = '';
}

// Global sort state for institutions table
let institutionsSortState = {
    currentColumn: null,
    ascending: true
};

function sortInstitutionsTable(columnIndex) {
    const data = window.institutionsMetricsData;
    if (!data) return;

    // Toggle sort direction if clicking the same column
    if (institutionsSortState.currentColumn === columnIndex) {
        institutionsSortState.ascending = !institutionsSortState.ascending;
    } else {
        institutionsSortState.currentColumn = columnIndex;
        institutionsSortState.ascending = true;
    }

    // Sort the data based on column
    const sortedData = [...data].sort((a, b) => {
        let aVal, bVal;

        switch(columnIndex) {
            case 0: // Institution name
                aVal = (a.unit_name || '').toLowerCase();
                bVal = (b.unit_name || '').toLowerCase();
                return institutionsSortState.ascending ?
                    aVal.localeCompare(bVal) :
                    bVal.localeCompare(aVal);

            case 1: // State
                aVal = (a.state || '').toLowerCase();
                bVal = (b.state || '').toLowerCase();
                return institutionsSortState.ascending ?
                    aVal.localeCompare(bVal) :
                    bVal.localeCompare(aVal);

            case 2: // Avg Score
                aVal = parseFloat(a.avg_score || 0);
                bVal = parseFloat(b.avg_score || 0);
                return institutionsSortState.ascending ? aVal - bVal : bVal - aVal;

            case 3: // Pass Rate
                aVal = parseFloat(a.pass_rate || 0);
                bVal = parseFloat(b.pass_rate || 0);
                return institutionsSortState.ascending ? aVal - bVal : bVal - aVal;

            case 4: // OSCEs
                aVal = a.osces_conducted || a.total_osces || 0;
                bVal = b.osces_conducted || b.total_osces || 0;
                return institutionsSortState.ascending ? aVal - bVal : bVal - aVal;

            case 5: // Students Enrolled
                aVal = a.total_students || 0;
                bVal = b.total_students || 0;
                return institutionsSortState.ascending ? aVal - bVal : bVal - aVal;

            default:
                return 0;
        }
    });

    // Clear all sort indicators
    document.getElementById('institutionSort').textContent = '';
    document.getElementById('stateSort').textContent = '';
    document.getElementById('avgScoreSort').textContent = '';
    document.getElementById('passRateSort').textContent = '';
    document.getElementById('oscesSort').textContent = '';
    document.getElementById('studentsSort').textContent = '';

    // Set the sort indicator for current column
    const sortIndicator = institutionsSortState.ascending ? '‚ñ≤' : '‚ñº';
    const sortSpans = ['institutionSort', 'stateSort', 'avgScoreSort', 'passRateSort', 'oscesSort', 'studentsSort'];
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;

    // Re-render the table with sorted data
    const container = document.getElementById('institutionsMetricsContainer');
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortInstitutionsTable(0)">Institution <span id="institutionSort"></span></th>';
    tableHtml += '<th style="cursor: pointer;" onclick="sortInstitutionsTable(1)">State <span id="stateSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(2)">Avg Score <span id="avgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(3)">Pass % <span id="passRateSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(4)">OSCEs <span id="oscesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortInstitutionsTable(5)">Students Enrolled <span id="studentsSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    sortedData.forEach(metric => {
        const avgScore = parseFloat(metric.avg_score || 0).toFixed(2);
        const passRate = parseFloat(metric.pass_rate || 0).toFixed(2);
        const oscesCount = metric.osces_conducted || metric.total_osces || 0;
        const totalStudents = metric.total_students || 0;
        const institutionName = metric.unit_name || 'Unknown';
        const state = metric.state || 'Unknown';

        tableHtml += `
            <tr>
                <td>${institutionName}</td>
                <td>${state}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
                <td style="text-align: center;">${oscesCount}</td>
                <td style="text-align: center;">${totalStudents}</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Re-apply the search filter if there's active search
    const searchInput = document.getElementById('institutionSearchInput');
    if (searchInput && searchInput.value) {
        filterInstitutionsTable(searchInput.value);
    }

    // Set the correct sort indicator for current column
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;
}

function filterInstitutionsTable(searchTerm) {
    const rows = document.querySelectorAll('#institutionsMetricsContainer table tbody tr');
    const searchLower = searchTerm.toLowerCase();

    rows.forEach(row => {
        const institutionName = row.cells[0].textContent.toLowerCase();
        if (institutionName.includes(searchLower)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // Show/hide "no results" message
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    const table = document.querySelector('#institutionsMetricsContainer table');

    if (visibleRows.length === 0 && table) {
        if (!document.getElementById('noSearchResults')) {
            const noResults = document.createElement('div');
            noResults.id = 'noSearchResults';
            noResults.style.cssText = 'text-align: center; padding: 32px; color: #64748b;';
            noResults.innerHTML = `<p style="font-size: 14px;">No institutions found matching "${searchTerm}"</p>`;
            table.parentElement.appendChild(noResults);
        }
    } else {
        const noResults = document.getElementById('noSearchResults');
        if (noResults) noResults.remove();
    }
}

// ============================================
// STATE ANALYSIS FUNCTIONS
// ============================================

function loadStateAnalysis() {
    const year = currentFilters.academic_year || new Date().getFullYear().toString();
    const semester = currentFilters.semester && currentFilters.semester !== '' ? currentFilters.semester : null;
    const institution = currentFilters.institution !== 'All' ? currentFilters.institution : null;
    const osceLevel = currentFilters.osce_level && currentFilters.osce_level !== '' ? currentFilters.osce_level : 'All';

    // Determine which endpoint to use - use SemesterMetrics if osce_level filter is applied
    const useUnitMetrics = !semester && osceLevel === 'All';
    const endpoint = useUnitMetrics ? '/api/unit-metrics/' : '/api/semester-metrics/';
    const params = new URLSearchParams();

    if (year) params.append('year', year);
    if (institution) params.append('unit_name', institution);
    if (semester) params.append('semester', semester);
    if (osceLevel !== 'All') params.append('osce_level', osceLevel);

    fetch(`${endpoint}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.documents && data.documents.length > 0) {
                const metricsArray = data.documents.map(doc => doc.data);
                const stateMetrics = aggregateMetricsByState(metricsArray);
                displayStateAnalysis(stateMetrics);
            } else {
                displayStateAnalysis([]);
            }
        })
        .catch(error => {
            console.error('Error loading state analysis:', error);
            displayStateAnalysis([]);
        });
}

function aggregateMetricsByState(metricsArray) {
    // Group metrics by state and aggregate
    const stateGroups = {};

    metricsArray.forEach(metric => {
        const state = metric.state || 'Unknown';

        if (!stateGroups[state]) {
            stateGroups[state] = {
                state: state,
                institutes: new Set(),
                students: 0,
                scores: [],
                osces: 0,
                passCount: 0
            };
        }

        // Add institution to set (for unique count)
        if (metric.unit_name) {
            stateGroups[state].institutes.add(metric.unit_name);
        }

        // Sum students
        stateGroups[state].students += metric.total_students || 0;

        // Collect scores for averaging
        if (metric.raw_scores && Array.isArray(metric.raw_scores)) {
            stateGroups[state].scores.push(...metric.raw_scores);
        }

        // Sum OSCEs
        stateGroups[state].osces += metric.total_osces || metric.osces_conducted || 0;

        // Count pass (score >= 80)
        if (metric.raw_scores && Array.isArray(metric.raw_scores)) {
            stateGroups[state].passCount += metric.raw_scores.filter(s => s >= 80).length;
        }
    });

    // Convert to array and calculate final metrics
    const stateMetrics = Object.values(stateGroups).map(state => {
        const institutesCount = state.institutes.size;
        const avgScore = state.scores.length > 0
            ? (state.scores.reduce((a, b) => a + b, 0) / state.scores.length)
            : 0;
        const passRate = state.scores.length > 0
            ? ((state.passCount / state.scores.length) * 100)
            : 0;

        return {
            state: state.state,
            institutes: institutesCount,
            students: state.students,
            avg_score: avgScore,
            pass_rate: passRate,
            osces: state.osces
        };
    });

    return stateMetrics;
}

function displayStateAnalysis(stateMetricsArray) {
    const container = document.getElementById('stateAnalysisContainer');

    // Clear search input and any previous "no results" message
    const searchInput = document.getElementById('stateSearchInput');
    if (searchInput) searchInput.value = '';
    const noResults = document.getElementById('stateNoSearchResults');
    if (noResults) noResults.remove();

    if (!stateMetricsArray || stateMetricsArray.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No state data available</p>
                <p class="empty-subtitle">Apply filters to view state-level analysis</p>
            </div>
        `;
        return;
    }

    // Store the metrics array globally for sorting
    window.stateMetricsData = stateMetricsArray;

    // Create table with sortable headers
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortStateAnalysisTable(0)">State <span id="stateNameSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(1)">Institutes <span id="institutesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(2)">Students <span id="stateStudentsSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(3)">Avg Score <span id="stateAvgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(4)">Pass % <span id="statePassRateSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(5)">OSCEs <span id="stateOscesSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    stateMetricsArray.forEach(state => {
        const avgScore = parseFloat(state.avg_score || 0).toFixed(2);
        const passRate = parseFloat(state.pass_rate || 0).toFixed(2);
        const stateName = state.state || 'Unknown';
        const institutes = state.institutes || 0;
        const students = state.students || 0;
        const osces = state.osces || 0;

        tableHtml += `
            <tr>
                <td>${stateName}</td>
                <td style="text-align: center;">${institutes}</td>
                <td style="text-align: center;">${students}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
                <td style="text-align: center;">${osces}</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Reset all sort indicators
    document.getElementById('stateNameSort').textContent = '';
    document.getElementById('institutesSort').textContent = '';
    document.getElementById('stateStudentsSort').textContent = '';
    document.getElementById('stateAvgScoreSort').textContent = '';
    document.getElementById('statePassRateSort').textContent = '';
    document.getElementById('stateOscesSort').textContent = '';
}

// Global sort state for state analysis table
let stateAnalysisSortState = {
    currentColumn: null,
    ascending: true
};

function sortStateAnalysisTable(columnIndex) {
    const data = window.stateMetricsData;
    if (!data) return;

    // Toggle sort direction if clicking the same column
    if (stateAnalysisSortState.currentColumn === columnIndex) {
        stateAnalysisSortState.ascending = !stateAnalysisSortState.ascending;
    } else {
        stateAnalysisSortState.currentColumn = columnIndex;
        stateAnalysisSortState.ascending = true;
    }

    // Sort the data based on column
    const sortedData = [...data].sort((a, b) => {
        let aVal, bVal;

        switch(columnIndex) {
            case 0: // State name
                aVal = (a.state || '').toLowerCase();
                bVal = (b.state || '').toLowerCase();
                return stateAnalysisSortState.ascending ?
                    aVal.localeCompare(bVal) :
                    bVal.localeCompare(aVal);

            case 1: // Institutes
                aVal = a.institutes || 0;
                bVal = b.institutes || 0;
                return stateAnalysisSortState.ascending ? aVal - bVal : bVal - aVal;

            case 2: // Students
                aVal = a.students || 0;
                bVal = b.students || 0;
                return stateAnalysisSortState.ascending ? aVal - bVal : bVal - aVal;

            case 3: // Avg Score
                aVal = parseFloat(a.avg_score || 0);
                bVal = parseFloat(b.avg_score || 0);
                return stateAnalysisSortState.ascending ? aVal - bVal : bVal - aVal;

            case 4: // Pass Rate
                aVal = parseFloat(a.pass_rate || 0);
                bVal = parseFloat(b.pass_rate || 0);
                return stateAnalysisSortState.ascending ? aVal - bVal : bVal - aVal;

            case 5: // OSCEs
                aVal = a.osces || 0;
                bVal = b.osces || 0;
                return stateAnalysisSortState.ascending ? aVal - bVal : bVal - aVal;

            default:
                return 0;
        }
    });

    // Clear all sort indicators
    document.getElementById('stateNameSort').textContent = '';
    document.getElementById('institutesSort').textContent = '';
    document.getElementById('stateStudentsSort').textContent = '';
    document.getElementById('stateAvgScoreSort').textContent = '';
    document.getElementById('statePassRateSort').textContent = '';
    document.getElementById('stateOscesSort').textContent = '';

    // Set the sort indicator for current column
    const sortIndicator = stateAnalysisSortState.ascending ? '‚ñ≤' : '‚ñº';
    const sortSpans = ['stateNameSort', 'institutesSort', 'stateStudentsSort', 'stateAvgScoreSort', 'statePassRateSort', 'stateOscesSort'];
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;

    // Re-render the table with sorted data
    const container = document.getElementById('stateAnalysisContainer');
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortStateAnalysisTable(0)">State <span id="stateNameSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(1)">Institutes <span id="institutesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(2)">Students <span id="stateStudentsSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(3)">Avg Score <span id="stateAvgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(4)">Pass % <span id="statePassRateSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortStateAnalysisTable(5)">OSCEs <span id="stateOscesSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    sortedData.forEach(state => {
        const avgScore = parseFloat(state.avg_score || 0).toFixed(2);
        const passRate = parseFloat(state.pass_rate || 0).toFixed(2);
        const stateName = state.state || 'Unknown';
        const institutes = state.institutes || 0;
        const students = state.students || 0;
        const osces = state.osces || 0;

        tableHtml += `
            <tr>
                <td>${stateName}</td>
                <td style="text-align: center;">${institutes}</td>
                <td style="text-align: center;">${students}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
                <td style="text-align: center;">${osces}</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Set the sort indicator after rendering
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;
}

function filterStateAnalysisTable(searchValue) {
    const table = document.querySelector('#stateAnalysisContainer table');
    if (!table) return;

    const rows = document.querySelectorAll('#stateAnalysisContainer table tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        const stateCell = row.querySelector('td:first-child');
        const state = stateCell.textContent.toLowerCase();

        if (state.includes(searchValue.toLowerCase())) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Show "no results" message if all rows are hidden
    if (visibleCount === 0 && searchValue.trim() !== '') {
        const noResultsDiv = document.createElement('div');
        noResultsDiv.id = 'stateNoSearchResults';
        noResultsDiv.className = 'no-search-results';
        noResultsDiv.textContent = `No states found matching "${searchValue}"`;
        table.parentElement.appendChild(noResultsDiv);
    } else {
        const noResults = document.getElementById('stateNoSearchResults');
        if (noResults) noResults.remove();
    }
}

// ============================================
// OSCE TYPE ANALYSIS FUNCTIONS
// ============================================

function loadOSCETypeAnalysis() {
    const year = currentFilters.academic_year || new Date().getFullYear().toString();
    const semester = currentFilters.semester && currentFilters.semester !== '' ? currentFilters.semester : null;
    const institution = currentFilters.institution !== 'All' ? currentFilters.institution : null;

    // Always use SemesterMetrics for OSCE type analysis (UnitMetrics doesn't have osce_type_breakdown)
    const endpoint = '/api/semester-metrics/';
    const params = new URLSearchParams();

    if (year) params.append('year', year);
    if (institution) params.append('unit_name', institution);
    if (semester) params.append('semester', semester);

    fetch(`${endpoint}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.documents && data.documents.length > 0) {
                const metricsArray = data.documents.map(doc => doc.data);
                const osceTypeMetrics = aggregateOSCETypeMetrics(metricsArray);
                displayOSCETypeAnalysis(osceTypeMetrics);
            } else {
                displayOSCETypeAnalysis([]);
            }
        })
        .catch(error => {
            console.error('Error loading OSCE type analysis:', error);
            displayOSCETypeAnalysis([]);
        });
}

function aggregateOSCETypeMetrics(metricsArray) {
    // Initialize data for each OSCE type
    const osceTypes = {
        'Classroom': {
            type: 'Classroom',
            institutesCount: 0,
            totalInstitutes: 0,
            studentsAssessed: 0,
            scoreSum: 0,
            scoreCount: 0,
            passSum: 0,
            passCount: 0
        },
        'Mock': {
            type: 'Mock',
            institutesCount: 0,
            totalInstitutes: 0,
            studentsAssessed: 0,
            scoreSum: 0,
            scoreCount: 0,
            passSum: 0,
            passCount: 0
        },
        'Final': {
            type: 'Final',
            institutesCount: 0,
            totalInstitutes: 0,
            studentsAssessed: 0,
            scoreSum: 0,
            scoreCount: 0,
            passSum: 0,
            passCount: 0
        }
    };

    // Get total count of unique institutions
    const totalInstitutions = new Set(metricsArray.map(m => m.unit_name)).size;

    // Process each metric
    metricsArray.forEach(metric => {
        const osceTypeBreakdown = metric.osce_type_breakdown || {};

        // For each OSCE type
        Object.keys(osceTypes).forEach(osceType => {
            osceTypes[osceType].totalInstitutes = totalInstitutions;

            // Check if this metric has data for this OSCE type
            if (osceTypeBreakdown[osceType]) {
                const typeData = osceTypeBreakdown[osceType];
                const studentsAssessedInType = typeData.students_assessed || 0;

                // Only count as "running" if students_assessed > 0
                if (studentsAssessedInType > 0) {
                    // Count institutions running this type
                    osceTypes[osceType].institutesCount++;

                    // Sum students assessed
                    osceTypes[osceType].studentsAssessed += studentsAssessedInType;

                    // Accumulate scores for averaging
                    if (typeData.avg_score !== undefined && typeData.avg_score !== null) {
                        osceTypes[osceType].scoreSum += typeData.avg_score;
                        osceTypes[osceType].scoreCount++;
                    }

                    // Accumulate pass rates for averaging
                    if (typeData.pass_rate !== undefined && typeData.pass_rate !== null) {
                        osceTypes[osceType].passSum += typeData.pass_rate;
                        osceTypes[osceType].passCount++;
                    }
                }
            }
        });
    });

    // Calculate final metrics and convert to array
    const result = Object.values(osceTypes).map(typeData => {
        const percentageOfTotal = typeData.totalInstitutes > 0
            ? (typeData.institutesCount / typeData.totalInstitutes) * 100
            : 0;

        const avgScore = typeData.scoreCount > 0
            ? typeData.scoreSum / typeData.scoreCount
            : 0;

        const passRate = typeData.passCount > 0
            ? typeData.passSum / typeData.passCount
            : 0;

        return {
            osceLevel: typeData.type,
            institutesRunning: typeData.institutesCount,
            percentageOfTotal: percentageOfTotal,
            studentsAssessed: typeData.studentsAssessed,
            avgScore: avgScore,
            passRate: passRate
        };
    });

    return result;
}

function displayOSCETypeAnalysis(osceTypeMetrics) {
    const container = document.getElementById('osceTypeAnalysisContainer');

    if (!osceTypeMetrics || osceTypeMetrics.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No OSCE type data available</p>
                <p class="empty-subtitle">Apply filters to view OSCE type analysis</p>
            </div>
        `;
        return;
    }

    // Store the metrics array globally for sorting
    window.osceTypeMetricsData = osceTypeMetrics;

    // Create table with sortable headers
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortOSCETypeTable(0)">OSCE Level <span id="osceLevelSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(1)">Institutes Running It <span id="osceInstitutesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(2)">% of Total Inst. <span id="oscePercentageSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(3)">Students Assessed <span id="osceStudentsSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(4)">Avg Score <span id="osceAvgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(5)">Pass %(>80%) <span id="oscePassRateSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    osceTypeMetrics.forEach(metric => {
        const percentage = parseFloat(metric.percentageOfTotal).toFixed(0);
        const avgScore = parseFloat(metric.avgScore).toFixed(0);
        const passRate = parseFloat(metric.passRate).toFixed(0);

        tableHtml += `
            <tr>
                <td>${metric.osceLevel}</td>
                <td style="text-align: center;">${metric.institutesRunning}</td>
                <td style="text-align: center;">${percentage}%</td>
                <td style="text-align: center;">${metric.studentsAssessed}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Reset all sort indicators
    document.getElementById('osceLevelSort').textContent = '';
    document.getElementById('osceInstitutesSort').textContent = '';
    document.getElementById('oscePercentageSort').textContent = '';
    document.getElementById('osceStudentsSort').textContent = '';
    document.getElementById('osceAvgScoreSort').textContent = '';
    document.getElementById('oscePassRateSort').textContent = '';
}

// Global sort state for OSCE type analysis table
let osceTypeSortState = {
    currentColumn: null,
    ascending: true
};

function sortOSCETypeTable(columnIndex) {
    const data = window.osceTypeMetricsData;
    if (!data) return;

    // Toggle sort direction if clicking the same column
    if (osceTypeSortState.currentColumn === columnIndex) {
        osceTypeSortState.ascending = !osceTypeSortState.ascending;
    } else {
        osceTypeSortState.currentColumn = columnIndex;
        osceTypeSortState.ascending = true;
    }

    // Sort the data based on column
    const sortedData = [...data].sort((a, b) => {
        let aVal, bVal;

        switch(columnIndex) {
            case 0: // OSCE Level (alphabetical)
                aVal = (a.osceLevel || '').toLowerCase();
                bVal = (b.osceLevel || '').toLowerCase();
                return osceTypeSortState.ascending ?
                    aVal.localeCompare(bVal) :
                    bVal.localeCompare(aVal);

            case 1: // Institutes Running It (numeric)
                aVal = a.institutesRunning || 0;
                bVal = b.institutesRunning || 0;
                return osceTypeSortState.ascending ? aVal - bVal : bVal - aVal;

            case 2: // % of Total Inst. (numeric)
                aVal = parseFloat(a.percentageOfTotal || 0);
                bVal = parseFloat(b.percentageOfTotal || 0);
                return osceTypeSortState.ascending ? aVal - bVal : bVal - aVal;

            case 3: // Students Assessed (numeric)
                aVal = a.studentsAssessed || 0;
                bVal = b.studentsAssessed || 0;
                return osceTypeSortState.ascending ? aVal - bVal : bVal - aVal;

            case 4: // Avg Score (numeric)
                aVal = parseFloat(a.avgScore || 0);
                bVal = parseFloat(b.avgScore || 0);
                return osceTypeSortState.ascending ? aVal - bVal : bVal - aVal;

            case 5: // Pass Rate (numeric)
                aVal = parseFloat(a.passRate || 0);
                bVal = parseFloat(b.passRate || 0);
                return osceTypeSortState.ascending ? aVal - bVal : bVal - aVal;

            default:
                return 0;
        }
    });

    // Clear all sort indicators
    document.getElementById('osceLevelSort').textContent = '';
    document.getElementById('osceInstitutesSort').textContent = '';
    document.getElementById('oscePercentageSort').textContent = '';
    document.getElementById('osceStudentsSort').textContent = '';
    document.getElementById('osceAvgScoreSort').textContent = '';
    document.getElementById('oscePassRateSort').textContent = '';

    // Set the sort indicator for current column
    const sortIndicator = osceTypeSortState.ascending ? '‚ñ≤' : '‚ñº';
    const sortSpans = ['osceLevelSort', 'osceInstitutesSort', 'oscePercentageSort', 'osceStudentsSort', 'osceAvgScoreSort', 'oscePassRateSort'];
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;

    // Re-render the table with sorted data
    const container = document.getElementById('osceTypeAnalysisContainer');
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortOSCETypeTable(0)">OSCE Level <span id="osceLevelSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(1)">Institutes Running It <span id="osceInstitutesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(2)">% of Total Inst. <span id="oscePercentageSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(3)">Students Assessed <span id="osceStudentsSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(4)">Avg Score <span id="osceAvgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortOSCETypeTable(5)">Pass %(>80%) <span id="oscePassRateSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    sortedData.forEach(metric => {
        const percentage = parseFloat(metric.percentageOfTotal).toFixed(0);
        const avgScore = parseFloat(metric.avgScore).toFixed(0);
        const passRate = parseFloat(metric.passRate).toFixed(0);

        tableHtml += `
            <tr>
                <td>${metric.osceLevel}</td>
                <td style="text-align: center;">${metric.institutesRunning}</td>
                <td style="text-align: center;">${percentage}%</td>
                <td style="text-align: center;">${metric.studentsAssessed}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Set the sort indicator after rendering
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;
}

// Category Analysis Functions
function loadCategoryAnalysis() {
    const year = currentFilters.academic_year || new Date().getFullYear().toString();
    const semester = currentFilters.semester && currentFilters.semester !== '' ? currentFilters.semester : null;
    const institution = currentFilters.institution !== 'All' ? currentFilters.institution : null;
    const osceLevel = currentFilters.osce_level && currentFilters.osce_level !== '' ? currentFilters.osce_level : 'All';
    const params = new URLSearchParams();

    // Build query parameters - always use semester metrics for category data (UnitMetrics doesn't have category breakdown)
    if (year) params.append('year', year);
    if (institution) params.append('unit_name', institution);
    if (semester) params.append('semester', semester);
    if (osceLevel !== 'All') params.append('osce_level', osceLevel);

    fetch(`/api/semester-metrics/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.documents && data.documents.length > 0) {
                // Extract the data from documents array
                const metricsArray = data.documents.map(doc => doc.data);
                const categoryMetrics = aggregateMetricsByCategory(metricsArray);
                displayCategoryAnalysis(categoryMetrics);
            } else {
                document.getElementById('categoryAnalysisContainer').innerHTML =
                    `<div class="empty-state">
                        <div class="empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                                <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                                <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                            </svg>
                        </div>
                        <p class="empty-text">No category data available</p>
                        <p class="empty-subtitle">Apply filters to view category analytics</p>
                    </div>`;
            }
        })
        .catch(error => {
            console.error('Error loading category analysis:', error);
        });
}

function aggregateMetricsByCategory(metricsArray) {
    const categories = {};
    const institutionSet = new Set();

    // First pass: collect all institutions
    metricsArray.forEach(metric => {
        if (metric.unit_name) {
            institutionSet.add(metric.unit_name);
        }
    });
    const totalInstitutions = institutionSet.size;

    // Second pass: aggregate by category
    metricsArray.forEach(metric => {
        if (metric.skills_performance) {
            Object.values(metric.skills_performance).forEach(skill => {
                if (!skill.category) return;

                const catName = skill.category;

                // Only count if skill was actually conducted (students_attempted > 0)
                if (skill.students_attempted > 0) {
                    if (!categories[catName]) {
                        categories[catName] = {
                            category: catName,
                            institutes: new Set(),
                            totalStudents: 0,
                            scoreSum: 0,
                            scoreCount: 0,
                            passCount: 0,
                            scoresList: []
                        };
                    }

                    categories[catName].institutes.add(metric.unit_name);
                    categories[catName].totalStudents += skill.students_attempted;

                    if (skill.avg_score !== undefined && skill.avg_score !== null) {
                        categories[catName].scoreSum += skill.avg_score;
                        categories[catName].scoreCount++;
                        categories[catName].scoresList.push(skill.avg_score);
                    }

                    // Count pass if score >= 80
                    if (skill.pass_rate !== undefined && skill.pass_rate !== null) {
                        // Calculate pass count from pass rate
                        const passesInSkill = Math.round((skill.pass_rate / 100) * skill.students_attempted);
                        categories[catName].passCount += passesInSkill;
                    }
                }
            });
        }
    });

    // Convert to array and calculate final metrics
    const result = Object.values(categories).map(cat => {
        const institutesCount = cat.institutes.size;
        const avgScore = cat.scoreCount > 0 ? cat.scoreSum / cat.scoreCount : 0;
        const passRate = cat.totalStudents > 0 ? (cat.passCount / cat.totalStudents) * 100 : 0;

        return {
            category: cat.category,
            institutesCount: institutesCount,
            percentageOfTotal: totalInstitutions > 0 ? (institutesCount / totalInstitutions) * 100 : 0,
            studentsAssessed: cat.totalStudents,
            avgScore: avgScore,
            passRate: passRate
        };
    });

    return result.sort((a, b) => a.category.localeCompare(b.category));
}

function displayCategoryAnalysis(categoryMetrics) {
    const container = document.getElementById('categoryAnalysisContainer');

    if (!categoryMetrics || categoryMetrics.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="5" y="12" width="3" height="6" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="10" y="8" width="3" height="10" rx="1" fill="currentColor" opacity="0.6"/>
                        <rect x="15" y="5" width="3" height="13" rx="1" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <p class="empty-text">No category data available</p>
                <p class="empty-subtitle">Apply filters to view category usage analytics</p>
            </div>
        `;
        return;
    }

    // Store the metrics array globally for sorting
    window.categoryMetricsData = categoryMetrics;

    // Create table with sortable headers
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortCategoryTable(0)">Category <span id="categoryNameSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(1)">Institutes Using It <span id="categoryInstitutesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(2)">% Inst. <span id="categoryPercentageSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(3)">Students Assessed <span id="categoryStudentsSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(4)">Avg Score <span id="categoryAvgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(5)">Pass % <span id="categoryPassRateSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    categoryMetrics.forEach(metric => {
        const percentage = parseFloat(metric.percentageOfTotal).toFixed(0);
        const avgScore = parseFloat(metric.avgScore).toFixed(0);
        const passRate = parseFloat(metric.passRate).toFixed(0);

        tableHtml += `
            <tr>
                <td>${metric.category}</td>
                <td style="text-align: center;">${metric.institutesCount}</td>
                <td style="text-align: center;">${percentage}%</td>
                <td style="text-align: center;">${metric.studentsAssessed}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Reset all sort indicators
    document.getElementById('categoryNameSort').textContent = '';
    document.getElementById('categoryInstitutesSort').textContent = '';
    document.getElementById('categoryPercentageSort').textContent = '';
    document.getElementById('categoryStudentsSort').textContent = '';
    document.getElementById('categoryAvgScoreSort').textContent = '';
    document.getElementById('categoryPassRateSort').textContent = '';
}

// Global sort state for category analysis table
let categorySortState = {
    currentColumn: null,
    ascending: true
};

function sortCategoryTable(columnIndex) {
    const data = window.categoryMetricsData;
    if (!data) return;

    // Toggle sort direction if clicking the same column
    if (categorySortState.currentColumn === columnIndex) {
        categorySortState.ascending = !categorySortState.ascending;
    } else {
        categorySortState.currentColumn = columnIndex;
        categorySortState.ascending = true;
    }

    // Sort the data based on column
    const sortedData = [...data].sort((a, b) => {
        let aVal, bVal;

        switch(columnIndex) {
            case 0: // Category name (alphabetical)
                aVal = (a.category || '').toLowerCase();
                bVal = (b.category || '').toLowerCase();
                return categorySortState.ascending ?
                    aVal.localeCompare(bVal) :
                    bVal.localeCompare(aVal);

            case 1: // Institutes Using It (numeric)
                aVal = a.institutesCount || 0;
                bVal = b.institutesCount || 0;
                return categorySortState.ascending ? aVal - bVal : bVal - aVal;

            case 2: // % Inst. (numeric)
                aVal = parseFloat(a.percentageOfTotal || 0);
                bVal = parseFloat(b.percentageOfTotal || 0);
                return categorySortState.ascending ? aVal - bVal : bVal - aVal;

            case 3: // Students Assessed (numeric)
                aVal = a.studentsAssessed || 0;
                bVal = b.studentsAssessed || 0;
                return categorySortState.ascending ? aVal - bVal : bVal - aVal;

            case 4: // Avg Score (numeric)
                aVal = parseFloat(a.avgScore || 0);
                bVal = parseFloat(b.avgScore || 0);
                return categorySortState.ascending ? aVal - bVal : bVal - aVal;

            case 5: // Pass Rate (numeric)
                aVal = parseFloat(a.passRate || 0);
                bVal = parseFloat(b.passRate || 0);
                return categorySortState.ascending ? aVal - bVal : bVal - aVal;

            default:
                return 0;
        }
    });

    // Clear all sort indicators
    document.getElementById('categoryNameSort').textContent = '';
    document.getElementById('categoryInstitutesSort').textContent = '';
    document.getElementById('categoryPercentageSort').textContent = '';
    document.getElementById('categoryStudentsSort').textContent = '';
    document.getElementById('categoryAvgScoreSort').textContent = '';
    document.getElementById('categoryPassRateSort').textContent = '';

    // Set the sort indicator for current column
    const sortIndicator = categorySortState.ascending ? '‚ñ≤' : '‚ñº';
    const sortSpans = ['categoryNameSort', 'categoryInstitutesSort', 'categoryPercentageSort', 'categoryStudentsSort', 'categoryAvgScoreSort', 'categoryPassRateSort'];
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;

    // Re-render the table with sorted data
    const container = document.getElementById('categoryAnalysisContainer');
    let tableHtml = `<table class="data-table"><thead><tr>`;
    tableHtml += '<th style="cursor: pointer;" onclick="sortCategoryTable(0)">Category <span id="categoryNameSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(1)">Institutes Using It <span id="categoryInstitutesSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(2)">% Inst. <span id="categoryPercentageSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(3)">Students Assessed <span id="categoryStudentsSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(4)">Avg Score <span id="categoryAvgScoreSort"></span></th>';
    tableHtml += '<th style="cursor: pointer; text-align: center;" onclick="sortCategoryTable(5)">Pass % <span id="categoryPassRateSort"></span></th>';
    tableHtml += '</tr></thead><tbody>';

    sortedData.forEach(metric => {
        const percentage = parseFloat(metric.percentageOfTotal).toFixed(0);
        const avgScore = parseFloat(metric.avgScore).toFixed(0);
        const passRate = parseFloat(metric.passRate).toFixed(0);

        tableHtml += `
            <tr>
                <td>${metric.category}</td>
                <td style="text-align: center;">${metric.institutesCount}</td>
                <td style="text-align: center;">${percentage}%</td>
                <td style="text-align: center;">${metric.studentsAssessed}</td>
                <td style="text-align: center;">${avgScore}%</td>
                <td style="text-align: center;">${passRate}%</td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;

    // Set the sort indicator after rendering
    document.getElementById(sortSpans[columnIndex]).textContent = sortIndicator;
}

function filterCategoryTable(searchTerm) {
    const table = document.querySelector('#categoryAnalysisContainer table');
    if (!table) return;

    const rows = table.querySelectorAll('tbody tr');
    const lowerSearchTerm = searchTerm.toLowerCase();

    rows.forEach(row => {
        const categoryName = row.cells[0].textContent.toLowerCase();
        if (categoryName.includes(lowerSearchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}


</script>
{% endblock %}

