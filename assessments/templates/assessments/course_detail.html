{% extends 'assessments/base.html' %}

{% block content %}
<!-- Merged Course Information Box -->
<div class="merged-course-info">
    <div class="back-button-container">
        <a href="{% url 'course_management' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Courses
        </a>
    </div>

    <div class="course-header">
        <div class="course-header-left">
            <h4><b>{{ course.name }}</b></h4>
            <p class="course-description">{{ course.description }}</p>
        </div>
        <div class="course-header-right">
            {% if "edit_course" in request.user.get_all_permissions or request.user.has_all_permissions %}
            <button class="btn btn-light" onclick="openEditCoursePanel()">
                <i class="fas fa-edit"></i>
                Edit Course
            </button>
            {% endif %}
            {% if "delete_course" in request.user.get_all_permissions or request.user.has_all_permissions %}
            <button class="btn btn-primary" style="background: #F16564; color: white; border-color: #F16564;" onclick="deleteCourse()">
                <i class="fas fa-trash"></i>
                Delete Course
            </button>
            {% endif %}
        </div>
    </div>

    <div class="course-overview">
        <div class="overview-card">
            <h3>Course Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <label>Total Procedures</label>
                    <span class="info-value">{{ course.total_procedures }}</span>
                </div>

                <!-- <div class="info-item">
                    <label>OSCE Types</label>
                    <div class="osce-types-display">
                        {% for osce_type in course.osce_types %}
                            <span class="osce-badge">{{ osce_type }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="info-item">
                    <label>Verification Required</label>
                    <span class="verification-status">
                        {% if course.verification_required %}
                            <i class="fas fa-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="fas fa-times-circle text-muted"></i> No
                        {% endif %}
                    </span>
                </div> -->
            </div>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="tab-navigation">
    <div class="tab-item active" data-tab="procedures" onclick="switchTab('procedures')">
        <i class="fas fa-list"></i>
        Procedures
    </div>
    <div class="tab-item" data-tab="students" onclick="switchTab('students')">
        <i class="fas fa-users"></i>
        Batches
    </div>
</div>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Procedures Tab -->
    <div class="tab-panel active" id="procedures-panel">
        <div class="procedures-header">
            <div class="procedures-title">
                <h3>Course Procedures</h3>
                <p class="text-muted">Manage procedures assigned to this course</p>
            </div>
            <!-- <button class="btn btn-primary" onclick="openAddProcedurePanel()" style="background: #F16564; color: white; border-color: #F16564;">
                <i class="fas fa-plus"></i>
                Add Procedure
            </button> -->
        </div>

        <!-- Search and Filter -->
        <div class="procedures-controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search procedures..." id="procedureSearch">
            </div>

        </div>

        <!-- Procedures Table -->
        <div class="procedures-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Procedure Name</th>
                        <!-- <th>Actions</th> -->
                    </tr>
                </thead>
                <tbody id="proceduresTableBody">
                    {% for procedure in course.procedures %}
                    <tr data-category="{{ procedure.category }}">
                        <td>
                            <div class="procedure-name">
                                <span>{{ procedure.name }}</span>
                            </div>
                        </td>
                        <!-- <td>
                            <div class="actions">
                                <button class="btn-icon btn-danger" title="Remove from Course" onclick="removeProcedure('{{ procedure.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td> -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Batches Tab -->
    <div class="tab-panel" id="students-panel">
        <div class="batches-header">
            <div class="batches-title">
                <h3>Course Batches</h3>
                <p class="text-muted">Manage batches assigned to this course</p>
            </div>
            <!-- <button class="btn btn-primary" onclick="openAddBatchPanel()">
                <i class="fas fa-plus"></i>
                Add Batch
            </button> -->
        </div>

        <!-- Search and Filter -->
        <div class="batches-controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search batches..." id="batchSearch">
            </div>
            <div class="filter-controls">
                <select class="form-control" id="unitTypeFilter">
                    <option value="">All Unit Types</option>
                    <option value="institution">Institution</option>
                    <option value="hospital">Hospital</option>
                </select>
                <select class="form-control" id="unitNameFilter">
                    <option value="">All Unit Names</option>
                </select>
            </div>
        </div>

        <!-- Batches Table -->
        <div class="batches-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Batch Name</th>
                        <th>Unit Type</th>
                        <th>Unit Name</th>
                        <th>Learner</th>
                    </tr>
                </thead>
                <tbody id="batchesTableBody">
                    <!-- Will be filled by JS -->
                </tbody>
            </table>
        </div>
        <div style="text-align:center; margin: 20px 0;">
            <button id="showMoreBatchesBtn" class="btn btn-primary" onclick="loadMoreBatches()">Show More</button>
        </div>
    </div>
</div>

<!-- Add Procedure Side Panel -->
<div class="side-panel" id="addProcedurePanel">
    <div class="side-panel-header">
        <h3>Add Procedures to Course</h3>
        <button type="button" class="close" onclick="closeAddProcedurePanel()">
            <span>&times;</span>
        </button>
    </div>
    
    <form class="side-panel-form" id="addProcedureForm" novalidate>
        <div class="form-group">
            <label>Search Procedures</label>
            <input type="text" class="form-control" placeholder="Search available procedures..." id="modalProcedureSearch" oninput="filterAvailableProcedures(this.value)">
        </div>

        <div class="form-group">
            <label>Available Procedures <span class="text-danger">*</span></label>
            <div class="available-procedures-container" id="availableProcedures">
                <!-- Procedures will be loaded dynamically -->
            </div>
            <div class="error-message" id="addProceduresError"></div>
        </div>

        <div class="side-panel-actions">
            <button type="button" class="btn btn-light" onclick="closeAddProcedurePanel()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="addProcedureSubmitBtn">
                <span class="btn-text">Add Procedures</span>
                <span class="btn-spinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </button>
        </div>
    </form>
</div>

<!-- Edit Course Side Panel -->
<div class="side-panel" id="editCoursePanel">
    <div class="side-panel-header">
        <h3>Edit Course</h3>
        <button type="button" class="close" onclick="closeEditCoursePanel()">
            <span>&times;</span>
        </button>
    </div>
    
    
    <form class="side-panel-form" id="editCourseForm" novalidate>
        <div class="form-group">
            <label>Course Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editCourseName" name="courseName" required>
            <div class="error-message" id="editCourseNameError"></div>
        </div>

        <div class="form-group">
            <label>Description</label>
            <textarea class="form-control" id="editDescription" name="description" rows="3" placeholder="Enter course description (optional)"></textarea>
            <div class="error-message" id="editDescriptionError"></div>
        </div>

        <div class="form-group">
            <label>Procedures <span class="text-danger">*</span></label>
            <div class="multiselect-container">
                <div class="multiselect-input" onclick="toggleEditDropdown()" id="editProceduresInput">
                    <span class="placeholder">Select procedures</span>
                    <div class="selected-tags" id="editSelectedTags"></div>
                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                </div>
                <div class="multiselect-dropdown" id="editProceduresDropdown">
                    <div class="search-container">
                        <input type="text" placeholder="Search procedures..." class="search-input" oninput="filterEditProcedures(this.value)">
                    </div>
                    <div class="options-container" id="editProceduresOptions">
                        <div class="option-item" data-value="1">
                            <div class="custom-checkbox">
                                <input type="checkbox" id="editProc1" value="1">
                                <label for="editProc1"></label>
                            </div>
                            <span>CPR Training</span>
                        </div>
                        <div class="option-item" data-value="2">
                            <div class="custom-checkbox">
                                <input type="checkbox" id="editProc2" value="2">
                                <label for="editProc2"></label>
                            </div>
                            <span>Airway Management</span>
                        </div>
                        <div class="option-item" data-value="3">
                            <div class="custom-checkbox">
                                <input type="checkbox" id="editProc3" value="3">
                                <label for="editProc3"></label>
                            </div>
                            <span>Defibrillation</span>
                        </div>
                        <div class="option-item" data-value="4">
                            <div class="custom-checkbox">
                                <input type="checkbox" id="editProc4" value="4">
                                <label for="editProc4"></label>
                            </div>
                            <span>Oxygen Administration</span>
                        </div>
                        <div class="option-item" data-value="5">
                            <div class="custom-checkbox">
                                <input type="checkbox" id="editProc5" value="5">
                                <label for="editProc5"></label>
                            </div>
                            <span>Chest Compressions</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="error-message" id="editProceduresError"></div>
        </div>


        <div class="side-panel-actions">
            <button type="button" class="btn btn-light" onclick="closeEditCoursePanel()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="editSubmitBtn">
                <span class="btn-text">Update Course</span>
                <span class="btn-spinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </button>
        </div>
    </form>
</div>

<style>
.merged-course-info {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 24px;
    margin-bottom: 24px;
}

.merged-course-info .back-button-container {
    margin-bottom: 20px;
}

.merged-course-info .course-header {
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 20px;
    margin-bottom: 20px;
    background: none;
    border: none;
    padding: 0;
}

.merged-course-info .course-overview {
    margin-bottom: 0;
}

.merged-course-info .overview-card {
    background: none;
    border: none;
    padding: 0;
    box-shadow: none;
}

.back-button-container {
    margin-bottom: 24px;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #4a5568;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.back-button:hover {
    background-color: #f7fafc;
    color: #2d3748;
    text-decoration: none;
}

.back-button i {
    font-size: 12px;
}

.course-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    /* margin-bottom: 32px; */
    padding-bottom: 24px;
    border-bottom: 1px solid #e2e8f0;
}

.procedures-table .actions .btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.procedures-table .actions .btn-sm {
    padding: 4px 8px;
    font-size: 11px;
}

.procedures-table .actions .btn-danger:hover {
    background: #F16564;
}

.course-header-left h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 600;
    color: #2d3748;
}

.course-description {
    color: #666;
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
    max-width: 600px;
}

.course-header-right {
    display: flex;
    gap: 12px;
}

.course-header-right .btn {
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.course-header-right .btn-light {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.course-header-right .btn-light:hover {
    background: #e2e6ea;
    color: #495057;
}

.course-header-right .btn-danger {
    background: #F16564;
    color: white;
}

.course-header-right .btn-danger:hover {
    background: #F16564;
}

/* Course Overview */
.course-overview {
    margin-bottom: 32px;
}

.overview-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 24px;
}

.overview-card h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 600;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.info-item label {
    font-size: 12px;
    font-weight: 500;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.info-value {
    font-size: 14px;
    font-weight: 500;
    color: #2d3748;
}



.osce-types-display {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.osce-badge {
    background: #edf2f7;
    color: #4a5568;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.verification-status {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
}

/* Tab Navigation */
.tab-navigation {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 24px;
}

.tab-item {
    padding: 12px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #4a5568;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-item:hover {
    color: #F16564;
    background: #f7fafc;
}

.tab-item.active {
    color: #F16564;
    border-bottom-color: #F16564;
    background: #f7fafc;
}

.tab-content {
    min-height: 400px;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

.procedures-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.procedures-title h3 {
    margin: 0 0 4px 0;
    font-size: 20px;
    font-weight: 600;
}

.procedures-controls {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    align-items: center;
}

.search-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 16px;
    max-width: 400px;
}

.search-box input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 14px;
}

.filter-controls {
    display: flex;
    gap: 12px;
}

.filter-controls select {
    min-width: 150px;
}

.procedures-table {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.category-badge {
    background: #edf2f7;
    color: #4a5568;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.batches-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.batches-title h3 {
    margin: 0 0 4px 0;
    font-size: 20px;
    font-weight: 600;
}

.batches-controls {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    align-items: center;
}

.batches-table {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.batches-table table {
    width: 100%;
    border-collapse: collapse;
}

.batches-table th,
.batches-table td {
    padding: 12px 16px;
    text-align: left;
}

.batches-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.batches-table tbody tr {
    border-bottom: 1px solid #e2e8f0;
}

.batches-table tbody tr:last-child {
    border-bottom: none;
}

.batch-name {
    font-weight: 500;
}

.unit-type-badge {
    background: #edf2f7;
    color: #4a5568;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.unit-name {
    color: #666;
}

.learner-count {
    color: #666;
}

.status-badge {
    background: #edf2f7;
    color: #4a5568;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.status-active {
    background: #c6f6d5;
    color: #22543d;
}



.actions {
    display: flex;
    gap: 8px;
}

.actions .btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.actions .btn-primary {
    background: #F16564;
    color: white;
}

.actions .btn-primary:hover {
    background: #e45857;
}

.actions .btn-warning {
    background: #ffd700;
    color: white;
}

.actions .btn-warning:hover {
    background: #e6c200;
}

.actions .btn-danger {
    background: #F16564;
    color: white;
}

.actions .btn-danger:hover {
    background: #F16564;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    width: 90%;
    max-width: 600px;
}

.modal-content {
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h5 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.search-procedures {
    margin-bottom: 20px;
}

.available-procedures {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
}

.procedure-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.procedure-item:last-child {
    border-bottom: none;
}

.procedure-item:hover {
    background: #f7fafc;
}

.procedure-category {
    font-size: 12px;
    color: #666;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.error {
    text-align: center;
    padding: 20px;
    color: #dc3545;
}

.no-procedures {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}

.procedure-item.already-added {
    opacity: 0.6;
    background-color: #f8f9fa;
}

.procedure-item.already-added .custom-checkbox input[type="checkbox"]:checked + label:before {
    background: #28a745;
    border-color: #28a745;
}

.procedure-item.already-added .custom-checkbox input[type="checkbox"]:disabled + label {
    cursor: not-allowed;
    color: #6c757d;
}

.already-added-badge {
    background: #28a745;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    margin-left: 8px;
    font-weight: 500;
}

/* Custom Checkbox in Modal */
.custom-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
}

.custom-checkbox input[type="checkbox"] {
    display: none;
}

.custom-checkbox label {
    position: relative;
    padding-left: 28px;
    cursor: pointer;
    margin: 0;
}

.custom-checkbox label:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    border: 2px solid #e2e8f0;
    border-radius: 4px;
    background: white;
}

.custom-checkbox input[type="checkbox"]:checked + label:before {
    background: #F16564;
    border-color: #F16564;
}

.custom-checkbox input[type="checkbox"]:checked + label:after {
    content: '';
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-75%) rotate(45deg);
    width: 6px;
    height: 11px;
    border: solid white;
    border-width: 0 2px 2px 0;
}

/* Side Panel Styles */
.side-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.side-panel.active {
    right: 0;
}

.side-panel-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.side-panel-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.side-panel-form {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2d3748;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: #F16564;
    box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
}

.form-control.error {
    border-color: #e53e3e;
}

.form-control.success {
    border-color: #38a169;
}

.error-message {
    color: #e53e3e;
    font-size: 12px;
    margin-top: 4px;
    display: none;
}

.error-message.show {
    display: block;
}

.text-danger {
    color: #e53e3e;
}

/* Multiselect Styles */
.multiselect-container {
    position: relative;
}

.multiselect-input {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 40px;
    background: white;
}

.multiselect-input.active {
    border-color: #F16564;
    box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
}

.placeholder {
    color: #a0aec0;
    font-size: 14px;
}

.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    flex: 1;
}

.selected-tag {
    background: #F16564;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.selected-tag .remove {
    cursor: pointer;
    font-weight: bold;
}

.dropdown-arrow {
    color: #a0aec0;
    transition: transform 0.2s;
}

.multiselect-input.active .dropdown-arrow {
    transform: rotate(180deg);
}

.multiselect-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e2e8f0;
    border-top: none;
    border-radius: 0 0 6px 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.multiselect-dropdown.active {
    display: block;
}

.search-container {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.search-input {
    width: 100%;
    border: none;
    outline: none;
    font-size: 14px;
    padding: 4px 0;
}

.options-container {
    max-height: 150px;
    overflow-y: auto;
}

.option-item {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.option-item:hover {
    background: #f7fafc;
}

/* Checkbox Group */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.verification-field {
    background: #f7fafc;
    padding: 16px;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
}

/* Side Panel Actions */
.side-panel-actions {
    margin-top: auto;
    padding-top: 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.side-panel-actions .btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.side-panel-actions .btn-light {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.side-panel-actions .btn-primary {
    background: #F16564;
    color: white;
}

.side-panel-actions .btn-primary:hover {
    background: #e45857;
}

.btn-spinner {
    display: none;
}

/* Available Procedures Container */
.available-procedures-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: white;
}

.procedure-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
}

.procedure-item:last-child {
    border-bottom: none;
}

.procedure-item:hover {
    background: #f7fafc;
}

.procedure-item .custom-checkbox {
    width: 100%;
}

.procedure-item .custom-checkbox label {
    margin: 0;
    padding-left: 28px;
    cursor: pointer;
    font-weight: 400;
    width: 100%;
}

/* Panel Overlay */
.panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: #edf2f7;
    color: #4a5568;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.btn-icon:hover {
    background: #e2e8f0;
}

.btn-icon.btn-danger {
    color: #c53030;
    background: #fff5f5;
}

.btn-icon.btn-danger:hover {
    background: #fed7d7;
}


.back-button-container {
    margin-bottom: 24px;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #4a5568;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.back-button:hover {
    background-color: #f7fafc;
    color: #2d3748;
    text-decoration: none;
}

.back-button i {
    font-size: 12px;
}

.course-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 24px;
    border-bottom: 1px solid #e2e8f0;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 0px;
}

.course-header-left {
    flex: 1;
}

.course-header-left h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 600;
    color: #2d3748;
}

.course-description {
    color: #666;
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
    max-width: 600px;
}

.course-header-right {
    display: flex;
    gap: 12px;
}

.course-header-right .btn {
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.course-header-right .btn-danger {
    background: #dc3545;
    color: white;
}

.course-header-right .btn-danger:hover {
    background: #c82333;
}

/* Batch Name Editable Styles */
.batch-name-container {
    position: relative;
}

.batch-name-display {
    display: flex;
    align-items: center;
    gap: 12px;
}

.batch-name-display h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 600;
    color: #2d3748;
}

.edit-name-btn {
    background: none;
    border: none;
    color: #718096;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 16px;
}

.edit-name-btn:hover {
    background: #f7fafc;
    color: #F16564;
}

.batch-name-edit {
    display: flex;
    align-items: center;
    gap: 12px;
}

.batch-name-input {
    font-size: 32px;
    font-weight: 600;
    color: #2d3748;
    border: 2px solid #F16564;
    border-radius: 6px;
    padding: 8px 12px;
    background: white;
    outline: none;
    min-width: 300px;
}

.batch-name-input:focus {
    box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.1);
}

.edit-actions {
    display: flex;
    gap: 8px;
}

.save-name-btn, .cancel-name-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 16px;
}

.save-name-btn {
    color: #38a169;
}

.save-name-btn:hover {
    background: #f0fff4;
    color: #2f855a;
}

.cancel-name-btn {
    color: #e53e3e;
}

.cancel-name-btn:hover {
    background: #fff5f5;
    color: #c53030;
}

.course-overview {
    margin-bottom: 32px;
}

.overview-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 24px;
}

.overview-card h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 600;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.info-item label {
    font-size: 12px;
    font-weight: 500;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.info-value {
    font-size: 14px;
    font-weight: 500;
    color: #2d3748;
}

.osce-types-display {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.osce-badge {
    background: #edf2f7;
    color: #4a5568;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.tab-navigation {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 24px;
}

.tab-item {
    padding: 12px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #4a5568;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-item:hover {
    color: #F16564;
    background: #f7fafc;
}

.tab-item.active {
    color: #F16564;
    border-bottom-color: #F16564;
    background: #f7fafc;
}

.tab-content {
    min-height: 400px;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

.procedures-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.procedures-title h3 {
    margin: 0 0 4px 0;
    font-size: 20px;
    font-weight: 600;
}

.procedures-controls {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    align-items: center;
}

.search-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 16px;
    max-width: 400px;
}

.search-box input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 14px;
}

.procedures-table {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background: #f8fafc;
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    text-transform: uppercase;
}

.table td {
    padding: 16px;
    border-top: 1px solid #e2e8f0;
}

.actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: #edf2f7;
    color: #4a5568;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.btn-icon:hover {
    background: #e2e8f0;
}

.btn-icon.btn-danger {
    color: #c53030;
    background: #fff5f5;
}

.btn-icon.btn-danger:hover {
    background: #fed7d7;
}

.btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #F16564;
    color: white;
}

.btn-primary:hover {
    background: #e45857;
}

.btn-light {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.text-muted {
    color: #666;
}

.side-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.side-panel.active {
    right: 0;
}

.side-panel-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.side-panel-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.side-panel-form {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.available-learners-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: white;
}

.learner-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.learner-item:last-child {
    border-bottom: none;
}

.learner-item:hover {
    background: #f7fafc;
}

.learner-item.current-learner {
    background: #f0f9ff;
    border-left: 3px solid #3b82f6;
}

.learner-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}

.learner-name {
    font-weight: 500;
    color: #2d3748;
}

.learner-email {
    font-size: 12px;
    color: #718096;
}

.current-learner-badge {
    background: #3b82f6;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
}

.custom-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
}

.custom-checkbox input[type="checkbox"] {
    display: none;
}

.custom-checkbox label {
    position: relative;
    padding-left: 28px;
    cursor: pointer;
    margin: 0;
    width: 100%;
}

.custom-checkbox label:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    border: 2px solid #e2e8f0;
    border-radius: 4px;
    background: white;
}

.custom-checkbox input[type="checkbox"]:checked + label:before {
    background: #F16564;
    border-color: #F16564;
}

.custom-checkbox input[type="checkbox"]:checked + label:after {
    content: '';
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-75%) rotate(45deg);
    width: 6px;
    height: 11px;
    border: solid white;
    border-width: 0 2px 2px 0;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2d3748;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #F16564;
    box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
}

.text-danger {
    color: #e53e3e;
}

.error-message {
    color: #e53e3e;
    font-size: 12px;
    margin-top: 4px;
    display: none;
}

.error-message.show {
    display: block;
}

.side-panel-actions {
    margin-top: auto;
    padding-top: 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.panel-overlay.active {
    display: block;
}

.available-courses-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: white;
}

.course-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
}

.course-item:last-child {
    border-bottom: none;
}

.course-item:hover {
    background: #f7fafc;
}

.course-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.course-name {
    font-weight: 500;
    color: #2d3748;
}

.course-details {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: #718096;
}

.course-procedures {
    color: #4a5568;
}

.course-osce {
    color: #718096;
}

/* Current Course Badge */
.current-course-badge {
    background: #3b82f6;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
}

.course-item.current-course {
    background: #f0f9ff;
    border-left: 3px solid #3b82f6;
}

.procedure-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.pill {
    background: #f0f4f8;
    color: #2d3748;
    border-radius: 12px;
    padding: 2px 10px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}

/* Loading Spinner Styles */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #666;
    font-size: 14px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #F16564;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Course data from Django template
const courseData = {
    id: '{{ course.id }}',
    name: '{{ course.name|escapejs }}',
    description: '{{ course.description|escapejs }}',
    osce_types: {{ course.osce_types|safe }},
    verification_required: {{ course.verification_required|yesno:"true,false" }},
    procedures: {{ course.procedures|safe }}
};

let procedures_populated = false

function switchTab(tabName) {
    // Remove active class from all tabs and panels
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Add active class to selected tab and panel
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

function openAddProcedurePanel() {
    const panel = document.getElementById('addProcedurePanel');
    panel.classList.add('active');
    
    // Load available procedures
    loadAvailableProcedures();
    
    
    // Add overlay
    if (!document.querySelector('.panel-overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'panel-overlay';
        overlay.onclick = closeAddProcedurePanel;
        document.body.appendChild(overlay);
    }
    
    document.body.style.overflow = 'hidden';
}

function closeAddProcedurePanel() {
    const panel = document.getElementById('addProcedurePanel');
    panel.classList.remove('active');
    
    // Remove overlay
    const overlay = document.querySelector('.panel-overlay');
    if (overlay) {
        overlay.remove();
    }
    
    document.body.style.overflow = '';
    
    // Reset form
    document.getElementById('addProcedureForm').reset();
    clearAddProcedureErrors();
}

function removeProcedure(procedureId) {
    if (confirm('Are you sure you want to remove this procedure from the course?')) {
        const courseId = courseData.id;
        
        $.ajax({
            url: `/courses/${courseId}/remove-procedure/`,
            method: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({ procedureId: procedureId }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(data) {
                showSuccess('Procedure removed successfully!');
                // Reload the page to reflect changes
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            },
            error: function(xhr, status, error) {
                let errorMessage = 'Failed to remove procedure';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showError(errorMessage);
            }
        });
    }
}

function loadAvailableProcedures() {
    const container = document.getElementById('availableProcedures');
    container.innerHTML = '<div class="loading">Loading procedures...</div>';
    
    $.ajax({
        url: '/fetch-procedures/',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            const procedures = data.procedures || [];
            const currentProcedureIds = courseData.procedures.map(p => p.id);
            
            populateAvailableProcedures(procedures, currentProcedureIds);
        },
        error: function(xhr, status, error) {
            container.innerHTML = '<div class="error">Failed to load procedures</div>';
        }
    });
}

function populateAvailableProcedures(procedures, currentProcedureIds) {
    const container = document.getElementById('availableProcedures');
    
    if (procedures.length === 0) {
        container.innerHTML = '<div class="no-procedures">No procedures available</div>';
        return;
    }
    
    container.innerHTML = '';
    
    procedures.forEach(procedure => {
        const isAlreadyAdded = currentProcedureIds.includes(procedure.id);
        const procedureItem = document.createElement('div');
        procedureItem.className = `procedure-item ${isAlreadyAdded ? 'already-added' : ''}`;
        
        procedureItem.innerHTML = `
            <div class="custom-checkbox">
                <input type="checkbox" id="proc_${procedure.id}" value="${procedure.id}" 
                       ${isAlreadyAdded ? 'checked disabled' : ''}>
                <label for="proc_${procedure.id}" class="${isAlreadyAdded ? 'disabled' : ''}">
                    ${procedure.name}
                    ${isAlreadyAdded ? '<span class="already-added-badge">Already Added</span>' : ''}
                </label>
            </div>
        `;
        
        container.appendChild(procedureItem);
    });
}

function filterAvailableProcedures(searchTerm) {
    const procedureItems = document.querySelectorAll('#availableProcedures .procedure-item');
    
    procedureItems.forEach(item => {
        const procedureName = item.querySelector('label').textContent.toLowerCase();
        const isAlreadyAdded = item.classList.contains('already-added');
        
        // Show all items when search is empty, or show matching items
        if (searchTerm === '' || procedureName.includes(searchTerm.toLowerCase())) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearAddProcedureErrors() {
    document.querySelectorAll('#addProcedureForm .error-message').forEach(error => {
        error.classList.remove('show');
    });
}

// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('procedureSearch');
    
    function filterProcedures() {
        const searchTerm = searchInput.value.toLowerCase();
        
        const rows = document.querySelectorAll('#proceduresTableBody tr');
        
        rows.forEach(row => {
            const name = row.querySelector('.procedure-name span').textContent.toLowerCase();
            
            const matchesSearch = name.includes(searchTerm);
            
            if (matchesSearch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterProcedures);
    
    // Add Procedure form submission
    const addProcedureForm = document.getElementById('addProcedureForm');
    if (addProcedureForm) {
        addProcedureForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedProcedures = document.querySelectorAll('#availableProcedures input:checked:not(:disabled)');
            if (selectedProcedures.length === 0) {
                showAddProcedureError('addProceduresError', 'Please select at least one procedure to add.');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('addProcedureSubmitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnSpinner = submitBtn.querySelector('.btn-spinner');
            
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-flex';
            submitBtn.disabled = true;
            
            // Collect selected procedure IDs
            const procedureIds = Array.from(selectedProcedures).map(cb => cb.value);
            const courseId = courseData.id;
            
            // Make API call
            $.ajax({
                url: `/courses/${courseId}/add-procedures/`,
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({ procedureIds: procedureIds }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    showSuccess(data.message || 'Procedures added successfully!');
                    closeAddProcedurePanel();
                    // Reload the page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Failed to add procedures';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    showError(errorMessage);
                },
                complete: function() {
                    // Reset button state
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                    submitBtn.disabled = false;
                }
            });
        });
    }
});

function showAddProcedureError(errorId, message) {
    const errorElement = document.getElementById(errorId);
    errorElement.textContent = message;
    errorElement.classList.add('show');
}

function deleteCourse() {
    if (confirm('Are you sure you want to delete this course? This action cannot be undone and will remove all associated procedures and data.')) {
        const courseId = courseData.id;
        
        $.ajax({
            url: `/courses/${courseId}/delete/`,
            method: 'POST',
            dataType: 'json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(data) {
                showSuccess('Course deleted successfully!');
                // Redirect to course management page after a short delay
                setTimeout(() => {
                    window.location.href = '/course-management/';
                }, 1000);
            },
            error: function(xhr, status, error) {
                let errorMessage = 'Failed to delete course';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showError(errorMessage);
            }
        });
    }
}

// Edit Course Panel Functions
function openEditCoursePanel() {
    const panel = document.getElementById('editCoursePanel');
    panel.classList.add('active');
    
    // Pre-populate form with current course data
    populateEditForm();
    
    // Add overlay
    if (!document.querySelector('.panel-overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'panel-overlay';
        overlay.onclick = closeEditCoursePanel;
        document.body.appendChild(overlay);
    }
    
    document.body.style.overflow = 'hidden';
}

function closeEditCoursePanel() {
    const panel = document.getElementById('editCoursePanel');
    panel.classList.remove('active');
    
    // Remove overlay
    const overlay = document.querySelector('.panel-overlay');
    if (overlay) {
        overlay.remove();
    }
    
    document.body.style.overflow = '';
    
    // Reset form
    document.getElementById('editCourseForm').reset();
    clearEditFormErrors();
}

function populateEditForm() {
    // Get current course data from the page
    const courseName = document.querySelector('.course-header-left h1').textContent;
    const courseDescription = document.querySelector('.course-description').textContent;
    
    // Populate basic fields
    document.getElementById('editCourseName').value = courseName;
    document.getElementById('editDescription').value = courseDescription;
    
    // Populate OSCE types based on current course data
    const osceTypes = ['Classroom', 'Mock', 'Final']; // Mock data for now
    osceTypes.forEach(type => {
        const checkbox = document.getElementById('edit' + type);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Show verification field if Final is selected
    const finalCheckbox = document.getElementById('editFinal');
    if (finalCheckbox && finalCheckbox.checked) {
        document.getElementById('editVerificationField').style.display = 'block';
        document.getElementById('editVerification').checked = true;
    }
    
    // Populate selected procedures
    const selectedProcedures = []; // Mock data for now
    const editSelectedTags = document.getElementById('editSelectedTags');
    const editPlaceholder = document.querySelector('#editProceduresInput .placeholder');
    
    editSelectedTags.innerHTML = '';
    selectedProcedures.forEach(procedure => {
            const checkbox = document.getElementById('editProc' + procedure.id);
            if (checkbox) {
                checkbox.checked = true;
            }
            
            // Add tag to display
            const tag = document.createElement('span');
            tag.className = 'selected-tag';
            tag.innerHTML = `
                ${procedure.name}
                <span class="remove" onclick="removeEditProcedureTag(${procedure.id}, this)">&times;</span>
            `;
            editSelectedTags.appendChild(tag);
        });
    
    
    // Hide placeholder if procedures are selected
    if (selectedProcedures.length > 0) {
        editPlaceholder.style.display = 'none';
    }
}

function toggleEditDropdown() {
    const dropdown = document.getElementById('editProceduresDropdown');
    const input = document.getElementById('editProceduresInput');
    
    dropdown.classList.toggle('active');
    input.classList.toggle('active');
}

function filterEditProcedures(searchTerm) {
    const options = document.querySelectorAll('#editProceduresOptions .option-item');
    
    options.forEach(option => {
        const text = option.querySelector('span').textContent.toLowerCase();
        if (text.includes(searchTerm.toLowerCase())) {
            option.style.display = 'flex';
        } else {
            option.style.display = 'none';
        }
    });
}

function toggleEditVerificationField(checkbox) {
    const verificationField = document.getElementById('editVerificationField');
    if (checkbox.checked) {
        verificationField.style.display = 'block';
    } else {
        verificationField.style.display = 'none';
        document.getElementById('editVerification').checked = false;
    }
}

function removeEditProcedureTag(procedureId, element) {
    // Remove the tag
    element.parentElement.remove();
    
    // Uncheck the corresponding checkbox
    const checkbox = document.getElementById('editProc' + procedureId);
    if (checkbox) {
        checkbox.checked = false;
    }
    
    // Show placeholder if no tags remain
    const selectedTags = document.getElementById('editSelectedTags');
    const placeholder = document.querySelector('#editProceduresInput .placeholder');
    if (selectedTags.children.length === 0) {
        placeholder.style.display = 'block';
    }
}

function clearEditFormErrors() {
    document.querySelectorAll('#editCourseForm .error-message').forEach(error => {
        error.classList.remove('show');
    });
    document.querySelectorAll('#editCourseForm .form-control').forEach(input => {
        input.classList.remove('error', 'success');
    });
}

// Handle edit form submission
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editCourseForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            if (validateEditForm()) {
                submitEditForm();
            }
        });
    }
    
    // Handle procedure selection in edit form
    document.addEventListener('change', function(e) {
        if (e.target.matches('#editProceduresOptions input[type="checkbox"]')) {
            handleEditProcedureSelection(e.target);
        }
    });
    
    // Load procedures for edit form
    loadProceduresForEdit();
});

function loadProceduresForEdit() {
    $.ajax({
        url: '/fetch-procedures/',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            const procedures = data.procedures || [];
            populateEditProceduresDropdown(procedures);
        },
        error: function(xhr, status, error) {
            console.error('Error loading procedures for edit:', error);
        }
    });
}

function populateEditProceduresDropdown(procedures) {
    const container = document.getElementById('editProceduresOptions');
    if (!container) return;
    
    container.innerHTML = '';
    
    procedures.forEach(procedure => {
        const optionItem = document.createElement('div');
        optionItem.className = 'option-item';
        optionItem.setAttribute('data-value', procedure.id);
        
        optionItem.innerHTML = `
            <div class="custom-checkbox">
                <input type="checkbox" id="editProc${procedure.id}" value="${procedure.id}">
                <label for="editProc${procedure.id}"></label>
            </div>
            <span>${procedure.name}</span>
        `;
        
        container.appendChild(optionItem);
    });
}

function submitEditForm() {
    const submitBtn = document.getElementById('editSubmitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnSpinner = submitBtn.querySelector('.btn-spinner');
    
    // Show loading state
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline-flex';
    submitBtn.disabled = true;
    
    // Collect form data
    const formData = {
        courseName: document.getElementById('editCourseName').value.trim(),
        description: document.getElementById('editDescription').value.trim(),
        procedures: Array.from(document.querySelectorAll('#editProceduresOptions input[type="checkbox"]:checked')).map(cb => cb.value),
    };
    
    const courseId = '{{ course.id }}';
    
    $.ajax({
        url: `/courses/${courseId}/update/`,
        method: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            showSuccess('Course updated successfully!');
            closeEditCoursePanel();
            // Reload the page to reflect changes
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        },
        error: function(xhr, status, error) {
            let errorMessage = 'Failed to update course';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            showError(errorMessage);
        },
        complete: function() {
            // Reset button state
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
        }
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showSuccess(message) {
    // Create a simple notification
    const notification = $(`
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-check-circle"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto remove after 5 seconds
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}

function showError(message) {
    // Create a simple notification
    const notification = $(`
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto remove after 5 seconds
    setTimeout(function() {
        notification.alert('close');
    }, 5000);
}

function openEditCoursePanel() {
    const panel = document.getElementById('editCoursePanel');
    panel.classList.add('active');
    
    // Populate form with current course data
    populateEditForm();
    
    // Add overlay
    if (!document.querySelector('.side-panel-overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'side-panel-overlay active';
        overlay.onclick = closeEditCoursePanel;
        document.body.appendChild(overlay);
    }
}

function closeEditCoursePanel() {
    const panel = document.getElementById('editCoursePanel');
    panel.classList.remove('active');
    
    // Remove overlay
    const overlay = document.querySelector('.side-panel-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function populateEditForm() {
    // Populate course name
    document.getElementById('editCourseName').value = courseData.name;
    
    // Populate description
    document.getElementById('editDescription').value = courseData.description;
    
    // Populate OSCE types
    courseData.osce_types.forEach(type => {
        const checkbox = document.getElementById(`edit${type.charAt(0).toUpperCase() + type.slice(1)}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Handle verification field
    const finalCheckbox = document.getElementById('editFinal');
    if (finalCheckbox && finalCheckbox.checked) {
        document.getElementById('editVerificationField').style.display = 'block';
        document.getElementById('editVerification').checked = courseData.verification_required;
    }
    
    // Populate procedures (will be handled after procedures are loaded)
    setTimeout(() => {
        populateEditProcedures();
    }, 500);
}

function populateEditProcedures() {
    if(procedures_populated == false) {
    const procedureIds = courseData.procedures.map(p => p.id);
    console.log(procedureIds);
    // Check the corresponding checkboxes
    procedureIds.forEach(id => {
        const checkbox = document.getElementById(`editProc${id}`);
        if (checkbox) {
            checkbox.checked = true;
            handleEditProcedureSelection(checkbox);
        }
    });
    procedures_populated = true;
    }
}

function handleEditProcedureSelection(checkbox) {
    const selectedTags = document.getElementById('editSelectedTags');
    const placeholder = document.querySelector('#editProceduresInput .placeholder');
    const procedureText = checkbox.parentElement.nextElementSibling.textContent;
    
    if (checkbox.checked) {
        // Add tag
        const tag = document.createElement('span');
        tag.className = 'selected-tag';
        tag.innerHTML = `
            ${procedureText}
            <span class="remove" onclick="removeEditProcedureTag(${checkbox.value}, this)">&times;</span>
        `;
        selectedTags.appendChild(tag);
        placeholder.style.display = 'none';
    } else {
        // Remove tag
        const tags = selectedTags.querySelectorAll('.selected-tag');
        tags.forEach(tag => {
            if (tag.textContent.trim().startsWith(procedureText)) {
                tag.remove();
            }
        });
        
        if (selectedTags.children.length === 0) {
            placeholder.style.display = 'block';
        }
    }
}

function validateEditForm() {
    let isValid = true;
    
    // Clear previous errors
    clearEditFormErrors();
    
    // Validate course name
    const courseName = document.getElementById('editCourseName');
    if (!courseName.value.trim()) {
        showEditError('editCourseNameError', 'Course name is required');
        courseName.classList.add('error');
        isValid = false;
    } else {
        courseName.classList.add('success');
    }
    
    // Validate procedures
    const selectedProcedures = document.querySelectorAll('#editProceduresOptions input:checked');
    if (selectedProcedures.length === 0) {
        showEditError('editProceduresError', 'Please select at least one procedure');
        isValid = false;
    }    
    
    return isValid;
}

function showEditError(errorId, message) {
    const errorElement = document.getElementById(errorId);
    errorElement.textContent = message;
    errorElement.classList.add('show');
}

// Batches lazy loading functionality

let batchOffset = 0;
const batchLimit = 10;
let batchLoading = false;
let allBatchesLoaded = false;

function renderBatchRow(batch) {
    return `
        <tr>
            <td><div class="batch-name"><span>${batch.batchName}</span></div></td>
            <td><span class="unit-type-badge">${batch.unitType}</span></td>
            <td><span class="unit-name">${batch.unitName}</span></td>
            <td><span class="learner-count">${batch.learnerCount} Learners</span></td>
        </tr>
    `;
}

function loadMoreBatches() {
    if (batchLoading || allBatchesLoaded) return;
    batchLoading = true;
    document.getElementById('showMoreBatchesBtn').innerText = 'Loading...';

    const courseId = '{{ course.id }}';
    const search = document.getElementById('batchSearch').value;
    const unitType = document.getElementById('unitTypeFilter').value;
    const unitName = document.getElementById('unitNameFilter').value;

    const params = new URLSearchParams({
        search: search,
        unit_type: unitType,
        unit_name: unitName,
        offset: batchOffset,
        limit: batchLimit
    });

    fetch(`/courses/${courseId}/batches/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            const batches = data.batches || [];
            if (batches.length < batchLimit) {
                allBatchesLoaded = true;
                document.getElementById('showMoreBatchesBtn').style.display = 'none';
            }
            batchOffset += batches.length;
            const tbody = document.getElementById('batchesTableBody');
            batches.forEach(batch => {
                tbody.insertAdjacentHTML('beforeend', renderBatchRow(batch));
            });
            if (batchOffset === 0 && batches.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#666;">No batches found</td></tr>`;
                document.getElementById('showMoreBatchesBtn').style.display = 'none';
            }
        })
        .finally(() => {
            batchLoading = false;
            if (!allBatchesLoaded) document.getElementById('showMoreBatchesBtn').innerText = 'Show More';
        });
}

function resetBatches() {
    batchOffset = 0;
    allBatchesLoaded = false;
    document.getElementById('batchesTableBody').innerHTML = '';
    document.getElementById('showMoreBatchesBtn').style.display = 'block';
    document.getElementById('showMoreBatchesBtn').innerText = 'Show More';
    loadMoreBatches();
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('batchSearch').addEventListener('input', () => resetBatches());
    document.getElementById('unitTypeFilter').addEventListener('change', function() {
        const unitType = this.value;
        loadUnitNames(unitType);
        document.getElementById('unitNameFilter').value = '';
        resetBatches();
    });
    document.getElementById('unitNameFilter').addEventListener('change', () => resetBatches());

    // Initial load
    resetBatches();
});

// --- Dynamic Unit Name Filter ---

function loadUnitNames(unitType) {
    const unitNameFilter = document.getElementById('unitNameFilter');
    unitNameFilter.innerHTML = '<option value="">All Unit Names</option>';
    if (!unitType) return;

    let url = '';
    if (unitType === 'institution') {
        url = '/fetch-institutes/';
    } else if (unitType === 'hospital') {
        url = '/api/fetch-hospitals/';
    } else {
        return;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            let units = [];
            if (unitType === 'institution' && data.institutes) {
                units = data.institutes.map(inst => ({
                    id: inst.id,
                    name: inst.instituteName
                }));
            } else if (unitType === 'hospital' && data.units) {
                units = data.units.map(hosp => ({
                    id: hosp.id,
                    name: hosp.name
                }));
            }
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.name;
                option.textContent = unit.name;
                unitNameFilter.appendChild(option);
            });
        });
}

// --- Hook up filters and search to AJAX ---
document.addEventListener('DOMContentLoaded', function() {
    // document.getElementById('batchSearch').addEventListener('input', () => loadCourseBatches(1));
    document.getElementById('unitTypeFilter').addEventListener('change', function() {
        const unitType = this.value;
        loadUnitNames(unitType);
        document.getElementById('unitNameFilter').value = '';
        // loadCourseBatches(1);
    });
    // document.getElementById('unitNameFilter').addEventListener('change', () => loadCourseBatches(1));

    // Initial load
    // loadCourseBatches(1);
});
</script>
{% endblock %} 