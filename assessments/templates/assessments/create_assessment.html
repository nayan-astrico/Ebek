{% extends "assessments/base.html" %}

{% block title %}Upload Assessment{% endblock %}
{% load custom_filters %}


{% block content %}

<!-- Updated the upload procedure button with sidebar  -->
<div class="header">
    <div class="header-left">
        <h1>Assessments</h1>
        <p class="text-muted">Manage your assessments.</p>
    </div>
    <div class="header-right">
        {% if "bulk_upload_learners" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <button class="btn btn-primary" onclick="toggleUploadPanel()">
            <i class="fas fa-plus"></i>
            Create Assessment
        </button>
        {% endif %}
        </div>
    </div>


    <!-- Updated search and filter for procedures -->
    <div>
    <div class="search-filter-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input 
                type="text" 
                placeholder="Search procedures..." 
                id="procedureSearchInput" 
                oninput="filterProcedures(this.value)"
            >
        </div>
    <button class="btn-filter" onclick="toggleProcedureFilterPanel()" id="filterBtn">
        <i class="fas fa-filter"></i>
        Filters
        <span class="filter-badge" id="filterBadge" style="display: none;">0</span>
    </button>
    </div>
        
    <!--Updated view of Procedures Table -->
    <div class="card">
        <table class="table">
            <thead>
                <tr>
                    <th>Procedure</th>
                    <th>Questions</th>
                    <th>Category</th>
                    <th>Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="proceduresTableBody">
                <!-- Procedures will be loaded dynamically -->
            </tbody>
        </table>

        <!-- Loading Spinner -->
        <div id="proceduresLoadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Loading procedures...</p>
        </div>

        <!-- Show More Button -->
        <div style="text-align:center; margin: 20px 0;">
            <button id="showMoreProceduresBtn" class="btn btn-primary" style="display:none;" onclick="loadMoreProcedures()">Show More</button>
        </div>

        <!-- Empty State -->
        <div id="emptyProceduresState" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-stethoscope"></i>
            </div>
            <h3>No procedures found</h3>
            <p>Try creating or importing a procedure.</p>
            {% if "create_procedure" in request.user.get_all_permissions or request.user.has_all_permissions %}
            <button class="btn btn-primary" onclick="toggleAddProcedurePanel()">
                <i class="fas fa-plus"></i>
                Create Procedure
            </button>
            {% endif %}
        </div>
    </div>


 
<div class="filter-panel" id="procedureFilterPanel">
    <div class="filter-header">
        <h3>Filter Procedures</h3>
        <button type="button" class="close" onclick="toggleProcedureFilterPanel()">
            <span>&times;</span>
        </button>
    </div>

    <form class="filter-form">
        <div class="filter-layout">
            <div class="filter-types">
                <div class="filter-type active" data-filter="status" onclick="switchProcedureFilter('status')">
                    <span>Status</span>
                </div>
            </div>

            <div class="filter-content-wrapper">
                <div class="filter-content active" id="procedure-status-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search status" id="procedureFilterStatusSearch" oninput="filterProcedureStatusOptions(this.value)">
                        <div class="selection-count" id="procedureStatusSelectionCount">0 Status selected</div>
                    </div>
                    <div class="options-list" id="procedureFilterStatusOptions">
                        <label class="option-item">
                            <input type="checkbox" name="status" value="active" onchange="updateProcedureStatusSelectionCount()">
                            <span>Active</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="status" value="inactive" onchange="updateProcedureStatusSelectionCount()">
                            <span>Inactive</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-actions">
            <button type="button" class="btn btn-light" onclick="clearAllProcedureFilters()">Clear All</button>
            <button type="button" class="btn btn-light" onclick="toggleProcedureFilterPanel()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="applyProcedureFilters()">Apply Filter</button>
        </div>
    </form>
</div>


    <!-- Side Panel for Viewing Procedure -->
    <div id="viewProcedurePanel" class="side-panel">
        <div class="side-panel-header">
            <h3 id="procedureTitle">Procedure Details</h3>
            <button class="close-btn" onclick="toggleViewProcedurePanel()">×</button>
        </div>
        <div id="procedureContent" class="side-panel-body"></div>
    </div>


<!-- Bulk Upload Panel -->
<div class="upload-panel" id="uploadPanel">
    <div class="upload-header">
        <h3>Upload Assessment</h3>
        <button type="button" class="btn-close" onclick="toggleUploadPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="upload-content">
        <!-- Templates Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-file-download"></i>
                <h4>Download Templates</h4>
            </div>
            <div class="template-buttons">
                <a href="/media/excel_templates/Assessment-Creation-Template.xlsx" class="template-card" download>
                    <div class="template-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="template-info">
                        <h5>Assessment Template</h5>
                        <p>For Creating assessments.</p>
                    </div>
                    <i class="fas fa-download"></i>
                </a>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Upload Excel File</h4>
            </div>
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}

            <div class="form-group" style="margin-bottom: 15px;">
            <label for="procedureName"><strong>Procedure Name</strong></label>
            <input type="text" id="procedureName" name="procedure_name" class="form-control" 
                   placeholder="Enter procedure name" required>
            </div>

            <!-- 🔹 NEW: Category Dropdown -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="category"><strong>Category</strong></label>
                <select id="category" name="category" class="form-control" required>
                    <option value="" disabled selected>Select a category</option>
                    <option value="Core Skills">Core Skills</option>
                    <option value="Infection Control">Infection Control</option>
                    <option value="Documentation">Documentation</option>
                    <option value="Pre-Procedure">Pre-Procedure</option>
                    <option value="Critical Thinking">Critical Thinking</option>
                </select>
            </div>







                <div class="upload-zone" id="uploadZone">
                    <div class="upload-placeholder">
                        <div class="upload-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <h5>Drag and drop your Excel file here</h5>
                        <p>or</p>
                        <label class="btn btn-outline">
                            Choose File
                            <input type="file" id="fileInput" accept=".xlsx" hidden>
                        </label>
                        <p class="upload-hint">Supported format: Excel (.xlsx)</p>
                    </div>
                    <div class="upload-preview" style="display: none;">
                        <div class="file-info">
                            <i class="fas fa-file-excel"></i>
                            <span class="filename">No file selected</span>
                        </div>
                        <button type="button" class="btn-icon" onclick="removeFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Preview Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-table"></i>
                <h4>Data Preview</h4>
            </div>
            <div class="preview-container">
                <div class="preview-table">
                    <div class="table-wrapper">
                        <!-- Table will be dynamically populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Section -->
        <div class="upload-section">
            <div class="section-header">
                <i class="fas fa-check-circle"></i>
                <h4>Validation Results</h4>
            </div>
            <div class="validation-results">
                <!-- Results will be dynamically populated -->
            </div>
        </div>

        <!-- Progress Section -->
        <div class="upload-section" id="progressSection" style="display: none;">
            <div class="section-header">
                <!-- <i class="fas fa-spinner fa-spin"></i> -->
                <h4>Upload Progress</h4>
            </div>
            <div class="progress-container">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <div class="progress-status" id="progressStatus">Preparing upload...</div>
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Rows:</span>
                        <span class="stat-value" id="totalRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Processed:</span>
                        <span class="stat-value" id="processedRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Success:</span>
                        <span class="stat-value success" id="successCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Updated:</span>
                        <span class="stat-value updated" id="updateCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Errors:</span>
                        <span class="stat-value error" id="errorCount">0</span>
                    </div>
                </div>
                <div class="progress-details" id="progressDetails">
                    <!-- Detailed progress information will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="upload-actions">
        <button type="button" class="btn btn-light" onclick="toggleUploadPanel()">Cancel</button>
        <button type="button" class="btn btn-primary" id="uploadButton" onclick="submitUpload()">
            <i class="fas fa-upload"></i>
            Upload
        </button>
        <button type="button" class="btn btn-success" id="doneButton" onclick="completeUpload()" style="display: none;">
            <i class="fas fa-check"></i>
            Done
        </button>
    </div>
</div>

<script>

function resetUploadPanel() {
    const previewContainer = document.querySelector('.table-wrapper');
    const validationContainer = document.querySelector('.validation-results');
    document.getElementById('uploadForm').reset();
    previewContainer.innerHTML = '';
    validationContainer.innerHTML = '';
}

// Toggle Upload Panel
function toggleUploadPanel() {
    const panel = document.getElementById('uploadPanel');
    panel.classList.toggle('active');
    document.body.style.overflow = panel.classList.contains('active') ? 'hidden' : '';
}

// DOM ready
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const previewContainer = document.querySelector('.table-wrapper');
    const validationContainer = document.querySelector('.validation-results');

    let selectedFile = null;

    // File select click only
    fileInput.addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        if (!selectedFile || !selectedFile.name.endsWith('.xlsx')) {
            alert('Please select a valid Excel file (.xlsx)');
            return;
        }
        previewExcel(selectedFile);
    });

    // Remove file
    window.removeFile = () => {
        selectedFile = null;
        fileInput.value = '';
        previewContainer.innerHTML = '';
        validationContainer.innerHTML = '';
    }

    // Preview Excel
    async function previewExcel(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch('/upload-preview/', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin', // ensures cookies (CSRF) are sent
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });

        // Check if response is JSON
        const text = await res.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (err) {
            console.error('Invalid JSON:', text);
            alert('Server returned invalid JSON. Check console.');
            return;
        }

        renderPreviewData(data);

    } catch (err) {
        console.error('Fetch error:', err);
        alert('Error fetching preview. Check console for details.');
    }
}

    // Render preview and validation
    function renderPreviewData(response) {
        previewContainer.innerHTML = '';
        validationContainer.innerHTML = '';

        if (!response || response.status !== 'success') {
            previewContainer.innerHTML = '<p style="color:red;">Upload failed. Please try again.</p>';
            return;
        }

        const rows = response.preview || [];
        if (!rows.length) {
            previewContainer.innerHTML = '<p>No preview data available.</p>';
        } else {
            let tableHTML = '<table><thead><tr>';
            Object.keys(rows[0]).forEach(k => tableHTML += `<th>${k}</th>`);
            tableHTML += '</tr></thead><tbody>';
            rows.forEach(row => {
                tableHTML += '<tr>';
                Object.values(row).forEach(v => tableHTML += `<td>${v === null || v === undefined || Number.isNaN(v) ? '-' : v}</td>`);
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            previewContainer.innerHTML = tableHTML;
        }

        const validations = response.validation || [];
        if (validations.length) {
            let html = '<ul>';
            validations.forEach(v => html += `<li>Row ${v.row}: ${v.message}</li>`);
            html += '</ul>';
            validationContainer.innerHTML = html;
        } else {
            validationContainer.innerHTML = '<p class="success">All rows valid ..</p>';
        }
    }

    // Upload button click
    uploadButton.addEventListener('click', async () => {
        if (!selectedFile) return alert('Please select a file first');

        const procedureName = document.getElementById('procedureName').value.trim();
        const category = document.getElementById('category').value;

        console.log(procedureName)
        console.log(category)

        // Basic validation
        if (!procedureName) return alert('Please enter a procedure name.');
        if (!category) return alert('Please select a category.');

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('procedure_name', procedureName);
        formData.append('category', category);

        try {
            const res = await fetch('/upload-excel/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: formData
            });
            const data = await res.json();
            alert(data.status === 'success' ? 'Upload successful ✅' : 'Upload failed ❌');
        } catch (err) {
            alert('Error uploading file.');
            console.error(err);
        }
    });

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
});


</script>

<script>
 // Current selected procedure filters
let currentProcedureFilters = { status: [] };

// Toggle panel
function toggleProcedureFilterPanel() {
    const panel = document.getElementById('procedureFilterPanel');
    const overlayClass = 'procedure-filter-overlay';

    panel.classList.toggle('active');
    if (panel.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
        if (!document.querySelector(`.${overlayClass}`)) {
            const overlay = document.createElement('div');
            overlay.className = `side-panel-overlay ${overlayClass}`;
            overlay.onclick = toggleProcedureFilterPanel;
            document.body.appendChild(overlay);
        }
    } else {
        document.body.style.overflow = '';
        const overlay = document.querySelector(`.${overlayClass}`);
        if (overlay) overlay.remove();
    }
}

// Switch filter tab (only status now)
function switchProcedureFilter(filterType) {
    document.querySelectorAll('.filter-type').forEach(type => type.classList.remove('active'));
    document.querySelectorAll('.filter-content').forEach(content => content.classList.remove('active'));

    document.querySelector(`.filter-type[data-filter="${filterType}"]`).classList.add('active');
    document.getElementById(`procedure-${filterType}-content`).classList.add('active');
}

// Update status selection count
function updateProcedureStatusSelectionCount() {
    const checkedStatuses = document.querySelectorAll('#procedureFilterStatusOptions input[type="checkbox"]:checked');
    document.getElementById('procedureStatusSelectionCount').textContent = `${checkedStatuses.length} Status selected`;
}

// Apply procedure filters
function applyProcedureFilters() {
    currentProcedureFilters.status = Array.from(
        document.querySelectorAll('#procedureFilterStatusOptions input[type="checkbox"]:checked')
    ).map(cb => cb.value);

    // Reload procedures with selected filters
    const searchText = document.getElementById('procedureSearchInput')?.value || '';
    filterProcedures(searchText);

    // Close panel
    toggleProcedureFilterPanel();

    if (currentProcedureFilters.status.length > 0) {
        showSuccess(`${currentProcedureFilters.status.length} filter(s) applied successfully!`);
    }
}

// Clear all filters
function clearAllProcedureFilters() {
    document.querySelectorAll('#procedureFilterStatusOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateProcedureStatusSelectionCount();
    currentProcedureFilters.status = [];

    // Reapply search without filters
    const searchText = document.getElementById('procedureSearchInput')?.value || '';
    filterProcedures(searchText);

    toggleProcedureFilterPanel();
    showSuccess('All filters cleared!');
}

// Filter function (to call your API with offset/limit & filters)
function filterProcedures(searchText = '') {
    const params = new URLSearchParams();
    params.append('offset', 0);
    params.append('limit', 10);
    if (searchText) params.append('search', searchText);
    currentProcedureFilters.status.forEach(status => params.append('status', status));

    fetch(`/fetch_assessments/?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            console.log('Filtered Procedures:', data);
            // TODO: Update your procedure table/list here
        });
}



</script>

<script>
    // function applyFilter() {
    //     const query = document.getElementById('searchInput').value;
    //     window.location.href = `?query=${query}`;
    // }


    function toggleActive(procedureId) {
        fetch(`/procedures/${procedureId}/toggle/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Status toggled successfully!");
            } else {
                alert(`Error: ${data.error}`);
            }
        });
    }


    function deleteProcedure(procedureId) {
        if (confirm("Are you sure you want to delete this procedure?")) {
            fetch(`/procedures/${procedureId}/delete/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}',
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Procedure deleted successfully!");
                    location.reload();
                } else {
                    alert(`Error: ${data.error}`);
                }
            });
        }
    }

    function downloadProcedure(procedureId) {
        window.location.href = `/procedures/${procedureId}/download/`;
    }
</script>

<script>

function viewProcedure(procedureId) {
    // Fetch the procedure details via AJAX
    fetch(`/procedures/${procedureId}/view/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Populate the side panel with fetched data
            populateSidePanel(data);

            // Show side panel
            toggleProcedurePanel(true);
        })
        .catch(error => {
            alert("An error occurred while fetching the procedure details.");
            console.error(error);
        });
}

function populateSidePanel(procedure) {
    let panel = document.getElementById('procedurePanel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'procedurePanel';
        panel.className = 'side-panel';
        panel.innerHTML = `
            <div class="side-panel-header">
                <h2 id="procedurePanelTitle"></h2>
                <button class="close-btn" onclick="toggleProcedurePanel(false)">×</button>
            </div>
            <div class="side-panel-body" id="procedurePanelBody"></div>
        `;
        document.body.appendChild(panel);
    }

    const panelTitle = document.getElementById('procedurePanelTitle');
    const panelBody = document.getElementById('procedurePanelBody');

    panelTitle.textContent = procedure.procedureName;
    panelBody.innerHTML = '';

    procedure.examMetaData.forEach((section, sectionIndex) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section';

        const sectionHeader = document.createElement('h4');
        sectionHeader.textContent = section.section_name 
            ? `Section ${sectionIndex + 1}: ${section.section_name}` 
            : '';
        sectionDiv.appendChild(sectionHeader);

        section.section_questions.forEach((question, questionIndex) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';

            const questionText = document.createElement('p');
            questionText.textContent = `${questionIndex + 1}. ${question.question}`;
            questionDiv.appendChild(questionText);

            const yesButton = createToggleButton('Yes', `yes-btn-${sectionIndex}-${questionIndex}`);
            const noButton = createToggleButton('No', `no-btn-${sectionIndex}-${questionIndex}`);
            questionDiv.appendChild(yesButton);
            questionDiv.appendChild(noButton);

            if (question.sub_section_questions_present) {
                question.sub_section_questions.forEach((subQuestion, subIndex) => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'sub-question';

                    const subText = document.createElement('p');
                    subText.textContent = `${String.fromCharCode(97 + subIndex)}. ${subQuestion.question}`;
                    subDiv.appendChild(subText);

                    const subYes = createToggleButton('Yes', `sub-yes-btn-${sectionIndex}-${questionIndex}-${subIndex}`);
                    const subNo = createToggleButton('No', `sub-no-btn-${sectionIndex}-${questionIndex}-${subIndex}`);
                    subDiv.appendChild(subYes);
                    subDiv.appendChild(subNo);

                    questionDiv.appendChild(subDiv);
                });
            }

            sectionDiv.appendChild(questionDiv);
        });

        panelBody.appendChild(sectionDiv);
    });
}

function toggleProcedurePanel(show = null) {
    const panel = document.getElementById('procedurePanel');
    if (!panel) return;

    const overlay = document.querySelector('.procedure-overlay');

    if (show === true || (!show && !panel.classList.contains('active'))) {
        // Show
        panel.classList.add('active');
        document.body.style.overflow = 'hidden';

        if (!overlay) {
            const newOverlay = document.createElement('div');
            newOverlay.className = 'procedure-overlay';
            newOverlay.onclick = () => toggleProcedurePanel(false);
            document.body.appendChild(newOverlay);

            setTimeout(() => newOverlay.classList.add('active'), 10);
        }
    } else {
        // Hide
        panel.classList.remove('active');
        document.body.style.overflow = '';

        if (overlay) {
            overlay.classList.remove('active');
            setTimeout(() => overlay.remove(), 300);
        }
    }
}

function createToggleButton(label, id = null) {
    const button = document.createElement('button');
    button.textContent = label;
    button.className = 'toggle-btn';
    if (id) button.id = id;

    button.addEventListener('click', () => {
        button.classList.toggle('selected');
    });

    return button;
}

</script>

<script>
let allProcedures = [];
let procedureOffset = 0;
const procedureLimit = 10;
let proceduresLoading = false;
let allProceduresLoaded = false;
let firstProcedureLoad = true;
let currentProcedureSearch = '';

function renderProcedureRow(proc) {
    const row = document.createElement('tr');
    row.className = 'procedure-row';
    row.innerHTML = `
        <td>${proc.name}</td>
        <td>${proc.questions}</td>
        <td>${proc.category}</td>
        <td>
            <label class="switch">
                <input type="checkbox" ${proc.active ? 'checked' : ''} onchange="toggleActive('${proc.id}', this)">
                <span class="slider round"></span>
            </label>
        </td>
        <td>
            <div class="actions">
                <button class="btn-icon btn-danger" onclick="event.stopPropagation(); deleteProcedure('${proc.id}')">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn-icon" onclick="event.stopPropagation(); downloadProcedure('${proc.id}')">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn-icon" onclick="event.stopPropagation(); viewProcedure('${proc.id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </td>
    `;
    return row;
}

function buildProcedureQueryParams() {
    const params = new URLSearchParams();
    params.append('offset', procedureOffset);
    params.append('limit', procedureLimit);
    if (currentProcedureSearch) params.append('search', currentProcedureSearch);
    currentProcedureFilters.status.forEach(status => params.append('status', status));
    return params.toString();
}

function loadMoreProcedures() {
    if (proceduresLoading || allProceduresLoaded) return;
    proceduresLoading = true;

    const spinner = document.getElementById('proceduresLoadingSpinner');
    const showMoreBtn = document.getElementById('showMoreProceduresBtn');

    if (firstProcedureLoad) {
        spinner.style.display = 'flex';
        showMoreBtn.style.display = 'none';
    } else {
        showMoreBtn.innerText = 'Loading...';
        showMoreBtn.disabled = true;
    }

    fetch(`/fetch-assessments/?${buildProcedureQueryParams()}`)
        .then(response => response.json())
        .then(data => {
            const procedures = data.assessments || [];

            if (procedures.length < procedureLimit || data.all_loaded) {
                allProceduresLoaded = true;
                showMoreBtn.style.display = 'none';
            }

            procedureOffset += procedures.length;
            allProcedures = allProcedures.concat(procedures);
            const tbody = document.getElementById('proceduresTableBody');

            procedures.forEach(proc => tbody.appendChild(renderProcedureRow(proc)));

            if (procedureOffset === 0 && procedures.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyProceduresState').style.display = 'block';
                showMoreBtn.style.display = 'none';
            } else {
                document.getElementById('emptyProceduresState').style.display = 'none';
            }

            if (!allProceduresLoaded && allProcedures.length > 0) {
                showMoreBtn.style.display = 'inline-block';
                showMoreBtn.innerText = 'Show More';
                showMoreBtn.disabled = false;
            }
        })
        .finally(() => {
            proceduresLoading = false;
            spinner.style.display = 'none';
            firstProcedureLoad = false;
        });
}

function resetProceduresAndLoad() {
    procedureOffset = 0;
    allProceduresLoaded = false;
    allProcedures = [];
    firstProcedureLoad = true;
    document.getElementById('proceduresTableBody').innerHTML = '';
    document.getElementById('showMoreProceduresBtn').style.display = 'none';
    document.getElementById('proceduresLoadingSpinner').style.display = 'flex';
    loadMoreProcedures();
}

// Filter / search support
function filterProcedures(query) {
    currentProcedureSearch = query.trim();
    resetProceduresAndLoad();
}

// Initialize Procedures table
document.addEventListener('DOMContentLoaded', function() {
    procedureOffset = 0;
    allProceduresLoaded = false;
    allProcedures = [];
    firstProcedureLoad = true;
    currentProcedureSearch = '';
    document.getElementById('proceduresTableBody').innerHTML = '';
    document.getElementById('showMoreProceduresBtn').style.display = 'none';
    document.getElementById('proceduresLoadingSpinner').style.display = 'flex';
    loadMoreProcedures();

    // Hook up procedure search input
    const searchInput = document.getElementById('procedureSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterProcedures(this.value);
        });
    }
});

</script>

<style>




/* Upload Panel */
.upload-panel {
    position: fixed;
    top: 0;
    right: -800px;
    width: 800px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.upload-panel.active {
    right: 0;
}

.upload-header {
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
}

.upload-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1a202c;
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    color: #64748b;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-close:hover {
    background: #e2e8f0;
    color: #1a202c;
}

.upload-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
}

.upload-section {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    padding: 20px;
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-header i {
    font-size: 20px;
    color: #F16564;
}

.section-header h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

.template-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.template-card {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    text-decoration: none;
    color: #1a202c;
    transition: all 0.2s;
}

.template-card:hover {
    border-color: #F16564;
    background: #fff5f5;
}

.template-icon {
    width: 40px;
    height: 40px;
    background: #F16564;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.template-info {
    flex: 1;
    margin-left: 16px;
}

.template-info h5 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.template-info p {
    margin: 4px 0 0;
    font-size: 12px;
    color: #64748b;
}

.template-card i.fa-download {
    color: #64748b;
    font-size: 16px;
}

.upload-zone {
    border: 2px dashed #e2e8f0;
    border-radius: 12px;
    padding: 32px;
    transition: all 0.2s;
    background: #f8fafc;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-zone.dragover {
    border-color: #F16564;
    background: #fff5f5;
}

.upload-placeholder {
    color: #4a5568;
    width: 100%;
    text-align: center;
}

.upload-icon {
    width: 64px;
    height: 64px;
    background: #F16564;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.upload-icon i {
    font-size: 32px;
    color: white;
}

.upload-placeholder h5 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

.upload-placeholder p {
    margin: 8px 0;
    color: #64748b;
}

.upload-hint {
    font-size: 12px;
    color: #64748b;
    margin-top: 16px;
}

.btn-outline {
    padding: 8px 24px;
    border: 2px solid #F16564;
    border-radius: 6px;
    background: none;
    color: #F16564;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    width: fit-content;
    margin: 0 auto;
    display: inline-block;
}

.btn-outline:hover {
    background: #F16564;
    color: white;
}

.upload-preview {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.file-info i {
    font-size: 24px;
    color: #F16564;
}

.filename {
    font-size: 14px;
    color: #1a202c;
}

.preview-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.table-wrapper {
    overflow-x: auto;
    max-height: 300px;
}

.table-wrapper table {
    width: 100%;
    border-collapse: collapse;
}

.table-wrapper th {
    background: #f8fafc;
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    position: sticky;
    top: 0;
}

.table-wrapper td {
    padding: 12px 16px;
    border-top: 1px solid #e2e8f0;
    font-size: 14px;
}

.validation-results {
    padding: 16px;
    border-radius: 8px;
    background: #f8fafc;
}

.alert {
    padding: 16px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.alert-danger {
    background: #fff5f5;
    color: #c53030;
}

.alert-success {
    background: #f0fff4;
    color: #2f855a;
}

.alert i {
    font-size: 20px;
}

.alert ul {
    margin: 8px 0 0;
    padding-left: 20px;
}

.upload-actions {
    padding: 20px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
}



.btn-primary:hover {
    background: #e45857;
}

.btn-light {
    background: #f1f5f9;
    border: none;
    color: #4a5568;
}

.btn-light:hover {
    background: #e2e8f0;
}

@media (max-width: 992px) {
    .upload-panel {
        width: 100%;
        right: -100%;
    }
    
    .template-buttons {
        grid-template-columns: 1fr;
    }
}

.preview-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.preview-table th, .preview-table td {
    border: 1px solid #ddd;
    padding: 8px;
}

.preview-table th {
    background-color: #f4f4f4;
    text-align: left;
}














    /* Modal Styling */
    #procedureModal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        padding: 20px;
        z-index: 1000;
    }

    #procedureModal h3 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
    }

    #modalBody {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Toggle Button Styling */
    .toggle-btn {
        margin-right: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
        color: #333;
        border-radius: 10px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease-in-out;
        border-color: #F16564;
        font-weight: bold;
    }

    .toggle-btn:hover {
        background-color: #f5f5f5;
    }

    /* Selected State */
    .toggle-btn.selected {
        background-color: #F16564; /* Orange */
        color: #fff;
        border-color: #F16564;
    }

    /* Modal Close Button */
    #procedureModal .close-modal-btn {
        font-size: 20px;
        font-weight: bold;
        border: none;
        background: none;
        cursor: pointer;
        color: #666;
        float: right;
    }

    /* Footer Button (Close Modal) */
    #procedureModal .close-btn {
        display: block;
        margin: 20px auto 0;
        background-color: #F16564;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
    }
    .sub-question {
        margin: 20px;
    }
    .question{
        margin-top: 25px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
       
/* Basic Layout */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header-left h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

.header-left p {
    margin: 4px 0 0;
    color: #666;
}

.btn-success {
    background: #48BB78;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    color: white;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
    text-decoration: none;
}

.btn-success:hover {
    background: #38A169;
    text-decoration: none;
    color: white;
}

/* Filters */
.filters {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
}

.filters .form-group {
    margin-bottom: 0;
}

.filters label {
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 4px;
}

.filters .form-control {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.filters .btn-block {
    margin-top: 24px;
}

/* Table Styles */
.card {
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background: #f8fafc;
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    text-transform: uppercase;
}

.table td {
    padding: 16px;
    border-top: 1px solid #e2e8f0;
}

.course-row {
    cursor: pointer;
}

.course-row:hover {
    background-color: #f7fafc;
}

/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: #1AA09A;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider.round {
    border-radius: 24px;
}

.slider.round:before {
    border-radius: 50%;
}

/* Action Buttons */
.actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: #edf2f7;
    color: #4a5568;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.btn-icon:hover {
    background: #e2e8f0;
}

.btn-icon.btn-danger {
    color: #c53030;
    background: #fff5f5;
}

.btn-icon.btn-danger:hover {
    background: #fed7d7;
}

/* Overlay */
.side-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.side-panel-overlay.active {
    display: block;
}

/* Filter Panel */
.filter-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
}

.filter-panel.active {
    right: 0;
}

.filter-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.filter-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.filter-layout {
    display: flex;
    height: calc(100vh - 140px);
}

.filter-types {
    width: 30%;
    border-right: 1px solid #e2e8f0;
    background: #f8fafc;
}

.filter-type {
    padding: 16px 20px;
    cursor: pointer;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 500;
    color: #4a5568;
}

.filter-type.active {
    background: white;
    color: #F16564;
    border-right: 2px solid #F16564;
}

.filter-content-wrapper {
    width: 70%;
    position: relative;
}

.filter-content {
    display: none;
    height: 100%;
    flex-direction: column;
}

.filter-content.active {
    display: flex;
}

.filter-search {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
}

.filter-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    margin-bottom: 12px;
}

.selection-count {
    font-size: 12px;
    color: #666;
}

.options-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px;
}

.option-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    cursor: pointer;
}

.option-item input[type="checkbox"] {
    margin: 0;
}

.filter-actions {
    padding: 16px 20px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

/* Responsive */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .header-right {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .header-right .btn {
        width: 100%;
    }

    .filters .row {
        margin: 0;
    }

    .filters [class*="col-"] {
        padding: 0;
        margin-bottom: 16px;
    }

    .filters .btn-block {
        margin-top: 0;
    }

    .card {
        overflow-x: auto;
    }

    .table {
        min-width: 800px;
    }
}

/* Search and Filter Bar */
.search-filter-bar {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
}

.search-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 16px;
}

.search-box input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 14px;
}

.btn-filter {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-filter:hover {
    background: #f7fafc;
}

/* Updated Filter Panel Styles */
.filter-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
}

.filter-panel.active {
    right: 0;
}

.filter-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
}

.filter-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1a202c;
}

.filter-form {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 64px); /* Header height */
}

.filter-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Filter Types (30%) */
.filter-types {
    width: 30%;
    background: #f8fafc;
    border-right: 1px solid #e2e8f0;
}

.filter-type {
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    color: #4a5568;
}

.filter-type:hover {
    background: #f1f5f9;
}

.filter-type.active {
    background: white;
    color: #F16564;
}

.filter-type.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #F16564;
}

/* Filter Content (70%) */
.filter-content-wrapper {
    width: 70%;
    display: flex;
    flex-direction: column;
    background: white;
}

.filter-content {
    display: none;
    height: 100%;
    flex-direction: column;
}

.filter-content.active {
    display: flex;
}

.filter-search {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
}

.filter-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 12px;
}

.filter-search input:focus {
    outline: none;
    border-color: #F16564;
    box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
}

.selection-count {
    font-size: 14px;
    color: #4a5568;
}

.options-list {
    padding: 16px 20px;
    overflow-y: auto;
    flex: 1;
}

.option-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    cursor: pointer;
}

.option-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border: 2px solid #cbd5e0;
    border-radius: 4px;
    cursor: pointer;
}

.option-item input[type="checkbox"]:checked {
    background-color: #F16564;
    border-color: #F16564;
}

.option-item span {
    font-size: 14px;
    color: #4a5568;
}

.filter-actions {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
    margin-top: auto;
}


.btn-light {
    background: #f1f5f9;
    border: none;
    padding: 8px 24px;
    border-radius: 6px;
    color: #4a5568;
    font-weight: 500;
    cursor: pointer;
}

.btn-light:hover {
    background: #e2e8f0;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-panel {
        width: 100%;
        right: -100%;
    }
}

/* Upload Panel */
.upload-panel {
    position: fixed;
    top: 0;
    right: -800px;
    width: 800px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.upload-panel.active {
    right: 0;
}

.upload-header {
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
}

.upload-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1a202c;
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    color: #64748b;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-close:hover {
    background: #e2e8f0;
    color: #1a202c;
}

.upload-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
}

.upload-section {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    padding: 20px;
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-header i {
    font-size: 20px;
    color: #F16564;
}

.section-header h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

.template-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.template-card {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    text-decoration: none;
    color: #1a202c;
    transition: all 0.2s;
}

.template-card:hover {
    border-color: #F16564;
    background: #fff5f5;
}

.template-icon {
    width: 40px;
    height: 40px;
    background: #F16564;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.template-info {
    flex: 1;
    margin-left: 16px;
}

.template-info h5 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.template-info p {
    margin: 4px 0 0;
    font-size: 12px;
    color: #64748b;
}

.template-card i.fa-download {
    color: #64748b;
    font-size: 16px;
}

.upload-zone {
    border: 2px dashed #e2e8f0;
    border-radius: 12px;
    padding: 32px;
    transition: all 0.2s;
    background: #f8fafc;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-zone.dragover {
    border-color: #F16564;
    background: #fff5f5;
}

.upload-placeholder {
    color: #4a5568;
    width: 100%;
    text-align: center;
}

.upload-icon {
    width: 64px;
    height: 64px;
    background: #F16564;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.upload-icon i {
    font-size: 32px;
    color: white;
}

.upload-placeholder h5 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

.upload-placeholder p {
    margin: 8px 0;
    color: #64748b;
}

.upload-hint {
    font-size: 12px;
    color: #64748b;
    margin-top: 16px;
}

.btn-outline {
    padding: 8px 24px;
    border: 2px solid #F16564;
    border-radius: 6px;
    background: none;
    color: #F16564;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    width: fit-content;
    margin: 0 auto;
    display: inline-block;
}

.btn-outline:hover {
    background: #F16564;
    color: white;
}

.upload-preview {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.file-info i {
    font-size: 24px;
    color: #F16564;
}

.filename {
    font-size: 14px;
    color: #1a202c;
}

.preview-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.table-wrapper {
    overflow-x: auto;
    max-height: 300px;
}

.table-wrapper table {
    width: 100%;
    border-collapse: collapse;
}

.table-wrapper th {
    background: #f8fafc;
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    position: sticky;
    top: 0;
}

.table-wrapper td {
    padding: 12px 16px;
    border-top: 1px solid #e2e8f0;
    font-size: 14px;
}

.validation-results {
    padding: 16px;
    border-radius: 8px;
    background: #f8fafc;
}

.alert {
    padding: 16px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.alert-danger {
    background: #fff5f5;
    color: #c53030;
}

.alert-success {
    background: #f0fff4;
    color: #2f855a;
}

.alert i {
    font-size: 20px;
}

.alert ul {
    margin: 8px 0 0;
    padding-left: 20px;
}

.upload-actions {
    padding: 20px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
}


.btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #F16564;
    color: white;
}

.btn-primary:hover {
    background: #e45857;
}

.btn-light {
    background: #f1f5f9;
    border: none;
    color: #4a5568;
}

.btn-light:hover {
    background: #e2e8f0;
}

@media (max-width: 992px) {
    .upload-panel {
        width: 100%;
        right: -100%;
    }
    
    .template-buttons {
        grid-template-columns: 1fr;
    }
}


/* Side Panel Styles */
.side-panel {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.side-panel.active {
    right: 0;
}

.side-panel-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.side-panel-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

/* .side-panel-form {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
    display: flex;
    flex-direction: column;
} */
.side-panel-body {
    padding: 20px 24px;
    overflow-y: auto;
    flex: 1;
    background-color: #fafafa;
}

/* started from here  */
.filter-panel {
   position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.filter-panel.active {
    right: 0;
}

.filter-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.filter-form {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
}

.filter-search {
    margin-bottom: 10px;
}

.selection-count {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.option-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
}

.filter-actions {
    display: flex;
    justify-content: space-between;
    margin-top: auto;
    padding-top: 10px;
    border-top: 1px solid #e2e8f0;
}

.side-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 999;
}

</style>
{% endblock %}
