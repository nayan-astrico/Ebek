{% extends "assessments/base.html" %}

{% block title %}Assign Assessment{% endblock %}
{% block content %}
{% load custom_filters %}

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1>Assessments</h1>
        <p class="text-muted">Manage your assessments</p>
    </div>
    <div class="header-right">
        {% if "assign_assignment" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <button class="btn btn-primary" onclick="toggleAssignPanel()">
            <i class="fas fa-plus"></i>
            Assign Assessment
        </button>
        {% endif %}
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search assessments..." oninput="filterAssessments(this.value)">
    </div>
    <button class="btn-filter" onclick="toggleFilterPanel()" id="filterBtn">
        <i class="fas fa-filter"></i>
        Filters
        <span class="filter-badge" id="filterBadge" style="display: none;">0</span>
    </button>
</div>

<!-- Filter Side Panel -->
<div class="filter-panel" id="filterPanel">
    <div class="filter-header">
        <h3>Filter Assessments</h3>
        <button type="button" class="close" onclick="toggleFilterPanel()">
            <span>&times;</span>
        </button>
    </div>
    
    
    <form class="filter-form">
        <div class="filter-layout">
            <!-- Main Filter Types (30%) -->
            <div class="filter-types">
                <div class="filter-type active" data-filter="type" onclick="switchFilter('type')">
                    <span>Type</span>
                </div>
                <div class="filter-type" data-filter="mode" onclick="switchFilter('mode')">
                    <span>Mode / Exam Type</span>
                </div>
                <div class="filter-type" data-filter="entity" onclick="switchFilter('entity')">
                    <span>Entity</span>
                </div>
                <div class="filter-type" data-filter="batch" onclick="switchFilter('batch')">
                    <span>Batch</span>
                </div>
                <div class="filter-type" data-filter="assessor" onclick="switchFilter('assessor')">
                    <span>Assessor</span>
                </div>
                <div class="filter-type" data-filter="date" onclick="switchFilter('date')">
                    <span>Date Range</span>
                </div>
                <div class="filter-type" data-filter="status" onclick="switchFilter('status')">
                    <span>Status</span>
                </div>
            </div>

            <!-- Filter Content (70%) -->
            <div class="filter-content-wrapper">
                <!-- Type Content -->
                <div class="filter-content active" id="type-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search type" id="filterTypeSearch" oninput="filterTypeOptions(this.value)">
                        <div class="selection-count" id="typeSelectionCount">0 Type selected</div>
                    </div>
                    <div class="options-list" id="filterTypeOptions">
                        <label class="option-item select-all-item">
                            <input type="checkbox" id="selectAllTypes" onchange="toggleSelectAll('type', this)">
                            <span><strong>Select All</strong></span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="type" value="B2B" onchange="updateTypeSelectionCount()"
                                   class="type-checkbox">
                            <span>B2B</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="type" value="B2C" onchange="updateTypeSelectionCount()"
                                   class="type-checkbox">
                            <span>B2C</span>
                        </label>
                    </div>
                </div>

                <!-- Mode Content -->
                <div class="filter-content" id="mode-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search mode" id="filterModeSearch" oninput="filterModeOptions(this.value)">
                        <div class="selection-count" id="modeSelectionCount">0 Mode selected</div>
                    </div>
                    <div class="options-list" id="filterModeOptions">
                        <label class="option-item select-all-item">
                            <input type="checkbox" id="selectAllModes" onchange="toggleSelectAll('mode', this)">
                            <span><strong>Select All</strong></span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="mode" value="Classroom" onchange="updateModeSelectionCount()"
                                   class="mode-checkbox">
                            <span>Classroom</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="mode" value="Mock" onchange="updateModeSelectionCount()"
                                   class="mode-checkbox">
                            <span>Mock</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="mode" value="Final" onchange="updateModeSelectionCount()"
                                   class="mode-checkbox">
                            <span>Final</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="mode" value="Skillathon" onchange="updateModeSelectionCount()"
                                   class="mode-checkbox">
                            <span>Skillathon</span>
                        </label>
                    </div>
                </div>

                <!-- Entity Content -->
                <div class="filter-content" id="entity-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search entity" id="filterEntitySearch" oninput="filterEntityOptions(this.value)">
                        <div class="selection-count" id="entitySelectionCount">0 Entity selected</div>
                    </div>
                    <div class="options-list" id="filterEntityOptions">
                        <label class="option-item select-all-item">
                            <input type="checkbox" id="selectAllEntities" onchange="toggleSelectAll('entity', this)">
                            <span><strong>Select All</strong></span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="entity" value="Skillathon" onchange="updateEntitySelectionCount()"
                                   class="entity-checkbox">
                            <span>Skillathon</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="entity" value="Institution" onchange="updateEntitySelectionCount()"
                                   class="entity-checkbox">
                            <span>Institution</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="entity" value="Hospital" onchange="updateEntitySelectionCount()"
                                   class="entity-checkbox">
                            <span>Hospital</span>
                        </label>
                    </div>
                </div>

                <!-- Batch Content -->
                <div class="filter-content" id="batch-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search batch" id="filterBatchSearch" oninput="filterBatchOptions(this.value)">
                        <div class="selection-count" id="batchSelectionCount">0 Batch selected</div>
                    </div>
                    <div class="options-list" id="filterBatchOptions">
                        <!-- Dynamic batches will be loaded here -->
                    </div>
                </div>

                <!-- Assessor Content -->
                <div class="filter-content" id="assessor-content">
                    <div class="filter-search">
                        <input type="text" placeholder="Search assessor" id="filterAssessorSearch" oninput="filterAssessorOptions(this.value)">
                        <div class="selection-count" id="assessorSelectionCount">0 Assessor selected</div>
                    </div>
                    <div class="options-list" id="filterAssessorOptions">
                        <!-- Dynamic assessors will be loaded here -->
                    </div>
                </div>

                <!-- Date Range Content -->
                <div class="filter-content" id="date-content">
                    <div class="date-range-inputs">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="filterDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="filterDateTo" class="form-control">
                        </div>
                    </div>
                </div>

                <!-- Status Content -->
                <div class="filter-content" id="status-content">
                    <div class="filter-search">
                        <div class="selection-count" id="statusSelectionCount">0 Status selected</div>
                    </div>
                    <div class="options-list" id="filterStatusOptions">
                        <label class="option-item">
                            <input type="checkbox" name="status" value="Active" onchange="updateStatusSelectionCount()">
                            <span>Active</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="status" value="Completed" onchange="updateStatusSelectionCount()">
                            <span>Completed</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" name="status" value="Scheduled" onchange="updateStatusSelectionCount()">
                            <span>Scheduled</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button type="button" class="btn btn-light" onclick="clearAllFilters()">Clear All</button>
            <button type="button" class="btn btn-light" onclick="toggleFilterPanel()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filter</button>
        </div>
    </form>
</div>

<!-- Filter Overlay -->
<div class="filter-overlay" id="filterOverlay" onclick="toggleFilterPanel()"></div>

<!-- Table -->
<div class="card">
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Assessment Name</th>
                    <th>Type</th>
                    <th>Mode</th>
                    <th>Batch</th>
                    <th>Procedures</th>
                    <th>Assessors</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="assessmentsTableBody">
                {% for test in page_obj %}
                <tr class="assessment-row" data-type="{{ test.type|default:'B2C' }}" data-mode="{{ test.mode|default:'Skillathon' }}">
                    <td>
                        <div class="assessment-name">
                            <span>{{ test.assessment_name }}</span>
                        </div>
                    </td>
                    <td>{{ test.type|default:"B2C" }}</td>
                    <td>{{ test.mode|default:"Skillathon" }}</td>
                    <td>{{ test.batch|default:"-" }}</td>
                    <td>
                        <div class="procedures-list" data-count="{{ test.procedure_assignments|length }}">
                            {% if test.procedure_assignments|length > 5 %}
                                <span class="badge badge-procedure collective-badge">Procedures Selected ({{ test.procedure_assignments|length }})</span>
                            {% else %}
                                {% for proc in test.procedure_assignments %}
                                    <span class="badge badge-procedure">{{ proc.procedure_name }}</span>
                                {% empty %}
                                    <span>-</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ test.assessors|default:"-" }}</td>
                    <td>
                        <span class="date-text">{{ test.testdate|date:"d M Y"|default:"-" }}</span>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn-icon" onclick="openEditTestPanel('{{ test.id }}', this)" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-icon-delete" onclick="confirmDeleteTest('{{ test.id }}','{{ test.type|default:"B2C" }}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="empty">
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>No assessments found</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                <!-- Empty state for filtered results -->
                <tr id="filteredEmptyState" style="display: none;">
                    <td colspan="9" class="empty">
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>No Assessment Available</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>        
    </div>
</div>

<!-- Pagination (reuse from learner_list.html) -->
{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="btn-page">
            <i class="fas fa-chevron-left"></i>
        </a>
    {% endif %}
    {% for num in page_obj.paginator.page_range %}
        <a href="?page={{ num }}" class="btn-page {% if page_obj.number == num %}active{% endif %}">
            {{ num }}
        </a>
    {% endfor %}
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn-page">
            <i class="fas fa-chevron-right"></i>
        </a>
    {% endif %}
</div>
{% endif %}

<!-- Assign Assessment Sliding Panel -->
<div class="assign-panel" id="assignPanel">
    <div class="assign-header">
        <h3>Assign Assessment</h3>
        {% if "assign_assignment" in request.user.get_all_permissions or request.user.has_all_permissions %}
        <button type="button" class="btn-close" onclick="toggleAssignPanel()">
            <i class="fas fa-times"></i>
        </button>
        {% endif %}
    </div>
    <form id="assignForm" onsubmit="return false;" style="overflow: scroll;">
        {% csrf_token %}
        <div class="assign-content">
            <div class="form-group">
                <label id="typeLabel" class="form-label">Type</label>
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="typeDropdownBtn" aria-labelledby="typeLabel">Select Type</button>
                    <ul class="dropdown-list" id="typeDropdownList">
                        <li data-value="B2C" data-id="B2C">B2C</li>
                        <li data-value="B2B" data-id="B2B">B2B</li>
                    </ul>
                </div>
            </div>

            <div id="internal-assessment-container" style="display: none;">
                <div class="form-group">
                    <label id="skillathonLabel" class="form-label">Skillathon</label>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="skillathonDropdownBtn" aria-labelledby="skillathonLabel">Select Skillathon</button>
                        <ul class="dropdown-list" id="skillathonDropdownList"></ul>
                    </div>
                    <div id="skillathonChipsContainer" class="chip-container"></div>
                </div>
            </div>

            <div id="external-assessment-container" style="display: none;">
                <div class="form-group">
                    <label id="instituteLabel" class="form-label">Institute/Hospital</label>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="institutionDropdownBtn" aria-labelledby="instituteLabel">Select Institution</button>
                        <div class="dropdown-search" id="institutionSearchContainer">
                            <input type="text" id="institutionSearch" placeholder="Search institution">
                        </div>
                        <ul class="dropdown-list" id="institutionDropdownList"></ul>
                    </div>
                    <div id="institutionChipsContainer" class="chip-container"></div>
                </div>
        
                <!-- Select Batch -->
                <div class="form-group">
                    <label id="batchLabel" class="form-label">Batch</label>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="batchDropdownBtn" aria-labelledby="batchLabel">Select Batch</button>
                        <ul class="dropdown-list" id="batchDropdownList"></ul>
                    </div>
                    <div id="batchChipsContainer" class="chip-container"></div>
                </div>

                <!-- Select Course -->
                <div class="form-group">
                    <label id="courseLabel" class="form-label">Course</label>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="courseDropdownBtn" aria-labelledby="courseLabel">Select Course</button>
                        <ul class="dropdown-list" id="courseDropdownList"></ul>
                    </div>
                    <div id="courseChipsContainer" class="chip-container"></div>
                </div>
            </div>

            <div class="form-group">
                <label id="procedureLabel" class="form-label">Procedure</label>
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="procedureDropdownBtn" aria-labelledby="procedureLabel">Select Procedure</button>
                    <ul class="dropdown-list" id="procedureDropdownList"></ul>
                </div>
                <div id="procedureChipsContainer" class="chip-container"></div>
                <!-- Inline Procedures & Assessors (B2B only) -->
                <div id="selectedProceduresContainer" style="display: none;">
                    <div id="selectedProceduresList"></div>
                </div>
            </div>

            <!-- Select Assessor (B2C only) -->
            <div id="assessorSelectionContainer">
                <div class="form-group">
                    <label id="assessorLabel" class="form-label">Assessor</label>
                    <div class="dropdown-container">
                        <button class="dropdown-btn" id="assessorDropdownBtn" aria-labelledby="assessorLabel">Select Assessor</button>
                        <ul class="dropdown-list" id="assessorDropdownList"></ul>
                    </div>
                    <div id="assessorChipsContainer" class="chip-container"></div>
                </div>
            </div>

            <!-- Select Exam Type (Mock/Final) -->
            <div class="form-group" id="examTypeContainer" style="display: none;">
                <label id="examTypeLabel" class="form-label">Exam Type</label>
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="examTypeDropdownBtn" aria-labelledby="examTypeLabel">Select Exam Type</button>
                    <ul class="dropdown-list" id="examTypeDropdownList">
                        <li data-value="Mock" data-id="Mock">Mock</li>
                        <li data-value="Final" data-id="Final">Final</li>
                    </ul>
                </div>
            </div>

            <!-- Select Date -->
            <div class="form-group">
                <label for="date" class="form-label">Date</label>
                <input type="date" id="date" class="form-control" style="border-radius: 5px; height: 45px;">
            </div>
        </div>
        <div class="assign-actions">
            <button type="button" class="btn btn-light" onclick="toggleAssignPanel()">Cancel</button>
            <button type="submit" class="btn btn-primary assign-btn">
                Assign
                <span class="spinner-border spinner-border-sm" style="display: none;" role="status" aria-hidden="true"></span>
            </button>
        </div>
    </form>
</div>
<div class="overlay" id="assignOverlay" onclick="toggleAssignPanel()"></div>

<!-- Edit Assessment Side Panel -->
<div class="assign-panel" id="editPanel">
    <div class="assign-header">
        <h3>Edit Assessment</h3>
        <button type="button" class="btn-close" onclick="toggleEditPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <form id="editForm" onsubmit="return false;" style="overflow: scroll;">
        {% csrf_token %}
        <div class="assign-content">
            <div class="form-group">
                <label class="form-label">Assessment Name</label>
                <input type="text" id="editAssessmentName" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Skillathon</label>
                <input type="text" id="editSkillathon" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Procedures</label>
                <div id="editProcedures" class="chip-container"></div>
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="editProcedureDropdownBtn">Select Procedure</button>
                    <ul class="dropdown-list" id="editProcedureDropdownList"></ul>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Assessors</label>
                <div id="editAssessors" class="chip-container"></div>
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="editAssessorDropdownBtn">Select Assessor</button>
                    <ul class="dropdown-list" id="editAssessorDropdownList"></ul>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="editStatus" class="form-control">
                    <option value="Not Completed">Not Completed</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="editDate" class="form-control" style="border-radius: 5px; height: 45px;">
            </div>
        </div>
        <div class="assign-actions">
            <button type="button" class="btn btn-light" onclick="toggleEditPanel()">Cancel</button>
            <button type="submit" class="btn btn-primary edit-save-btn">
                Save
                <span class="spinner-border spinner-border-sm" style="display: none;" role="status" aria-hidden="true"></span>
            </button>
        </div>
    </form>
</div>
<div class="overlay" id="editOverlay" onclick="toggleEditPanel()"></div>

<style>
    .btn {
        padding: 0.5rem 1rem !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        border-radius: 6px !important;
        transition: all 0.2s !important;
    }
    .btn-add {
        background-color: #f7a82d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .btn-add:hover {
        background-color: #e69500;
        color: white;
    }

    .btn-light {
        background-color: #EDF2F7;
        border-color: #EDF2F7;
        color: #4A5568;
    }

    .btn-light:hover {
        background-color: #E2E8F0;
        border-color: #E2E8F0;
        color: #2D3748;
    }

    .btn-icon {
        background: none;
        border: none;
        color: #6c757d;
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 4px;
    }

    .btn-icon:hover {
        background-color: #f8f9fa;
        color: #333;
    }

    .btn-icon.btn-danger {
        color: #dc3545;
    }

    .btn-icon.btn-danger:hover {
        background-color: #dc3545;
        color: white;
    }

    .empty {
        text-align: center;
        padding: 40px 0;
    }

    .empty i {
        font-size: 48px;
        color: #6c757d;
        margin-bottom: 16px;
    }

    .empty p {
        color: #6c757d;
        margin-bottom: 16px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
        color: #333;
    }

    .dropdown-container {
    position: relative;
    }

    .dropdown-btn {
        width: 100%;
        min-height: 38px;
        padding: 8px 12px;
        font-size: 14px;
        color: #333;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s;
        position: relative;
        z-index: 1;
    }

    .dropdown-btn:hover {
        border-color: #cbd5e0;
    }

    .dropdown-btn.active {
        border-color: #F16564;
    }

    /* Dropdown Search */
    .dropdown-search {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        padding: 8px;
        background: white;
        border: 1px solid #e2e8f0;
        border-top: none;
        border-radius: 0;
        display: none;
        z-index: 2001;
    }

    .dropdown-search.show {
        display: block;
    }

    .dropdown-search input {
        width: 100%;
        padding: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        outline: none;
        box-sizing: border-box;
    }

    .dropdown-search input:focus {
        border-color: #F16564;
        box-shadow: 0 0 0 2px rgba(241, 101, 100, 0.1);
    }

    /* Dropdown List */
    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-top: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 280px;
        overflow-y: auto;
        display: none;
        z-index: 99999;
        list-style: none;
        padding: 0;
    }
    
    .dropdown-list.show {
        display: block !important;
    }

    /* Custom Scrollbar */
    .dropdown-list::-webkit-scrollbar {
        width: 8px;
    }

    .dropdown-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .dropdown-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .dropdown-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .dropdown-list li {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        cursor: pointer;
        list-style: none;
    }

    .dropdown-list li:hover {
        background: #f7fafc;
    }

    .dropdown-list li label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
        width: 100%;
        cursor: pointer;
    }

    /* Ensure dropdown item text uses 16px font and 24px line-height,
       with span sized to 263.23px x 24px as requested */
    .dropdown-list li label span {
        display: inline-block;
        width: 263.23px;
        height: 24px;
        font-size: 16px;
        line-height: 24px;
    }

    .dropdown-list li input[type="checkbox"] {
        margin: 0;
        margin-right: 10px;
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #F16564;
    }

    /* Chip Container */
    .chip-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
    }

    .chip-container:empty {
        display: none;
    }

    /* Chip/Tag Styles */
    .chip {
        background: #F16564;
        color: #fff;
        border: none;
        border-radius: 14px;
        padding: 5px 10px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .chip:hover {
        background: #e45857;
    }
    
    /* Make procedure chips clickable for B2B */
    #procedureChipsContainer .chip:not(.collective) {
        cursor: pointer;
    }

    .chip .remove {
        cursor: pointer;
        color: #fff;
        font-weight: 700;
        opacity: 0.9;
    }

    .chip .remove:hover {
        opacity: 1;
    }

    /* Collective Chip - for "X Selected" style */
    .chip.collective {
        background-color: #F16564;
        color: #fff;
        font-weight: 500;
        padding: 6px 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ced4da;
        border-radius: 5px;
    }
    #editStatus.form-control { 
        width: 100%; 
        height: 45px;
        padding: 10px 12px;
        line-height: 1.5;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 35px;
    }


    .card {
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    /* Table Enhancements */
    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }

    .table th {
        padding: 12px 16px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: #4a5568;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s;
    }

    .table tbody tr:hover {
        background: #f8fafc;
    }

    .table td {
        padding: 14px 16px;
        font-size: 14px;
        color: #2d3748;
        vertical-align: middle;
    }
    
    /* Procedures List Container */
    .procedures-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }
    
    /* Assessment Name Bold */
    .assessment-name span {
        font-weight: 500;
        color: #1a202c;
    }
    
    /* Regular text columns */
    .table tbody td {
        color: #4a5568;
    }
    
    /* Date styling */
    .date-text {
        color: #4a5568;
        font-size: 13px;
    }
    
    /* Remove list styles from assessors */
    .assessors-list {
        color: #4a5568;
    }

    .institution {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Filter Button */
    .btn-filter {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        transition: all 0.2s;
        position: relative;
        white-space: nowrap;
    }

    .btn-filter:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }

    .btn-filter i {
        font-size: 14px;
        color: #6b7280;
    }

    .filter-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #F16564;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
    }

    /* Filter Panel */
    .filter-panel {
        position: fixed;
        right: -500px;
        top: 0;
        width: 500px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1050;
        display: flex;
        flex-direction: column;
    }

    .filter-panel.active {
        right: 0;
    }

    .filter-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1a202c;
    }

    .filter-header .close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #718096;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .filter-form {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .filter-layout {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* Filter Types (Left Side - 30%) */
    .filter-types {
        width: 40%;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
        background: #f8fafc;
    }

    .filter-type {
        padding: 14px 20px;
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: all 0.2s;
        font-size: 14px;
        color: #4a5568;
    }

    .filter-type:hover {
        background: #edf2f7;
    }

    .filter-type.active {
        background: white;
        border-left-color: #F16564;
        color: #F16564;
        font-weight: 500;
    }

    /* Filter Content (Right Side - 70%) */
    .filter-content-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .filter-content {
        display: none;
    }

    .filter-content.active {
        display: block;
    }

    .filter-search {
        margin-bottom: 16px;
    }

    .filter-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .selection-count {
        font-size: 12px;
        color: #718096;
        margin-top: 8px;
    }

    .options-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: #f8fafc;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .option-item:hover {
        background: #edf2f7;
    }

    .option-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #F16564;
    }

    .option-item span {
        font-size: 14px;
        color: #2d3748;
    }

    /* Date Range Inputs */
    .date-range-inputs {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .date-range-inputs .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .date-range-inputs label {
        font-size: 13px;
        font-weight: 500;
        color: #4a5568;
    }

    .date-range-inputs .form-control {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }

    /* Filter Actions */
    .filter-actions {
        padding: 16px 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    /* Filter Overlay */
    .filter-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1049;
        pointer-events: none;
    }

    .filter-overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    /* Scrollbar for filter types */
    .filter-types::-webkit-scrollbar,
    .filter-content-wrapper::-webkit-scrollbar {
        width: 6px;
    }

    .filter-types::-webkit-scrollbar-track,
    .filter-content-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .filter-types::-webkit-scrollbar-thumb,
    .filter-content-wrapper::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }

    /* Badge Styles */
    .badge-procedure {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 14px;
        font-size: 12px;
        font-weight: 500;
        background: #F16564;
        color: #fff;
        margin-right: 4px;
        margin-bottom: 4px;
    }

    .badge-procedure:hover {
        background: #e45857;
    }

    .collective-badge {
        background: #F16564;
        color: #fff;
        font-weight: 500;
        padding: 6px 14px;
        cursor: pointer;
    }

    .badge-type,
    .badge-assessor,
    .badge-info {
        display: none;
    }

    .badge.active {
        background: #c6f6d5;
        color: #2f855a;
    }

    .badge.inactive {
        background: #fed7d7;
        color: #c53030;
    }

    .status-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #fff;
        font-size: 14px;
        color: #2d3748;
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .status-select:focus {
        outline: none;
        border-color: #F16564;
        box-shadow: 0 0 0 3px rgba(241, 101, 100, 0.15);
    }

    /* Actions Column */
    .actions {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        color: #6b7280;
    }

    .btn-icon:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-icon i {
        font-size: 14px;
    }

    .btn-icon-delete {
        color: #ef4444;
    }

    .btn-icon-delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-state i {
        font-size: 48px;
        color: #cbd5e0;
        margin-bottom: 16px;
    }

    .empty-state p {
        color: #718096;
        font-size: 16px;
        margin: 0;
    }

    .btn-primary {
        background: #F16564;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        text-decoration: none;
        box-shadow: none;
    }

    .btn-primary:hover {
        background: #e45857;
        color: white;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-left h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1.2;
    }

    .header-left p {
        margin: 2px 0 0;
        color: #666;
        font-size: 1rem;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Search Bar Styling */
    .search-filter-bar {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .search-box {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 16px;
    }
    
    .search-box i {
        color: #718096;
        font-size: 14px;
    }
    
    .search-box input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 14px;
        background: transparent;
    }
    
    .search-box input::placeholder {
        color: #a0aec0;
    }
    
    /* Filter Button */
    .btn-filter {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        color: #4a5568;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
    }
    
    .btn-filter:hover {
        background: #f7fafc;
    }
    
    .btn-filter i {
        font-size: 14px;
    }
    
    .filter-badge {
        background: #F16564;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        position: absolute;
        top: -5px;
        right: -5px;
    }

    /* Active Filters Display */
    .active-filters-display {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px 16px;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        flex: 1;
    }

    .filter-count-text {
        font-size: 14px;
        font-weight: 600;
        color: #4a5568;
    }

    .active-filters-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .filter-tag {
        display: inline-block;
        padding: 4px 10px;
        background: white;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        font-size: 12px;
        color: #4a5568;
    }

    /* Applied Filters Section in Panel */
    .applied-filters-section {
        padding: 16px 24px;
        border-bottom: 1px solid #e2e8f0;
        background: #f7fafc;
    }

    .applied-filters-header {
        margin-bottom: 12px;
        font-size: 14px;
        color: #4a5568;
    }

    .applied-filters-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .applied-filter-item {
        padding: 8px 12px;
        background: white;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        font-size: 13px;
        color: #4a5568;
    }

    /* Badge against individual filter types (left sidebar) */
    .filter-type {
        position: relative;
        padding-right: 28px; /* room for badge on the right */
    }
    .select-all-item {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 12px;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .select-all-item span {
        font-weight: 600;
        color: #1a202c;
    }

    .filter-type .filter-type-badge {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        min-width: 18px;
        height: 18px;
        line-height: 18px;
        padding: 0 6px;
        border-radius: 9px;
        background: #F16564;
        color: #fff;
        font-size: 11px;
        font-weight: 700;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .assign-panel {
        position: fixed;
        right: -600px;
        top: 0;
        width: 600px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1050;
        overflow-y: auto;
    }

    .assign-panel.active {
        right: 0;
    }

    .assign-header {
        padding: 24px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
    }

    .assign-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #1a202c;
    }

    .btn-close {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        color: #64748b;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 20px;
    }

    .btn-close:hover {
        background: #e2e8f0;
        color: #1a202c;
    }

    .assign-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
    }

    .assign-actions {
        padding: 20px 24px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        background: white;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1040;
        pointer-events: none;
    }
    .overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    .selected-procedures-container {
        margin-top: 20px;
    }

    .procedure-item {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8fafc;
    }

    .procedure-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .procedure-name {
        font-weight: 600;
        color: #2d3748;
        font-size: 14px;
    }

    .remove-procedure {
        background: #e53e3e;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
    }

    .remove-procedure:hover {
        background: #c53030;
    }

    .assessor-selection {
        margin-top: 10px;
    }

    .assessor-chips {
        margin-top: 8px;
        min-height: 20px;
    }

    .assessor-dropdown {
        position: relative;
        margin-top: 8px;
    }

    .assessor-dropdown-btn {
        width: 100%;
        padding: 8px 12px;
        font-size: 12px;
        color: #4a5568;
        background-color: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        text-align: left;
        cursor: pointer;
    }

    .assessor-dropdown-btn:hover {
        background-color: #edf2f7;
    }

    .assessor-dropdown-list {
        position: absolute;
        width: 100%;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 150px;
        overflow-y: auto;
        margin-top: 2px;
        display: none;
        z-index: 2000;
    }

    .assessor-dropdown-list.show {
        display: block;
    }

    .assessor-dropdown-list li {
        padding: 8px 12px;
        cursor: pointer;
        list-style: none;
        font-size: 12px;
    }

    .assessor-dropdown-list li:hover {
        background-color: #f1f3f4;
    }

    /* Table Container with Scrollbar */
    .card {
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .table-wrapper {
        overflow: visible;
        width: 100%;
    }

    /* Table Styles */
    .table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px; /* Ensures horizontal scroll on smaller screens */
    }
</style>

<script>
    function applyFilter() {
        const query = document.getElementById('searchInput').value;
        window.location.href = `?query=${query}`;
    }



    $(document).ready(function () {
        // Load procedures/assessors for edit dropdowns
        $('#editProcedureDropdownBtn').off('click').on('click', function(e){
            e.preventDefault(); 
            e.stopPropagation();
            $.get('/fetch-procedures/', function(res){
                populateDropdown('editProcedureDropdownList', res.procedures, 'name');
                $('#editProcedureDropdownList').show();
            });
        });
        
        $('#editAssessorDropdownBtn').off('click').on('click', function(e){
            e.preventDefault(); 
            e.stopPropagation();
            $.get('/fetch-assessors/', function(res){
                populateDropdown('editAssessorDropdownList', res.assessors, 'name');
                $('#editAssessorDropdownList').show();
            });
        });
    
        // Add to chips in edit panel
        $('#editProcedureDropdownList, #editAssessorDropdownList').off('click').on('click', 'li', function (e) {
            e.preventDefault();
            const value = $(this).data('value');
            const id = $(this).data('id');
            const parentId = $(this).parent().attr('id');
            const containerId = parentId === 'editProcedureDropdownList' ? 'editProcedures' : 'editAssessors';
            if ($(`#${containerId} .chip[data-id="${id}"]`).length === 0) {
                $(`#${containerId}`).append(`<span class=\"chip\" data-id=\"${id}\">${value}<span class=\"remove\">&times;</span></span>`);
            }
            $(this).closest('.dropdown-list').hide();
        });
        
        // Remove chips in edit panel
        $('#editProcedures, #editAssessors').on('click', '.chip .remove', function(){ 
            $(this).parent().remove(); 
        });
    
        // UNIVERSAL DROPDOWN HANDLER - FIXED VERSION
        // Use namespace to prevent duplicate handlers
        // Use event delegation with target to work reliably in all environments
        $(document).off('click.dropdownHandler', '.dropdown-btn').on('click.dropdownHandler', '.dropdown-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Use event target as primary source (more reliable across environments)
            // This works regardless of 'this' context issues in production
            const $target = $(e.target);
            let $btn = $target.closest('.dropdown-btn');
            
            // Fallback: if target is already the button, use it directly
            if (!$btn.length && $target.hasClass('dropdown-btn')) {
                $btn = $target;
            }
            
            // Final fallback: use 'this' if event target doesn't work
            if (!$btn.length) {
                $btn = $(this);
                if (!$btn.hasClass('dropdown-btn')) {
                    $btn = $btn.closest('.dropdown-btn');
                }
            }
            
            // Validate we have a button
            if (!$btn.length || !$btn.hasClass('dropdown-btn')) {
                console.warn('Could not find dropdown button element. Target:', e.target, 'This:', this);
                return;
            }
            
            // Get the native DOM element for ID access
            const btnElement = $btn[0];
            
            // Get ID - prioritize native property (most reliable)
            const btnId = (btnElement && btnElement.id) || $btn.attr('id') || $btn.prop('id') || 'unknown';
            
            const $container = $btn.closest('.dropdown-container');
            const $list = $container.find('.dropdown-list');
            const $search = $container.find('.dropdown-search');
            
            console.log('Dropdown clicked:', btnId, 'Target:', e.target, 'Button element:', btnElement);
            console.log('List found:', $list.length, 'Search found:', $search.length);
            
            // Validate we have the necessary elements
            if (!$container.length) {
                console.warn('Dropdown container not found for button:', btnId);
                return;
            }
            
            // Close all other dropdowns
            $('.dropdown-list').not($list).hide().removeClass('show');
            $('.dropdown-search').not($search).hide().removeClass('show');
            $('.dropdown-btn').not($btn).removeClass('active');
            
            // Toggle current dropdown
            const isVisible = $list.is(':visible');
            
            if (isVisible) {
                $list.hide().removeClass('show');
                $search.hide().removeClass('show');
                $btn.removeClass('active');
            } else {
                $list.show().addClass('show');
                $search.show().addClass('show');
                $btn.addClass('active');
            }
        });
    
        // Close when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.dropdown-container').length) {
                $('.dropdown-list').hide().removeClass('show');
                $('.dropdown-search').hide().removeClass('show');
                $('.dropdown-btn').removeClass('active');
            }
        });
    
        // Prevent dropdown from closing when clicking inside
        $(document).on('click', '.dropdown-list', function(e) {
            e.stopPropagation();
        });
    
        // Specific handler for assessor dropdown - fetch if empty
        // This handler runs first and ensures data is loaded before showing dropdown
        // Use namespace to prevent duplicate handlers
        $(document).off('click.assessorHandler', '#assessorDropdownBtn').on('click.assessorHandler', '#assessorDropdownBtn', function(e) {
            // Ensure we get the button element
            const $btn = $(this).closest('.dropdown-btn').length ? $(this).closest('.dropdown-btn') : $(this);
            const btnId = this.id || $btn.attr('id') || 'assessorDropdownBtn';
            
            // Only handle if this is actually the assessor button
            if (btnId !== 'assessorDropdownBtn') {
                return; // Let other handlers proceed
            }
            
            const $list = $('#assessorDropdownList');
            
            // Check if list is empty or has no valid items
            const listItems = $list.find('li');
            const hasItems = listItems.length > 0 && 
                           !listItems.first().text().includes('No options available') &&
                           !listItems.first().text().includes('No assessors available') &&
                           !listItems.first().text().includes('Error loading') &&
                           !listItems.first().text().includes('Loading assessors');
            
            if (!hasItems) {
                // Stop event propagation to prevent universal handler from toggling empty dropdown
                e.stopImmediatePropagation();
                
                // Show loading state immediately
                $list.html('<li style="color:#888; cursor:default; padding: 8px 12px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Loading assessors...</li>');
                $list.show().addClass('show');
                $btn.addClass('active');
                
                // Fetch assessors
                $.ajax({
                    url: '/fetch-assessors/',
                    type: 'GET',
                    success: function (response) {
                        console.log('Assessors API response:', response);
                        if (response && response.assessors && Array.isArray(response.assessors) && response.assessors.length > 0) {
                            populateDropdown('assessorDropdownList', response.assessors, 'name');
                            // Ensure dropdown stays visible after populating
                            $list.show().addClass('show');
                            $btn.addClass('active');
                        } else {
                            console.warn('No assessors in response:', response);
                            $list.html('<li style="color:#888; cursor:default; padding: 8px 12px;">No assessors available</li>');
                            $list.show().addClass('show');
                            $btn.addClass('active');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to fetch assessors:', error, 'Status:', status, 'Response:', xhr.responseText);
                        $list.html('<li style="color:#f44336; cursor:default; padding: 8px 12px;">Error loading assessors. Please try again.</li>');
                        $list.show().addClass('show');
                        $btn.addClass('active');
                    }
                });
                
                return false; // Prevent further event handling
            }
            // If items exist, let the universal handler proceed normally
        });
    
        // Type selection - FIXED
        $(document).on('click', '#typeDropdownList li', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const type = $(this).data('value');
            $('#typeDropdownBtn').text(type);
            $('#typeDropdownList').hide().removeClass('show');
            $('#typeDropdownBtn').removeClass('active');
            
            // Clear selections
            $('#batchChipsContainer').empty();
            $('#procedureChipsContainer').empty();
            $('#assessorChipsContainer').empty();
            $('#selectedProceduresList').empty();
            $('#courseDropdownBtn').text('Select Course');
            $('#courseDropdownList').empty();
            $('#procedureDropdownList').empty();
            $('#assessorDropdownList').empty();
    
            if (type === 'B2C') {
                $('#internal-assessment-container').show();
                $('#external-assessment-container').hide();
                $('#selectedProceduresContainer').hide();
                $('#assessorSelectionContainer').show();
                $('#examTypeContainer').hide();
            
                // Fetch skillathons - THIS IS THE MISSING CODE
                $.ajax({
                    url: '/fetch-skillathons/',  // Adjust this URL to match your backend endpoint
                    type: 'GET',
                    success: function (response) {
                        console.log('Fetched skillathons:', response);
                        populateDropdown('skillathonDropdownList', response.skillathons, 'name');
                    },
                    error: function () {
                        console.error('Failed to fetch skillathons');
                    }
                });
            
                // Fetch procedures
                $.ajax({
                    url: '/fetch-procedures/',
                    type: 'GET',
                    success: function (response) {
                        populateProcedureDropdownWithCheckboxes(response.procedures);
                    },
                    error: function () {
                        console.error('Failed to fetch procedures');
                    }
                });
            
                // Fetch assessors
                $.ajax({
                    url: '/fetch-assessors/',
                    type: 'GET',
                    success: function (response) {
                        populateDropdown('assessorDropdownList', response.assessors, 'name');
                    },
                    error: function () {
                        console.error('Failed to fetch assessors');
                    }
                });
    
            } else if (type === 'B2B') {
                $('#internal-assessment-container').hide();
                $('#external-assessment-container').show();
                $('#selectedProceduresContainer').hide();
                $('#assessorSelectionContainer').hide();
                $('#examTypeContainer').show();
                fetchB2BInstitutesAndHospitals();
            }
        });

        // Fetch institutes and hospitals with B2B onboarding type
        function fetchB2BInstitutesAndHospitals() {
            $.ajax({
                url: '/fetch-institutes/',
                type: 'GET',
                data: { onboarding_type: 'b2b' },
                success: function (response) {
                    const institutes = response.institutes.map(inst => ({
                        id: inst.id,
                        name: inst.instituteName,
                        type: inst.type || 'institution'
                    }));
                    populateDropdown('institutionDropdownList', institutes, 'name');
                },
                error: function () {
                    console.error('Failed to fetch B2B institutions and hospitals.');
                }
            });
        }


        // Skillathon selection 
        $(document).on('click', '#skillathonDropdownList li', function(e) {
            e.preventDefault();
            const value = $(this).data('value');
            const id = $(this).data('id');
            
            // Store both text and ID
            $('#skillathonDropdownBtn').text(value).attr('data-skillathon-id', id);
            $('#skillathonDropdownList').hide();
            
            console.log('Skillathon selected:', value, 'ID:', id); // For debugging
        });
    
    
        // Institution selection
        $(document).on('click', '#institutionDropdownList li', function(e) {
            e.preventDefault();
            const institutionName = $(this).data('value');
            const institutionId = $(this).data('id');
            const institutionType = $(this).data('type');
            
            // Store both text and ID on the button
            $('#institutionDropdownBtn').text(institutionName).attr('data-institution-id', institutionId);
            $('#institutionDropdownList').hide();
            $('#institutionSearchContainer').hide();

            console.log('Institution selected:', institutionName, 'ID:', institutionId);
            
            // Clear previous selections
            $('#batchDropdownList').empty();
            $('#batchChipsContainer').empty();
            $('#courseDropdownList').empty();
            $('#courseDropdownBtn').text('Select Course');
            $('#procedureDropdownList').empty();
            $('#procedureChipsContainer').empty();

            // Fetch batches
            $.ajax({
                url: '/api/batches/',
                type: 'GET',
                data: { 
                    unitType: institutionType,
                    unitName: institutionName
                },
                success: function (response) {
                    console.log('Batches response:', response);
                    
                    if (response.success && response.batches) {
                        const batches = response.batches.map(batch => ({
                            id: batch.id,
                            name: batch.batchName
                        }));
                        populateBatchDropdownWithCheckboxes(batches);
                    } else {
                        $('#batchDropdownList').append('<li style="color:#888; cursor:default; padding: 8px 12px;">No batches available</li>');
                    }
                },
                error: function (xhr) {
                    console.error('Failed to fetch batches:', xhr);
                    console.error('Error details:', xhr.responseText);
                    $('#batchDropdownList').append('<li style="color:#888; cursor:default; padding: 8px 12px;">Error loading batches</li>');
                }
            });
        });
    
        // Institution search
        $('#institutionSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('#institutionDropdownList li').each(function() {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(searchTerm));
            });
        });
    
        // Batch selection - Handle both checkbox changes and li clicks
        $(document).on('click', '#batchDropdownList li', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const li = $(this);
            const checkbox = li.find('input[type="checkbox"]');
            const value = li.data('value');
            const id = li.data('id');
            
            // Toggle checkbox
            checkbox.prop('checked', !checkbox.prop('checked'));
            
            if (checkbox.is(':checked')) {
                if ($(`#batchChipsContainer .chip[data-id="${id}"]`).length === 0) {
                    $('#batchChipsContainer').append(`<span class="chip" data-id="${id}" data-value="${value}">${value}<span class="remove">&times;</span></span>`);
                }
            } else {
                $(`#batchChipsContainer .chip[data-id="${id}"]`).remove();
            }
            
            // Update courses based on all selected batches
            updateCoursesForSelectedBatches();
        });
        
        // Prevent li click toggle when clicking directly on batch checkbox
        $(document).on('click', '#batchDropdownList input[type="checkbox"]', function(e) {
            e.stopPropagation();
        });

        // Also handle direct checkbox clicks (without re-triggering li click)
        $(document).on('change', '#batchDropdownList input[type="checkbox"]', function(e) {
            e.stopPropagation();
            const checkbox = $(this);
            const li = checkbox.closest('li');
            const value = li.data('value');
            const id = li.data('id');

            if (checkbox.is(':checked')) {
                if ($(`#batchChipsContainer .chip[data-id="${id}"]`).length === 0) {
                    $('#batchChipsContainer').append(`<span class="chip" data-id="${id}" data-value="${value}">${value}<span class="remove">&times;</span></span>`);
                }
            } else {
                $(`#batchChipsContainer .chip[data-id="${id}"]`).remove();
            }

            // Update dependent courses based on selected batches
            updateCoursesForSelectedBatches();
        });
    
        // Course selection - Handle li clicks
        $(document).on('click', '#courseDropdownList li', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const courseName = $(this).data('value');
            const courseId = $(this).data('id');
            
            console.log('=== COURSE SELECTION DEBUG ===');
            console.log('Course Name:', courseName);
            console.log('Course ID:', courseId);
            console.log('Course ID type:', typeof courseId);
            console.log('LI element:', $(this));
            console.log('LI data:', $(this).data());
            
            // Store both text and ID on the button
            $('#courseDropdownBtn').text(courseName).attr('data-course-id', courseId);
            $('#courseDropdownList').hide().removeClass('show');
            $('#courseDropdownBtn').removeClass('active');
            
            console.log('Stored course ID:', $('#courseDropdownBtn').attr('data-course-id'));
            
            // Construct the URL
            const proceduresUrl = `/api/courses/${courseId}/procedures/`;
            console.log('Procedures URL:', proceduresUrl);
            
            // Fetch procedures for course
            $.ajax({
                url: `/api/courses/${courseId}/procedures/`,
                type: 'GET',
                success: function (response) {
                    console.log('Procedures response:', response);
                    
                    if (response.success && response.procedures && response.procedures.length > 0) {
                        const procedures = response.procedures.map(proc => ({
                            id: proc.id,
                            name: proc.name
                        }));
                        populateProcedureDropdownWithCheckboxes(procedures);
                    } else {
                        // Handle empty procedures
                        $('#procedureDropdownList').empty().append(
                            '<li style="color:#888; cursor:default; padding: 8px 12px;">No procedures available for this course</li>'
                        );
                    }
                },
                error: function (xhr, status, error) {
                    console.error('=== PROCEDURE FETCH ERROR ===');
                    console.error('Status:', status);
                    console.error('Error:', error);
                    console.error('Status Code:', xhr.status);
                    console.error('Response:', xhr.responseText);
                    
                    // Show user-friendly error message
                    $('#procedureDropdownList').empty().append(
                        '<li style="color:#888; cursor:default; padding: 8px 12px;">Error fetching procedures. Please try again.</li>'
                    );
                }
            });
        
            // Fetch assessors
            $.ajax({
                url: '/fetch-assessors/',
                type: 'GET',
                success: function (response) {
                    populateAssessorsForB2B(response.assessors);
                },
                error: function () {
                    console.error('Failed to fetch assessors');
                }
            });
        });
    
        // Procedure selection with checkboxes - Handle both checkbox and li clicks
        $(document).on('click', '#procedureDropdownList li', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const li = $(this);
            const checkbox = li.find('.procedure-checkbox');
            const value = li.data('value');
            const id = li.data('id');
            
            // Toggle checkbox
            checkbox.prop('checked', !checkbox.prop('checked'));
            
            if (checkbox.is(':checked')) {
                if ($(`#procedureChipsContainer .chip[data-id="${id}"]`).length === 0) {
                    $('#procedureChipsContainer').append(`<span class="chip" data-id="${id}" data-value="${value}">${value}<span class="remove">&times;</span></span>`);
                    
                    updateChipDisplay('procedureChipsContainer', 'Procedures');
                    
                    const testType = $('#typeDropdownBtn').text().trim();
                    if (testType === 'B2B') {
                        addProcedureWithAssessorSelection(id, value);
                    }
                }
            } else {
                $(`#procedureChipsContainer .chip[data-id="${id}"]`).remove();
                updateChipDisplay('procedureChipsContainer', 'Procedures');
                
                const testType = $('#typeDropdownBtn').text().trim();
                if (testType === 'B2B') {
                    // Close the assessor dropdown for this procedure before removing
                    const assessorRow = $(`.assessor-selection-row[data-procedure-id="${id}"]`);
                    if (assessorRow.length > 0) {
                        const dropdownList = assessorRow.find('.assessor-dropdown-list');
                        const dropdownBtn = assessorRow.find('.assessor-dropdown-btn');
                        dropdownList.hide().removeClass('show');
                        dropdownBtn.removeClass('active');
                    }
                    removeProcedure(id);
                }
            }
        });
        
        // Prevent li click toggle when clicking directly on procedure checkbox
        $(document).on('click', '#procedureDropdownList .procedure-checkbox', function(e) {
            e.stopPropagation();
        });

        // Also handle direct checkbox clicks (without re-triggering li click)
        $(document).on('change', '#procedureDropdownList .procedure-checkbox', function(e) {
            e.stopPropagation();
            const checkbox = $(this);
            const li = checkbox.closest('li');
            const value = li.data('value');
            const id = li.data('id');

            if (checkbox.is(':checked')) {
                if ($(`#procedureChipsContainer .chip[data-id="${id}"]`).length === 0) {
                    $('#procedureChipsContainer').append(`<span class="chip" data-id="${id}" data-value="${value}">${value}<span class="remove">&times;</span></span>`);
                    updateChipDisplay('procedureChipsContainer', 'Procedures');
                    const testType = $('#typeDropdownBtn').text().trim();
                    if (testType === 'B2B') {
                        addProcedureWithAssessorSelection(id, value);
                    }
                }
            } else {
                $(`#procedureChipsContainer .chip[data-id="${id}"]`).remove();
                updateChipDisplay('procedureChipsContainer', 'Procedures');
                const testType = $('#typeDropdownBtn').text().trim();
                if (testType === 'B2B') {
                    // Close the assessor dropdown for this procedure before removing
                    const assessorRow = $(`.assessor-selection-row[data-procedure-id="${id}"]`);
                    if (assessorRow.length > 0) {
                        const dropdownList = assessorRow.find('.assessor-dropdown-list');
                        const dropdownBtn = assessorRow.find('.assessor-dropdown-btn');
                        dropdownList.hide().removeClass('show');
                        dropdownBtn.removeClass('active');
                    }
                    removeProcedure(id);
                }
            }
        });

        // Safety: if any future course list contains checkboxes, prevent li handler from double-toggling
        $(document).on('click', '#courseDropdownList input[type="checkbox"]', function(e) {
            e.stopPropagation();
        });
    
        // Assessor selection (B2C)
        $(document).on('click', '#assessorDropdownList li', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const value = $(this).data('value');
            const id = $(this).data('id');
    
            // Toggle checkbox if present
            const checkbox = $(this).find('input[type="checkbox"]');
            if (checkbox.length) {
                checkbox.prop('checked', !checkbox.prop('checked'));
            }

            if ($(`#assessorChipsContainer .chip[data-id="${id}"]`).length === 0) {
                $(`#assessorChipsContainer`).append(`<span class="chip" data-id="${id}" data-value="${value}">${value}<span class="remove">&times;</span></span>`);
                updateChipDisplay('assessorChipsContainer', 'Assessors');
            }
            $(this).closest('.dropdown-list').hide().removeClass('show');
            $('#assessorDropdownBtn').removeClass('active');
        });

        // Prevent double toggle when clicking the checkbox directly in B2C assessor dropdown
        $(document).on('click', '#assessorDropdownList input[type="checkbox"]', function(e) {
            e.stopPropagation();
            // Trigger parent li click to reuse chip logic
            $(this).closest('li').trigger('click');
        });
    
        // Assessor dropdown for B2B procedures
        $(document).on('click', '.assessor-dropdown-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const procedureId = $(this).data('procedure-id');
            const dropdownList = $(this).next('.assessor-dropdown-list');
            
            // Toggle only this dropdown (independent of others - multiple can be open)
            if (dropdownList.is(':visible')) {
                dropdownList.hide().removeClass('show');
                $(this).removeClass('active');
            } else {
                dropdownList.show().addClass('show');
                $(this).addClass('active');
            }
        });
    
        // Assessor selection for specific procedures (B2B)
        $(document).on('change', '.assessor-dropdown-list input[type="checkbox"]', function(e) {
            e.stopPropagation();
            const checkbox = $(this);
            const li = checkbox.closest('li');
            const assessorId = li.data('id');
            const assessorName = li.data('value');
            const procedureId = li.closest('[data-procedure-id]').data('procedure-id');
            
            if (checkbox.is(':checked')) {
                if ($(`.assessor-selection-row[data-procedure-id="${procedureId}"] .assessor-chips .chip[data-id="${assessorId}"]`).length === 0) {
                    $(`.assessor-selection-row[data-procedure-id="${procedureId}"] .assessor-chips`).append(
                        `<span class="chip" data-id="${assessorId}" data-value="${assessorName}">${assessorName}<span class="remove">&times;</span></span>`
                    );
                }
            } else {
                $(`.assessor-selection-row[data-procedure-id="${procedureId}"] .assessor-chips .chip[data-id="${assessorId}"]`).remove();
            }

            // Update collective chip display for this procedure's assessor chips
            updateChipDisplay(`assessorChips-${procedureId}`, 'Assessors');
        });

        // Make entire assessor row clickable to toggle its checkbox (B2B per-procedure assessor lists)
        $(document).on('click', '.assessor-dropdown-list li', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const checkbox = $(this).find('input[type="checkbox"]');
            if (checkbox.length) {
                checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
            }
        });

        // Prevent double toggle when clicking directly on assessor checkbox
        $(document).on('click', '.assessor-dropdown-list input[type="checkbox"]', function(e) {
            e.stopPropagation();
        });
    
        // Remove assessor chips (B2B) and uncheck corresponding checkbox
        $(document).on('click', '.assessor-chips .chip .remove', function(e) {
            e.preventDefault();
            const chip = $(this).parent();
            const container = chip.closest('.assessor-chips');
            const procedureId = container.closest('[data-procedure-id]').data('procedure-id');
            const assessorId = chip.data('id');
            // Uncheck checkbox in list
            $(`#assessorList-${procedureId} li[data-id="${assessorId}"] input[type="checkbox"]`).prop('checked', false);
            // Remove chip
            chip.remove();
            // Update collective display
            updateChipDisplay(`assessorChips-${procedureId}`, 'Assessors');
        });
    
        // Remove procedure button (B2B)
        $(document).on('click', '.remove-procedure', function(e) {
            e.preventDefault();
            const procedureId = $(this).data('procedure-id');
            removeProcedure(procedureId);
        });
    
        // Click on procedure chip to toggle its assessor dropdown (B2B only)
        $(document).on('click', '#procedureChipsContainer .chip:not(.collective)', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Don't trigger if clicking the remove button
            if ($(e.target).hasClass('remove') || $(e.target).closest('.remove').length) {
                return;
            }
            
            const chip = $(this);
            const procedureId = chip.data('id');
            const testType = $('#typeDropdownBtn').text().trim();
            
            // Only for B2B type
            if (testType === 'B2B') {
                const assessorRow = $(`.assessor-selection-row[data-procedure-id="${procedureId}"]`);
                
                if (assessorRow.length > 0) {
                    const dropdownList = assessorRow.find('.assessor-dropdown-list');
                    const dropdownBtn = assessorRow.find('.assessor-dropdown-btn');
                    
                    // Toggle only this procedure's dropdown (independent of others)
                    if (dropdownList.is(':visible')) {
                        dropdownList.hide().removeClass('show');
                        dropdownBtn.removeClass('active');
                    } else {
                        dropdownList.show().addClass('show');
                        dropdownBtn.addClass('active');
                    }
                }
            }
        });
        
        // Remove chips when clicking X
        $('.chip-container').on('click', '.chip:not(.collective) .remove', function(e) {
            e.stopPropagation(); // Prevent triggering chip click
            const chip = $(this).parent();
            const containerId = chip.closest('.chip-container').attr('id');
            const chipId = chip.data('id');
            
            // Uncheck corresponding checkbox
            if (containerId === 'procedureChipsContainer') {
                $(`#procedureDropdownList li[data-id="${chipId}"] .procedure-checkbox`).prop('checked', false);
                updateChipDisplay('procedureChipsContainer', 'Procedures');
                
                const testType = $('#typeDropdownBtn').text().trim();
                if (testType === 'B2B') {
                    // Close the assessor dropdown for this procedure before removing
                    const assessorRow = $(`.assessor-selection-row[data-procedure-id="${chipId}"]`);
                    if (assessorRow.length > 0) {
                        const dropdownList = assessorRow.find('.assessor-dropdown-list');
                        const dropdownBtn = assessorRow.find('.assessor-dropdown-btn');
                        dropdownList.hide().removeClass('show');
                        dropdownBtn.removeClass('active');
                    }
                    removeProcedure(chipId);
                }
            } else if (containerId === 'assessorChipsContainer') {
                $(`#assessorDropdownList li[data-id="${chipId}"] input[type="checkbox"]`).prop('checked', false);
                updateChipDisplay('assessorChipsContainer', 'Assessors');
            } else if (containerId === 'batchChipsContainer') {
                $(`#batchDropdownList li[data-id="${chipId}"] input[type="checkbox"]`).prop('checked', false);
                updateChipDisplay('batchChipsContainer', 'Batches');
                // Update courses when batch is removed
                updateCoursesForSelectedBatches();
            }
            
            chip.remove();
        });
    
        // Exam type selection
        $(document).on('click', '#examTypeDropdownList li', function(e) {
            e.preventDefault();
            const examType = $(this).data('value');
            $('#examTypeDropdownBtn').text(examType);
            $('#examTypeDropdownList').hide();
        });
    });

    function populateProcedureDropdownWithCheckboxes(items) {
        const dropdown = $('#procedureDropdownList');
        dropdown.empty();
        if (!items || !items.length) {
            dropdown.append('<li style="color:#888; cursor:default; padding: 8px 12px;">No options</li>');
            return;
        }
        items.forEach(item => {
            dropdown.append(`
                <li data-value="${item.name}" data-id="${item.id}">
                    <label style="display: flex; align-items: center; width: 100%; margin: 0; cursor: pointer;">
                        <input type="checkbox" value="${item.id}" class="procedure-checkbox" style="margin-right: 8px;">
                        <span>${item.name}</span>
                    </label>
                </li>
            `);
        });
    }

    // Helper function for batch dropdown with checkboxes
    function populateBatchDropdownWithCheckboxes(items) {
        const dropdown = $('#batchDropdownList');
        dropdown.empty();
        if (!items || !items.length) {
            dropdown.append('<li style="color:#888; cursor:default; padding: 8px 12px;">No batches available</li>');
            return;
        }
        items.forEach(item => {
            dropdown.append(`
                <li data-value="${item.name}" data-id="${item.id}">
                    <label style="display: flex; align-items: center; width: 100%; margin: 0; cursor: pointer;">
                        <input type="checkbox" value="${item.id}" style="margin-right: 8px;">
                        <span>${item.name}</span>
                    </label>
                </li>
            `);
        });
    }

    // Helper function to populate regular dropdowns
    function populateDropdown(listId, items, nameKey) {
        const dropdown = $(`#${listId}`);
        dropdown.empty();
        
        if (!items || !items.length) {
            dropdown.append('<li style="color:#888; cursor:default; padding: 8px 12px;">No options available</li>');
            return;
        }
        
        // If this is the B2C assessor list, render with checkbox + label to match B2B styling
        if (listId === 'assessorDropdownList') {
            items.forEach(item => {
                const displayName = item[nameKey] || item.name || item;
                const itemId = item.id || item;
                dropdown.append(`
                    <li data-value="${displayName}" data-id="${itemId}">
                        <label style="display: flex; align-items: center; width: 100%; margin: 0; cursor: pointer;">
                            <input type="checkbox" value="${itemId}" style="margin-right: 8px;">
                            <span>${displayName}</span>
                        </label>
                    </li>
                `);
            });
        } else {
            items.forEach(item => {
                const displayName = item[nameKey] || item.name || item;
                const itemId = item.id || item;
                dropdown.append(`
                    <li data-value="${displayName}" data-id="${itemId}">
                        <span>${displayName}</span>
                    </li>
                `);
            });
        }
    }

    // Function to update courses based on all selected batches
    function updateCoursesForSelectedBatches() {
        // Get all selected batch IDs from chips
        const selectedBatchIds = $('#batchChipsContainer .chip').map(function() {
            return $(this).data('id');
        }).get();
        
        // Clear course dropdown and reset button
        $('#courseDropdownList').empty();
        $('#courseDropdownBtn').text('Select Course').removeAttr('data-course-id');
        
        // If no batches selected, show empty message
        if (selectedBatchIds.length === 0) {
            $('#courseDropdownList').append('<li style="color:#888; cursor:default; padding: 8px 12px;">Please select at least one batch</li>');
            return;
        }
        
        // Fetch courses for all selected batches
        const coursePromises = selectedBatchIds.map(batchId => {
            return $.ajax({
                url: `/api/batches/${batchId}/courses/`,
                type: 'GET',
                dataType: 'json'
            });
        });
        
        // Wait for all requests to complete using $.when
        if (coursePromises.length === 0) {
            $('#courseDropdownList').append('<li style="color:#888; cursor:default; padding: 8px 12px;">Please select at least one batch</li>');
            return;
        }
        
        $.when.apply($, coursePromises).done(function() {
            console.log('All course responses received');
            console.log('Arguments:', arguments);
            
            // $.when returns arguments in format: data1, data2, data3, ... or [data, status, xhr] for single
            // Convert arguments to array
            const responses = coursePromises.length === 1 ? [arguments[0]] : Array.from(arguments);
            
            // Extract course arrays from responses
            const allCourseArrays = responses.map(function(response) {
                // response is the data object: {success: true, courses: [...]}
                console.log('Processing response:', response);
                
                if (response && response.success && Array.isArray(response.courses)) {
                    return response.courses.map(course => ({
                        id: course.id,
                        name: course.name || course.courseName
                    }));
                }
                console.warn('Unexpected response format:', response);
                return [];
            });
            
            console.log('All course arrays:', allCourseArrays);
            
            // Find intersection: courses that exist in ALL batches
            let commonCourses = [];
            if (allCourseArrays.length > 0) {
                // Filter out empty arrays
                const nonEmptyArrays = allCourseArrays.filter(arr => arr.length > 0);
                
                if (nonEmptyArrays.length > 0) {
                    // Start with courses from first non-empty batch
                    commonCourses = nonEmptyArrays[0];
                    
                    // Filter to keep only courses that exist in all other batches
                    for (let i = 1; i < nonEmptyArrays.length; i++) {
                        const currentBatchCourses = nonEmptyArrays[i];
                        commonCourses = commonCourses.filter(course1 => 
                            currentBatchCourses.some(course2 => course1.id === course2.id)
                        );
                    }
                }
            }
            
            console.log('Common courses:', commonCourses);
            
            // Populate dropdown with common courses
            if (commonCourses.length > 0) {
                populateDropdown('courseDropdownList', commonCourses, 'name');
            } else {
                $('#courseDropdownList').append('<li style="color:#888; cursor:default; padding: 8px 12px;">No common courses found for selected batches</li>');
            }
        }).fail(function() {
            console.error('Failed to fetch courses for batches');
            $('#courseDropdownList').append('<li style="color:#888; cursor:default; padding: 8px 12px;">Error loading courses</li>');
        });
    }

    // Update chip display to show collective badge if more than 5 chips
    function updateChipDisplay(containerId, label) {
        const container = $(`#${containerId}`);
        const chips = container.find('.chip:not(.collective)');
        const collectiveBadge = container.find('.chip.collective');
        
        if (chips.length > 5) {
            chips.hide();
            if (collectiveBadge.length === 0) {
                container.append(`<span class="chip collective" data-count="${chips.length}">${label} Selected (${chips.length})<span class="remove">&times;</span></span>`);
            } else {
                collectiveBadge.text(`${label} Selected (${chips.length})`).attr('data-count', chips.length);
                collectiveBadge.append('<span class="remove">&times;</span>');
            }
        } else {
            chips.show();
            collectiveBadge.remove();
        }
    }

    // Add procedure with assessor selection for B2B
    function addProcedureWithAssessorSelection(procedureId, procedureName) {
        // Check if procedure already exists
        if ($(`.assessor-selection-row[data-procedure-id="${procedureId}"]`).length > 0) {
            return;
        }
        
        // Ensure container is visible when at least one procedure is selected
        $('#selectedProceduresContainer').show();
        
        const procedureHtml = `
            <div class="assessor-selection-row" data-procedure-id="${procedureId}" style="margin-top: 10px;">
                <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px;">
                    <span class="procedure-name" style="font-weight: 600;">${procedureName}</span>
                    <button type="button" class="remove-procedure" data-procedure-id="${procedureId}" title="Remove" style="background: none; border: none; cursor: pointer; color: #6c757d;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="dropdown-container" style="margin-top: 8px;">
                    <button type="button" class="dropdown-btn assessor-dropdown-btn" data-procedure-id="${procedureId}">Select Assessors</button>
                    <ul class="dropdown-list assessor-dropdown-list" id="assessorList-${procedureId}"></ul>
                </div>
                <div class="assessor-chips chip-container" id="assessorChips-${procedureId}" data-procedure-id="${procedureId}" style="margin-top: 8px;"></div>
            </div>
        `;
        
        $('#selectedProceduresList').append(procedureHtml);
        
        // Populate assessor list for this procedure
        $.ajax({
            url: '/fetch-assessors/',
            type: 'GET',
            success: function(response) {
                populateAssessorsForProcedure(procedureId, response.assessors);
            },
            error: function() {
                console.error('Failed to fetch assessors for procedure');
            }
        });
    }

    // Populate assessors for a specific procedure (B2B)
    function populateAssessorsForProcedure(procedureId, assessors) {
        const assessorList = $(`#assessorList-${procedureId}`);
        assessorList.empty();
        
        if (!assessors || assessors.length === 0) {
            assessorList.append('<li style="color:#888; padding:8px 12px;">No assessors available</li>');
            return;
        }
        
        assessors.forEach(assessor => {
            assessorList.append(`
                <li data-id="${assessor.id}" data-value="${assessor.name}">
                    <label style="display: flex; align-items: center; width: 100%; margin: 0; cursor: pointer;">
                        <input type="checkbox" value="${assessor.id}" style="margin-right: 8px;">
                        <span>${assessor.name}</span>
                    </label>
                </li>
            `);
        });
    }

    // Populate assessors for B2B (all procedures)
    function populateAssessorsForB2B(assessors) {
        // This populates the global assessor list that can be used for all procedures
        const assessorList = $('#assessorDropdownList');
        assessorList.empty();
        
        if (!assessors || assessors.length === 0) {
            assessorList.append('<li style="color:#888; padding:8px 12px;">No assessors available</li>');
            return;
        }
        
        assessors.forEach(assessor => {
            assessorList.append(`
                <li data-id="${assessor.id}" data-value="${assessor.name}">
                    <span>${assessor.name}</span>
                </li>
            `);
        });
    }

    // Remove procedure from B2B selection
    function removeProcedure(procedureId) {
        // Remove from UI
        $(`.assessor-selection-row[data-procedure-id="${procedureId}"]`).remove();
        
        // Uncheck the checkbox
        $(`#procedureDropdownList li[data-id="${procedureId}"] .procedure-checkbox`).prop('checked', false);
        
        // Remove chip
        $(`#procedureChipsContainer .chip[data-id="${procedureId}"]`).remove();
        
        // Update display
        updateChipDisplay('procedureChipsContainer', 'Procedures');
        
        // Hide the container ONLY if no assessor-selection-row remains
        if ($('#selectedProceduresList .assessor-selection-row').length === 0) {
            $('#selectedProceduresContainer').hide();
        }
    }

    function updateTestStatus(select, testId) {
        const status = select.checked;
        console.log(status)
        var status_new;
        if(status == true){
            status_new = 'Completed';
        } else {
            status_new = 'In Progress';
        }
        $.ajax({
            url: `/update-test-status/${testId}/${status_new}/`,
            type: 'GET',
            success: function (response) {
                alert('Test status updated successfully.');
                window.location.reload();
            },
            error: function (xhr) {
                console.error(xhr.responseJSON.error);
            },
            complete: function () {
                console.log('complete');
            },
        });
    }

    $('#assignForm').on('submit', function (e) {
        e.preventDefault();
    
        const testDate = $('#date').val();
        const button = $('.assign-btn'); 
        const spinner = button.find('.spinner-border'); 
    
        // Get test type
        const testType = $('#typeDropdownBtn').text().trim();
    
        // Validation: Check if type is selected
        if (testType === 'Select Type' || !testType) {
            alert('Please select a Type (B2C or B2B)');
            return false;
        }
    
        // Check if date is selected
        if (!testDate) {
            alert('Please select a test date');
            return false;
        }
    
        // Get skillathon id (for B2C)
        let skillathonId = null;
        if (testType === 'B2C') {
            // Get the skillathon ID from the button's data attribute
            skillathonId = $('#skillathonDropdownBtn').attr('data-skillathon-id');
            
            // Validation: Check if skillathon is selected
            if (!skillathonId || skillathonId === 'undefined') {
                alert('Please select a Skillathon');
                return false;
            }
            
            console.log('B2C - Skillathon ID:', skillathonId);
        }
    
        // Gather selected batch IDs from the chip container (for B2B)
        let batchIds = [];
        let courseId = null;
        let examType = null;
        let institutionId = null;
        
        if (testType === 'B2B') {
            batchIds = $('#batchChipsContainer .chip').map(function () {
                return $(this).data('id');
            }).get();
            
            // Validation: Check if batches are selected
            if (batchIds.length === 0) {
                alert('Please select at least one batch');
                return false;
            }
            
            // Get selected course ID
            courseId = $('#courseDropdownBtn').attr('data-course-id');

            console.log('=== COURSE ID DEBUG ===');
            console.log('Course ID:', courseId);
            console.log('Course button text:', $('#courseDropdownBtn').text());
            console.log('Course button:', $('#courseDropdownBtn'));

            // Validation: Check if course is selected
            if (!courseId || courseId === 'undefined' || courseId === 'Select Course') {
                alert('Please select a Course');
                return false;
            }

            // Get exam type
            examType = $('#examTypeDropdownBtn').text().trim();
            if (examType === 'Select Exam Type') {
                examType = null;
            }

            // Get institution ID from button's data attribute
            institutionId = $('#institutionDropdownBtn').attr('data-institution-id');

            // Validation: Check if institution is selected
            if (!institutionId || institutionId === 'undefined') {
                alert('Please select an Institution/Hospital');
                return false;
            }
            
            console.log('B2B - Batch IDs:', batchIds, 'Institution:', institutionId);
        }
    
        // Gather data based on test type
        let procedureAssessorMappings = [];
        let procedures = [];
        let assessors = [];
        
        if (testType === 'B2B') {
            // B2B: Use per-procedure assessor selection (inline rows)
            $('#selectedProceduresList .assessor-selection-row').each(function() {
                const container = $(this);
                const procedureId = container.data('procedure-id');
                const procedureName = container.find('.procedure-name').text();
                let assessorIds = container.find('.assessor-chips .chip').map(function() {
                    return $(this).data('id');
                }).get().filter(function(v){ return v !== undefined && v !== null && v !== ''; });

                // Fallback 1: if no per-procedure assessor chips (e.g., collapsed into summary), read checked items from its dropdown list
                if (assessorIds.length === 0) {
                    assessorIds = $(`#assessorList-${procedureId} input[type="checkbox"]:checked`).map(function(){
                        return $(this).val();
                    }).get().filter(function(v){ return v !== undefined && v !== null && v !== ''; });
                }

                // Fallback 2: if still none, use global assessors (if any)
                if (assessorIds.length === 0) {
                    assessorIds = $('#assessorChipsContainer .chip:not(.collective)').map(function() {
                        return $(this).data('id');
                    }).get().filter(function(v){ return v !== undefined && v !== null && v !== ''; });
                }
                
                procedureAssessorMappings.push({
                    procedureId: procedureId,
                    procedureName: procedureName,
                    assessorIds: assessorIds
                });
            });
            
            // Validation: Check if procedures are selected
            if (procedureAssessorMappings.length === 0) {
                alert('Please select at least one procedure');
                return false;
            }

            // Deduplicate mappings by procedureId and union assessorIds
            (function dedupeProcedureMappings(){
                const byId = new Map();
                procedureAssessorMappings.forEach(m => {
                    const pid = String(m.procedureId || '').trim();
                    const name = m.procedureName || '';
                    const ids = Array.isArray(m.assessorIds) ? m.assessorIds.map(String) : [];
                    if (!byId.has(pid)) {
                        byId.set(pid, { procedureId: pid, procedureName: name, assessorIds: new Set(ids) });
                    } else {
                        const entry = byId.get(pid);
                        ids.forEach(id => entry.assessorIds.add(id));
                        if (!entry.procedureName && name) entry.procedureName = name; // prefer any non-empty name
                    }
                });
                procedureAssessorMappings = Array.from(byId.values()).map(e => ({
                    procedureId: e.procedureId,
                    procedureName: e.procedureName,
                    assessorIds: Array.from(e.assessorIds)
                }));
            })();

            // Ensure each selected procedure has at least one assessor; report names
            const missing = procedureAssessorMappings
                .filter(m => !m.assessorIds || m.assessorIds.length === 0)
                .map(m => m.procedureName || ('Procedure ' + (m.procedureId || '')));
            if (missing.length > 0) {
                alert('Please select at least one assessor for: ' + missing.join(', '));
                // Focus the first missing row
                const firstMissing = missing[0];
                const firstMissingRow = $('#selectedProceduresList [data-procedure-id]').filter(function(){
                    const name = $(this).find('.procedure-name').text();
                    return name === firstMissing;
                }).get(0);
                if (firstMissingRow) {
                    firstMissingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }

            // For B2B, also gather all assessors for backward compatibility
            const allAssessors = [];
            procedureAssessorMappings.forEach(mapping => {
                allAssessors.push(...mapping.assessorIds);
            });
            assessors = [...new Set(allAssessors)];

            console.log('B2B - Procedures:', procedureAssessorMappings);
        } else {
            // B2C: Use original logic
            procedures = $('#procedureChipsContainer .chip:not(.collective)').map(function () {
                return $(this).data('id');
            }).get();
            
            assessors = $('#assessorChipsContainer .chip:not(.collective)').map(function () {
                return $(this).data('id');
            }).get();
            
            // Validation: Check if procedures are selected
            if (procedures.length === 0) {
                alert('Please select at least one procedure');
                return false;
            }
            
            // Validation: Check if assessors are selected
            if (assessors.length === 0) {
                alert('Please select at least one assessor');
                return false;
            }
            
            console.log('B2C - Procedures:', procedures, 'Assessors:', assessors);
        }
    
        button.prop('disabled', true);
        spinner.show();
        button.contents().filter(function () {
            return this.nodeType === 3;
        }).first().replaceWith('Assigning...');
    
        // AJAX request to create tests for multiple batches
        const requestData = {
            test_type: testType,
            test_date: testDate,
            csrfmiddlewaretoken: $('[name="csrfmiddlewaretoken"]').val(),
        };
        
        if (testType === 'B2B') {

            if (!courseId) {
                alert('Please select a Course');
                button.prop('disabled', false);
                spinner.hide();
                button.contents().filter(function () {
                    return this.nodeType === 3;
                }).first().replaceWith('Assign Assessment');
                return false;
            }

            // B2B: Send procedure-assessor mappings and related data
            requestData.batch_ids = batchIds;
            requestData.institution_id = institutionId;
            requestData.course_id = courseId;
            requestData.exam_type = examType;
            requestData.procedure_assessor_mappings = JSON.stringify(procedureAssessorMappings);
            requestData.assessor_ids = assessors;
        } else {
            // B2C: Send skillathon and procedure/assessor data
            requestData.skillathon_id = skillathonId;
            requestData.procedure_ids = procedures;
            requestData.assessor_ids = assessors;
        }
        
        console.log('Request Data:', requestData);
        
        $.ajax({
            url: '/create-procedure-assignment-and-test/',
            type: 'POST',
            data: requestData,
            traditional: true,
            success: function (response) {
                console.log('Success:', response);
                toggleAssignPanel();
                window.location.reload();
            },
            error: function (xhr) {
                console.error('Error Response:', xhr);
                console.error('Error Details:', xhr.responseJSON);
                let errorMsg = 'Failed to create tests and assignments.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += '\n' + xhr.responseJSON.error;
                }
                alert(errorMsg);
            },
            complete: function () {
                spinner.hide();
                button.prop('disabled', false);
                button.contents().filter(function () {
                    return this.nodeType === 3;
                }).first().replaceWith('Assign');
            },
        });
    });

    function toggleAssignPanel() {
        const panel = document.getElementById('assignPanel');
        const overlay = document.getElementById('assignOverlay');
        panel.classList.toggle('active');
        overlay.classList.toggle('active');
        document.body.style.overflow = panel.classList.contains('active') ? 'hidden' : '';
    }
    // Show confirmation modal
    function confirmDeleteTest(testId, testType) {
        document.getElementById('deleteTestId').value = testId;
        document.getElementById('deleteTestType').value = (testType || 'B2C');
        $('#deleteTestModal').modal('show');
    }

    // Actually delete after confirmation
    document.addEventListener('DOMContentLoaded', function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                const testId = document.getElementById('deleteTestId').value;
                const testType = document.getElementById('deleteTestType').value || 'B2C';
                const btn = this;
                const originalText = btn.textContent;
                
                // Disable button and show loading
                btn.disabled = true;
                btn.textContent = 'Deleting...';
                
                const csrf = $('[name="csrfmiddlewaretoken"]').val();
                const url = (testType === 'B2B') ? `/api/batch-assignments/${testId}/delete/` : `/api/tests/${testId}/delete/`;
                $.ajax({ 
                    url, 
                    method: 'POST', 
                    headers: { 'X-CSRFToken': csrf } 
                }).done(function(){
                    $('#deleteTestModal').modal('hide');
                    window.location.reload();
                }).fail(function(xhr){
                    alert(xhr.responseJSON?.error || 'Failed to delete');
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
            });
        }
    });

    let __editingTestId = null;
    function openEditTestPanel(testId, buttonElement){
        if (!testId) {
            console.error('openEditTestPanel: testId is missing');
            return;
        }
        
        __editingTestId = testId;
        
        // Check if jQuery elements exist
        if (!$('#editAssessmentName').length) {
            console.error('Edit panel elements not found');
            return;
        }
        
        // Try to extract data from the table row as fallback
        let rowData = {};
        if (buttonElement) {
            const row = buttonElement.closest('.assessment-row');
            if (row) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    // Extract data from table cells
                    rowData.assessment_name = cells[1]?.querySelector('.assessment-name span')?.textContent?.trim() || '';
                    rowData.skillathon = row.dataset.mode || '';
                    rowData.status = 'Not Completed'; // Default, will be updated from API if available
                    const dateText = cells[7]?.querySelector('.date-text')?.textContent?.trim() || '';
                    // Try to parse date if available
                    if (dateText && dateText !== '-') {
                        // Date format is "d M Y" (e.g., "15 Jan 2024")
                        try {
                            const dateParts = dateText.split(' ');
                            if (dateParts.length === 3) {
                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                const monthIndex = months.indexOf(dateParts[1]);
                                if (monthIndex !== -1) {
                                    const day = parseInt(dateParts[0]);
                                    const year = parseInt(dateParts[2]);
                                    const date = new Date(year, monthIndex, day);
                                    if (!isNaN(date.getTime())) {
                                        rowData.testdate = date.toISOString().split('T')[0];
                                    }
                                }
                            }
                        } catch (e) {
                            // Ignore date parsing errors
                        }
                    }
                }
            }
        }
        
        // Open the panel first
        toggleEditPanel(true);
        
        // Clear existing data
        $('#editAssessmentName').val(rowData.assessment_name || '');
        $('#editSkillathon').val(rowData.skillathon || '');
        $('#editProcedures').empty();
        $('#editAssessors').empty();
        $('#editStatus').val(rowData.status || 'Not Completed');
        $('#editDate').val(rowData.testdate || '');
        
        // Try to load data from API (but don't block if it fails)
        const url = `/api/tests/${testId}/`;
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            }
        })
          .then(r => {
            if (!r.ok) {
                // If API fails, continue with row data we extracted
                console.warn('API request failed, using row data. Status:', r.status);
                return null;
            }
            return r.json().catch(e => {
                console.warn('Failed to parse JSON response:', e);
                return null;
            });
          })
          .then(res => {
            if (!res || !res.success || !res.test) {
                // If response is invalid, continue with row data
                if (res && res.error) {
                    console.warn('API error:', res.error);
                } else {
                    console.warn('Invalid API response structure');
                }
                return;
            }
            
            const t = res.test;
            
            // Populate form fields from API (overrides row data)
            if (t.assessment_name !== undefined && t.assessment_name !== null) {
                $('#editAssessmentName').val(String(t.assessment_name));
            }
            if (t.skillathon !== undefined && t.skillathon !== null) {
                $('#editSkillathon').val(String(t.skillathon));
            }
            if (t.status !== undefined && t.status !== null) {
                $('#editStatus').val(String(t.status));
            }
            if (t.testdate !== undefined && t.testdate !== null) {
                $('#editDate').val(String(t.testdate));
            }
            
            // Populate procedures
            const procContainer = $('#editProcedures'); 
            procContainer.empty(); // Clear any existing chips
            if (t.procedures && Array.isArray(t.procedures) && t.procedures.length > 0) {
                t.procedures.forEach(p => {
                    if (p && p.id && p.name) {
                        const procId = String(p.id);
                        const procName = String(p.name);
                        procContainer.append(`<span class="chip" data-id="${procId}">${procName}<span class="remove">&times;</span></span>`);
                    }
                });
            }
            
            // Populate assessors
            const assContainer = $('#editAssessors'); 
            assContainer.empty(); // Clear any existing chips
            if (t.assessors && Array.isArray(t.assessors) && t.assessors.length > 0) {
                t.assessors.forEach(a => {
                    if (a && a.id && a.name) {
                        const assId = String(a.id);
                        const assName = String(a.name);
                        assContainer.append(`<span class="chip" data-id="${assId}">${assName}<span class="remove">&times;</span></span>`);
                    }
                });
            }
          })
          .catch(error => { 
            // Silently handle errors - panel is already open with row data, user can still edit
            console.warn('Error loading test data (non-blocking):', error);
          });
    }

    function toggleEditPanel(forceOpen){
        const panel = document.getElementById('editPanel');
        const overlay = document.getElementById('editOverlay');
        
        if (!panel || !overlay) {
            console.error('Edit panel or overlay not found');
            return;
        }
        
        if (forceOpen === true){
            panel.classList.add('active');
            overlay.classList.add('active');
        } else {
            panel.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        document.body.style.overflow = panel.classList.contains('active') ? 'hidden' : '';
    }

    $('#editForm').on('submit', function(e){
        e.preventDefault();
        if(!__editingTestId) return;
        const button = $('.edit-save-btn');
        const spinner = button.find('.spinner-border');
        button.prop('disabled', true);
        spinner.show();
        // Collect ids from chips
        const procIds = $('#editProcedures .chip').map(function(){ return $(this).data('id'); }).get();
        const assessorIds = $('#editAssessors .chip').map(function(){ return $(this).data('id'); }).get();
        const payload = {
            testdate: $('#editDate').val() || undefined,
            status: $('#editStatus').val(),
            procedure_ids: procIds,
            assessor_ids: assessorIds
        };
        fetch(`/api/tests/${__editingTestId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()
            },
            body: JSON.stringify(payload)
        }).then(r => r.json()).then(res => {
            if(res.success){ window.location.reload(); }
            else { alert(res.error || 'Update failed'); }
        }).catch(() => alert('Update failed'))
        .finally(() => { spinner.hide(); button.prop('disabled', false); });
    });

    // Search/Filter Assessments
    function filterAssessments(searchTerm) {
        const rows = document.querySelectorAll('.assessment-row');
        const term = searchTerm.toLowerCase();
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(term)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Toggle Filter Panel
    function toggleFilterPanel() {
        const panel = document.getElementById('filterPanel');
        const overlay = document.getElementById('filterOverlay');
        const isOpening = !panel.classList.contains('active');
        panel.classList.toggle('active');
        overlay.classList.toggle('active');
        // Update active filters display when opening panel
        if (isOpening) {
            // Rebuild batch and assessor lists from current table contents
            buildDynamicFilterLists();
            updateActiveFiltersDisplay();
        }
    }


    // Switch Filter Type
    function switchFilter(filterType) {
        // Update active filter type
        document.querySelectorAll('.filter-type').forEach(type => {
            type.classList.remove('active');
        });
        document.querySelector(`.filter-type[data-filter="${filterType}"]`).classList.add('active');
        
        // Show corresponding content
        document.querySelectorAll('.filter-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${filterType}-content`).classList.add('active');
    }

    // Update Selection Counts
    function toggleSelectAll(category, selectAllCheckbox) {
        let checkboxSelector;
        if (category === 'type') {
            checkboxSelector = '.type-checkbox';
        } else if (category === 'mode') {
            checkboxSelector = '.mode-checkbox';
        } else if (category === 'entity') {
            checkboxSelector = '.entity-checkbox';
        } else if (category === 'batch') {
            checkboxSelector = '.batch-checkbox';
        } else if (category === 'assessor') {
            checkboxSelector = '.assessor-checkbox';
        } else {
            checkboxSelector = `input[name="${category}"]`;
        }
        
        const checkboxes = document.querySelectorAll(`#filter${category.charAt(0).toUpperCase() + category.slice(1)}Options ${checkboxSelector}`);
        const isChecked = selectAllCheckbox.checked;
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const changeEvent = new Event('change', { bubbles: true });
            checkbox.dispatchEvent(changeEvent);
        });
        
        if (category === 'type') {
            updateTypeSelectionCount();
        } else if (category === 'mode') {
            updateModeSelectionCount();
        } else if (category === 'entity') {
            updateEntitySelectionCount();
        } else if (category === 'batch') {
            updateBatchSelectionCount();
        } else if (category === 'assessor') {
            updateAssessorSelectionCount();
        }
    }

    function updateTypeSelectionCount() {
        const checkedBoxes = document.querySelectorAll('#filterTypeOptions .type-checkbox:checked');
        const count = checkedBoxes.length;
        document.getElementById('typeSelectionCount').textContent = `${count} Type selected`;
        
        // Sync "Select All" checkbox state
        const selectAllCheckbox = document.getElementById('selectAllTypes');
        const allCheckboxes = document.querySelectorAll('#filterTypeOptions .type-checkbox');
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = (count === allCheckboxes.length);
            selectAllCheckbox.indeterminate = (count > 0 && count < allCheckboxes.length);
        }
        
        updateFilterBadge();
        setFilterTypeBadge('type', count);
    }

    // Build Batch and Assessor filter lists from table rows
    function buildDynamicFilterLists() {
        const batchSet = new Set();
        const assessorSet = new Set();

        document.querySelectorAll('.assessment-row').forEach(row => {
            // Batch is the 4th column (0-based index 3) per table header
            const batchCell = row.cells && row.cells[3] ? row.cells[3].textContent.trim() : '';
            if (batchCell && batchCell !== '-' && batchCell.toLowerCase() !== 'batch') {
                batchSet.add(batchCell);
            }
            // Assessors is the 6th column (index 5)
            const assessorCell = row.cells && row.cells[5] ? row.cells[5].textContent.trim() : '';
            if (assessorCell && assessorCell !== '-' && assessorCell.toLowerCase() !== 'assessors') {
                assessorCell.split(',').map(s => s.trim()).filter(Boolean).forEach(name => assessorSet.add(name));
            }
        });

        const batchOptions = document.getElementById('filterBatchOptions');
        const assessorOptions = document.getElementById('filterAssessorOptions');
        if (batchOptions) {
            const batchOptionsHTML = Array.from(batchSet).sort().map(b => (
                `<label class="option-item"><input type="checkbox" name="batch" value="${b}" onchange="updateBatchSelectionCount()" class="batch-checkbox"><span>${b}</span></label>`
            )).join('');
            batchOptions.innerHTML = `<label class="option-item select-all-item"><input type="checkbox" id="selectAllBatches" onchange="toggleSelectAll('batch', this)"><span><strong>Select All</strong></span></label>` + batchOptionsHTML;
        }
        if (assessorOptions) {
            const assessorOptionsHTML = Array.from(assessorSet).sort().map(a => (
                `<label class="option-item"><input type="checkbox" name="assessor" value="${a}" onchange="updateAssessorSelectionCount()" class="assessor-checkbox"><span>${a}</span></label>`
            )).join('');
            assessorOptions.innerHTML = `<label class="option-item select-all-item"><input type="checkbox" id="selectAllAssessors" onchange="toggleSelectAll('assessor', this)"><span><strong>Select All</strong></span></label>` + assessorOptionsHTML;
        }
    }

    function updateModeSelectionCount() {
        const checkedBoxes = document.querySelectorAll('#filterModeOptions .mode-checkbox:checked');
        const count = checkedBoxes.length;
        document.getElementById('modeSelectionCount').textContent = `${count} Mode selected`;
        
        // Sync "Select All" checkbox state
        const selectAllCheckbox = document.getElementById('selectAllModes');
        const allCheckboxes = document.querySelectorAll('#filterModeOptions .mode-checkbox');
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = (count === allCheckboxes.length);
            selectAllCheckbox.indeterminate = (count > 0 && count < allCheckboxes.length);
        }
        
        updateFilterBadge();
        setFilterTypeBadge('mode', count);
    }

    function updateEntitySelectionCount() {
        const checkedBoxes = document.querySelectorAll('#filterEntityOptions .entity-checkbox:checked');
        const count = checkedBoxes.length;
        document.getElementById('entitySelectionCount').textContent = `${count} Entity selected`;
        
        // Sync "Select All" checkbox state
        const selectAllCheckbox = document.getElementById('selectAllEntities');
        const allCheckboxes = document.querySelectorAll('#filterEntityOptions .entity-checkbox');
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = (count === allCheckboxes.length);
            selectAllCheckbox.indeterminate = (count > 0 && count < allCheckboxes.length);
        }
        
        updateFilterBadge();
        setFilterTypeBadge('entity', count);
    }

    function updateBatchSelectionCount() {
        const checkedBoxes = document.querySelectorAll('#filterBatchOptions .batch-checkbox:checked');
        const count = checkedBoxes.length;
        document.getElementById('batchSelectionCount').textContent = `${count} Batch selected`;
        
        // Sync "Select All" checkbox state
        const selectAllCheckbox = document.getElementById('selectAllBatches');
        const allCheckboxes = document.querySelectorAll('#filterBatchOptions .batch-checkbox');
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = (count === allCheckboxes.length);
            selectAllCheckbox.indeterminate = (count > 0 && count < allCheckboxes.length);
        }
        
        updateFilterBadge();
        setFilterTypeBadge('batch', count);
    }

    function updateAssessorSelectionCount() {
        const checkedBoxes = document.querySelectorAll('#filterAssessorOptions .assessor-checkbox:checked');
        const count = checkedBoxes.length;
        document.getElementById('assessorSelectionCount').textContent = `${count} Assessor selected`;
        
        // Sync "Select All" checkbox state
        const selectAllCheckbox = document.getElementById('selectAllAssessors');
        const allCheckboxes = document.querySelectorAll('#filterAssessorOptions .assessor-checkbox');
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = (count === allCheckboxes.length);
            selectAllCheckbox.indeterminate = (count > 0 && count < allCheckboxes.length);
        }
        
        updateFilterBadge();
        setFilterTypeBadge('assessor', count);
    }

    function updateStatusSelectionCount() {
        const count = document.querySelectorAll('input[name="status"]:checked').length;
        document.getElementById('statusSelectionCount').textContent = `${count} Status selected`;
        updateFilterBadge();
        setFilterTypeBadge('status', count);
    }

    // Helper to show count badges against individual filter types in sidebar
    function setFilterTypeBadge(category, count) {
        const el = document.querySelector(`.filter-type[data-filter="${category}"]`);
        if (!el) return;
        let badge = el.querySelector('.filter-type-badge');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'filter-type-badge';
            el.appendChild(badge);
        }
        if (count > 0) {
            badge.textContent = String(count);
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    // Update Filter Badge
    function updateFilterBadge() {
        const totalFilters = 
            document.querySelectorAll('input[name="type"]:checked').length +
            document.querySelectorAll('input[name="mode"]:checked').length +
            document.querySelectorAll('input[name="entity"]:checked').length +
            document.querySelectorAll('input[name="batch"]:checked').length +
            document.querySelectorAll('input[name="assessor"]:checked').length +
            document.querySelectorAll('input[name="status"]:checked').length +
            (document.getElementById('filterDateFrom').value ? 1 : 0) +
            (document.getElementById('filterDateTo').value ? 1 : 0);
        
        const badge = document.getElementById('filterBadge');
        if (totalFilters > 0) {
            badge.textContent = totalFilters;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }

        // Also ensure sidebar badges are updated for all categories
        setFilterTypeBadge('type', document.querySelectorAll('input[name="type"]:checked').length);
        setFilterTypeBadge('mode', document.querySelectorAll('input[name="mode"]:checked').length);
        setFilterTypeBadge('entity', document.querySelectorAll('input[name="entity"]:checked').length);
        setFilterTypeBadge('batch', document.querySelectorAll('input[name="batch"]:checked').length);
        setFilterTypeBadge('assessor', document.querySelectorAll('input[name="assessor"]:checked').length);
        setFilterTypeBadge('status', document.querySelectorAll('input[name="status"]:checked').length);
    }

    // Clear All Filters
    function clearAllFilters() {
        document.querySelectorAll('.filter-form input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            cb.indeterminate = false;
        });
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        updateTypeSelectionCount();
        updateModeSelectionCount();
        updateEntitySelectionCount();
        updateBatchSelectionCount();
        updateAssessorSelectionCount();
        updateStatusSelectionCount();
        updateFilterBadge();
        updateActiveFiltersDisplay();
        // Show all rows again
        document.querySelectorAll('.assessment-row').forEach(row => row.style.display = '');
        // Hide empty state message
        const emptyStateRow = document.getElementById('filteredEmptyState');
        if (emptyStateRow) {
            emptyStateRow.style.display = 'none';
        }
    }

    // Make entire option row clickable to toggle checkbox
    document.addEventListener('click', function(e) {
        const label = e.target.closest('label.option-item');
        if (!label) return;
        
        // Only handle filter options
        if (!label.closest('.filter-content')) return;
        
        if (label.classList.contains('select-all-item')) {
            return;
        }
        
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (!checkbox) return;
        
        if (e.target === checkbox || e.target.type === 'checkbox') {
            setTimeout(function() {
                const container = label.closest('.filter-content');
                if (container) {
                    const category = container.id.replace('-content', '');
                    if (category === 'type') {
                        updateTypeSelectionCount();
                    } else if (category === 'mode') {
                        updateModeSelectionCount();
                    } else if (category === 'entity') {
                        updateEntitySelectionCount();
                    } else if (category === 'batch') {
                        updateBatchSelectionCount();
                    } else if (category === 'assessor') {
                        updateAssessorSelectionCount();
                    }
                }
            }, 10);
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        checkbox.checked = !checkbox.checked;
        
        const changeEvent = new Event('change', { bubbles: true, cancelable: false });
        checkbox.dispatchEvent(changeEvent);
        
        const container = label.closest('.filter-content');
        if (container) {
            const category = container.id.replace('-content', '');
            if (category === 'type') {
                updateTypeSelectionCount();
            } else if (category === 'mode') {
                updateModeSelectionCount();
            } else if (category === 'entity') {
                updateEntitySelectionCount();
            } else if (category === 'batch') {
                updateBatchSelectionCount();
            } else if (category === 'assessor') {
                updateAssessorSelectionCount();
            }
        }
    }, true);

    // Store active filters globally
    let activeFilters = {
        types: [],
        modes: [],
        entities: [],
        batches: [],
        assessors: [],
        statuses: [],
        dateFrom: '',
        dateTo: ''
    };

    // Update active filters display (inside panel only)
    function updateActiveFiltersDisplay() {
        const filters = {
            types: Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => cb.value),
            modes: Array.from(document.querySelectorAll('input[name="mode"]:checked')).map(cb => cb.value),
            entities: Array.from(document.querySelectorAll('input[name="entity"]:checked')).map(cb => cb.value),
            batches: Array.from(document.querySelectorAll('input[name="batch"]:checked')).map(cb => cb.value),
            assessors: Array.from(document.querySelectorAll('input[name="assessor"]:checked')).map(cb => cb.value),
            statuses: Array.from(document.querySelectorAll('input[name="status"]:checked')).map(cb => cb.value),
            dateFrom: document.getElementById('filterDateFrom').value,
            dateTo: document.getElementById('filterDateTo').value
        };
        
        activeFilters = filters;
        
        // Count total filters
        const totalFilters = filters.types.length + filters.modes.length + filters.entities.length + 
                            filters.batches.length + filters.assessors.length + filters.statuses.length +
                            (filters.dateFrom ? 1 : 0) + (filters.dateTo ? 1 : 0);

        // No inside text summary required; badges indicate counts per category
    }

    // Apply Filters
    function applyFilters() {
        const filters = {
            types: Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => cb.value),
            modes: Array.from(document.querySelectorAll('input[name="mode"]:checked')).map(cb => cb.value),
            entities: Array.from(document.querySelectorAll('input[name="entity"]:checked')).map(cb => cb.value),
            batches: Array.from(document.querySelectorAll('input[name="batch"]:checked')).map(cb => cb.value),
            assessors: Array.from(document.querySelectorAll('input[name="assessor"]:checked')).map(cb => cb.value),
            statuses: Array.from(document.querySelectorAll('input[name="status"]:checked')).map(cb => cb.value),
            dateFrom: document.getElementById('filterDateFrom').value,
            dateTo: document.getElementById('filterDateTo').value
        };
        
        const rows = document.querySelectorAll('.assessment-row');
        let visibleCount = 0;
        
        // Check if any filters are active
        const hasActiveFilters = filters.types.length > 0 || 
                                 filters.modes.length > 0 || 
                                 filters.entities.length > 0 || 
                                 filters.batches.length > 0 || 
                                 filters.assessors.length > 0 || 
                                 filters.statuses.length > 0 || 
                                 filters.dateFrom || 
                                 filters.dateTo;
        
        rows.forEach(row => {
            let show = true;
            
            // Type filter (use data-type set on row)
            if (filters.types.length > 0) {
                const typeText = (row.dataset.type || '').trim();
                if (!filters.types.includes(typeText)) show = false;
            }
            
            // Mode filter (use data-mode set on row)
            if (filters.modes.length > 0) {
                const modeText = (row.dataset.mode || '').trim();
                if (!filters.modes.some(mode => modeText.includes(mode))) show = false;
            }

            // Batch filter (compare against Batch column text)
            if (filters.batches.length > 0) {
                const batchText = (row.cells && row.cells[3] ? row.cells[3].textContent.trim() : '');
                if (!filters.batches.includes(batchText)) show = false;
            }

            // Assessor filter (match any of the selected assessors in the Assessors column)
            if (filters.assessors.length > 0) {
                const assessorText = (row.cells && row.cells[5] ? row.cells[5].textContent.trim() : '');
                const assessorList = assessorText.split(',').map(s => s.trim()).filter(Boolean);
                const hasAssessor = filters.assessors.some(a => assessorList.includes(a));
                if (!hasAssessor) show = false;
            }
            
            // Status filter
            if (filters.statuses.length > 0) {
                // You'll need to add status data to your table row
                // const statusText = row.dataset.status;
                // if (!filters.statuses.includes(statusText)) show = false;
            }
            
            // Date filter
            if (filters.dateFrom || filters.dateTo) {
                const dateText = row.querySelector('.date-text')?.textContent.trim();
                // Add date comparison logic here
            }
            
            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });
        
        // Show/hide empty state message if filters are active and no results
        const emptyStateRow = document.getElementById('filteredEmptyState');
        if (emptyStateRow) {
            if (hasActiveFilters && visibleCount === 0) {
                emptyStateRow.style.display = '';
            } else {
                emptyStateRow.style.display = 'none';
            }
        }
        
        // Update active filters display
        updateActiveFiltersDisplay();
        
        toggleFilterPanel();
    }

    // Filter search functions
    function filterTypeOptions(searchTerm) {
        const options = document.querySelectorAll('#filterTypeOptions .option-item');
        options.forEach(option => {
            // Always show "Select All" option
            if (option.classList.contains('select-all-item')) {
                option.style.display = '';
                return;
            }
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        });
    }

    function filterModeOptions(searchTerm) {
        const options = document.querySelectorAll('#filterModeOptions .option-item');
        options.forEach(option => {
            // Always show "Select All" option
            if (option.classList.contains('select-all-item')) {
                option.style.display = '';
                return;
            }
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        });
    }

    function filterEntityOptions(searchTerm) {
        const options = document.querySelectorAll('#filterEntityOptions .option-item');
        options.forEach(option => {
            // Always show "Select All" option
            if (option.classList.contains('select-all-item')) {
                option.style.display = '';
                return;
            }
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        });
    }

    function filterBatchOptions(searchTerm) {
        const options = document.querySelectorAll('#filterBatchOptions .option-item');
        options.forEach(option => {
            // Always show "Select All" option
            if (option.classList.contains('select-all-item')) {
                option.style.display = '';
                return;
            }
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        });
    }

    function filterAssessorOptions(searchTerm) {
        const options = document.querySelectorAll('#filterAssessorOptions .option-item');
        options.forEach(option => {
            // Always show "Select All" option
            if (option.classList.contains('select-all-item')) {
                option.style.display = '';
                return;
            }
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        });
    }

    // Click collective badge to show all procedures
    $(document).on('click', '.collective-badge', function() {
        const proceduresList = $(this).parent();
        const count = proceduresList.data('count');
        
        // You can implement a modal or tooltip to show all procedures
        alert(`This assessment has ${count} procedures. Click edit to see details.`);
    });
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTestModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Delete Assessment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this assessment?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="deleteTestId" value="">
<input type="hidden" id="deleteTestType" value="">

{% endblock %}
